[{"content":"èƒŒæ™¯ æœ€è¿‘åœ¨åšä¸€ä¸ª APP çš„åç«¯å¼€å‘ï¼Œä¸ºäº†æ–¹ä¾¿å’Œå®¢æˆ·ç«¯åŒå­¦è”è°ƒï¼Œç”¨äº†ä¸€å°é˜¿é‡Œäº‘çš„æœºå™¨æ¥éƒ¨ç½²æœåŠ¡ï¼Œæœ¬æ–‡ç®€å•è®°å½•ç›¸å…³éƒ¨ç½²å’Œè°ƒè¯•æµç¨‹ï¼Œä»¥å¤‡æŸ¥é˜…ã€‚\næœåŠ¡ç¯å¢ƒå‡†å¤‡ è€ƒè™‘åˆ°æµ‹è¯•ç¯å¢ƒå¯¹æ€§èƒ½å’Œç¨³å®šæ€§è¦æ±‚ä¸é«˜ï¼Œä¸ºäº†èŠ‚çœæˆæœ¬ï¼Œé€‰æ‹©ä¹‹é—´å°† MySQL å’Œ Redis éƒ½å®‰è£…åœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œå…¶ä¸­ Linux ç‰ˆæœ¬ä¸º CentOS Linux release 7.9ã€‚\né…ç½® SSH å¯†é’¥ç™»å½• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 # 1. å®¢æˆ·ç«¯ç”Ÿæˆå¯†é’¥å¯¹ï¼Œç³»ç»Ÿæœ‰æç¤ºï¼Œä¸€è·¯å›è½¦å³å¯ ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519_aliyun -C \u0026#34;your_email@example.com\u0026#34; # 2. å°†ç§é’¥æ·»åŠ åˆ° ssh-agent eval (ssh-agent -c) # å¯åŠ¨ ssh-agent (fish å†™æ³•) ssh-add ~/.ssh/id_ed25519_aliyun ssh-add -l # æŸ¥çœ‹å·²æ·»åŠ çš„å…¬é’¥ # 3. å°†å…¬é’¥æ·»åŠ åˆ°è¿œç¨‹æœåŠ¡å™¨ cat ~/.ssh/id_ed25519_aliyun.pub | ssh username@server_ip \u0026#34;cat \u0026gt;\u0026gt; ~/.ssh/authorized_keys\u0026#34; # 4. é…ç½® fish è‡ªåŠ¨å¯åŠ¨ ssh-agent # åœ¨ ~/.config/fish/config.fish ä¸­æ·»åŠ  if status is-interactive # æ£€æŸ¥ ssh-agent æ˜¯å¦å·²è¿è¡Œ if not test -e $SSH_AUTH_SOCK eval (ssh-agent -c) set -Ux SSH_AUTH_SOCK $SSH_AUTH_SOCK set -Ux SSH_AGENT_PID $SSH_AGENT_PID end # æ·»åŠ å¯†é’¥ï¼ˆå¦‚æœæœªæ·»åŠ ï¼‰ ssh-add -l \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 if test $status -eq 1 ssh-add ~/.ssh/id_ed25519_aliyun ssh-add ~/.ssh/id_ed25519 end end # 5. ç¼–è¾‘ SSH é…ç½®æ–‡ä»¶ # åœ¨ ~/.ssh/config æ·»åŠ ä¸»æœºé…ç½®(ä¹‹åç›´æ¥ ssh aliyun_test_server å°±å¯ä»¥ç™»å½•æœåŠ¡å™¨äº†) Host aliyun_test_server HostName server_ip User root UseKeychain yes AddKeysToAgent yes PreferredAuthentications publickey IdentityFile ~/.ssh/id_ed25519_aliyun å®‰è£… Javaã€MySQLã€Redis ç­‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # 1. Javaï¼ˆå¦‚æœå®‰è£…çš„æ˜¯ java-1.8.0-openjdkï¼Œåˆ™ä»…ä»…æ˜¯ JREï¼Œä¸åŒ…å«é¢å¤–çš„å¼€å‘å·¥å…·ï¼ˆå¦‚ javacã€jpsã€jstack ç­‰ï¼‰ sudo yum install java-1.8.0-openjdk-devel # 2. Redis # å®‰è£… sudo yum install -y redis # å¯åŠ¨ Redis systemctl start redis # è®¾ç½®å¼€æœºå¯åŠ¨ systemctl enable redis # éªŒè¯ Redis redis-cli ping # 3. MySQL sudo yum install -y mysql-community-server # å¯åŠ¨ MySQL æœåŠ¡ sudo systemctl start mysqld # è®¾ç½®å¼€æœºå¯åŠ¨ sudo systemctl enable mysqld # æŸ¥çœ‹é»˜è®¤çš„ root ç”¨æˆ·å¯†ç  grep \u0026#39;temporary password\u0026#39; /var/log/mysqld.log # ç™»å½• MySQL mysql -u root -p éƒ¨ç½² Java æœåŠ¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 1. æœ¬åœ°æ„å»ºå¾—åˆ° jar åŒ… mvn clean package 2. æ‰“åŒ…æœ¬åœ° lib åŒ…ï¼ˆå…¶ä¸­åŒ…å«æ‰€æœ‰ maven ä¾èµ– jarï¼‰ # è€ƒè™‘ä½¿ç”¨ maven-assembly-plugin æ’ä»¶ç”ŸæˆåŒ…å«æ‰€æœ‰ä¾èµ–çš„ JAR æ–‡ä»¶ï¼Œçœç•¥è¯¥æ­¥éª¤ zip -r lib.zip lib/ 2. ä½¿ç”¨ scp ä¼ è¾“åˆ°è¿œç¨‹æœåŠ¡å™¨ scp target/your-project-jar-with-dependencies.jar user@remote-server:/path/to/deploy scp target/lib.zip user@remote-server:/path/to/deploy unzip lib.zip -d lib/ # ç™»å½•è¿œç¨‹æœåŠ¡å™¨åè§£å‹ 3. ç¼–å†™å¯åŠ¨è„šæœ¬å¯åŠ¨æœåŠ¡ # vim restart.sh #!/bin/bash echo \u0026#34;************ æŸ¥æ‰¾è¿›ç¨‹ **************\u0026#34; str=`ps aux | grep \u0026#34;biz-1.0.0.jar\u0026#34; | grep -v grep | awk \u0026#39;{print $2}\u0026#39;` echo $str biz kill -9 $str if [ \u0026#34;$?\u0026#34; -eq 0 ]; then echo \u0026#34;kill success\u0026#34; else echo \u0026#34;kill failed\u0026#34; fi echo \u0026#34;************ æ€æ‰è¿›ç¨‹ **************\u0026#34; export SUPERVISOR_LOG_HOME=\u0026#34;logs\u0026#34; JAVA_OPTS=\u0026#34;-server -Xmx512m -Xms512m -Xmn256m -Xss256k -XX:MetaspaceSize=96m\u0026#34; JAVA_OPTS=\u0026#34;$JAVA_OPTS -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=localhost:5005\u0026#34; JAVA_OPTS=\u0026#34;$JAVA_OPTS -XX:+DisableExplicitGC\u0026#34; JAVA_OPTS=\u0026#34;$JAVA_OPTS -XX:+UseConcMarkSweepGC\u0026#34; JAVA_OPTS=\u0026#34;$JAVA_OPTS -XX:CMSMaxAbortablePrecleanTime=5000\u0026#34; JAVA_OPTS=\u0026#34;$JAVA_OPTS -XX:+CMSClassUnloadingEnabled \u0026#34; JAVA_OPTS=\u0026#34;$JAVA_OPTS -XX:+CMSParallelRemarkEnabled\u0026#34; JAVA_OPTS=\u0026#34;$JAVA_OPTS -XX:+UseFastAccessorMethods\u0026#34; JAVA_OPTS=\u0026#34;$JAVA_OPTS -XX:+UseCMSInitiatingOccupancyOnly\u0026#34; JAVA_OPTS=\u0026#34;$JAVA_OPTS -XX:+ExplicitGCInvokesConcurrent\u0026#34; JAVA_OPTS=\u0026#34;$JAVA_OPTS -XX:CMSInitiatingOccupancyFraction=80\u0026#34; JAVA_OPTS=\u0026#34;$JAVA_OPTS -XX:SurvivorRatio=8\u0026#34; JAVA_OPTS=\u0026#34;$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError -XX:+OmitStackTraceInFastThrow -XX:HeapDumpPath=$SUPERVISOR_LOG_HOME/java.hprof\u0026#34; JAVA_OPTS=\u0026#34;$JAVA_OPTS -Xloggc:$SUPERVISOR_LOG_HOME/gc.log -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps\u0026#34; JAVA_OPTS=\u0026#34;$JAVA_OPTS -Dlog.path=$SUPERVISOR_LOG_HOME\u0026#34; nohup java $JAVA_OPTS -Dspring.profiles.active=test -jar biz-1.0.0.jar 2\u0026gt;\u0026amp;1 \u0026amp; echo \u0026#34;************ å¯åŠ¨æˆåŠŸ **************\u0026#34; ç›®å‰è¿™ä¸ªéè‡ªåŠ¨åŒ–éƒ¨ç½²çš„æµç¨‹ï¼Œæ“ä½œèµ·æ¥è¿˜æ˜¯æ¯”è¾ƒç¹çã€‚\nä½¿ç”¨ SSH éš§é“è¿›è¡Œè¿œç¨‹è°ƒè¯• å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œdebug ç»‘å®šåªç»‘å®šæœ¬åœ°å›ç¯æ¥å£ï¼Œç„¶åé€šè¿‡ SSH éš§é“è¿›è¡Œè¿æ¥ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 # 1. åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šå¯åŠ¨ Java åº”ç”¨æ—¶æ·»åŠ è°ƒè¯•å‚æ•° # é…ç½® Java åº”ç”¨åªç›‘å¬ localhost java -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=localhost:5005 YourApp # 2. å»ºç«‹ SSH éš§é“ # è¯­æ³•ï¼šssh -L æœ¬åœ°ç«¯å£:è¿œç¨‹ä¸»æœº:è¿œç¨‹ç«¯å£ ç”¨æˆ·å@è¿œç¨‹ä¸»æœº # è¿™é‡Œæˆ‘å®é™…ç”¨çš„æ˜¯é…ç½®åœ¨ .ssh/config ä¸­çš„ä¸»é”®æ˜µç§°-aliyun_test_server ssh -L 5005:localhost:5005 aliyun_test_server # å¦‚æœéœ€è¦åœ¨åå°è¿è¡Œ ssh -fNL 5005:localhost:5005 aliyun_test_server # 3.é…ç½® IDE - é…ç½®è¿œç¨‹è°ƒè¯• - è¿æ¥åœ°å€ï¼šlocalhost:5005ï¼ˆä½¿ç”¨æœ¬åœ°è½¬å‘çš„ç«¯å£ # 4. å¸¸ç”¨çš„ SSH éš§é“å‘½ä»¤é€‰é¡¹ # -f: åå°è¿è¡Œ # -N: ä¸æ‰§è¡Œè¿œç¨‹å‘½ä»¤ # -L: æœ¬åœ°ç«¯å£è½¬å‘ # -v: æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼ˆè°ƒè¯•ç”¨ï¼‰ # è¯¦ç»†æ¨¡å¼ï¼ˆä¾¿äºè°ƒè¯•ï¼‰ ssh -vNL 5005:localhost:5005 root@server_ip # åå°è¿è¡Œæ¨¡å¼ ssh -fNL 5005:localhost:5005 root@server_ip # æŒ‡å®šå¯†é’¥æ–‡ä»¶ ssh -i ~/.ssh/id_ed25519_aliyun.pub -fNL 5005:localhost:5005 root@server_ip # 5. æ£€æŸ¥éš§é“çŠ¶æ€ # æŸ¥çœ‹å·²å»ºç«‹çš„è¿æ¥ netstat -tunlp | grep 5005 # æŸ¥çœ‹ SSH è¿›ç¨‹ ps aux | grep ssh # æµ‹è¯•ç«¯å£è½¬å‘æ˜¯å¦æˆåŠŸ nc -zv localhost 5005 # 6. å…³é—­ SSH éš§é“ # æŸ¥æ‰¾ SSH è¿›ç¨‹ ps aux | grep ssh # å…³é—­ç‰¹å®šçš„ SSH éš§é“ kill \u0026lt;è¿›ç¨‹ID\u0026gt; # æˆ–è€…å…³é—­æ‰€æœ‰ SSH éš§é“ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰ pkill -f \u0026#34;ssh -fNL\u0026#34; é‡åˆ°çš„é—®é¢˜ ä¸€ä¸ªè´Ÿè´£ç™»å½•è®¤è¯çš„æ‹¦æˆªå™¨æœªæ³¨å†Œ æ¯”è¾ƒå¥‡æ€ªçš„ç‚¹åœ¨äºï¼Œæœ¬åœ°è¿™ä¸ªæ‹¦æˆªå™¨æ˜¯æ­£å¸¸çš„ï¼Œä½†éƒ¨ç½²åˆ°è¿œç¨‹ä¹‹åå®ƒå°±å¤±æ•ˆäº†(è¿œç¨‹ Debug ç±» HandlerExecutionChain#applyPreHandleå‘ç°ç¡®å®æ²¡æœ‰è¿™ä¸ªæ‹¦æˆªå™¨)ï¼Œå¯¼è‡´ä¸€äº›éœ€è¦ç™»å½•è®¤è¯çš„æ¥å£æ— æ³•ä½¿ç”¨ã€‚\nä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 @Configuration public class InterceptorConfig extends WebMvcConfigurationSupport { @Bean public JwtInterceptor authenticationInterceptor() { return new JwtInterceptor(); } @Override public void addInterceptors(InterceptorRegistry registry) { registry.addInterceptor(authenticationInterceptor()) .addPathPatterns(\u0026#34;/**\u0026#34;); } } ç›®å‰æ€€ç–‘å¯èƒ½æ˜¯æŸäº›ç±»å†²çªå¯¼è‡´çš„ï¼ˆæœ¬åœ°ç±»åŠ è½½é¡ºåºå’Œè¿œç¨‹ä¸ä¸€æ ·ï¼‰ï¼Œå…·ä½“åŸå› è¿˜åœ¨æ’æŸ¥(æˆªè‡³05.10)ã€‚\n","date":"2025-05-10T17:13:00+08:00","permalink":"https://zhumengzhu.github.io/2025/05/aliyun-deployment-debugging-java-services/","title":"é˜¿é‡Œäº‘éƒ¨ç½²è°ƒè¯• Java æœåŠ¡è®°å½•"},{"content":"è¦ç‚¹ç®€ä»‹ï¼š\næœåŠ¡è§„æ¨¡ï¼š40å°4C8Gæœºå™¨çš„ç”Ÿäº§çº§æ¨¡å‹æ¨ç†é›†ç¾¤ ä¸šåŠ¡åŸºå‡†ï¼šç¨³å®šæ”¯æ’‘1ä¸‡QPSï¼ŒæœåŠ¡SLAè¦æ±‚50ms@TP9999 é—®é¢˜ç‰¹å¾ï¼šæ— ä»£ç å˜æ›´çš„æƒ…å†µä¸‹å‡ºç°æ€§èƒ½æ–­å´– å¼•å‘æ€è€ƒï¼šçœ‹ä¼¼ç¨³å®šçš„ç³»ç»Ÿä¸ºä½•ä¼šçªç„¶æ€§èƒ½åŠ£åŒ–ï¼Ÿ Previous Next \u0026nbsp; \u0026nbsp; / [pdf] View the PDF file here. ","date":"2024-07-19T11:30:00+08:00","permalink":"https://zhumengzhu.github.io/2024/07/in-depth-jvm-performance-tuning-guide/","title":"JVMæ€§èƒ½è°ƒä¼˜å®æˆ˜åˆ†äº«"},{"content":"èƒŒæ™¯ åœ¨å¯¹æŸæŠ½å¥–å‹æµ‹æœåŠ¡æ—¶(dev\u0026amp;testç¯å¢ƒ)ï¼Œå‘ç°å½“ QPS è¾¾åˆ° 100 å·¦å³æ—¶ï¼ŒCPU ä½¿ç”¨ç‡å°±è¾¾åˆ° 100%ï¼Œå¯¹åº”çš„ on-CPU ç«ç„°å›¾æ˜¾ç¤ºï¼Œæœ‰æ¥è¿‘ 56% çš„ CPU æ—¶é—´åœ¨è¿›è¡Œ Deoptimizationï¼š ç»è°ƒç ”ï¼Œæ€€ç–‘æ˜¯è¯¥ JDK Bug å¯¼è‡´ï¼šhttps://bugs.openjdk.org/browse/JDK-8243615 ç±»ä¼¼çš„åé¦ˆè¿˜æœ‰ï¼š\nhttps://mail.openjdk.org/pipermail/hotspot-dev/2016-June/023316.html https://mail.openjdk.org/pipermail/hotspot-compiler-dev/2016-June/023278.html https://github.com/trinodb/trino/issues/6405 https://trino.io/blog/2021/10/06/jvm-issues-at-comcast.html#jit-recompilation å¤ç°æ–¹æ³• æµ‹è¯•ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 public class UnstableIfTest { static int compute(double x) { return (int) (Math.sin(x) + Math.cos(x)); } static void hotMethod(int iteration) { if (iteration \u0026lt; 20) { compute(78.3); } else if (iteration \u0026lt; 40) { compute(78.3); } else if (iteration \u0026lt; 60) { compute(78.3); } else if (iteration \u0026lt; 80) { compute(78.3); } else if (iteration \u0026lt; 100) { compute(78.3); } else { compute(78.3); } } static void hotMethodWrapper(int iteration) { int count = 100_000; for (int i = 0; i \u0026lt; count; i++) { hotMethod(iteration); } } public static void main(String[] args) { for (int k = 0; k \u0026lt; 1000; k++) { long start = System.nanoTime(); hotMethodWrapper(k + 1); System.out.println(\u0026#34;iteration \u0026#34; + k + \u0026#34;: \u0026#34; + (System.nanoTime() - start) / 1_000_000 + \u0026#34;ms\u0026#34;); } } } æ‰§è¡Œæ­¥éª¤ï¼š\n1 2 3 4 5 6 7 8 # Step1ï¼š ç¼–è¯‘ä»£ç  javac UnstableIfTest.java # Step2ï¼šæ‰§è¡Œä»£ç  java -XX:PerMethodRecompilationCutoff=4 UnstableIfTest # Step3ï¼šåœ¨ä»£ç æ‰§è¡ŒæœŸé—´ï¼Œä½¿ç”¨ arthas æˆ–è€… async-profiler æ”¶é›†ç«ç„°å›¾ profiler start -e cpu -d 120 ç»“æœï¼š è¯•åˆ†æåŸå›  å®éªŒ æ³¨ï¼š è¿™é‡Œéœ€è¦ä½¿ç”¨ java21ï¼Œå› ä¸ºä¹‹å‰çš„ç‰ˆæœ¬è¿˜ä¸æ”¯æŒæ‰“å° deoptimization æ—¥å¿—ã€‚\n1 2 3 4 5 6 7 8 9 # ä½¿ç”¨ java21 æ‰§è¡Œä¸€ä¸‹å‘½ä»¤ java -XX:+UnlockDiagnosticVMOptions -XX:PerMethodRecompilationCutoff=4 -Xlog:deoptimization=debug UnstableIfTest \u0026gt; log.txt # å¤§é‡ deoptimization æ—¥å¿— [18.896s][debug][deoptimization] cid= 632 level=4 UnstableIfTest.hotMethod(I)V trap_bci=67 unstable_if none pc=0x0000000113084938 relative_pc=0x0000000000000138 [18.896s][debug][deoptimization] cid= 632 level=4 UnstableIfTest.hotMethod(I)V trap_bci=67 unstable_if none pc=0x0000000113084938 relative_pc=0x0000000000000138 [18.896s][debug][deoptimization] cid= 632 level=4 UnstableIfTest.hotMethod(I)V trap_bci=67 unstable_if none pc=0x0000000113084938 relative_pc=0x0000000000000138 [18.896s][debug][deoptimization] cid= 632 level=4 UnstableIfTest.hotMethod(I)V trap_bci=67 unstable_if none pc=0x0000000113084938 relative_pc=0x0000000000000138 .... ç¬¬ 98 æ¬¡è¿­ä»£è€—æ—¶åªæœ‰ 3msï¼š ç¬¬ 99 æ¬¡è¿­ä»£ï¼Œè€—æ—¶ 631msï¼š ï¼ˆæ³¨æ„åœ¨ç¬¬ 98 æ¬¡è¿­ä»£æ—¶ï¼Œcid=621 osrï¼Œåˆ°ç¬¬ 99 æ¬¡è¿­ä»£æ—¶ï¼Œcid=624ï¼‰ åœ¨ä¸¤æ¬¡è¿­ä»£ç›´æ¥ï¼Œæ€»å…±æ‰“å°äº† 10ä¸‡æ¬¡(102086-2086=100000) deoptimization æ—¥å¿—ï¼Œè¿™æ­£å¥½æ˜¯æ–¹æ³• hotMethodWrapper å†…éƒ¨å¾ªç¯çš„æ¬¡æ•°ï¼š\n1 2 3 4 5 6 7 static void hotMethodWrapper(int iteration) { int count = 100_000; for (int i = 0; i \u0026lt; count; i++) { hotMethod(iteration); } } ","date":"2023-09-23T14:14:52+08:00","permalink":"https://zhumengzhu.github.io/2023/09/root-cause-jvm-deoptimization-storm/","title":"JIT deoptimization é£æš´å¯¼è‡´ CPU ä½¿ç”¨ç‡é£™å‡"},{"content":"èƒŒæ™¯ staging ç¯å¢ƒï¼ŒæŸä¸ªè½¦è”ç½‘æœåŠ¡å†…å­˜å‡ºç°äº†å†…å­˜æ³„éœ²ï¼Œç›¸å…³åŒå­¦åœ¨ 06-14 åŠ 06-15 ä¸¤å¤©åˆ†åˆ«é‡‡é›†äº†ä¸¤ä¸ª dump æ–‡ä»¶ï¼Œä»¥ä¸‹ç®€å•è®°å½•åˆ†æè¿‡ç¨‹ã€‚\nå†…å­˜æ³„éœ²æœ€å¸¸ç”¨çš„æ’æŸ¥å·¥å…·æ˜¯ Eclipse Memory Analyzer (MAT)ï¼Œä½¿ç”¨ MAT æ‰“å¼€ä¸¤ä¸ª dump æ–‡ä»¶ã€‚\né¦–å…ˆçœ‹ Leak Suspects ç–‘ç‚¹ä¸€ï¼šJarFile org.springframework.boot.loader.jar.JarFile æ˜¯ Spring Boot çš„ç±»åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½ jar åŒ…ã€‚\nçŒœæµ‹æ­¤é—®é¢˜ä¸ Druid issue-3808 ç±»ä¼¼ï¼š\næ‰€æœ‰ jar åŒ…è¢«åŠ è½½çš„æ¬¡æ•°å‡ ä¹ç›¸åŒï¼› å†…å­˜ dump ä¸­ç›¸å…³å¯¹è±¡çš„æ•°é‡åªæœ‰å‡ åƒä¸ªï¼Œå’Œè¯·æ±‚é‡æ— å…³ï¼Œæ›´åƒæ˜¯æŸäº›å®šæ—¶ä»»åŠ¡åœ¨åšç±»åŠ è½½ï¼š 06-14 çš„ dump ä¸­åŠ è½½æ¬¡æ•°çº¦ä¸º 3250ï¼› 06-15 çš„ dump ä¸­åŠ è½½æ¬¡æ•°çº¦ä¸º 1260ï¼› å¯ä»¥é€šè¿‡å‡çº§æˆ–é™çº§ mysql-connector-java ç‰ˆæœ¬è¿›è¡ŒéªŒè¯ã€‚\nç–‘ç‚¹äºŒï¼šLockPubSub org.redisson.pubsub.LockPubSub æ˜¯ Redisson çš„åˆ†å¸ƒå¼é”å®ç°ï¼Œç”¨äºåˆ†å¸ƒå¼é”çš„è®¢é˜…å’Œæ¶ˆæ¯é€šçŸ¥ï¼šåŠ é”å¯¹è±¡å¦‚æœå·²ç»è¢«é”å®šéœ€è¦ç­‰å¾…çš„æ—¶å€™ï¼Œé€šè¿‡ pubsub è®¢é˜…æ¶ˆæ¯æ³¨å†Œä¸€ä¸ª listener æ¥ç­‰å¾…é”èµ„æºã€‚\nåˆ†æ 06-14 çš„å†…å­˜ dumpï¼Œå‘ç° key 7e5axxxc00:gateway:xx:zz:msg:task:lock:c53fxxxaa13a çš„ listeners è¾¾åˆ° 33206 ä¸ªï¼Œå†…å­˜å ç”¨è¾¾åˆ° 1.32 GBã€‚\næ­¤é—®é¢˜ä¸ redisson-issues-3577æœ‰äº›ç›¸ä¼¼ï¼Œä½†æˆ‘åœ¨æ—¥å¿—ä¸­æ²¡æœ‰æ‰¾åˆ°è¿™ä¸ªæœåŠ¡é”çš„ timeout æ—¥å¿—ï¼ˆå¯èƒ½å› ä¸ºä¸šåŠ¡ä»£ç æ²¡æ‰“å°ï¼‰ï¼Œè€Œåªæœ‰è·å–é”å¤±è´¥çš„æ—¥å¿—ã€‚\nå¦å¤–ï¼Œä¸šåŠ¡æ—¥å¿—ä¸­åªæœ‰é‡Šæ”¾é”çš„æ—¥å¿—ï¼Œè€Œæ²¡æœ‰åŠ é”çš„æ—¥å¿—(ä¹Ÿå¯èƒ½å› ä¸ºä¸šåŠ¡ä»£ç æ²¡æ‰“å°)ã€‚ è¿›ä¸€æ­¥åˆ†æ 1ã€å¯¹å†…å­˜æ³„éœ²éƒ¨åˆ†çš„ char æ•°ç»„è¿›è¡Œèšåˆçš„ç»“æœï¼ˆ2.12 GB çš„å†…å­˜æ³„éœ²ï¼Œæ—¥å¿—ä¿¡æ¯ 1.66GBï¼Œå æ¯”æ¥è¿‘ 80%ï¼‰ï¼š 2ã€å…¶ä¸­ä¸€ä¸ª char æ•°ç»„åˆ° gc roots çš„è·¯å¾„ï¼š è¿™ä¹Ÿæ˜¯å†…å­˜æ³„éœ²çš„è·¯å¾„ï¼šOpenTelemetry åœ¨åšé“¾è·¯è¿½è¸ªæ—¶ï¼Œä¼šå°†ä¸€æ¬¡ gRPCã€HTTP è°ƒç”¨æˆ– MQ æ¶ˆè´¹è¿‡ç¨‹ä¸­çš„ Metrics ä»¥åŠæ—¥å¿—ä¿¡æ¯éƒ½æ”¾åˆ°å®ƒçš„ Context å¯¹è±¡ä¸­ï¼Œè¿™æ¬¡è°ƒç”¨æˆ–æ¶ˆè´¹ä¸ç»“æŸï¼Œè¿™äº›å†…å­˜å°±ä¼šè¢«å¼•ç”¨è€Œé‡Šæ”¾ï¼›ä¸šåŠ¡ä½¿ç”¨åˆ†å¸ƒå¼é”çš„æ–¹å¼å¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œå¯¼è‡´å¾ˆå¤šè¯·æ±‚æ— æ³•ç»“æŸï¼Œå¤§é‡å¯¹è±¡å­˜æ´»æ— æ³•é‡Šæ”¾ã€‚\n3ã€ä»¥ä¸‹ä¸ºè¯¥æœåŠ¡æ‰“å°æ—¥å¿—çš„é¢‘ç‡ç›‘æ§\u0026mdash;-æ¯åˆ†é’Ÿå‡ åƒæ¡æ—¥å¿—ã€‚ 4ã€å¦å¤–é€šè¿‡Kibana æŸ¥è¯¢å‘ç°ï¼Œæœ‰å¾ˆå¤šåŠ¨è¾„å‡ å KB çš„ä¸šåŠ¡æ—¥å¿—ï¼ˆæ•æ„Ÿæ•°æ®å°±ä¸è´´å›¾äº†ï¼‰ã€‚ 5ã€æœåŠ¡çš„ GC ä¿¡æ¯ ç»¼åˆä¸Šè¿°ä¿¡æ¯ï¼Œå¯ä»¥ç¡®å®šæœåŠ¡å†…å­˜æ³„éœ²ï¼Œé«˜æ¦‚ç‡æ˜¯å¤§æ—¥å¿—å¯¼è‡´çš„ã€‚\nè§£å†³æ–¹æ³• å‡çº§æˆ–é™çº§ mysql-connector-java ç‰ˆæœ¬ é¿å…å¤§æ—¥å¿— å‚è€ƒèµ„æ–™ Redisåˆ†å¸ƒå¼é”-è¿™ä¸€ç¯‡å…¨äº†è§£(Redissionå®ç°åˆ†å¸ƒå¼é”å®Œç¾æ–¹æ¡ˆ) https://github.com/redisson/redisson/issues/4216 https://github.com/redisson/redisson/issues/4294 ","date":"2023-07-17T11:46:30+08:00","permalink":"https://zhumengzhu.github.io/2023/07/memory-leak-issue-in-a-service/","title":"æœåŠ¡å†…å­˜æ³„éœ²é—®é¢˜æ’æŸ¥è®°å½•"},{"content":"Q1ã€JDK å’Œ JRE çš„åŒºåˆ« ç­”ï¼šJDK æ˜¯ JRE çš„çˆ¶é›†ï¼Œæˆ‘ä»¬ POD ä¸­éœ€è¦å®‰è£… JDKï¼Œä»¥ä¾¿èƒ½è¿è¡Œä¸€äº›è¯Šæ–­å·¥å…·ã€‚\nJDK(Java Development Kitï¼ŒJava å¼€å‘å·¥å…·åŒ…) ï¼Œæ˜¯æ•´ä¸ªJAVAçš„æ ¸å¿ƒï¼ŒåŒ…æ‹¬äº†Javaè¿è¡Œç¯å¢ƒJREï¼ˆJava Runtime Envirnmentï¼‰ï¼Œä¸€å †Javaå·¥å…·ï¼ˆjavac/java/jdbç­‰ï¼‰å’ŒJavaåŸºç¡€çš„ç±»åº“ï¼‰ï¼ŒåŒ…å«JVMæ ‡å‡†å®ç°åŠJavaæ ¸å¿ƒç±»åº“ã€‚ JRE(Java Runtime Environment Java è¿è¡Œç¯å¢ƒ) ï¼Œæ˜¯ JDK çš„å­é›†ï¼Œä¹Ÿå°±æ˜¯åŒ…æ‹¬ JRE æ‰€æœ‰å†…å®¹ï¼Œä»¥åŠå¼€å‘åº”ç”¨ç¨‹åºæ‰€éœ€çš„ç¼–è¯‘å™¨å’Œè°ƒè¯•å™¨ç­‰å·¥å…·ã€‚ è§ï¼šhttps://docs.oracle.com/javase/8/docs/ Q2ã€Oracle JDK ç©¶ç«Ÿä»å“ªä¸ªç‰ˆæœ¬å¼€å§‹æ”¶è´¹ï¼Ÿ ç­”ï¼šjdk8u201 å’Œ jdk8u202 æ˜¯ orcale jdk8 æœ€åçš„å…è´¹ç‰ˆæœ¬ï¼Œä» jdk8u211 å’Œ jdk8u212 å¼€å§‹æ”¶è´¹ã€‚å‚è€ƒï¼šhttps://www.cnblogs.com/xuruiming/p/12881503.html\nå¦‚æœä½¿ç”¨ Orcale JDKï¼Œå»ºè®® jdk8u201: Q3ã€å¦‚ä½•ä¸‹è½½ Orcale JDK 8u201? ç­”ï¼šä» Oracle å®˜ç½‘ä¸‹è½½ï¼šhttps://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html\nQ4ã€Oracle JDK8u å’Œ OpenJDK8u æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ ç­”ï¼šæœ€ä¸»è¦çš„æ˜¯æˆæƒåè®®ä¸åŒã€‚Orcale çš„é«˜ç‰ˆæœ¬å•†ç”¨æ—¶æ”¶è´¹ï¼ŒOpenJDK åˆ™å®Œå…¨å…è´¹ã€‚\nå…¶æ¬¡è¿˜æœ‰OpenJDKæºä»£ç ä¸å®Œæ•´ã€éƒ¨åˆ†æºä»£ç ç”¨å¼€æºä»£ç æ›¿æ¢ã€OpenJDKåªåŒ…å«æœ€ç²¾ç®€çš„JDKç­‰é—®é¢˜ï¼Œä½†ä¸€èˆ¬æ¥è¯´ï¼Œè¿™äº›å½±å“å¯ä»¥å¿½ç•¥ã€‚\nQ5ã€JDK8 çš„æ”¯æŒåˆ°ä»€ä¹ˆæ—¶å€™ç»“æŸï¼Ÿ ç­”ï¼š2030å¹´12æœˆ31æ—¥ï¼Œhttps://endoflife.date/java Q6ã€OpenJDK æ”¯æŒ Java Flight Recorder å—ï¼Ÿ ç­”ï¼šæ”¯æŒï¼Œè§ï¼šä½å»¶è¿Ÿ Profile å·¥å…· Flight Recorder è¢«ç§»æ¤åˆ° Java 8ã€‚\nå¼€å¯æ–¹æ³•ï¼š\n1 -XX:+UnlockCommercialFeatures -XX:+FlightRecorder Q7ã€OpenJDK8 ä¸­çš„ Java Flight Recorder æ˜¯å•†ç”¨ç‰¹æ€§å—ï¼Ÿ ç­”ï¼šä¸æ˜¯ï¼Œè¯¥ç‰¹æ€§åœ¨ OpenJDK æ˜¯å®Œå…¨å…è´¹çš„ï¼Œè§ï¼šGet started with JDK Flight Recorder in OpenJDK 8uã€‚\nä½†è¦æ³¨æ„ï¼šOracle çš„ JDK11 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ JFR æ˜¯å•†ç”¨ç‰¹æ€§ï¼Œæ‰€ä»¥éœ€è¦åŠ  -XX:+UnlockCommercialFeatures å¼€å¯ï¼›åŒæ—¶ä¸ºäº†å…¼å®¹æ€§ï¼Œä½¿ç”¨ OpenJDK ä¹Ÿè¦æ·»åŠ è¯¥å‚æ•°ã€‚\nQ8ã€OpenJDK8 æ”¯æŒè¯†åˆ« Docker å®¹å™¨çš„èµ„æºé™åˆ¶å—ï¼Ÿ ç­”ï¼šå–å†³äºç‰ˆæœ¬ã€‚\næ¯”å¦‚ï¼šä» jdk8u191 å¼€å§‹å®Œæ•´æ”¯æŒï¼Œä¸éœ€è¦éœ€è¦ä½¿ç”¨ -XX:ParallelGCThreads=4 -XX:ConcGCThreads=1 -XX:G1ConcRefinementThreads=5 -XX:ActiveProcessorCount=8 è¿™äº›å‚æ•°æŒ‡å®š GC çº¿ç¨‹æ•°ã€‚\nè¯¦è§ï¼šJVM å¯¹å®¹å™¨åŒ–æ”¯æŒçš„å‚æ•°ï¼ˆå¼ºçƒˆå»ºè®®ï¼Œå‚è€ƒè¯¥æ–‡ç« åœ¨ docker ä¸­è¿›è¡ŒéªŒè¯ï¼‰ã€‚\nå°äº jdk8u131 ç‰ˆæœ¬ä¸æ”¯æŒï¼› å¤§äºç­‰äº jdk8u131ï¼Œå°äº jdk8u191 å®éªŒæ€§æ”¯æŒï¼› å¤§äºç­‰äº jdk8u191 å¼€å§‹å®Œæ•´çš„æ”¯æŒï¼› Q9ã€å¦‚ä½•ä¸‹è½½ OpenJDK8ï¼Ÿ ç­”ï¼š å¾ˆå¤šï¼Œè¿™é‡Œç»™å‡ºä¸¤ä¸ªï¼šAzul Zulu Downloadsï¼ŒOpenLogic OpenJDK Downloads ã€‚\nç‰¹åˆ«åœ°ï¼Œå¦‚æœæ˜¯åœ¨ä¸ªäººå¼€å‘ç”µè„‘ï¼Œåˆ™å¼ºçƒˆå»ºè®®ä½¿ç”¨ SDKMAN ï¼Œå®ƒæ”¯æŒå¹¶è¡Œç‰ˆæœ¬ç®¡ç†ï¼ŒJava ç”Ÿæ€çš„å„ç§è½¯ä»¶åŒ…ï¼ŒåŒ…æ‹¬ JDKã€ã€Kotlinã€Groovyã€Scalaã€Mavenã€Gradle ç­‰ç­‰ã€‚\n","date":"2023-07-11T12:35:11+08:00","permalink":"https://zhumengzhu.github.io/2023/07/oracle-jdk-vs-openjdk-selection-guide/","title":"Oracle JDK å’Œ OpenJDK å¦‚ä½•é€‰æ‹©ï¼Ÿ"},{"content":"èƒŒæ™¯ æŸ Java æœåŠ¡çš„è€å¹´ä»£å†…å­˜å ç”¨æŒç»­é«˜ä½ï¼Œæ€€ç–‘å¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼çš„é£é™©ã€‚ æ’æŸ¥è®°å½• åˆ†æå †å†…å­˜ dump dump\u0026amp;\u0026amp;åˆ†æ jmap -dump:[live],format=b,file=\u0026lt;file-path\u0026gt; \u0026lt;pid\u0026gt; live: if set, it only prints objects which have active references and discards the ones that are ready to be garbage collected. This parameter is optional. format=b: specifies that the dump file will be in binary format. If not set, the result is the same. file: the file where the dump will be written to pid: id of the Java process 1ã€ä¸è¿›è¡Œ FullGC ç›´æ¥ dump å†…å­˜\n1 2 3 jmap -dump:format=b,file=dump.hprof 1 tar -cvzf dump.zip dump.hprof # å‹ç¼©ï¼Œä»¥æ–¹ä¾¿ä¸‹è½½ Leak Suspects æ˜¾ç¤ºä¸»è¦ç–‘ç‚¹å…¨éƒ¨ä¸ com.ecwid.consul.v1.Response æœ‰å…³ã€‚ 2ã€å¼ºåˆ¶ FullGC ç„¶å dump å†…å­˜ ä¾æ¬¡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè·å–å†…å­˜ dump ç„¶åè¿›è¡Œå‹ç¼©ï¼ˆæé«˜æ–‡ä»¶ä¸‹è½½é€Ÿåº¦ï¼‰ï¼Œç„¶åé€šè¿‡æœåŠ¡æ²»ç†å¹³å°-æ–‡ä»¶ä¸‹è½½åŠŸèƒ½ä¸‹è½½åˆ°æœ¬åœ°ï¼Œä½¿ç”¨ eclipse mat æˆ–è€… VisualVM è¿›è¡Œåˆ†æã€‚\n1 2 3 jmap -dump:live,format=b,file=dump.hprof 1 tar -cvzf dump.zip dump.hprof ç»“è®º Old Gen è™½ç„¶ä¼šè¾¾åˆ°å¾ˆé«˜å æ¯”ï¼Œä½†æ€»æ˜¯èƒ½æœ€ç»ˆä¸‹é™åˆ°ä½ä½ï¼Œè¯´æ˜ä¸å­˜åœ¨ä¸¥æ ¼æ„ä¹‰ä¸Šçš„å†…å­˜æ³„éœ²ï¼› æ ¹æ® Leak Suspects æŠ¥å‘Šï¼ŒOld Gen å ç”¨é«˜ä¸»è¦æ˜¯ç±» com.ecwid.consul.v1.Response å¯¼è‡´ï¼Œå®ƒä»£è¡¨ä» consul æ‹‰å–çš„æ•°æ®ï¼ŒåŒ…æ‹¬ä¸¤ç±»ï¼› CustomConfigWatchï¼ˆjavakitï¼‰è·å–çš„æ•°æ®å¤§å°çº¦ 2MBï¼› ConsulCatalogWatchï¼ˆSpringBootï¼‰è·å–çš„æ•°æ®å¤§å°çº¦ 170KBï¼› è¿™äº›æ•°æ®ä¼šå¯¼è‡´äº§ç”Ÿ Humongous å¯¹è±¡ï¼šæ¯”å¦‚ç½‘ç»œå±‚é¢æ¥æ”¶è¿™äº›æ•°æ®æ—¶éœ€è¦åˆ†é…å¤§çš„ byte æ•°ç»„ï¼Œè½¬ä¸º HttpResponse æ—¶åˆ†é… char æ•°ç»„ï¼ˆCharArrayBufferï¼‰ï¼› æ ¹æ® Dominator Treeï¼Œé™¤äº† consul æ•°æ®ï¼Œç›‘æ§æ•°æ®å å†…å­˜åŒæ ·å¾ˆé«˜ åˆ†æ GC æ—¥å¿— ç»“è®º Old Gen å æ¯”é«˜å¹¶ä¸æ˜¯å› ä¸ºé•¿ç”Ÿå‘½å‘¨æœŸå¯¹è±¡æ™‹å‡ï¼Œè€Œæ˜¯å¤§é‡åˆ†é… Humongous å¯¹è±¡ï¼ˆç®€ç§° H-Objï¼‰\u0026mdash;-å› ä¸ºæ ¹æ®ç›‘æ§ï¼Œåœ¨æ²¡æœ‰ GC æ—¶ï¼ŒOld Gen çš„å´ä¸€ç›´åœ¨å¢é•¿ï¼› æ¯å½“è¿›è¡Œ H-obj åˆ†é…æ—¶ï¼Œå°±ä¼šè§¦å‘ Mixed GC çš„å¹¶å‘æ ‡è®°å¾ªç¯ï¼Œè¿›è€Œå¯¼è‡´ä¸€æ¬¡ YGCï¼ˆinital markï¼‰ï¼Œå›æ”¶æ­»äº¡çš„ H-Objï¼›ä½†å¦‚æœå½“å‰å¤„äº Mixed GC é˜¶æ®µï¼Œåˆ™ä¸ä¼šå†è§¦å‘ä¸€æ¬¡ï¼› ç”±äº H-obj çš„åˆ†é…é¢‘ç‡éå¸¸é«˜ï¼Œå› æ­¤å®é™…ä¼šä¸€ç›´å¤„äº Mixed GC é˜¶æ®µï¼ˆä¸­é—´å¯ä»¥å¤¹æ‚å¤šæ¬¡ YGCï¼‰ï¼› åœ¨ YGC ä»¥åŠ Mixed GC çš„ cleanup é˜¶æ®µï¼ŒOld Gen ä¼šå¤§å¹…ä¸‹é™ï¼Œå› ä¸ºæ­¤é˜¶æ®µä¼šå¯¹ H-Obj å¯¹è±¡è¿›è¡Œæ¸…ç†ï¼› è™½ç„¶å¼ºåˆ¶æŒ‡å®š -Xmn1gï¼Œä½†å®é™… Young åŒºè¿˜æ˜¯ä¼šç¼©å°ï¼› dev \u0026amp; test ç¯å¢ƒï¼Œåœ¨å‡ºç°å¦‚ä¸‹ GC æ—¥å¿—æ—¶ï¼ŒOld Gen åªæœ‰å°å¹…ä¸‹é™ï¼š 1 2 3 4 5 6 - 2023-06-30T07:10:32.869+0000: 3600.316: [GC pause (G1 Humongous Allocation) (mixed) 3600.316: [G1Ergonomics (CSet Construction) start choosing CSet, _pending_cards: 26151, predicted base time: 42.80 ms, remaining time: 157.20 ms, target pause time: 200.00 ms] - 3600.316: [G1Ergonomics (CSet Construction) add young regions to CSet, eden: 384 regions, survivors: 0 regions, predicted young region time: 3.51 ms] - 3600.316: [G1Ergonomics (CSet Construction) finish adding old regions to CSet, reason: predicted time is too high, predicted time: 1.00 ms, remaining time: 0.60 ms, old: 153 regions, min: 83 regions] - 3600.316: [G1Ergonomics (CSet Construction) finish choosing CSet, eden: 384 regions, survivors: 0 regions, old: 153 regions, predicted pause time: 199.40 ms, target pause time: 200.00 ms] - G1 é¢„æµ‹å›æ”¶ Old Gen æ—¶åªå‰©ä½™ 0.6 msï¼Œå› æ­¤è¿›è¡Œå›æ”¶æ—¶åªé€‰å–äº†å°‘é‡çš„ Old Genï¼Œä¸”æ²¡æœ‰å›æ”¶ Humongous å¯¹è±¡ï¼› - æ ¹æ® jdk8u çš„æºç ï¼Œæ­¤é¢„æµ‹ä¼¼ä¹åŸºäºå¯¹å…ˆå‰è‹¥å¹²æ¬¡å›æ”¶æ—¶é—´çš„ç»Ÿè®¡ï¼› æ•´ä½“ç»“è®º Old Gen çš„å¿«é€Ÿä¸Šå‡ä¸»è¦æ˜¯ç”±äºå¤§é‡çš„ H-obj åˆ†é…ï¼Œå¤§å¯¹è±¡çš„æ¥æºæŒ‰é¢‘ç‡æ’åºï¼Œç›®å‰ä¸»è¦æœ‰ 3 ä¸ª: ConsulCatalogWatchï¼ˆSpringBootï¼‰è·å–çš„æ•°æ®å¤§å°çº¦ 170KBï¼Œçº¦æ¯ 2 ç§’ä¸€æ¬¡ï¼› CustomConfigWatchï¼ˆjavakitï¼‰è·å–çš„æ•°æ®å¤§å°çº¦ 2MBï¼Œçº¦æ¯ 27 ç§’ä¸€æ¬¡ï¼› Prometheus\u0026amp;Metrics ç›‘æ§æ•°æ®ï¼Œå°äºç­‰äº 1.3 MBï¼Œçº¦ 1 åˆ†é’Ÿä¸€æ¬¡ï¼Ÿï¼Ÿ H-obj çš„åˆ†é…é€Ÿç‡ä¸å¹´è½»ä»£å¯¹è±¡çš„å¢é•¿é€Ÿç‡å¤§çº¦æˆæ­£æ¯”ï¼Œä¸”å¾€å¾€å°äºå¹´è½»ä»£çš„å¢é•¿é€Ÿç‡ï¼› ä½†å­˜åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œåœ¨ mixed å›æ”¶é˜¶æ®µï¼Œç”±äº Old Gen ä¸­å¯å›æ”¶çš„ region å¤§äº 5% é˜ˆå€¼ï¼Œéœ€è¦è§¦å‘æ··åˆå›æ”¶ï¼›ä¸”æ ¹æ®é¢„æµ‹ï¼Œå¯ä»¥ç•™ç»™ Old Gen çš„å›æ”¶æ—¶é—´éå¸¸çŸ­ï¼ˆä¸è¶³ 1msï¼‰ï¼Œå¯¼è‡´é€‰æ‹©é€‰æ‹© CSet æ—¶ Old Gen region ç‰¹åˆ«å°‘ï¼Œå‰©ä½™ region ä»ç„¶å¤§äº 5%é˜ˆå€¼ï¼Œå› æ­¤ mixed é˜¶æ®µå°†æŒç»­ï¼Œç„¶åæ¶æ€§å¾ªç¯ï¼ˆæœ€å¤š 8 æ¬¡ mixed gcï¼‰ï¼›ä¸­é—´å¦‚æœå‡ºå‘ YGCï¼Œåˆ™ humongous å¯¹è±¡ä¼šè¢«æ¸…é™¤ï¼ŒOld Gen å ç”¨ä¼šå¤§å¹…ä¸‹é™ï¼ˆçœŸæ­£çš„è€å¹´ä»£å¯¹è±¡å¹¶ä¸ä¼šæ¸…é™¤ï¼‰ï¼› é—®é¢˜åœ¨äºé¢„æµ‹æ—¶é—´ä¸ºä»€ä¹ˆä¼šè¿™ä¹ˆçŸ­ï¼Ÿ ä¼˜åŒ–æ–¹æ¡ˆ ä¼˜åŒ– PrometheusScrapeEndpoint ç›¸å…³è®¨è®ºï¼š\nStringHttpMessageConverter may trigger humongous allocations (G1GC) #25645 Add support for streaming responses from actuator web endpoints #21308 æ€è·¯ï¼Ÿ\nä½¿ç”¨ä¸€ä¸ª char[] å†…å­˜æ± ï¼Œscrape æ—¶ä»å†…å­˜æ± è·å–ä¸€ä¸ªè¶³å¤Ÿå¤§çš„ char æ•°ç»„ç”¨äºç”Ÿæˆæ•°æ®ï¼Œå®Œæˆåï¼Œå°†æ•°ç»„å½’è¿˜å†…å­˜æ± ï¼Ÿ å‡å°‘ tag æ•°é‡ï¼Ÿ ","date":"2023-06-26T13:30:37+08:00","permalink":"https://zhumengzhu.github.io/2023/06/java-service-old-generation-memory-anomaly-large-object-impact-and-solutions/","title":"Java æœåŠ¡è€å¹´ä»£å†…å­˜å¼‚å¸¸ï¼šå¤§å¯¹è±¡çš„å½±å“ä¸è§£å†³æ–¹æ¡ˆ"},{"content":"å‚æ•°å»ºè®® è¿™äº›å»ºè®®åŸºäºä»¥ä¸‹å‰æï¼š\næœåŠ¡å™¨ CPU æ”¯æŒè¶…çº¿ç¨‹ï¼Œå³ä¸€ä¸ªæ ¸å¯ä»¥å½“æˆä¸¤ä¸ªæ ¸ç”¨ï¼Œå¦åˆ™ï¼ŒGC çº¿ç¨‹ç›¸å…³å‚æ•°å€¼åº”è¯¥å‡åŠï¼› å¦‚æœ JDK ç‰ˆæœ¬å°äº 1.8.0_191-b12(å¦‚JDK 1.8.0_151)ï¼Œåˆ™éœ€è¦è®¾ç½® -XX:ParallelGCThreads=n, -XX:ConcGCThreads=n, -XX:G1ConcRefinementThreads=n ä¸‰ä¸ªå‚æ•°ï¼› å¦‚æœ JDK ç‰ˆæœ¬å‡çº§åˆ° 1.8.0_191-b12 åŠä»¥ä¸Šï¼Œåˆ™æœ€å¥½ä¸è¦è®¾ç½®ä¸Šè¿°ä¸‰ä¸ªå‚æ•°ï¼Œæ”¹ä¸ºè®¾ç½® -XX:+UnlockExperimentalVMOptions -XX:ActiveProcessorCount=nï¼Œn å–å®¹å™¨æ ¸æ•°ï¼› ç»Ÿä¸€è®¾ç½®çš„å‚æ•° -XX:+UseG1GC ä½¿ç”¨åƒåœ¾ä¼˜å…ˆ(G1)æ”¶é›†å™¨ -XX:+PrintFlagsFinal æ‰“å°æ‰€æœ‰å‚æ•°çš„æœ€ç»ˆå€¼ï¼ˆå‚è€ƒï¼šJava -XX:+PrintFlagsFinalå‘½ä»¤è¡Œå‚æ•°è¯¦è§£ï¼‰ -XX:+PrintCommandLineFlags æ˜¯æ‰“å°é‚£äº›è¢«æ–°å€¼è¦†ç›–çš„é¡¹ -XX:+PrintStringTableStatistics åœ¨ JVM è¿›ç¨‹é€€å‡ºæ—¶ä¼šè¾“å‡º SymbolTable ç»Ÿè®¡å’Œ StringTable ç»Ÿè®¡ï¼ˆå‚è€ƒï¼šèŠèŠjvmçš„StringTableåŠSymbolTableï¼‰ -XX:+PrintGC æ‰“å°GCæ—¥å¿— -XX:+PrintGCDetails æ‰“å°è¯¦ç»†çš„GCæ—¥å¿—ï¼Œè¿˜ä¼šåœ¨é€€å‡ºå‰æ‰“å°å †çš„è¯¦ç»†ä¿¡æ¯ -XX:+PrintGCDateStamps æ‰“å°CGå‘ç”Ÿçš„æ—¥æœŸæ—¶é—´ -XX:+PrintGCTimeStamps æ‰“å°CGå‘ç”Ÿçš„ç›¸å¯¹æ—¶é—´æˆ³ -XX:+PrintHeapAtGC æ¯æ¬¡GCå‰åæ‰“å°å †ä¿¡æ¯ -XX:+PrintTenuringDistribution YGC æ—¶ï¼Œæ‰“å°å‡ºå¹¸å­˜åŒºä¸­å¯¹è±¡çš„å¹´é¾„åˆ†å¸ƒ -XX:+PrintAdaptiveSizePolicy æ‰“å°åˆ†ä»£å¤§å°è°ƒæ•´çš„ä¿¡æ¯ -XX:+PrintGCApplicationStoppedTime æ‰“å°åº”ç”¨ç”±äºGCè€Œäº§ç”Ÿçš„åœé¡¿æ—¶é—´ -XX:+PrintGCApplicationConcurrentTime æ‰“å°åº”ç”¨ç¨‹åºçš„æ‰§è¡Œæ—¶é—´ -XX:+PrintReferenceGC æ‰“å°è½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¼•ç”¨å’ŒFinallizeé˜Ÿåˆ—å¤„ç†æƒ…å†µ -XX:ParallelRefProcEnabled å¯ç”¨å¹¶è¡Œå¼•ç”¨å¤„ç† -XX:-OmitStackTraceInFastThrow ç¦ç”¨ FastThrow ä¼˜åŒ–ã€‚å¦‚æœå¼€å¯ï¼Œä¼šå¯¼è‡´æŠ›å‡ºå¼‚å¸¸æ—¶æ²¡æœ‰å †æ ˆä¿¡æ¯ï¼Œä¸åˆ©äºæ’æŸ¥é—®é¢˜ã€‚ -Xloggc:/app/logs/gc_$HOSTNAME.log GC æ—¥å¿—è·¯å¾„ -XX:GCLogFileSize=30M GC æ—¥å¿—æ–‡ä»¶å¤§å° -XX:+UseGCLogFileRotation å¯ç”¨ GC æ—¥å¿—æ–‡ä»¶æ»šåŠ¨ç­–ç•¥ï¼Œéœ€è¦å…ˆè®¾ç½® -Xloggc -XX:NumberOfGCLogFiles=10 è®¾ç½®æ»šåŠ¨æ—¥å¿—æ—¶çš„æ–‡ä»¶æ•° -XX:+HeapDumpOnOutOfMemoryError å½“å‘ç”Ÿ OOM æ—¶ï¼Œè‡ªåŠ¨ç”Ÿæˆ dump æ–‡ä»¶ -XX:HeapDumpPath=\u0026quot;/app/logs/java_%p_$HOSTNAME.hprof\u0026quot; æŒ‡å®š dump æ–‡ä»¶çš„è·¯å¾„ -XX:ErrorFile=/app/logs/hs_err_%p_$HOSTNAME.log é”™è¯¯å‘ç”Ÿæ—¶ï¼Œé”™è¯¯æ•°æ®çš„å­˜å‚¨è·¯å¾„ -Djava.security.egd=file:/dev/./urandom åŠ å¿«éšæœºæ•°äº§ç”Ÿè¿‡ç¨‹ å…è®¸è°ƒæ•´çš„å‚æ•° -Xms2g -Xms4g total_memory / 2 æœ€å°å †å†…å­˜ï¼ŒJVM åˆå§‹åŒ–æ—¶å°±ä¼šåˆ†é…çš„å †å†…å­˜å¤§å°ã€‚ -Xmx2g -Xms4g total_memory / 2 æœ€å¤§å †å†…å­˜ -XX:MaxDirectMemorySize=512m -XX:MaxDirectMemorySize=512m - è®¾ç½®æœ€å¤§ç›´æ¥å†…å­˜ï¼ˆå‚è€ƒ JVMæºç åˆ†æä¹‹å †å¤–å†…å­˜å®Œå…¨è§£è¯»ï¼‰ -XX:MaxMetaspaceSize=512m -XX:MaxMetaspaceSize=512m - è®¾ç½®æœ€å¤§å…ƒç©ºé—´ï¼ˆå‚è€ƒJVMæºç åˆ†æä¹‹Metaspaceè§£å¯†ï¼‰ -XX:MaxGCPauseMillis=200 -XX:MaxGCPauseMillis=200 - è®¾ç½®æœ€å¤§GCæš‚åœæ—¶é—´çš„ç›®æ ‡ã€‚è¿™æ˜¯ä¸€ä¸ªè½¯ç›®æ ‡ï¼ŒJVMå°†å°½æœ€å¤§åŠªåŠ›å®ç°å®ƒã€‚é»˜è®¤ 200msã€‚ -XX:ParallelGCThreads=4 -XX:ParallelGCThreads=8 - è®¾ç½®åƒåœ¾å›æ”¶å™¨å¹¶è¡Œé˜¶æ®µä½¿ç”¨çš„çº¿ç¨‹æ•°ã€‚è®¡ç®—å…¬å¼è§JVMè°ƒä¼˜ç³»åˆ—: é»˜è®¤GCçº¿ç¨‹æ•°çš„è®¡ç®—å…¬å¼ -XX:ConcGCThreads=1 -XX:ConcGCThreads=2 - è®¾ç½®åƒåœ¾å›æ”¶å™¨å¹¶å‘é˜¶æ®µä½¿ç”¨çš„çº¿ç¨‹æ•° -XX:G1ConcRefinementThreads=5 -XX:G1ConcRefinementThreads=9 ParallelGCThreads+1 è®¾ç½®å¹¶å‘ä¼˜åŒ–çº¿ç¨‹ï¼Œåªä¸“æ³¨æ‰«ææ—¥å¿—ç¼“å†²åŒºè®°å½•çš„å¡ç‰‡æ¥ç»´æŠ¤æ›´æ–° RSet -XX:G1ReservePercent=10 -XX:G1ReservePercent=10 - è®¾ç½®è¦ä¿æŒç©ºé—²çš„é¢„ç•™å†…å­˜çš„ç™¾åˆ†æ¯”ï¼Œä»¥å‡å°‘ç©ºé—´æº¢å‡ºçš„é£é™©ã€‚ é»˜è®¤å€¼æ˜¯10%ã€‚ å½“å¢åŠ æˆ–å‡å°‘è¿™ä¸ªç™¾åˆ†æ¯”æ—¶ï¼Œè¯·ç¡®ä¿å¯¹Javaå †æ€»é‡è¿›è¡Œç›¸åŒçš„è°ƒæ•´ã€‚ -XX:InitiatingHeapOccupancyPercent=45 -XX:InitiatingHeapOccupancyPercent=45 - å¯åŠ¨å¹¶å‘GCå‘¨æœŸçš„(æ•´ä¸ª)å †å ç”¨çš„ç™¾åˆ†æ¯”ã€‚ å®ƒç”±åŸºäºæ•´ä¸ªå †å ç”¨æƒ…å†µè§¦å‘å¹¶å‘GCå‘¨æœŸçš„GCä½¿ç”¨ï¼Œè€Œä¸ä»…ä»…æ˜¯å…¶ä¸­çš„ä¸€ä¸ªä»£(ä¾‹å¦‚G1)ã€‚ å€¼ä¸º0è¡¨ç¤ºâ€œæ‰§è¡Œæ’å®šçš„GCå‘¨æœŸâ€ã€‚ ç¼ºçœå€¼ä¸º45ã€‚ -XX:SoftRefLRUPolicyMSPerMB=1000 -XX:SoftRefLRUPolicyMSPerMB=1000 - æ¯1Mç©ºé—²ç©ºé—´å¯ä¿æŒçš„SoftReferenceå¯¹è±¡ç”Ÿå­˜çš„æ—¶é•¿ï¼ˆå•ä½msï¼‰ï¼ˆå‚è€ƒï¼šä¸€æ¬¡ JVM FullGC çš„æ’æŸ¥è¿‡ç¨‹åŠè§£å†³æ–¹æ¡ˆï¼ï¼‰ ä¸å»ºè®®è®¾ç½®çš„å‚æ•° ä¸è®¾ç½® -XX:+DisableExplicitGCï¼Œè¿™æ ·å…è®¸ä¸šåŠ¡ä½¿ç”¨ System.gc() åœ¨æŸäº›ç‰¹å®šæƒ…å†µä¸‹ä¸»åŠ¨ FullGCï¼› ä¸è¦æŒ‡å®š -Xmn å‚æ•°ï¼Œè®© G1 è‡ªå·±å»è°ƒæ•´ï¼›å¦‚æœè®¾ç½®äº†å¹´è½»ä»£å¤§å°ï¼Œä¼šå¯¼è‡´ G1 æ— æ³•ä½¿ç”¨æš‚åœæ—¶é—´ç›®æ ‡ï¼› å®Œæ•´å‚æ•°ç¤ºä¾‹ ä»¥ä¸‹é’ˆå¯¹ 4C8G æœºå™¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 -Xms4g -Xmx4g -XX:MaxDirectMemorySize=512m -XX:MaxMetaspaceSize=512m -XX:+PrintFlagsFinal -XX:+PrintCommandLineFlags -XX:+PrintStringTableStatistics -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:ParallelGCThreads=8 -XX:ConcGCThreads=2 -XX:G1ConcRefinementThreads=9 -XX:+PrintGC -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps -XX:+PrintHeapAtGC -XX:+PrintTenuringDistribution -XX:+PrintAdaptiveSizePolicy -XX:+PrintGCApplicationStoppedTime -XX:+PrintGCApplicationConcurrentTime -XX:G1ReservePercent=10 -XX:InitiatingHeapOccupancyPercent=45 -XX:SoftRefLRUPolicyMSPerMB=1000 -XX:+PrintReferenceGC -XX:ParallelRefProcEnabled -Xloggc:/app/logs/gc_$HOSTNAME.log -XX:GCLogFileSize=30M -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=\u0026#34;/app/logs/java_%p_$HOSTNAME.hprof\u0026#34; -XX:ErrorFile=/app/logs/hs_err_%p_$HOSTNAME.log -XX:-OmitStackTraceInFastThrow -Djava.security.egd=file:/dev/./urandom å…¶å®ƒ å»ºè®®å‡çº§ JDK è‡³å°‘åˆ° 1.8.0_191-b12 åŠä»¥ä¸Šï¼ŒåŸå› å‚è€ƒ JVMå¦‚ä½•è·å–å½“å‰å®¹å™¨çš„èµ„æºé™åˆ¶ï¼Ÿ å’Œ äº‘åŸç”Ÿæ¶æ„ï¼šå®¹å™¨èµ„æºé™åˆ¶åŠèµ„æºå¯è§æ€§ å‚è€ƒèµ„æ–™ Java HotSpot VM Options 10 Garbage-First Garbage Collector Tuning Collecting and reading G1 garbage collector logs - part 2 JVMæ€§èƒ½â€”â€”JVMè°ƒä¼˜å‚æ•°åˆ—è¡¨ è¯¦è§£ G1 åƒåœ¾æ”¶é›†å™¨ JVMä¹‹G1å›æ”¶å™¨å’Œå¸¸è§å‚æ•°é…ç½® ","date":"2023-06-18T12:18:18+08:00","permalink":"https://zhumengzhu.github.io/2023/06/jvm-parameter-recommendations-and-reasons/","title":"JVM å‚æ•°å»ºè®®åŠç†ç”±"},{"content":"å¼•å­ åœ¨å¯åŠ¨ Java é¡¹æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°è¿™ç§è¯¡å¼‚çš„ç°è±¡ï¼š\nåœ¨æœ¬åœ°å¯ä»¥å¯åŠ¨ï¼Œä½†éƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šå´ä¸èƒ½å¯åŠ¨ï¼› æˆ–è€…ï¼Œåœ¨æœåŠ¡å™¨å¯ä»¥å¯åŠ¨ï¼Œä½†æœ¬åœ°ä¸å¯ä»¥å¯åŠ¨ï¼› æ­¤æ—¶å¦‚æœå»æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼Œå¾€å¾€å¯ä»¥çœ‹åˆ°è¯¸å¦‚ ClassNotFoundExceptionã€NoClassDefFoundError ç­‰å¼‚å¸¸ä¿¡æ¯ï¼Œæ¥ç€å¾ˆå®¹æ˜“å°±ä¼šæƒ³åˆ°å¾ˆå¯èƒ½æ˜¯å‘ç”Ÿäº†ç±»å†²çªã€‚ ç„¶åä½ ä¼šç»“åˆå¼‚å¸¸æ—¥å¿—å³ä¾èµ–å˜æ›´æƒ…å†µï¼Œå®šä½åˆ°å†²çªçš„ç±»åŠå…¶æ‰€åœ¨çš„ jar åŒ…ï¼Œç„¶åç”¨ dependecy-exclude ç­‰æ‰‹æ®µå°†å†²çªè§£å†³æ‰ï¼Œæœ€ç»ˆä½¿å¾—æœåŠ¡å¯ä»¥æ­£å¸¸å¯åŠ¨ã€‚ä¸€èˆ¬æˆ‘ä»¬å¤„ç†é—®é¢˜å°±åˆ°æ­¤ä¸ºæ­¢äº†ã€‚ æœ¬æ–‡è¯•å›¾æ›´è¿‘ä¸€æ­¥ï¼Œæ·±å…¥åˆ†ææœ¬åœ°ä¸è¿œç¨‹æœåŠ¡å™¨è¡Œä¸ºä¸ä¸€è‡´çš„åŸå› ï¼Œå¹¶ç®€å•ä»‹ç»ä¸šç•Œè§£å†³ä¾èµ–å†²çªçš„ä¸€äº›æ–¹æ³•ï¼Œå’Œæ’æŸ¥ç±»å†²çªé—®é¢˜çš„å°æŠ€å·§ã€‚\nèƒŒæ™¯çŸ¥è¯† Java Classpath: æœ¬åœ°å¯åŠ¨çš„ Classpath é¡ºåº æœ¬åœ°ä¸€èˆ¬éƒ½æ˜¯åœ¨ IDEA ä¸­å¯åŠ¨ï¼›IDEA å¯åŠ¨æœåŠ¡æ—¶ï¼Œä¼šåœ¨ Console æ‰“å°å¯åŠ¨å‚æ•°ï¼š é‚£ä¹ˆ IDEA æ˜¯ä»¥æ€æ ·çš„é¡ºåºå°† jar åŒ…æ·»åŠ åˆ° classpath ä¸­å‘¢ï¼Ÿ\nç­”æ¡ˆï¼šæ˜¯æŒ‰ Maven ä¾èµ–è§£æçš„æ–¹å¼è¿›è¡ŒåŠ è½½çš„ã€‚é€šè¿‡æ‰§è¡Œ mvn dependency:list å¯ä»¥çœ‹åˆ° Maven ä¾èµ–è§£æçš„ç»“æœï¼Œè¿™ä¸ªé¡ºåºï¼Œå°±æ˜¯ classpath ä¸­ jar çš„æ·»åŠ é¡ºåºï¼š é€šè¿‡å¯¹æ¯”å¯ä»¥å‘ç°ï¼Œä¸¤è€…é¡ºåºä¸€è‡´ã€‚\nè¿œç¨‹å¯åŠ¨çš„ Classpath é¡ºåº ç™»å½•æœåŠ¡å™¨ï¼Œä½¿ç”¨ ps aux | grep java æŸ¥çœ‹å¯åŠ¨å‚æ•°ï¼Œä¼šå‘ç°ï¼Œè¿œç¨‹æœåŠ¡å™¨æ²¡æœ‰åŠ  -classpath å‚æ•°ï¼ï¼ï¼ç›¸å…³çš„ä¾èµ–åœ¨å“ªé‡Œï¼Ÿï¼Ÿï¼Ÿ å®é™…ä¸Šï¼Œåœ¨æ„å»ºé¡¹ç›®æ—¶ï¼ŒMaven ä¼šå°†æ‰€æœ‰çš„ä¾èµ–éƒ½æ·»åŠ åˆ° xx-server.jar ä¸­çš„ BOOT-INF/lib ç›®å½•ä¸‹ã€‚\nJVM åœ¨å¯åŠ¨æ—¶ï¼Œä¼šæ ¹æ® Jar åŒ…ä¸­çš„å¦ä¸€ä¸ªå…ƒæ•°æ®æ–‡ä»¶\u0026ndash;META-INF/MANIFEST.MFï¼Œæ¥å†³å®šç±»çš„åŠ è½½é¡ºåºã€‚\nMETA-INF/MANIFEST.MF é»˜è®¤æƒ…å†µä¸‹ï¼ŒJVM åœ¨åŠ è½½ç±»çš„é¡ºåºä¾èµ– OS æ—¶ï¼Œå¯¹äº Linux æ¥è¯´ï¼Œæœ€åº•å±‚æ˜¯ opendir å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›çš„é¡ºåºï¼Œåˆä¸æ–‡ä»¶ç³»ç»Ÿæœ‰å…³ã€‚ã€å¯¹äº CentOS 6ï¼Œå®ƒä½¿ç”¨çš„æ˜¯Ext4ï¼Œæ–‡ä»¶é¡ºåºä¸ç›®å½•æ–‡ä»¶çš„å¤§å°æ˜¯å¦è¶…è¿‡ä¸€ä¸ªç£ç›˜å—å’Œæ–‡ä»¶ç³»ç»Ÿè®¡ç®—çš„Hashå€¼æœ‰å…³ã€‚ã€\nç®€å•è¯´ï¼Œå…ˆåŠ è½½å®Œå…¨æ˜¯å“ªä¸ªçœ‹è¿æ°”ï¼è¿œç¨‹æœåŠ¡å™¨çš„ç‰ˆæœ¬ä¸åŒï¼ŒåŠ è½½çš„é¡ºåºå°±å¯èƒ½ä¸ä¸€æ ·ã€‚è¿™å°±æ˜¯æ–‡ç« å¼€å¤´è¯¡å¼‚é—®é¢˜çš„æ ¹æºã€‚\nçœ‹è¿æ°”æ€ä¹ˆè¡Œï¼Ÿï¼\nspring-boot-maven-plugin è¿™ä¸ªæ’ä»¶ä½¿ç”¨äº† The Executable Jar Formatï¼Œæ”¯æŒä¸€ç§ç§°ä¹‹ä¸º Classpath Index çš„ç´¢å¼•æ–‡ä»¶ï¼Œè´Ÿè´£æŒ‡å®š jar è¢«æ·»åŠ åˆ° classpath ä¸­çš„é¡ºåºã€‚å¾ˆæ˜æ˜¾ï¼Œé€šè¿‡è¿™ä¸ªæ’ä»¶å¯ä»¥ä¿è¯ jar çš„æ‰«æé¡ºåºåœ¨ä¸åŒçš„ç¯å¢ƒä¸‹æ˜¯ä¸€è‡´çš„ã€‚å®Œç¾è§£å†³ä¸Šé¢çš„é—®é¢˜ã€‚ å°èŠ‚ ç±»çš„åŠ è½½é¡ºåºå–å†³äº classpathï¼› åµŒå¥—çš„ JARS ä¸­çš„åŠ è½½é¡ºåºï¼Œåœ¨é»˜è®¤æƒ…å†µå–å†³äº OSï¼Œå¯¹äº Linux æ¥è¯´å–å†³äºæ–‡ä»¶ç³»ç»Ÿï¼› Spring Boot æä¾›äº†ä¸€ä¸ªæ’ä»¶ï¼Œåˆ©ç”¨ The Executable Jar Format å®Œç¾è§£å†³äº†åŠ è½½é¡ºåºé”™ä¹±é—®é¢˜ï¼› å…¶å®ƒ ä¸šç•Œçš„ä¸€äº›å…¶ä»–è§£å†³æ–¹æ¡ˆ Spring Boot çš„æ–¹æ¡ˆå¯ä»¥è§£å†³æ‹¥æœ‰ main æ–¹æ³•çš„æœåŠ¡çš„å†²çªé—®é¢˜ï¼Œè§£å†³æ–¹æ³•ä¾èµ–ä¸€ä¸ª Maven å·®è·ã€‚\nå¯¹äºå¼€å‘æˆ–æ‰©å±•ç±»åº“(æ¯”å¦‚ guava/hadoop)ï¼Œæˆ–è€… Java Agent çš„å¼€å‘æ—¶ï¼Œæœ‰æ—¶å€™é¢ä¸´çš„é—®é¢˜æ›´å¤æ‚ï¼Œç”šè‡³è¦è§£å†³ classloader å†²çªçš„é—®é¢˜ã€‚\nmaven-plugin-shade maven-plugin-shade è¯¦è§£\nè‡ªå®šä¹‰ç±»åŠ è½½å™¨ Java Agent çš„ç±»åŠ è½½éš”ç¦»å®ç°\næ€è·¯ï¼šã€ä½¿ç”¨ç‹¬ç«‹çš„ç±»åŠ è½½å™¨å»åŠ è½½ Java Agent ä¾èµ–çš„ç±»ï¼Œè¯¥ç‹¬ç«‹çš„ç±»åŠ è½½å™¨çš„ parent æŒ‡å‘ Bootstrap ClassLoaderï¼Œä¸”å°† Java Agent ä¾èµ–çš„ç±»çš„é»˜è®¤åç¼€ .class è¿›è¡Œè°ƒæ•´ï¼Œä»¥é¿å…ç³»ç»Ÿç±»åŠ è½½å™¨åŠ è½½åˆ°è¿™äº›ç±»ï¼Œä»¥å®ç°ç±»çš„éš”ç¦»ã€‚ã€\nç±»å†²çªé—®é¢˜æ’æŸ¥å°æŠ€å·§ åŠ å¯åŠ¨å‚æ•° -verbose:classpath åŠ ä¸Šè¿™ä¸ªå‚æ•°ï¼Œ JVM ä¼šå°†ã€å“ªä¸ªç±»æ˜¯ä»å“ªä¸ª jarä¸­è¢«åŠ è½½ã€çš„ä¿¡æ¯è¾“å‡ºåˆ° console ä¸­ã€‚\nè¿™ä¸ªæ–¹æ³•éœ€è¦ä½ èƒ½æ§åˆ¶å¯åŠ¨å‚æ•°ï¼Œé€‚åˆåœ¨æœ¬åœ°ï¼Œä¸ç¡®å®šå“ªä¸ªç±»å†²çªçš„æ—¶å€™ä½¿ç”¨ã€‚\nä½¿ç”¨ arthas çš„ Jad åŠŸèƒ½ arthas è¾“å‡ºçš„ä¿¡æ¯æ›´å…¨é¢ï¼Œå‡ºäº†ç°å®åŠ è½½çš„ä½ç½®ï¼Œè¿˜ä¼šå‘Šè¯‰ä½  ClassLoader æ˜¯å“ªä¸€ä¸ªï¼Œå¹¶ä¸”è‡ªåŠ¨åç¼–è¯‘(jad å‘½ä»¤æœ¬æ¥å°±æ˜¯å¹²è¿™ä¸ªçš„ï¼)\nè¿™ä¸ªæ–¹æ³•éœ€è¦ä½ å®‰è£… arthasï¼Œé€‚åˆæœ¬åœ°å’Œ devã€test ç¯å¢ƒï¼Œåœ¨ä½ æœ‰äº†æ˜ç¡®çš„æ€€ç–‘å¯¹è±¡æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨è¿™ä¸ªå‘½ä»¤ã€‚\nå¦‚ä½•å®‰è£… arthas 1 2 3 4 # https://arthas.aliyun.com/doc/install-detail.html curl -O https://arthas.aliyun.com/arthas-boot.jar java -jar arthas-boot.jar ","date":"2023-04-03T18:26:48+08:00","permalink":"https://zhumengzhu.github.io/2023/04/java-class-conflict-and-solutions/","title":"Java ç±»å†²çªé—®é¢˜åŠå…¶è§£å†³æ–¹æ¡ˆ"},{"content":"Contention in java.util.Random it\u0026rsquo;s thread-safe it\u0026rsquo;s lock-free To better understand this, let\u0026rsquo;s see how one of its primary operations, next(int), is implemented:\n1 2 3 4 5 6 7 8 9 protected int next(int bits) { long oldseed, nextseed; AtomicLong seed = this.seed; do { oldseed = seed.get(); nextseed = (oldseed * multiplier + addend) \u0026amp; mask; } while (!seed.compareAndSet(oldseed, nextseed)); return (int)(nextseed \u0026gt;\u0026gt;\u0026gt; (48 - bits)); } Instead of a dedicated instance of Random per thread, each thread only needs to maintain its own seed value. As of Java 8, the Thread class itself has been retrofitted to maintain the seed value:\n1 2 3 4 5 6 7 8 9 10 11 12 public class Thread implements Runnable { // omitted @jdk.internal.vm.annotation.Contended(\u0026#34;tlr\u0026#34;) long threadLocalRandomSeed; @jdk.internal.vm.annotation.Contended(\u0026#34;tlr\u0026#34;) int threadLocalRandomProbe; @jdk.internal.vm.annotation.Contended(\u0026#34;tlr\u0026#34;) int threadLocalRandomSecondarySeed; } The threadLocalRandomSeed variable is responsible for maintaining the current seed value for ThreadLocalRandom. Moreover, the secondary seed, threadLocalRandomSecondarySeed, is usually used internally by the likes of ForkJoinPool.\nThis implementation incorporates a few optimizations to make ThreadLocalRandom even more performant:\nAvoiding false sharing by using the @Contented annotation, which basically adds enough padding to isolate the contended variables in their own cache lines Using sun.misc.Unsafe to update these three variables instead of using the Reflection API Avoiding extra hashtable lookups associated with the ThreadLocal implementation Contention in java.util.SecureRandom it\u0026rsquo;s the subclass of java.util.Random\none of the most common locking issues within Java applications is triggered through an innocent-looking java.io.File.createTempFile() calls. Under the hood, this temporary file creation is relying upon a SecureRandom class to calculate the name of the file.\n1 2 3 4 5 6 7 8 9 10 private static final SecureRandom random = new SecureRandom(); static File generateFile(String prefix, String suffix, File dir) { long n = random.nextLong(); if (n == Long.MIN_VALUE) { n = 0; // corner case } else { n = Math.abs(n); } return new File(dir, prefix + Long.toString(n) + suffix); } And SecureRandom, when nextLong is called, eventually calls its method nextBytes(), which is defined as synchronized:\n1 2 3 synchronized public void nextBytes(byte[] bytes) { secureRandomSpi.engineNextBytes(bytes); } One may say, that if I create new SecureRandom in each thread, I will not get any issues. Unfortunately, itâ€™s not that simple. SecureRandom uses an implementation of java.security.SecureRandomSpi, which will eventually be contended anyhow (you may look at the following bug discussion with some benchmarks in Jenkins issue tracker)\nThis in combination with certain application usage patterns (especially if you have lots of SSL connections which rely on SecureRandom for their crypto-handshaking magic) has a tendency to build up into long-lasting contention issues.\nThe fix to the situation is simple if you can control the source code â€“ just rebuild the solution to rely upon the java.util.ThreadLocalRandom for multithreaded designs. In cases where you are stuck with a standard API making the decisions for you the solution can be more complex and require significant refactoring.\nurandom and random Devices https://www.ibm.com/docs/en/aix/7.2?topic=files-urandom-random-devices\nLinux Kernel 5.8 ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œå¦‚æœç†µæ± çš„æ•°æ®ä¸è¶³ï¼Œä» /dev/random è¯»å–æ•°æ®å¯èƒ½é˜»å¡ï¼Œä½†æ˜¯ä» /dev/urandom ä¸ä¼šé˜»å¡ã€‚Java ç¨‹åºä¸€èˆ¬ä¼šæŒ‡å®š -Djava.security.egd=file:/dev/./urandom å‚æ•°é¿å…é˜»å¡çš„å‘ç”Ÿ(ä½†ä¸ä¸€å®šç”Ÿæ•ˆ)ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ\n-Djava.security.egd=file:/dev/urandom æ˜¯é”™è¯¯çš„ï¼› -Djava.security.egd=file:/dev/./urandom æ‰æ˜¯æ­£ç¡®çš„ï¼› è§ï¼šhttps://stackoverflow.com/questions/137212/how-to-deal-with-a-slow-securerandom-generator å…³äºæ€§èƒ½ ThreadLocalRandom å’Œ SecureRandom éƒ½æ˜¯ Random çš„å­ç±»ï¼› æ€§èƒ½ï¼šThreadLocalRandom \u0026gt; Random \u0026gt; SecureRandomï¼› Random å’Œ ThreadLocalRandom ä½¿ç”¨çš„éƒ½æ˜¯ã€Œçº¿æ€§åŒä½™å‘ç”Ÿå™¨ã€ç®—æ³•ï¼Œé€Ÿåº¦å¾ˆå¿«ï¼ŒåŒºåˆ«æ˜¯ï¼š Random ä½¿ç”¨ CAS æ–¹å¼æ›´æ–°ç§å­ï¼Œé«˜å¹¶å‘æƒ…å†µä¸‹ç«äº‰å¤§ï¼Œæ€§èƒ½ä¼šä¸‹é™ï¼› ThreadLocalRandom å°†ç§å­å­˜åœ¨åœ¨ Thread å¯¹è±¡ä¸Šï¼Œæ€§èƒ½æ›´å¥½ï¼š ç§å­å°é—­åœ¨çº¿ç¨‹å†…ï¼Œä¸éœ€è¦ CASï¼› é¿å…é¢å¤–çš„ã€é—´æ¥ã€è®¡ç®—ï¼š ç›¸æ¯” ThreadLocal + Randomï¼Œåœ¨ Java8 ä¸­ï¼ŒThreadLocalRandom åªéœ€è¦ç›´æ¥è¯»å–å­˜å‚¨åœ¨ Thread å¯¹è±¡ä¸Šçš„ threadLocalRandomSeed ç„¶åç›´æ¥æ›´æ–°å°±å¯ä»¥ï¼Œä¸éœ€è¦è°ƒç”¨ ThreadLocal.get è¿›è¡Œä¸€æ¬¡ HashTable Lookupï¼› é€šè¿‡ UNSAFE çš„ native æ–¹æ³•æ›´æ–°ç§å­å€¼ï¼Œè€Œä¸æ˜¯åå°„ï¼Œæ•ˆç‡æ›´é«˜ï¼› é€šè¿‡ä½¿ç”¨ Contended æ³¨è§£ï¼Œé¿å…ä¼ªå…±äº«é—®é¢˜ï¼› SecureRandom ä½¿ç”¨ OS ç»´æŠ¤çš„éšæœºæ•°æ®æ¥ç”Ÿæˆéšæœºæ•°ï¼Œåº•å±‚ä¼šä½¿ç”¨ synchronized é”ï¼Œå› æ­¤æ€§èƒ½æ¯”è¾ƒå·®ï¼Œä¸”å¯èƒ½å‘ç”Ÿé˜»å¡ï¼› SecureRandom ä½¿ç”¨çš„æŸäº›ç®—æ³•ï¼Œéœ€è¦è¯»å– /dev/random æ¥è·å–éšæœºæ•°æ®ï¼Œå½“ OS ç»´æŠ¤çš„ç†µæ± ä¸­çš„ç†µä¸è¶³æ—¶ï¼Œä¼šå‘ç”Ÿé˜»å¡ï¼Œå¯¼è‡´ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼› åœ¨ Linux çš„ v5.6 åŠå…¶ä»¥åçš„å†…æ ¸ä¸­ï¼Œè¯»å– /dev/random ä¸ä¼šå†è¢«é˜»å¡äº†ï¼Œä½†æ˜¯å°±åƒ /dev/urandom ä¸€æ ·ï¼Œåœ¨ä¸€ä¸ªå…¨æ–°çš„ç³»ç»Ÿåˆšå¯åŠ¨æ—¶ç”±äºç³»ç»Ÿå°šæœªäº§ç”Ÿç†µå€¼ï¼Œæ­¤æ—¶è¿˜æ˜¯å¯èƒ½é˜»å¡ç­‰å¾…è¶³å¤Ÿçš„ç†µå€¼äº§ç”Ÿï¼› UUID.randomUUID åº•å±‚ä½¿ç”¨çš„å°±æ˜¯ SecureRandomï¼Œå› æ­¤æ€§èƒ½ä¼šæ¯”è¾ƒå·®ï¼› File.createTempFile åº•å±‚ä¹Ÿä¼šä½¿ç”¨ SecureRandomï¼Œå› æ­¤æ€§èƒ½ä¼šæ¯”è¾ƒå·®ï¼› å»ºç«‹ SSL è¿æ¥åŒæ ·ä¾èµ– SecureRandomï¼Œå› æ­¤ä¹Ÿè¦å°å¿ƒï¼› å¦‚ä½•é¢„æµ‹ä¸‹ä¸€ä¸ªéšæœºæ•° ä»¥ä¸‹æ–¹æ³•ä»…å¯¹åŸºäº LCG ç®—æ³•æœ‰æ•ˆï¼Œåˆ©ç”¨å…¬å¼ ğ‘‹ğ‘›+1=(ğ‘ğ‘‹ğ‘›+ğ‘) mod ğ‘šã€‚\nç»™å®šä¸¤ä¸ªè¿ç»­çš„ int ç±»å‹å€¼ï¼Œæˆ–ä¸€ä¸ª doubleï¼Œæˆ–ä¸€ä¸ª long ç±»å‹å€¼ï¼Œå³å¯é¢„æµ‹åç»­çš„éšæœºæ•°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 Predict Next Random Number.java import java.util.ArrayList; import java.util.Random; public class ReplicatedRandom extends Random { public static void main(String[] args) { predictByNextDouble(); predictByNextInt(); } private static void predictByNextInt() { long seed = System.currentTimeMillis(); Random r = new Random(seed); int v1 = r.nextInt(); int v2 = r.nextInt(); ReplicatedRandom rr = new ReplicatedRandom(); rr.replicateState(v1, v2); System.out.println(r.nextInt() == rr.nextInt()); // True System.out.println(r.nextInt() == rr.nextInt()); // True System.out.println(r.nextInt() == rr.nextInt()); // True } private static void predictByNextDouble() { long seed = System.currentTimeMillis(); Random r = new Random(seed); ReplicatedRandom rr = new ReplicatedRandom(); rr.replicateState(r.nextDouble()); System.out.println(r.nextDouble() == rr.nextDouble()); // True System.out.println(r.nextDouble() == rr.nextDouble()); // True System.out.println(r.nextDouble() == rr.nextDouble()); // True } // Replicate the state of a Random using a single value from its nextDouble public boolean replicateState(double nextDouble) { // nextDouble() is generated from ((next(26) \u0026lt;\u0026lt; 27) + next(27)) / (1L \u0026lt;\u0026lt; 53) // Inverting those operations will get us the values of next(26) and next(27) long numerator = (long) (nextDouble * (1L \u0026lt;\u0026lt; 53)); int first26 = (int) (numerator \u0026gt;\u0026gt;\u0026gt; 27); int last27 = (int) (numerator \u0026amp; ((1L \u0026lt;\u0026lt; 27) - 1)); return replicateState(first26, 26, last27, 27); } // Replicate the state of a Random using a single value from its nextLong public boolean replicateState(long nextLong) { int last32 = (int) (nextLong \u0026amp; ((1L \u0026lt;\u0026lt; 32) - 1)); int first32 = (int) ((nextLong - last32) \u0026gt;\u0026gt; 32); return replicateState(first32, 32, last32, 32); } // Replicate the state of a Random using two consecutive values from its nextInt public boolean replicateState(int firstNextInt, int secondNextInt) { return replicateState(firstNextInt, 32, secondNextInt, 32); } // Replicate the state of a Random using two consecutive values from its nextFloat public boolean replicateState(float firstNextFloat, float secondNextFloat) { return replicateState((int) (firstNextFloat * (1 \u0026lt;\u0026lt; 24)), 24, (int) (secondNextFloat * (1 \u0026lt;\u0026lt; 24)), 24); } public boolean replicateState(int nextN, int n, int nextM, int m) { // Constants copied from java.util.Random final long multiplier = 0x5DEECE66DL; final long addend = 0xBL; final long mask = (1L \u0026lt;\u0026lt; 48) - 1; long upperMOf48Mask = ((1L \u0026lt;\u0026lt; m) - 1) \u0026lt;\u0026lt; (48 - m); // next(x) is generated by taking the upper x bits of 48 bits of (oldSeed * multiplier + addend) mod (mask + 1) // So now we have the upper n and m bits of two consecutive calls of next(n) and next(m) long oldSeedUpperN = ((long) nextN \u0026lt;\u0026lt; (48 - n)) \u0026amp; mask; long newSeedUpperM = ((long) nextM \u0026lt;\u0026lt; (48 - m)) \u0026amp; mask; // Bruteforce the lower (48 - n) bits of the oldSeed that was truncated. // Calculate the next seed for each guess of oldSeed and check if it has the same top m bits as our newSeed. // If it does then the guess is right and we can add that to our candidate seeds. ArrayList\u0026lt;Long\u0026gt; possibleSeeds = new ArrayList\u0026lt;Long\u0026gt;(); for (long oldSeed = oldSeedUpperN; oldSeed \u0026lt;= (oldSeedUpperN | ((1L \u0026lt;\u0026lt; (48 - n)) - 1)); oldSeed++) { long newSeed = (oldSeed * multiplier + addend) \u0026amp; mask; if ((newSeed \u0026amp; upperMOf48Mask) == newSeedUpperM) { possibleSeeds.add(newSeed); } } if (possibleSeeds.size() == 1) { // If there\u0026#39;s only one candidate seed, then we found it! setSeed(possibleSeeds.get(0) ^ multiplier); // setSeed(x) sets seed to `(x ^ multiplier) \u0026amp; mask`, so we need another `^ multiplier` to cancel it out return true; } if (possibleSeeds.size() \u0026gt;= 1) { System.out.println(\u0026#34;Didn\u0026#39;t find a unique seed. Possible seeds were: \u0026#34; + possibleSeeds); } else { System.out.println(\u0026#34;Failed to find seed!\u0026#34;); } return false; } } è¯´æ˜ï¼š\nä¸Šé¢çš„ç®—æ³•åˆ©ç”¨äº† Java ç”Ÿæˆçš„éšæœºæ•°æœ‰ 48 ä¸ªæœ‰æ•ˆä½è¿™ä¸€ä¿¡æ¯ï¼› å¯¹äº nextInt æ¥è¯´ï¼Œè¿”å›å€¼æ˜¯ 32 ä½ï¼Œå› æ­¤åœ¨è¿”å›ç»“æœæ—¶ï¼Œä¼šèˆå¼ƒä½ 16 ä½ï¼Œè¿™æ˜¯é€šè¿‡ \u0026raquo;\u0026gt; ä½ç§»æ“ä½œå®ç°çš„ï¼› å¯¹äº nextLong æ¥è¯´ï¼Œå®ƒæ˜¯ç”±ä¸¤ä¸ªè¿ç»­çš„ nextInt ç»„æˆçš„ï¼› å¯¹äº nextDouble æ¥è¯´ï¼Œå®ƒæ˜¯ç”±ä¸¤ä¸ªè¿ç»­çš„åˆ†åˆ«æ˜¯ 27 bits å’Œ 26 bits æ•°å­—ç»„æˆçš„ï¼› å› æ­¤ï¼Œå½“ç»™å®šä¸€ä¸ª nextInt å€¼æ—¶ï¼Œå°†å…¶å·¦ç§» 16 ä½ï¼Œå³å¾—åˆ°ç§å­çš„æœ€å°å¯èƒ½å€¼ï¼Œè¯¥å€¼åŠ ä¸Š 2^16 - 1ï¼Œå°±æ˜¯ç§å­çš„æœ€å¤§å¯èƒ½å€¼ï¼›å› æ­¤ï¼Œåªéœ€éå†è¯¥ç©ºé—´(åŒ…å« 2^16 ä¸ªæ•°å­—)ï¼Œå³å¯æ¨æµ‹å‡ºç§å­çš„å®é™…å€¼ï¼› ç°ä»£ CPU å¯ä»¥åœ¨ 1 ç§’å†…ç”¨æš´åŠ›æ–¹æ³•é€†å‘çš„æ¨æµ‹å‡ºå½“å‰çš„ç§å­å€¼ï¼› Benchmark å•çº¿ç¨‹ç»“æœï¼š 4 çº¿ç¨‹ç»“æœï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 RandomBenchmark.java package benchmark; import org.openjdk.jmh.annotations.Benchmark; import org.openjdk.jmh.annotations.BenchmarkMode; import org.openjdk.jmh.annotations.Fork; import org.openjdk.jmh.annotations.Measurement; import org.openjdk.jmh.annotations.Mode; import org.openjdk.jmh.annotations.OutputTimeUnit; import org.openjdk.jmh.annotations.Scope; import org.openjdk.jmh.annotations.State; import org.openjdk.jmh.annotations.Threads; import org.openjdk.jmh.annotations.Warmup; import org.openjdk.jmh.results.format.ResultFormatType; import org.openjdk.jmh.runner.Runner; import org.openjdk.jmh.runner.RunnerException; import org.openjdk.jmh.runner.options.Options; import org.openjdk.jmh.runner.options.OptionsBuilder; import java.time.LocalDateTime; import java.time.format.DateTimeFormatter; import java.util.Random; import java.util.concurrent.ThreadLocalRandom; import java.util.concurrent.TimeUnit; /** */ @BenchmarkMode({Mode.AverageTime, Mode.Throughput}) @Warmup(iterations = 3, time = 1) @Measurement(iterations = 5, time = 5) @Threads(4) @Fork(1) @State(value = Scope.Benchmark) @OutputTimeUnit(TimeUnit.NANOSECONDS) public class RandomBenchmark { private final Random random = new Random(); private final ThreadLocal\u0026lt;Random\u0026gt; simpleThreadLocal = ThreadLocal.withInitial(Random::new); public static void main(String[] args) throws RunnerException { // å°†ç»“æœæ–‡ä»¶ä¸Šä¼ åˆ° https://jmh.morethan.io/ å¯ä»¥å¾—åˆ°å¯è§†åŒ–ç»“æœ String now = LocalDateTime.now().format(DateTimeFormatter.ofPattern(\u0026#34;yyyyMMddHHmmss\u0026#34;)); String filePath = \u0026#34;/tmp/jmh_result_\u0026#34; + now + \u0026#34;.json\u0026#34;; Options opt = new OptionsBuilder() .include(RandomBenchmark.class.getSimpleName()) .result(filePath) .resultFormat(ResultFormatType.JSON).build(); new Runner(opt).run(); } @Benchmark // @BenchmarkMode(Throughput) public int regularRandom() { return random.nextInt(); } @Benchmark // @BenchmarkMode(Throughput) public int simpleThreadLocal() { return simpleThreadLocal.get().nextInt(); } @Benchmark // @BenchmarkMode(Throughput) public int builtinThreadLocal() { return ThreadLocalRandom.current().nextInt(); } } Reference https://www.baeldung.com/java-thread-local-random https://alidg.me/blog/2020/4/24/thread-local-random https://stackoverflow.com/questions/11051205/difference-between-java-util-random-and-java-security-securerandom https://resources.infosecinstitute.com/topic/random-number-generation-java/ https://jazzy.id.au/2010/09/21/cracking_random_number_generators_part_2.html https://jazzy.id.au/2010/09/22/cracking_random_number_generators_part_3.html https://blogs.oracle.com/linux/post/rngd1 https://blogweb.cn/article/1642969777211 https://lwn.net/Articles/808575/ https://unix.stackexchange.com/questions/243127/how-to-check-if-reading-from-dev-random-will-block https://crypto.stackexchange.com/questions/51686/how-to-determine-the-next-number-from-javas-random-method https://franklinta.com/2014/08/31/predicting-the-next-math-random-in-java/ https://jazzy.id.au/2010/09/20/cracking_random_number_generators_part_1.html (è®²è§£äº†ç ´è§£éšæœºæ•°ç”Ÿæˆå™¨çš„ç†è®ºåŸºç¡€) ","date":"2023-01-30T10:33:47+08:00","permalink":"https://zhumengzhu.github.io/2023/01/java-random-number-issues-overview/","title":"Java éšæœºæ•°é—®é¢˜ç»¼è¿°"},{"content":"è¯´æ˜ è¯´æ˜\nåŸæ–‡ï¼šhttps://dev.mysql.com/doc/refman/8.0/en/innodb-locks-set.html ä¸‹æ–‡é»‘è‰²å­—ä½“åŸæ–‡ï¼Œé»„è‰²å­—ä½“æ˜¯ç¿»è¯‘ï¼Œçº¢è‰²æ˜¯è‡ªå·±åŠ çš„æ ‡æ³¨ï¼Œè®°å½•è‡ªå·±å¯¹åŸæ–‡çš„ç†è§£ã€‚ æµ‹è¯•è¡¨ç»“æ„ï¼š 1 2 3 4 5 6 CREATE TABLE `t` ( `id` bigint NOT NULL AUTO_INCREMENT COMMENT \u0026#39;ä¸»é”® ID\u0026#39;, `version` bigint NOT NULL DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;ç‰ˆæœ¬å·\u0026#39;, PRIMARY KEY (`id`), UNIQUE KEY `uk_version` (`version`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT=\u0026#39;ç‰ˆæœ¬è¡¨\u0026#39;ï¼› è¡¨é‡Œçš„åˆå§‹æ•°æ®ä¸ºï¼š\n1 1 2 5 3 10 4 15 ç¿»è¯‘\u0026amp;ç¬”è®° ã€A locking read, an UPDATE, or a DELETE generally set record locks on every index record that is scanned in the processing of an SQL statement. It does not matter whether there are WHERE conditions in the statement that would exclude the row. InnoDB does not remember the exact WHERE condition, but only knows which index ranges were scanned. The locks are normally next-key locks that also block inserts into the â€œgapâ€ immediately before the record. However, gap locking can be disabled explicitly, which causes next-key locking not to be used. For more information, see Section 15.7.1, â€œInnoDB Lockingâ€. The transaction isolation level can also affect which locks are set; see Section 15.7.2.1, â€œTransaction Isolation Levelsâ€.ã€\nä¸€æ¬¡åŠ é”çš„è¯»ã€æ›´æ–°æˆ–åˆ é™¤é€šå¸¸åœ¨ SQL è¯­å¥å¤„ç†è¿‡ç¨‹ä¸­æ‰«æçš„æ¯ä¸ªç´¢å¼•è®°å½•ä¸Šè®¾ç½®è®°å½•é”ã€‚ è¯­å¥ä¸­æ˜¯å¦ä½¿ç”¨ WHERE æ¡ä»¶æ’é™¤äº†æŸäº›è¡Œå¹¶ä¸å…³é”®ã€‚InnoDB ä¸ä¼šè®°ä½å‡†ç¡®çš„ WHERE æ¡ä»¶ï¼Œè€Œæ˜¯åªå…³å¿ƒç´¢å¼•çš„æ‰«æèŒƒå›´ã€‚é”é€šå¸¸æ˜¯ä¸´é”®é”ï¼Œç”¨æ¥ç»„ç»‡åœ¨è®°å½•ä¹‹å‰çš„ã€é—´éš™ã€æ’å…¥è®°å½•ã€‚ä½†æ˜¯ï¼Œé—´éš™é”å¯ä»¥è¢«ç¦ç”¨ï¼Œæ­¤æ—¶ä¸ä¼šä½¿ç”¨ä¸´é”®é”ã€‚æ›´å¤šä¿¡æ¯ï¼Œè§ç¬¬15.7.1ï¼Œã€InnoDB Lockingã€ã€‚äº‹åŠ¡éš”ç¦»çº§åˆ«ä¹Ÿä¼šå½±å“é”çš„è®¾ç½®ï¼Œè¯¦æƒ…è§15.7.2.1ï¼Œã€Transaction Isolation Levelsã€ã€‚ é”æ˜¯è®¾ç½®åœ¨ç´¢å¼•è®°å½•ä¸Šçš„ã€‚ ã€If a secondary index is used in a search and the index record locks to be set are exclusive, InnoDB also retrieves the corresponding clustered index records and sets locks on them.ã€\nå¦‚æœåœ¨æœç´¢ä¸­ä½¿ç”¨äº†äºŒçº§ç´¢å¼•ï¼Œå¹¶ä¸”è¦è®¾ç½®çš„ç´¢å¼•è®°å½•é”æ˜¯æ’ä»–çš„ï¼ŒInnoDBä¹Ÿä¼šæ£€ç´¢ç›¸åº”çš„èšé›†ç´¢å¼•è®°å½•å¹¶å¯¹å…¶è®¾ç½®é”ã€‚ æ€ä¹ˆç†è§£ï¼Ÿ ã€åœ¨æœç´¢ä¸­ä½¿ç”¨äºŒçº§ç´¢å¼•ã€ï¼ŒInnoDB åœ¨æ‰§è¡Œæ—¶æ˜¯é€šè¿‡æ‰«æäºŒçº§ç´¢å¼•æ¥æŸ¥æ‰¾è®°å½•çš„ï¼Œä¸¾ä¸ªä¾‹å­ï¼š äº‹åŠ¡ä¸€ï¼Œæ‰§è¡Œ begin; select * from t where version = 1 for update; äº‹åŠ¡äºŒï¼Œæ‰§è¡Œ select id from t where id = 1 for update; ä¼šè¢«é˜»å¡ï¼›æ­¤æ—¶æŸ¥è¯¢data_locks è¡¨ï¼Œä¼šå‘ç°äº‹åŠ¡ä¸€åœ¨èšç°‡ç´¢å¼•ä¸Šè®¾ç½®äº†è®°å½•é”ï¼š ã€If you have no indexes suitable for your statement and MySQL must scan the entire table to process the statement, every row of the table becomes locked, which in turn blocks all inserts by other users to the table. It is important to create good indexes so that your queries do not scan more rows than necessary.ã€\nå¦‚æœæ²¡æœ‰é€‚åˆè¯­å¥çš„ç´¢å¼•ï¼ŒMySQLå¿…é¡»æ‰«ææ•´ä¸ªè¡¨æ¥å¤„ç†è¯­å¥ï¼Œæ­¤æ—¶è¡¨çš„æ¯ä¸€è¡Œéƒ½è¢«é”å®šï¼Œä»è€Œé˜»æ­¢å…¶ä»–ç”¨æˆ·å¯¹è¡¨çš„æ‰€æœ‰æ’å…¥ã€‚ åˆ›å»ºè‰¯å¥½çš„ç´¢å¼•éå¸¸é‡è¦ï¼Œè¿™æ ·æŸ¥è¯¢å°±ä¸ä¼šæ‰«æä¸å¿…è¦çš„è¡Œã€‚â€ ã€InnoDB sets specific types of locks as follows.ã€\nInnoDBè®¾ç½®é”çš„å…·ä½“ç±»å‹å¦‚ä¸‹ã€‚ ã€SELECT \u0026hellip; FROM is a consistent read, reading a snapshot of the database and setting no locks unless the transaction isolation level is set to SERIALIZABLE. For SERIALIZABLE level, the search sets shared next-key locks on the index records it encounters. However, only an index record lock is required for statements that lock rows using a unique index to search for a unique row.ã€ ã€When UPDATE modifies a clustered index record, implicit locks are taken on affected secondary index records. The UPDATE operation also takes shared locks on affected secondary index records when performing duplicate check scans prior to inserting new secondary index records, and when inserting new secondary index records.ã€ å½“ Update ä¿®æ”¹èšç°‡ç´¢å¼•è®°å½•æ—¶ï¼Œä¼šéšå¼çš„å¯¹å—å½±å“çš„æ¬¡çº§ç´¢å¼•åŠ é”ã€‚åœ¨æ’å…¥æ–°çš„æ¬¡çº§ç´¢å¼•è®°å½•ä¹‹å‰æ‰§è¡Œé‡å¤æ£€æŸ¥æ‰«ææ—¶ï¼Œä»¥åŠåœ¨æ’å…¥æ–°çš„æ¬¡çº§ç´¢å¼•è®°å½•æ—¶ï¼ŒUPDATE æ“ä½œè¿˜å¯¹å—å½±å“çš„æ¬¡çº§ç´¢å¼•è®°å½•åŠ å…±äº«é”ã€‚ æ€ä¹ˆç†è§£ ã€éšå¼åŠ é”ã€ï¼Ÿ äº‹åŠ¡ä¸€ï¼Œæ‰§è¡Œ begin; update t set version = -1 where id = 1; ç„¶åæŸ¥ data_locks è¡¨ï¼Œä¼šå‘ç°æ²¡æœ‰å¯¹ uk_version åŠ é”ï¼› äº‹åŠ¡äºŒï¼Œæ‰§è¡Œ update t set version = -2 where version = 1; ä¼šè¢«é˜»å¡ï¼Œæ­¤æ—¶å†æ¬¡æŸ¥çœ‹ data_locks è¡¨ï¼Œä¼šå‘ç°äº‹åŠ¡ä¸€è·å–äº† uk_version çš„è®°å½•é”ï¼š è¿™è¯´æ˜ï¼Œäº‹åŠ¡ä¸€ç¡®å®ä¼šå¯¹æ¬¡çº§ç´¢å¼•åŠ é”ï¼Œåªæ˜¯ä¸çŸ¥é“ä»€ä¹ˆåŸå› ï¼Œæ²¡æœ‰é”å†²çªæ˜¯ï¼Œåœ¨ data_locks è¡¨ä¸­æŸ¥ä¸åˆ°é”è®°å½•ï¼› æ€ä¹ˆç†è§£ã€è¿›è¡Œé‡å¤æ€§æ£€æŸ¥æ‰«ææ—¶ï¼Œä¼šå¯¹å—å½±å“çš„æ¬¡çº§ç´¢å¼•åŠ å…±äº«é”ã€ï¼Ÿ æ‰§è¡Œ begin; insert into t (version) value (1); ç„¶åæŸ¥ data_locks è¡¨ï¼Œä¼šå‘ç°äº‹åŠ¡æŒæœ‰äº† uk_version ä¸Šçš„ S é”ï¼› ç”±äºè¡¨ä¸­å·²ç»æœ‰ä¸€æ¡ version=1 çš„è®°å½•ï¼Œå½“åœ¨æ’å…¥ version=1 çš„è®°å½•æ—¶ï¼Œä¼šåŠ ä¸€ä¸ª S é”ä»¥è¿›è¡Œé‡å¤æ£€æŸ¥ï¼› ","date":"2023-01-16T11:07:26+08:00","permalink":"https://zhumengzhu.github.io/2023/01/locks-set-by-different-sql-statements-in-innodb/","title":"ã€Locks Set by Different SQL Statements in InnoDBã€ç¿»è¯‘\u0026ç¬”è®°"},{"content":"ç›®æ ‡ ä¸€ï¼šåˆ†æä¸‹é¢è¿™æ¡è¯­å¥æ‰§è¡Œæ—¶ï¼Œä¼šåŠ å“ªäº›é”ã€ä¸ºä»€ä¹ˆåŠ è¿™äº›é”ï¼Œä»¥åŠå¯èƒ½ä¼šå­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼š\nINSERT INTO t (version) SELECT IFNULL(MAX(version) + 1, 1) FROM t; äºŒï¼šæŒæ¡åŸºæœ¬çš„åˆ†æ MySQL åŠ é”æƒ…å†µçš„æŠ€èƒ½ï¼›\nç»“è®º åŠ çš„é”åŒ…æ‹¬ï¼š\nä¸¤ä¸ªæ„å‘é” æ„å‘æ’ä»–é”( IX é”)ï¼š äº‹åŠ¡æƒ³è¦è·å¾—ä¸€å¼ è¡¨ä¸­æŸå‡ è¡Œçš„æ’ä»–é” æ„å‘å…±äº«é”( IS é”)ï¼šäº‹åŠ¡æƒ³è¦è·å¾—ä¸€å¼ è¡¨ä¸­æŸå‡ è¡Œçš„å…±äº«é” ä¸‰ä¸ªå…±äº«é” ä¸€ä¸ªå¯¹ â€œä¸Šç¡®ç•Œä¼ªçºªå½•â€çš„å…±äº«ä¸´é”®é”ï¼› ä¸€ä¸ªå¯¹ â€œversionå€¼æœ€å¤§çš„é‚£æ¡uk_versionç´¢å¼•è®°å½•â€çš„å…±äº«ä¸´é”®é”ï¼› ä¸€ä¸ªå¯¹\u0026quot;å¾…æ’å…¥çš„æ•°æ®çš„uk_versionç´¢å¼•è®°å½•\u0026quot;çš„é—´éš™é”ï¼› ä¸‹è¡¨æ˜¯ä» performance_schema.data_locks è¡¨ä¸­æˆªå–çš„çœŸå®æ•°æ®(çœç•¥äº†ä¸ç›¸å…³çš„å­—æ®µ)ï¼š\nINDEX_NAME LOCK_TYPE LOCK_MODE LOCK_DATA è¯´æ˜ NULL TABLE IX NULL NULL TABLE IS NULL uk_version RECORD S supremum pseudo-record å¯¹â€œä¸Šç¡®ç•Œä¼ªçºªå½•â€åŠ  shared next-key locks uk_version RECORD S 15,4 å¯¹ version æœ€å¤§çš„é‚£æ¡è®°å½•åŠ  next-key locks uk_version RECORD S,GAP 16, 5 éªŒè¯ æ•°æ®åº“ç‰ˆæœ¬ è¿›è¡Œå®éªŒçš„ MySQL ç‰ˆæœ¬ä¸º: 8.0.27 MySQL Community Server - GPL\nåº“è¡¨å‡†å¤‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # åˆ›å»ºåº“ CREATE DATABASE IF NOT EXISTS `test`; USE `test`; # åˆ›å»ºè¡¨ CREATE TABLE IF NOT EXISTS `t` ( `id` BIGINT AUTO_INCREMENT COMMENT \u0026#39;ä¸»é”® ID\u0026#39;, `version` BIGINT DEFAULT 0 NOT NULL COMMENT \u0026#39;ç‰ˆæœ¬å·\u0026#39;, PRIMARY KEY (`id`), UNIQUE KEY `uk_version` (`version`) ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COMMENT \u0026#39;ç‰ˆæœ¬è¡¨\u0026#39;; # åˆå§‹åŒ–æ•°æ® INSERT INTO `t` (`version`) VALUE (1); INSERT INTO `t` (`version`) VALUE (5); INSERT INTO `t` (`version`) VALUE (10); INSERT INTO `t` (`version`) VALUE (15); å®éªŒ å®éªŒä¸€ INSERT INTO t (version) SELECT IFNULL(MAX(version) + 1, 1) FROM t`` ç›´æ¥æ‰§è¡Œ INSERTO \u0026hellip; SELECT ç„¶åçœ‹åŠ é”æƒ…å†µã€‚\n1 2 3 4 5 6 7 8 9 # session 1 BEGIN; INSERT INTO `t` (`version`) SELECT IFNULL(MAX(version) + 1, 1) FROM `t`; # session 2 SELECT ENGINE, ENGINE_LOCK_ID, ENGINE_TRANSACTION_ID, THREAD_ID, INDEX_NAME, OBJECT_INSTANCE_BEGIN, LOCK_TYPE, LOCK_MODE, LOCK_STATUS, LOCK_DATA FROM performance_schema.data_locks; # session 1 ROLLBACK; MySQL å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œå¤§æ¦‚è§£é‡Šäº†ä¸ºä»€ä¹ˆåŠ è¿™äº›é”ï¼š\nhttps://dev.mysql.com/doc/refman/8.0/en/innodb-locks-set.html INSERT INTO T SELECT \u0026hellip; FROM S WHERE \u0026hellip; sets an exclusive index record lock (without a gap lock) on each row inserted into T. If the transaction isolation level is READ COMMITTED, InnoDB does the search on S as a consistent read (no locks). Otherwise, InnoDB sets shared next-key locks on rows from S. InnoDB has to set locks in the latter case: During roll-forward recovery using a statement-based binary log, every SQL statement must be executed in exactly the same way it was done originally. CREATE TABLE \u0026hellip; SELECT \u0026hellip; performs the SELECT with shared next-key locks or as a consistent read, as for INSERT \u0026hellip; SELECT. When a SELECT is used in the constructs REPLACE INTO t SELECT \u0026hellip; FROM s WHERE \u0026hellip; or UPDATE t \u0026hellip; WHERE col IN (SELECT \u0026hellip; FROM s \u0026hellip;), InnoDB sets shared next-key locks on rows from table s.\nå®éªŒäºŒ SELECT IFNULL(MAX(version) + 1, 1) AS version FROM t FOR SHARE; å•ç‹¬æ‰§è¡Œ SELECT FOR SHARE ç„¶åæŸ¥çœ‹åŠ é”æƒ…å†µï¼š\n1 2 3 4 5 6 7 8 9 # session 1 BEGIN; SELECT IFNULL(MAX(version) + 1, 1) AS version FROM `t` FOR SHARE; # session 2 SELECT ENGINE, ENGINE_LOCK_ID, ENGINE_TRANSACTION_ID, THREAD_ID, INDEX_NAME, OBJECT_INSTANCE_BEGIN, LOCK_TYPE, LOCK_MODE, LOCK_STATUS, LOCK_DATA FROM performance_schema.data_locks; # session 1 ROLLBACK; å®éªŒä¸‰ å…ˆ SELECT FOR SHARE ç„¶åæ‰§è¡Œ INSERT.\nå¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ‰§è¡Œå®Œ INSERT åï¼Œ è·å–çš„é”ä¸å®éªŒä¸€ç›¸åŒã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # session 1 BEGIN; SELECT IFNULL(MAX(version) + 1, 1) AS version FROM `t` FOR SHARE; # session 2 SELECT ENGINE, ENGINE_LOCK_ID, ENGINE_TRANSACTION_ID, THREAD_ID, INDEX_NAME, OBJECT_INSTANCE_BEGIN, LOCK_TYPE, LOCK_MODE, LOCK_STATUS, LOCK_DATA FROM performance_schema.data_locks; # session 1 INSERT INTO `t` (`version`) VALUE (16); # session 2 SELECT ENGINE, ENGINE_LOCK_ID, ENGINE_TRANSACTION_ID, THREAD_ID, INDEX_NAME, OBJECT_INSTANCE_BEGIN, LOCK_TYPE, LOCK_MODE, LOCK_STATUS, LOCK_DATA FROM performance_schema.data_locks; # session 1 ROLLBACK; åŠ é”åˆ†æ å¯¹äºä¸Šé¢çš„æ•°æ®ï¼Œå…¶uk_versionçš„ç»“æ„å¤§æ¦‚å¦‚ä¸‹ï¼š\nåœ¨æ‰§è¡Œ SELECT IFNULL(MAX(version) + 1, 1) AS version FROM t FOR SHARE æ—¶ï¼š\né¦–å…ˆä¼šå…ˆæ‰«æåˆ° (version=15, id=4) è¿™æ¡è®°å½•ï¼Œç„¶åå¯¹å…¶åŠ  next-key lockï¼›ç„¶åç»§ç»­å‘åæ‰«æï¼Œå¯¹ supremum pseudo-record è¿™æ¡ä¼ªè®°å½•åŠ  next-key lockã€‚\nå°èŠ‚ ç»“è®ºä¸€ï¼šINSERT INTO \u0026hellip; SELECT FROM ç­‰ä»·äºå…ˆæ‰§è¡Œ SELECT FROM FOR SHARE ç„¶åå† INSERT INTOï¼› ç»“è®ºäºŒï¼šSELECT MAX(\u0026hellip;) FROM \u0026hellip; æ˜¯èŒƒå›´æŸ¥è¯¢ï¼Œå› æ­¤ä¼šåŠ é—´éš™é”ï¼› ç»“è®ºä¸‰ï¼šç»“è®ºäºŒå¯¹å”¯ä¸€ç´¢å¼•åŒæ ·é€‚ç”¨ï¼› ç†è®º é”åˆ†ç±» data_locks è¡¨ å®˜æ–¹æ–‡æ¡£ï¼šhttps://dev.mysql.com/doc/mysql-perfschema-excerpt/8.0/en/performance-schema-data-locks-table.html\nç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 MySQL [test]\u0026gt; SELECT * FROM performance_schema.data_locks\\G *************************** 1. row *************************** ENGINE: INNODB ENGINE_LOCK_ID: 281472727006424:1069:281472627977064 ENGINE_TRANSACTION_ID: 2423 THREAD_ID: 53 EVENT_ID: 129 OBJECT_SCHEMA: test OBJECT_NAME: t PARTITION_NAME: NULL SUBPARTITION_NAME: NULL INDEX_NAME: NULL OBJECT_INSTANCE_BEGIN: 281472627977064 LOCK_TYPE: TABLE LOCK_MODE: IX LOCK_STATUS: GRANTED LOCK_DATA: NULL *************************** 2. row *************************** ENGINE: INNODB ENGINE_LOCK_ID: 281472727006424:1069:281472627976976 ENGINE_TRANSACTION_ID: 2423 THREAD_ID: 53 EVENT_ID: 128 OBJECT_SCHEMA: test OBJECT_NAME: t PARTITION_NAME: NULL SUBPARTITION_NAME: NULL INDEX_NAME: NULL OBJECT_INSTANCE_BEGIN: 281472627976976 LOCK_TYPE: TABLE LOCK_MODE: IS LOCK_STATUS: GRANTED LOCK_DATA: NULL *************************** 3. row *************************** ENGINE: INNODB ENGINE_LOCK_ID: 281472727006424:4:5:1:281472627973984 ENGINE_TRANSACTION_ID: 2423 THREAD_ID: 53 EVENT_ID: 128 OBJECT_SCHEMA: test OBJECT_NAME: t PARTITION_NAME: NULL SUBPARTITION_NAME: NULL INDEX_NAME: uk_version OBJECT_INSTANCE_BEGIN: 281472627973984 LOCK_TYPE: RECORD LOCK_MODE: S LOCK_STATUS: GRANTED LOCK_DATA: supremum pseudo-record *************************** 4. row *************************** ENGINE: INNODB ENGINE_LOCK_ID: 281472727006424:4:5:5:281472627973984 ENGINE_TRANSACTION_ID: 2423 THREAD_ID: 53 EVENT_ID: 128 OBJECT_SCHEMA: test OBJECT_NAME: t PARTITION_NAME: NULL SUBPARTITION_NAME: NULL INDEX_NAME: uk_version OBJECT_INSTANCE_BEGIN: 281472627973984 LOCK_TYPE: RECORD LOCK_MODE: S LOCK_STATUS: GRANTED LOCK_DATA: 15, 4 *************************** 5. row *************************** ENGINE: INNODB ENGINE_LOCK_ID: 281472727006424:4:5:6:281472627974328 ENGINE_TRANSACTION_ID: 2423 THREAD_ID: 53 EVENT_ID: 129 OBJECT_SCHEMA: test OBJECT_NAME: t PARTITION_NAME: NULL SUBPARTITION_NAME: NULL INDEX_NAME: uk_version OBJECT_INSTANCE_BEGIN: 281472627974328 LOCK_TYPE: RECORD LOCK_MODE: S,GAP LOCK_STATUS: GRANTED LOCK_DATA: 16, 7 5 rows in set (0.004 sec) å­—æ®µè¯´æ˜ æ„å‘é”çš„ä½œç”¨\nå½“æˆ‘ä»¬å‡†å¤‡ç»™ä¸€å¼ è¡¨åŠ ä¸Šè¡¨é”çš„æ—¶å€™ï¼Œæˆ‘ä»¬é¦–å…ˆè¦å» åˆ¤æ–­æœ‰æ²¡å…¶ä»–çš„äº‹åŠ¡é”å®šäº†å…¶ä¸­äº†æŸäº›è¡Œï¼Ÿå¦‚æœæœ‰çš„è¯ï¼Œè‚¯å®šä¸èƒ½åŠ ä¸Šè¡¨é”ã€‚é‚£ä¹ˆè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±è¦å»æ‰«ææ•´å¼ è¡¨æ‰èƒ½ç¡®å®šèƒ½ä¸èƒ½æˆåŠŸåŠ ä¸Šä¸€ä¸ªè¡¨é”ï¼Œå¦‚æœæ•°æ®é‡ç‰¹åˆ«å¤§ï¼Œæ¯”å¦‚æœ‰ä¸Šåƒä¸‡çš„æ•°æ®çš„æ—¶å€™ï¼ŒåŠ è¡¨é”çš„æ•ˆç‡ä¼šå¾ˆä½ã€‚å½“æˆ‘ä»¬åœ¨ä½¿ç”¨å…±äº«è¡Œé”æ—¶ï¼ŒInnodb ä¼šè‡ªåŠ¨ç»™æˆ‘ä»¬åŠ ä¸ŠISï¼Œä½¿ç”¨æ’ä»–è¡Œé”æ—¶è‡ªåŠ¨åŠ ä¸ŠIX ï¼Œç”¨æ¥è¡¨ç¤ºæ”¹è¡¨ä¸­å·²ç»å­˜åœ¨é‚£äº›é” å‚è€ƒï¼šhttps://www.jianshu.com/p/ae91c63e7257\næ’å…¥æ„å‘é”çš„ä½œç”¨\næ’å…¥æ„å‘é”æ˜¯åœ¨æ’å…¥ä¹‹å‰ï¼Œå…ˆåˆ¤æ–­æ’å…¥çš„é—´éš™æ˜¯å¦å­˜åœ¨é—´éš™é”ï¼Œå¦‚æœå­˜åœ¨åˆ™äº§ç”Ÿä¸€ä¸ªæ’å…¥æ„å‘é”ï¼Œå»ç­‰å¾…é—´éš™é”çš„é‡Šæ”¾ã€‚ å¤šä¸ªäº‹åŠ¡æ’å…¥åŒä¸€ä¸ªé—´éš™çš„ä¸åŒä½ç½®ï¼Œä»–ä»¬å¹¶ä¸ä¼šå†²çªã€‚å‡è®¾å­˜åœ¨ç´¢å¼•è®°å½•ï¼Œå…¶å€¼åˆ†åˆ«ä¸º5å’Œ9ã€‚å•ç‹¬çš„äº‹åŠ¡åˆ†åˆ«å°è¯•æ’å…¥å€¼6å’Œ7ï¼Œåœ¨è·å¾—æ’å…¥è¡Œçš„æ’ä»–é”ä¹‹å‰ï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½ä½¿ç”¨æ’å…¥æ„å›¾é”æ¥é”å®š5å’Œ9ä¹‹é—´çš„é—´éš™ï¼Œä½†ä»–ä»¬ä¸ä¼šäº’ç›¸é˜»å¡ã€‚ å‚è€ƒå®˜æ–¹è¯´æ˜ï¼šhttps://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html An insert intention lock is a type of gap lock set by INSERT operations prior to row insertion. This lock signals the intent to insert in such a way that multiple transactions inserting into the same index gap need not wait for each other if they are not inserting at the same position within the gap. Suppose that there are index records with values of 4 and 7. Separate transactions that attempt to insert values of 5 and 6, respectively, each lock the gap between 4 and 7 with insert intention locks prior to obtaining the exclusive lock on the inserted row, but do not block each other because the rows are nonconflicting.\nä¸ºä»€ä¹ˆ INSERT INTO T SELECT \u0026hellip; FROM S WHERE \u0026hellip; éœ€è¦åŠ å…±äº«é” è€ƒè™‘ä¸‹é¢çš„æƒ…å†µï¼š\nåˆå§‹æ—¶ï¼Œè¡¨ä¸­çš„ version çš„æœ€å¤§å€¼æ˜¯ 15ï¼› æ—¶é—´ äº‹åŠ¡ä¸€ äº‹åŠ¡äºŒ T1 BEGIN; T2 INSERT INTO t (version) SELECT IFNULL(MAX(version) + 1, 1) FROM t; T3 (æˆåŠŸï¼Œå†™å…¥ä¸€æ¡ version=16 çš„æ•°æ®) BEGIN; T4 INSERT INTO t (version) VALUE (10000); T5 COMMIT; T6 COMMIT; åœ¨åŸºäº statement-based binary log çš„ä¸»ä»åŒæ­¥æ¨¡å¼ä¸‹ï¼Œå¦‚æœä¸åŠ å…±äº«é”ï¼Œç”±äºäº‹åŠ¡äºŒæ˜¯å…ˆæäº¤çš„ï¼Œå› æ­¤ï¼Œbin log åœ¨ä»åº“æ‰§è¡Œçš„æ—¶å€™ï¼Œå¯èƒ½å‡ºç°ä¸‹é¢çš„æƒ…å†µï¼š\nå¯¹äºä¸»åº“ï¼šäº‹åŠ¡ä¸€å…ˆå†™å…¥ä¸€æ¡ version=16çš„è®°å½•ï¼Œäº‹åŠ¡äºŒåå†™å…¥ä¸€æ¡ version=10000 çš„è®°å½•ï¼› å¯¹äºä»åº“ï¼šäº‹åŠ¡äºŒå…ˆå†™å…¥ä¸€æ¡ version=10000 çš„è®°å½•ï¼Œäº‹åŠ¡ä¸€åå†™å…¥ä¸€æ¡ version=10001 çš„è®°å½•ï¼›âœ˜ åº“ è®°å½• é¢„æœŸç»“æœ å®é™…ç»“æœ ä¸»åº“ è®°å½•ä¸€ version=16 version=16 ä¸»åº“ è®°å½•äºŒ version=10000 version=10000 ä»åº“ è®°å½•ä¸€ version=16 version=10000 ä»åº“ è®°å½•äºŒ version=10000 version=10001 Reference https://dev.mysql.com/doc/refman/8.0/en/innodb-locks-set.html https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html https://dev.mysql.com/doc/refman/8.0/en/innodb-locking-reads.html https://forums.mysql.com/read.php?22,689892,689892#msg-689892 MySQL8.0ä¹‹é”äº‹ MySQLé”çš„æ€»ç»“ å’Œ ä¸€æ¬¡æ’å…¥æ„å‘é”çš„æ­»é”è¿˜åŸåˆ†æ ","date":"2022-12-26T11:47:21+08:00","permalink":"https://zhumengzhu.github.io/2022/12/insert-into-t-select-from-s-where-conditional-query/","title":"INSERT INTO T SELECT ... FROM S WHERE ... è¯­å¥åŠ é”åˆ†æ"},{"content":"ç®€ä»‹ æœ¬æ–‡ä»ã€ä¼˜æƒ åˆ¸å‘æ”¾ã€é—®é¢˜çš„è®¨è®ºå‡ºå‘ï¼Œä»‹ç»å‡ ä¸ªè§£å†³æ–¹æ¡ˆå¹¶åˆ†æå…¶ä¼˜ç¼ºç‚¹ï¼Œç„¶åè®¨è®ºä¸€ä¸‹å¸¸è§çš„update just one unused rowæ¨¡å¼ï¼Œæœ€åèŠä¸€ä¸‹ MySQL 8.0.1 çš„ SKIP LOCKED å’Œ NOWAIT ç‰¹æ€§ã€‚\nã€åˆ¸å‘æ”¾ã€é—®é¢˜ åˆ¸å‘æ”¾ï¼Œä¸€èˆ¬ä½¿ç”¨ã€é¢„ç”Ÿæˆã€æ¨¡å¼ã€‚åœ¨å‘æ”¾å‰ï¼Œå…ˆå°†åˆ¸å…¨éƒ¨ç”Ÿæˆå¥½ï¼Œå­˜åœ¨ä¸€å¼ å…¨è¡¨ï¼Œè¿™å¼ è¡¨ä¸€èˆ¬è‡³å°‘åŒ…å«ä¸‰ä¸ªå­—æ®µï¼š\nä¸€ä¸ªå…¨å±€å”¯ä¸€çš„åˆ¸ç å­—æ®µï¼› ä¸€ä¸ªçŠ¶æ€å­—æ®µè¡¨ç¤ºæ˜¯å¦å‘æ”¾ï¼› ä¸€ä¸ªç”¨æˆ· ID å­—æ®µè®°å½•åˆ¸å‘ç»™äº†è°ï¼› å½“ç”¨æˆ·è¯·æ±‚é¢†åˆ¸æ—¶ï¼Œä¼šä»è¡¨ä¸­é€‰æ‹©ä¸€æ¡çŠ¶æ€ä¸ºã€æœªé¢†å–ã€çš„è®°å½•ï¼Œå°†å…¶çŠ¶æ€ç½®ä¸ºã€å·²é¢†å–ã€ï¼Œç”¨æˆ· IDç½®ä¸ºã€é¢†åˆ¸è€…çš„ IDã€ï¼Œæœ€åå°†åˆ¸ç è¿”ç»™ç”¨æˆ·ã€‚\nå‡è®¾åˆ¸è¡¨ç»“æ„å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 CREATE TABLE `coupon` ( `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT \u0026#39;ä¸»é”®id\u0026#39;, `code` VARCHAR(64) NOT NULL DEFAULT \u0026#39;\u0026#39; COMMENT \u0026#39;å”¯ä¸€åŠµç \u0026#39;, `status` TINYINT(10) NOT NULL DEFAULT 0 COMMENT \u0026#39;åŠµçŠ¶æ€, 0: æœªé¢†å–ï¼Œ1ï¼šå·²é¢†å–ï¼Œ2ï¼šå·²æ ¸é”€\u0026#39;, `user_id` BIGINT(20) NOT NULL DEFAULT 0 COMMENT \u0026#39;ç”¨æˆ· ID\u0026#39;, `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, PRIMARY KEY (`id`), UNIQUE KEY `uk_code` (`code`), KEY `idx_status` (`status`) ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COMMENT =\u0026#39;ä¼˜æƒ åˆ¸è¡¨\u0026#39;; åˆ¸è¡¨ä¸­çš„æ•°æ®å¦‚ä¸‹ï¼š\nID CODE status user_id 1 c1 0 0 2 c2 0 0 3 c3 0 0 4 c4 0 0 5 c5 0 0 å‡è®¾é¢†åˆ¸çš„ç”¨æˆ· ID ä¸º 1000ã€‚\næ–¹æ³•ä¸€ï¼šä¹è§‚é”-CAS 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # 1ã€é€‰æ‹©ä¸€å¼ åˆ¸ï¼Œå‡è®¾é€‰ä¸­çš„åˆ¸ç ä¸º `c1`ï¼› SELECT * FROM coupon WHERE `status` = 0 LIMIT 1; # 2ã€ä¿®æ”¹åˆ¸è®°å½•çš„çŠ¶æ€ UPDATE coupon SET `status` = 1, `user_id` = 1000 WHERE `code` = \u0026#39;c1\u0026#39; AND `status` = 0; # 3ã€è¿”å›åˆ¸ç  `c1` ä¸Šè¿°æ–¹æ³•ï¼Œåœ¨å¹¶å‘æƒ…å†µä¸‹å¯èƒ½å­˜åœ¨é—®é¢˜ï¼š\næ“ä½œé¡ºåº çº¿ç¨‹ä¸€ çº¿ç¨‹äºŒ 1 SELECT * FROM coupon WHERE status = 0 LIMIT 1; # å‡è®¾è¿”å›è®°å½•åˆ¸ç ä¸º c1 2 SELECT * FROM coupon WHERE status = 0 LIMIT 1; # å‡è®¾è¿”å›è®°å½•åˆ¸ç ä¹Ÿæ˜¯ c1 3 UPDATE coupon SET status = 1, user_id = 1000 WHERE code = \u0026lsquo;c1\u0026rsquo; AND status = 0; # æˆåŠŸ 4 UPDATE coupon SET status = 1, user_id = 1000 WHERE code = \u0026lsquo;c1\u0026rsquo; AND status = 0; # å¤±è´¥ ç”±äºçº¿ç¨‹ä¸€æ‰§è¡Œå®Œç¬¬ä¸‰æ­¥åï¼Œå·²å°†c1è¿™æ¡è®°å½•çš„statusçš„å€¼æ”¹ä¸º 1ï¼Œå› æ­¤çº¿ç¨‹äºŒæ‰§è¡Œç¬¬å››æ­¥ä¼šå¤±è´¥ã€‚æ‰€ä»¥éœ€è¦é‡è¯•ã€‚\nè¿™å¯ä»¥çœ‹åšä¸€ç§ã€ä¹è§‚é”ã€æ¨¡å¼ï¼Œã€ä¹è§‚é”ã€ä¸é€‚åˆé«˜å¹¶å‘åœºæ™¯ã€‚\næ–¹æ³•äºŒï¼šæ‚²è§‚é”-SELECT FOR UPDATE 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # 1ã€å¼€å¯äº‹åŠ¡ï¼ˆInnoDB é»˜è®¤çš„ RR çº§åˆ«ï¼‰ begin; # 2ã€é€‰æ‹©ä¸€å¼ åˆ¸ï¼Œå‡è®¾é€‰ä¸­çš„åˆ¸ç ä¸º `c1`ï¼› SELECT * FROM coupon WHERE `status` = 0 LIMIT 1 FOR UPDATE; # 3ã€ä¿®æ”¹åˆ¸è®°å½•çš„çŠ¶æ€ UPDATE coupon SET `status` = 1, `user_id` = 1000 WHERE `code` = \u0026#39;c1\u0026#39; AND `status` = 0; # 4ã€æäº¤äº‹åŠ¡ commit; # 5ã€è¿”å›åˆ¸ç  `c1` ä¸ºäº†è§£å†³å¹¶å‘çš„æƒ…å†µä¸‹æŸä¸ªæ“ä½œå¤±è´¥ï¼Œ å¯ä»¥å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œç„¶åä½¿ç”¨ select for update å…ˆå¯¹è®°å½•è¿›è¡ŒåŠ é”ï¼Œç„¶åå†ä¿®æ”¹è®°å½•çŠ¶æ€ã€‚ å‡è®¾æ“ä½œé¡ºåºå¦‚ä¸‹ï¼š\næ“ä½œé¡ºåº çº¿ç¨‹ä¸€ çº¿ç¨‹äºŒ 1 begin; 2 begin; 3 SELECT * FROM coupon WHERE status = 0 LIMIT 1 FOR UPDATE; # å‡è®¾è¿”å›è®°å½•åˆ¸ç ä¸º c1 4 SELECT * FROM coupon WHERE status = 0 LIMIT 1 FOR UPDATE; # é˜»å¡ 5 UPDATE coupon SET status = 1, user_id = 1000 WHERE code = \u0026lsquo;c1\u0026rsquo; AND status = 0; # æˆåŠŸ 6 commit; # é‡Šæ”¾è®°å½•c1çš„é” 7 SELECT * FROM coupon WHERE status = 0 LIMIT 1; # æˆåŠŸï¼Œè¿”å›åˆ¸ç  c2 8 UPDATE coupon SET status = 1, user_id = 1000 WHERE code = \u0026lsquo;c2\u0026rsquo; AND status = 0; # æˆåŠŸ 9 commit; # é‡Šæ”¾è®°å½•c2çš„é” çº¿ç¨‹äºŒåœ¨æ‰§è¡Œç¬¬ 4 æ­¥æ—¶ï¼Œç”±äºçº¿ç¨‹ä¸€å·²ç»æŠ¢åˆ°è®°å½•c1çš„é”ï¼Œçº¿ç¨‹äºŒä¼šè¢«é˜»å¡ï¼Œç›´åˆ°çº¿ç¨‹ä¸€æäº¤äº‹åŠ¡ï¼ˆ æ ¹æ®2PLï¼Œæäº¤äº‹åŠ¡æ—¶æ‰ä¼šé‡Šæ”¾é”ï¼‰ï¼›çº¿ç¨‹äºŒåœ¨ 7 æ­¥è·å–é”åï¼Œç”±äºè®°å½•c1çš„statusçš„å€¼å·²è¢«çº¿ç¨‹ä¸€æ”¹ä¸º 1ï¼Œæ‰€ä»¥æ­¤æ—¶æŸ¥è¯¢åˆ°çš„è®°å½•æ˜¯c2ã€‚\næ–¹æ³•äºŒè™½ç„¶å¯ä»¥ä¿è¯åˆ¸å‘æ”¾ä¸ä¼šå¤±è´¥ï¼Œä½†åœ¨é«˜å¹¶å‘ä¸‹ï¼Œä¼šæœ‰å¤§é‡çº¿ç¨‹é˜»å¡ã€‚\næ–¹æ³•ä¸‰ï¼šä½¿ç”¨ LAST_INSERT_ID ä¼˜åŒ–é”çš„æŒæœ‰æ—¶é—´ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # 1ã€å°†çŠ¶æ€ä¸ºæœªé¢†å–çš„ä¸€å¼ åˆ¸å‘æ”¾ç»™ç”¨æˆ· UPDATE coupon SET `status` = 1, `user_id` = 1000, `id` = LAST_INSERT_ID(`id`) WHERE `status` = 0 LIMIT 1; # 2ã€æŸ¥è¯¢æ­¥éª¤ 1 ä¿®æ”¹çš„åˆ¸çš„ IDï¼Œå‡è®¾ id ä¸º 1 SELECT LAST_INSERT_ID(); # 3ã€æŸ¥è¯¢åˆ¸ç ï¼Œå‡è®¾åˆ¸ç å€¼ä¸º `c1` SELECT `code` FROM coupon WHERE id = 1; # 4ã€è¿”å›åˆ¸ç  `c1` æ–¹æ³•äºŒä¸­ï¼Œæ ¹æ® 2PLï¼ˆä¸¤é˜¶æ®µé”åè®®ï¼‰ï¼Œé”çš„æŒæœ‰æ—¶é—´ä» select for update ä¸€ç›´æŒç»­åˆ° commitã€‚ é€šè¿‡ä½¿ç”¨ LAST_INSERT_ID å¯ä»¥é¿å…å¼€å¯äº‹åŠ¡ï¼Œé”çš„æŒæœ‰æ—¶é—´éå¸¸çŸ­ã€‚\nä¸è¿‡è¿™ä¸ªæ–¹æ³•æ²¡æ³•é¿å…é”äº‰æŠ¢ï¼Œå› ä¸ºæ ¹æ® InnoDB çš„é”æœºåˆ¶ï¼Œåœ¨æ‰«æåˆ°æ»¡è¶³æ¡ä»¶çš„è®°å½•æ—¶ä¼šè¿›è¡ŒåŠ é”(ç”±äº idx_status æ˜¯éå”¯ä¸€ç´¢å¼•ï¼Œå› æ­¤ä¼šåŠ  next-key é”) ï¼Œæ‰€ä»¥å¹¶å‘æ‰§è¡Œæ—¶ä»ç„¶ä¼šå­˜åœ¨é˜»å¡çš„æƒ…å†µã€‚\nè¿™å…¶å®å°±æ˜¯ç»å…¸çš„**ã€çƒ­ç‚¹æ•°æ®æ›´æ–°ã€**é—®é¢˜ã€‚\næ­¤å¤–ï¼Œè¦è¿™ä¸ªæ–¹æ³•æ˜¯ multi-user safe çš„ï¼Œæ‰€ä»¥åœ¨å¹¶å‘æƒ…å†µä¸‹ä¹Ÿæ˜¯å®‰å…¨çš„:\nIt is multi-user safe because multiple clients can issue the UPDATE statement and get their own sequence value with the SELECT statement (or mysql_insert_id()), without affecting or being affected by other clients that generate their own sequence values.\nsee MySQL 8.0 Reference Manual\næœ€åï¼Œè¿˜å¯ä»¥å¯¹ä¸Šé¢çš„ SQL è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œä½¿å¾—åªéœ€æ‰§è¡Œ 2 æ¬¡ SQLï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # 1ã€å°†çŠ¶æ€ä¸ºæœªé¢†å–çš„ä¸€å¼ åˆ¸å‘æ”¾ç»™ç”¨æˆ· UPDATE coupon SET `status` = 1, `user_id` = 1000, `id` = LAST_INSERT_ID(`id`) WHERE `status` = 0 LIMIT 1; # 2ã€æŸ¥è¯¢åˆ¸ç  SELECT `code` FROM coupon, (SELECT LAST_INSERT_ID() id) AS t WHERE coupon.id = t.id; # 3ã€è¿”å›åˆ¸ç  `c1` æ–¹æ³•å››ï¼šä½¿ç”¨ SKIP LOCKED é¿å…é”äº‰æŠ¢ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # 1ã€å¼€å¯äº‹åŠ¡ï¼ˆInnoDB é»˜è®¤çš„ RR çº§åˆ«ï¼‰ begin; # 2ã€æ˜¯ç”¨ `SELECT FOR UPDATE SKIP LOCKED` é€‰æ‹©ä¸€æ¡åˆ¸ SELECT * FROM coupon WHERE `status` = 0 LIMIT 1 FOR UPDATE SKIP LOCKED; # 3ã€ä¿®æ”¹åˆ¸è®°å½•çš„çŠ¶æ€ UPDATE coupon SET `status` = 1, `user_id` = 1000 WHERE `code` = \u0026#39;c1\u0026#39; AND `status` = 0; # 4ã€æäº¤äº‹åŠ¡ commit; # 5ã€è¿”å›åˆ¸ç  `c1` å‡è®¾æ“ä½œé¡ºåºå¦‚ä¸‹ï¼š\næ“ä½œé¡ºåº çº¿ç¨‹ä¸€ çº¿ç¨‹äºŒ 1 begin; 2 begin; 3 SELECT * FROM coupon WHERE status = 0 LIMIT 1 FOR UPDATE SKIP LOCKED; # å‡è®¾è¿”å›è®°å½•åˆ¸ç ä¸º c1 4 SELECT * FROM coupon WHERE status = 0 LIMIT 1 FOR UPDATE SKIP LOCKED; # æˆåŠŸï¼Œè¿”å›åˆ¸ç  c2 5 UPDATE coupon SET status = 1, user_id = 1000 WHERE code = \u0026lsquo;c1\u0026rsquo; AND status = 0; # æˆåŠŸ 6 commit; # é‡Šæ”¾è®°å½•c1çš„é” 8 UPDATE coupon SET status = 1, user_id = 1000 WHERE code = \u0026lsquo;c2\u0026rsquo; AND status = 0; # æˆåŠŸ 9 commit; # é‡Šæ”¾è®°å½•c2çš„é” ä¸åŒäºæ–¹æ³•äºŒï¼Œçº¿ç¨‹äºŒåœ¨æ‰§è¡Œç¬¬ 4 æ­¥æ—¶ï¼Œä¸ä¼šé˜»å¡åœ¨è®°å½•c1ä¸Šï¼Œè€Œæ˜¯ä¼šè·³è¿‡è¿™æ¡è®°å½•ï¼Œç›´æ¥å¯¹ä¸‹ä¸€æ¡è®°å½•c2è¿›è¡ŒåŠ é”ã€‚\nè¿™ä¸ªæ–¹æ³•ï¼Œé”çš„æŒæœ‰æ—¶é—´ä¸æ–¹æ³•äºŒç›¸åŒï¼Œä½†é¿å…äº†äº‰æŠ¢é”ï¼Œä¹Ÿèƒ½è¾¾åˆ°ä¸€ä¸ªå¾ˆå¥½çš„æ€§èƒ½ã€‚\næ³¨æ„ï¼ŒSKIP LOCKED æ˜¯ MySQL 8.0.1 å¼•å…¥çš„æ–°ç‰¹æ€§ã€‚\næ–¹æ³•äº”ï¼šä½¿ç”¨ Redis å‡å°‘ SQL çš„æ‰§è¡Œæ¬¡æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # 0ã€åˆå§‹åŒ– Redis: åœ¨æ´»åŠ¨å¼€å§‹å‰ï¼Œå…ˆä»æ•°æ®åº“ä¸­æŸ¥è¯¢æ‰€æœ‰æœªå‘æ”¾åˆ¸çš„åˆ¸ç ï¼Œæ”¾å…¥ Redis ä¸­çš„é˜Ÿåˆ—ä¸­ LPUSH coupon_list_key (SELECT code from coupon WHERE status = 0) # 1ã€å‘æ”¾æ—¶ï¼Œä» Redis é˜Ÿåˆ—ä¸­ç§»é™¤å¹¶è¿”å›ä¸€ä¸ªåˆ¸ç ï¼Œå‡è®¾å€¼ä¸º`c1` LPOP coupon_list_key # 2ã€ä¿®æ”¹åˆ¸è®°å½•çš„çŠ¶æ€ UPDATE coupon SET `status` = 1, `user_id` = 1000 WHERE `code` = \u0026#39;c1\u0026#39; AND `status` = 0; # 3ã€è¿”å›åˆ¸ç  `c1` ä½¿ç”¨ Redisï¼Œæ—¢èƒ½ä¿è¯æ­£ç¡®æ€§ï¼Œä¹Ÿæœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œå› ä¸ºï¼š\nRedis æ˜¯å•çº¿ç¨‹æ‰§è¡Œå‘½ä»¤çš„ï¼Œå› æ­¤ä» Redis è¿”å›çš„åˆ¸ç æ˜¯å”¯ä¸€çš„ï¼Œæ‰§è¡Œç¬¬ 2 æ­¥ä¸ä¼šäº‰æŠ¢é”ä¹Ÿä¸ä¼šå¤±è´¥ï¼› LPOP å‘½ä»¤æ˜¯ä»é˜Ÿåˆ—å¤´ç§»é™¤ä¸€ä¸ªå…ƒç´ ï¼Œæ—¶é—´å¤æ‚åº¦ä»…ä¸º O(1)ï¼› ä»…éœ€è¦æ‰§è¡Œä¸€æ¡ UPDATE è¯­å¥ï¼› é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡å¼•å…¥ MQ å°† UPDATE è¯­å¥æ”¹ä¸ºå¼‚æ­¥æ‰§è¡Œï¼Œè¿›ä¸€æ­¥æé«˜å¹¶å‘åº¦ã€‚\nä¸è¿‡ï¼Œå¼•å…¥ Redis ä¼šä½¿å¾—ç³»ç»Ÿå˜å¾—æ›´å¤æ‚ï¼Œå› ä¸ºï¼š\néœ€è¦é¢å¤–ç¼–å†™ä¸€ä¸ªæ¨¡å—ç”¨æ¥åˆå§‹åŒ– Redisï¼› åœ¨åˆå§‹åŒ– Redis è¦ç‰¹åˆ«å°å¿ƒï¼Œä¸èƒ½å°†ã€å·²å‘æ”¾ã€çš„åˆ¸æ”¾å…¥ Redisï¼› ä» Redis å‡ºé˜ŸæˆåŠŸï¼Œä½†å†™æ•°æ®åº“å¤±è´¥ï¼Œä¼šå¯¼è‡´åˆ¸ç è¢«æµªè´¹ï¼Œéœ€è¦å›æ»š Redisï¼› å›æ»š Redis å¯èƒ½å®ç°èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œå› ä¸ºå°†åˆ¸ç æ”¾å› Redis æ—¶å¯èƒ½å¤±è´¥ï¼Œéœ€è¦é‡è¯•æœºï¼› Redis ä¸»ä»åŒæ­¥å¯èƒ½å­˜åœ¨å»¶è¿Ÿï¼Œæ­¤æ—¶ä¸»ä»åˆ‡æ¢å¯èƒ½å¯¼è‡´ Redis è¿”å›é‡å¤çš„åˆ¸ç ï¼Œå¯¼è‡´æ–¹æ³•å¤±è´¥ï¼Œéœ€è¦é‡è¯•æœºåˆ¶ï¼› å°èŠ‚ æ–¹æ³•ä¸€å’Œæ–¹æ³•äºŒä¸é€‚åˆé«˜å¹¶å‘åœºæ™¯ï¼Œå‰è€…å¤±è´¥ç‡é«˜ï¼Œåè€…æ€§èƒ½ç‰¹åˆ«å·®ï¼› æ–¹æ³•ä¸‰æŒæœ‰é”çš„æ—¶é—´å¾ˆçŸ­ï¼Œæ€§èƒ½æ¯”è¾ƒå¥½ï¼Œå®ç°ä¹Ÿå¾ˆç®€å•ï¼Œä½†å­˜åœ¨çƒ­ç‚¹æ•°æ®æ›´æ–°é—®é¢˜ï¼› æ–¹æ³•å››æŒæœ‰é”çš„æ—¶é—´ç¨é•¿ï¼Œå› ä¸ºé”çš„æ˜¯ä¸åŒçš„è®°å½•ï¼Œå› æ­¤ä¸å­˜åœ¨çƒ­ç‚¹æ•°æ®ï¼Œæ€§èƒ½æ¯”è¾ƒå¥½ï¼Œå®ç°ä¹Ÿç®€å•ï¼Œä½†åªèƒ½åœ¨ MySQL 8.0.1 åŠä»¥ä¸Šæ‰èƒ½ä½¿ç”¨ï¼› æ–¹æ³•äº”å¼•å…¥ Redisï¼Œåœ¨æ€§èƒ½ä¸Šæœ‰æœ€å¤§çš„æ½œåŠ›ï¼Œä½†å®ç°èµ·æ¥æ›´å¤æ‚ï¼› æ–¹æ³•ä¸‰ã€å››ã€äº”å­°ä¼˜å­°åŠ£ï¼Œç•™å¾…å®è·µè¿›è¡Œæ£€éªŒã€‚\nUpdate just one unused row ä»…æ›´æ–°ä¸€è¡Œæœªä½¿ç”¨çš„æ•°æ®ï¼Œæ˜¯ä¸€ç§éå¸¸å¸¸è§çš„åœºæ™¯ï¼Œçœ‹ä¼¼éå¸¸å®¹æ˜“è§£å†³ï¼š\n1 2 3 4 5 # ä¹è§‚é” CAS æ›´æ–° UPDATE record SET `status` = \u0026#39;used\u0026#39; WHERE `status` = \u0026#39;unused\u0026#39; LIMIT 1; ä½†å½“æˆ‘ä»¬éœ€è¦è·å–è¢«æ›´æ–°æ•°æ®çš„ ID æ—¶ï¼Œé—®é¢˜ç¬é—´å˜å¾—å¤æ‚èµ·æ¥ã€‚\nè·å–å˜æ›´ IDï¼Œé™¤äº†ä¸Šé¢ä»‹ç»çš„ä½¿ç”¨æ‚²è§‚é”SELECT FOR UPDATEå’ŒLAST_INSERT_IDä¸¤ä¸ªæ–¹æ³•å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡ä¸´æ—¶å˜é‡æ¥å®ç°ï¼š\nSET @update_id := 0; UPDATE some_table SET column_name = \u0026lsquo;value\u0026rsquo;, id = (SELECT @update_id := id) WHERE some_other_column = \u0026lsquo;blah\u0026rsquo; LIMIT 1; SELECT @update_id;\nè¯¦æƒ…è§ï¼šHow to get ID of the last updated row in MySQL?:\nè¿™ç§æ–¹æ³•åœ¨éœ€è¦ä¸€æ¬¡æ›´æ–°å¤šæ¡è®°å½•æ—¶ç‰¹åˆ«æœ‰ç”¨ã€‚\nMySQL 8.0.1 SKIP LOCKED and NOWAIT æ¨èä¸€ç¯‡æ–‡ç« ï¼šMySQL 8.0.1: Using SKIP LOCKED and NOWAIT to handle hot rows è¿™ç¯‡æ–‡ç« æ˜¯åœ¨ 2017 å¹´ 4 æœˆ 12 ç”± Martin Hansson å‘å¸ƒåœ¨ MySQL å®˜æ–¹åšå®¢ä¸Šçš„ã€‚å®ƒä¸»è¦æ˜¯é€šè¿‡ä¸€ä¸ªè®¢ç¥¨ç³»ç»Ÿï¼Œè®²è§£ SKIP LOCKED å’Œ NOWAIT çš„ä½¿ç”¨æ–¹æ³•ã€‚\nå¦å¤–ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ï¼š\nStatements that use NOWAIT or SKIP LOCKED are unsafe for statement based replication.\nReference https://dba.stackexchange.com/questions/131051/update-just-one-unused-row https://stackoverflow.com/questions/1388025/how-to-get-id-of-the-last-updated-row-in-mysql https://gist.github.com/PieterScheffers/189cad9510d304118c33135965e9cddb https://dev.mysql.com/blog-archive/mysql-8-0-1-using-skip-locked-and-nowait-to-handle-hot-rows/ https://dev.mysql.com/doc/refman/8.0/en/information-functions.html#function_last-insert-id https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html ","date":"2022-11-20T17:21:39+08:00","permalink":"https://zhumengzhu.github.io/2022/11/mysql-update-just-one-unused-row/","title":"MySQL ä¸­å¦‚ä½•å®ç°åªæ›´æ–°æœªä½¿ç”¨çš„ä¸€è¡Œæ•°æ®"},{"content":"èƒŒæ™¯ è¿™æ˜¯ä¸€ç¯‡åšå®¢é˜…è¯»ç¬”è®°ï¼ŒåŸåšå®¢Late row lookups: InnoDBå†™äº 2011 å¹´ï¼Œä½œè€…æ˜¯ä¸€ä¸ªå« Quassnoi çš„ä¿„ç½—æ–¯äººã€‚\nQuassnoi åœ¨ 2009 å¹´æ—¶å†™äº†ä¸€ç¯‡æ–‡ç« è®² MySQL Limit çš„æ€§èƒ½ä¼˜åŒ–(MySQL ORDER BY / LIMIT performance: late row lookups)ï¼Œåæ¥æœ‰è¯»è€…æäº†ä¸¤ä¸ªé—®é¢˜ï¼š\nIs this workaround specific to MyISAM engine? How does PostgreSQL handle this? Quassnoi å†™ä¸‹è¿™ç¯‡æ–°åšå®¢ï¼Œå³ä¸ºäº†å›ç­”ä¸Šè¿°ä¸¤ä¸ªé—®é¢˜ã€‚\næ­£æ–‡ The questions concerns a certain workaround for MySQL LIMIT â€¦ OFFSET queries like this:\n1 2 3 4 SELECT * FROM mytable ORDER BY id LIMIT 10 OFFSET 10000; which can be improved using a little rewrite:\n1 2 3 4 5 6 7 8 SELECT m.* FROM (SELECT id FROM mytable ORDER BY id LIMIT 10 OFFSET 10000) q JOIN mytable m ON m.id = q.id ORDER BY m.id; æ³¨æ„ï¼šä½œè€…ä¹‹å‰çš„æ–‡ç« è®¨è®ºçš„æ˜¯è¿™ä¸ªæ–¹æ³•å¯¹ MyISAM æ˜¯æœ‰æ•ˆçš„ï¼›é—®é¢˜æ˜¯ï¼Œå¯¹äº InnoDB å’Œ PostgreSQL å‘¢ï¼Ÿ\nPostgreSQL The Answer The second questions is easy: PostgreSQL won\u0026rsquo;t pull the fields from the table until it really needs them. If a query involving an ORDER BY along with LIMIT and OFFSET is optimized to use the index for the ORDER BY part, the table lookups won\u0026rsquo;t happen for the records skipped.\nè¿™å¥è¯æ˜¯è¯´ï¼ŒPostgreSQL åªä¼šåœ¨éœ€è¦çš„æ—¶å€™æ‰å›è¡¨æŸ¥è¯¢ã€‚å¦‚æœä¸€ä¸ªæŸ¥è¯¢æ¶‰åŠ ORDER BYã€LIMIT å’Œ OFFSETï¼Œé‚£ä¹ˆå¯ä»¥å…ˆåˆ©ç”¨ç´¢å¼•è·³è¿‡ä¸éœ€è¦çš„è®°å½•ï¼Œåªå¯¹éœ€è¦çš„è®°å½•è¿›è¡Œè¿›è¡Œå›è¡¨ã€‚\nè¿™å…¶å®å°±æ˜¯ã€Late Row Lookupsã€ï¼›ä¸ä¹‹ç›¸å¯¹çš„ï¼ŒMySQL æ‰§è¡Œçš„æ˜¯ã€Early Row Lookupsã€ã€‚\nä½œè€…åé¢è¯´è™½ç„¶ PostgreSQL çš„æŸ¥è¯¢è®¡åˆ’ä¸ä¼šè¾“å‡ºå›è¡¨ä¿¡æ¯ï¼Œä½†å¯ä»¥é€šè¿‡ä¸€ä¸ªç®€å•çš„æµ‹è¯•è¿›è¡ŒéªŒè¯ã€‚ä½†å…·ä½“æ€ä¹ˆè¿›è¡Œè¿™ä¸ªå®éªŒï¼Œä½œè€…æ²¡è®²ï¼Œä¸‹é¢è¯•ç€åšä¸ªè¡¥å……ã€‚\néªŒè¯(å­˜ç–‘) å»ºè¡¨è¯¦æƒ… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 -- å»ºè¡¨ CREATE TABLE page ( id SERIAL PRIMARY KEY, name VARCHAR(16) DEFAULT NULL, content VARCHAR(255) DEFAULT NULL ); -- ä¸º name å­—æ®µåˆ›å»ºäºŒçº§ç´¢å¼• CREATE INDEX idx_name ON page (name); -- åˆå§‹åŒ– 600 ä¸‡æ¡æ•°æ® INSERT INTO page (name, content) (SELECT CONCAT(\u0026#39;å°ç“¦\u0026#39;, s.id) AS name, CONCAT(\u0026#39;xx\u0026#39;, s.id) AS content FROM GENERATE_SERIES(1, 6000010) AS s(id)); æ‰§è¡Œ SQL ä¸€ï¼šç›´æ¥æŸ¥è¯¢ 1 2 3 4 5 6 7 postgres=# EXPLAIN ANALYZE SELECT * FROM page ORDER BY id OFFSET 6000000 LIMIT 10; QUERY PLAN ------------------------------------------------------------------------------------------------------------------------------------------ Limit (cost=199830.43..199830.76 rows=10 width=26) (actual time=540.002..540.003 rows=10 loops=1) -\u0026gt; Index Scan using page_pkey on page (cost=0.43..199846.81 rows=6000492 width=26) (actual time=0.087..427.982 rows=6000010 loops=1) Planning Time: 0.108 ms Execution Time: 540.022 ms æ‰§è¡Œ SQL äºŒï¼šä½¿ç”¨å­æŸ¥è¯¢ 1 2 3 4 5 6 7 8 9 10 11 postgres=# EXPLAIN ANALYZE SELECT t1.* FROM page t1, (SELECT id FROM page ORDER BY id OFFSET 6000000 LIMIT 10) t2 where t1.id=t2.id ORDER BY t1.id; QUERY PLAN ---------------------------------------------------------------------------------------------------------------------------------------------------- Nested Loop (cost=155811.47..155895.90 rows=10 width=26) (actual time=368.952..368.960 rows=10 loops=1) -\u0026gt; Limit (cost=155811.04..155811.30 rows=10 width=4) (actual time=368.941..368.942 rows=10 loops=1) -\u0026gt; Index Only Scan using page_pkey on page (cost=0.43..155823.81 rows=6000492 width=4) (actual time=0.015..248.584 rows=6000010 loops=1) Heap Fetches: 50 -\u0026gt; Index Scan using page_pkey on page t1 (cost=0.43..8.45 rows=1 width=26) (actual time=0.001..0.001 rows=1 loops=10) Index Cond: (id = page.id) Planning Time: 0.375 ms Execution Time: 369.004 ms æ‰§è¡Œ SQL ä¸‰ï¼šä½¿ç”¨å­æŸ¥è¯¢ 1 2 3 4 5 6 7 8 9 10 11 postgres=# EXPLAIN ANALYZE SELECT t1.* FROM page t1 join (SELECT id FROM page ORDER BY id OFFSET 6000000 LIMIT 10) t2 ON t1.id=t2.id ORDER BY t1.id; QUERY PLAN ---------------------------------------------------------------------------------------------------------------------------------------------------- Nested Loop (cost=155811.47..155895.90 rows=10 width=26) (actual time=362.645..362.652 rows=10 loops=1) -\u0026gt; Limit (cost=155811.04..155811.30 rows=10 width=4) (actual time=362.633..362.634 rows=10 loops=1) -\u0026gt; Index Only Scan using page_pkey on page (cost=0.43..155823.81 rows=6000492 width=4) (actual time=0.017..243.148 rows=6000010 loops=1) Heap Fetches: 50 -\u0026gt; Index Scan using page_pkey on page t1 (cost=0.43..8.45 rows=1 width=26) (actual time=0.001..0.001 rows=1 loops=10) Index Cond: (id = page.id) Planning Time: 4.609 ms Execution Time: 362.707 ms ä¸‰ä¸ªæŸ¥è¯¢çš„è€—æ—¶ä¸ºï¼š`540.022 ms` vs `369.004 ms` vs `362.707 ms`ã€‚ \u003e Tips: ä½¿ç”¨ `EXPLAIN ANALYZE` æ—¢å¯ä»¥è·å¾—æŸ¥è¯¢è®¡åˆ’ï¼Œåˆèƒ½æ‰§è¡Œè¯­å¥ã€‚ ç»“è®º ä¸Šè¿°å®éªŒå¯ä»¥è¯æ˜è¯¥ä¼˜åŒ–å¯¹äº PostgreSQL åŒæ ·å¯ä»¥æœ‰æ•ˆã€‚\nInnoDB ä¸ºäº†å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œä½œè€…é¦–å…ˆåˆ›å»ºäº†ä¸€å¼ è¡¨ã€‚\nå»ºè¡¨ å»ºè¡¨è¯¦æƒ… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 # åˆ›å»ºä¸€å¼ å†…å­˜è¡¨ CREATE TABLE filler ( id INT NOT NULL PRIMARY KEY AUTO_INCREMENT ) ENGINE = Memory; # åˆ›å»º InnoDB è¡¨ CREATE TABLE lookup ( id INT NOT NULL PRIMARY KEY, value INT NOT NULL, shorttxt TEXT NOT NULL, longtxt TEXT NOT NULL ) ENGINE = InnoDB ROW_FORMAT = COMPACT; # ä¸º value å­—æ®µåˆ›å»ºç´¢å¼• CREATE INDEX ix_lookup_value ON lookup (value); # åˆ›å»ºå­˜å‚¨è®¡åˆ’ DELIMITER $$ CREATE PROCEDURE prc_filler(cnt INT) BEGIN DECLARE _cnt INT; SET _cnt = 1; WHILE _cnt \u0026lt;= cnt DO INSERT INTO filler SELECT _cnt; SET _cnt = _cnt + 1; END WHILE; END $$ # åˆå§‹åŒ–å†…å­˜è¡¨ DELIMITER ; START TRANSACTION; CALL prc_filler(100000); COMMIT; # åˆå§‹åŒ– InnoDB è¡¨ INSERT INTO lookup SELECT id, CEILING(RAND(20110211) * 1000000), RPAD(\u0026#39;\u0026#39;, CEILING(RAND(20110211 \u0026lt;\u0026lt; 1) * 100), \u0026#39;*\u0026#39;), RPAD(\u0026#39;\u0026#39;, CEILING(8192 + RAND(20110211 \u0026lt;\u0026lt; 1) * 100), \u0026#39;*\u0026#39;) FROM filler; ä¸Šé¢åˆ©ç”¨ä¸€å¼ å†…å­˜è¡¨å’Œå­˜å‚¨è®¡åˆ’åˆ›å»ºäº†ä¸€å¼  InnoDB è¡¨ `lookup`ï¼šè¿™å¼ è¡¨åŒ…å«ä¸€ä¸ªåŠ äº†ç´¢å¼•çš„ `INT` åˆ—ï¼Œä»¥åŠä¸¤ä¸ª `TEXT` åˆ—ï¼Œå…¶ä¸­ shorttxt å­˜å‚¨çŸ­å­—ç¬¦ä¸²(åŒ…å« 1~100 ä¸ªå­—ç¬¦)ï¼Œlongtxt å­˜å‚¨é•¿å­—ç¬¦ä¸²(åŒ…å« 8193~8293 ä¸ªå­—ç¬¦)ã€‚ é€šè¿‡ä¸»é”®ç´¢å¼•æŸ¥è¯¢ value å’Œ shottxt ä¸¤ä¸ªå­—æ®µæ—¶ï¼Œæ˜¯å¦ä½¿ç”¨å­æŸ¥è¯¢ä¼˜åŒ–å¯¹è€—æ—¶å½±å“ä¸å¤§ï¼Œç•¥å»ä¸è®¨è®ºã€‚\né€šè¿‡ä¸»é”®ç´¢å¼•æŸ¥è¯¢ longtxt åˆ— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Rewrite SELECT LENGTH(l.longtxt) FROM (SELECT id FROM lookup ORDER BY id LIMIT 10 OFFSET 90000) q JOIN lookup l ON l.id = q.id ORDER BY q.id; # 10 rows in set (0.133 sec) # No rewrite SELECT LENGTH(longtxt) FROM lookup ORDER BY id LIMIT 10 OFFSET 90000; # 10 rows in set (1.579 sec) 0.133 sec vs 1.579 secã€‚\nWhy such a difference?\nThe reason is that InnoDB, despite the fact it stores the data in the clustered index, is still able to move \u0026gt; some data out of the index. This is called external storage.\nåœ¨ InnoDB ä¸­ï¼Œå°äº 768 å­—èŠ‚çš„åˆ—ä¼šå…¨éƒ¨å­˜å‚¨åœ¨é¡µä¸Šï¼Œå¤§äº 768 å­—èŠ‚åˆ™ä¼šåˆ†å¼€å­˜å‚¨ã€‚åœ¨ä¸Šé¢çš„ lookup è¡¨ä¸­ï¼Œshottxt åˆ—æ€»æ˜¯ on-page å­˜å‚¨çš„ï¼Œè€Œ longtxt åˆ™æ˜¯ off-pageçš„ã€‚\nå› æ­¤ï¼Œç›´æ¥æŸ¥è¯¢ longtxt æ—¶ï¼Œæ¯æ‰«æä¸€æ¡è®°å½•éƒ½è¦å‡ºå‘ä¸¤æ¬¡page lookupsï¼šç¬¬ä¸€æ¬¡æŸ¥èšç°‡ç´¢å¼•ï¼Œç¬¬äºŒæ¬¡æŸ¥å¤–éƒ¨å­˜å‚¨ã€‚è¿™æ—¢ä¼šèŠ±è´¹å¾ˆå¤šæ—¶é—´ï¼Œä¹Ÿå¯èƒ½ç ´å InnoDB ç¼“å­˜ï¼Œå¯¼è‡´ç¼“å­˜å‘½ä¸­ç‡ä¸‹é™ã€‚\né€šè¿‡äºŒçº§ç´¢å¼•æŸ¥è¯¢ shorttxt åˆ— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # Rewrite SELECT LENGTH(l.shorttxt) FROM (SELECT id, value FROM lookup ORDER BY value LIMIT 10 OFFSET 90000) q JOIN lookup l ON l.id = q.id ORDER BY q.value; # 10 rows in set (0.022 sec) # No rewrite SELECT LENGTH(shorttxt) FROM lookup ORDER BY value LIMIT 10 OFFSET 90000;# 10 rows in set (0.209 sec) 0.022 sec vs 0.209 secï¼Œè€—æ—¶ç›¸å·® 10 å€ã€‚ InnoDBçš„äºŒçº§ç´¢å¼•æŸ¥è¯¢æœ‰ç‚¹ç±»ä¼¼MyISAMï¼Œéƒ½éœ€è¦ä¸€æ¬¡é¢å¤–çš„å›è¡¨æŸ¥è¯¢å»è·å–æ­£åœ¨çš„æ•°æ®ã€‚\nä¸Šé¢ç¬¬ä¸€ä¸ªæŸ¥è¯¢å¯¹äºè·³è¿‡çš„è®°å½•ä¸ä¼šæ‰§è¡Œå›è¡¨æŸ¥è¯¢ï¼Œå› æ­¤é€Ÿåº¦æ˜¯åŸæ¥çš„ 10 å€ã€‚å®ƒç”šè‡³æ¯”åœ¨ä¸»é”®ç´¢å¼•ä¸Šçš„æŸ¥è¯¢(0.044 sec)è¿˜å¿«ï¼ŒåŸå› æ˜¯äºŒçº§ç´¢å¼•åŒ…å«çš„æ•°æ®æ¯”ä¸»é”®ç´¢å¼•æ›´å°‘ï¼Œæ¯é¡µä¿å­˜çš„æ•°æ®æ›´å¤šï¼Œå› æ­¤ç´¢å¼•å¯èƒ½æ›´åŠ çŸ®èƒ–ï¼Œæ‰«æé€Ÿåº¦æ›´å¿«ã€‚\nå½“ç„¶ï¼ŒäºŒçº§ç´¢å¼•ä¸ŠåŒæ ·æ˜¯Early Row Lookupsã€‚\nç»“è®º A trick used to avoid early row lookups for the LIMIT â€¦ OFFSET queries is useful on InnoDB tables too, though to different extent, depending on the ORDER BY condition and the columns involved:\nIt\u0026rsquo;s very useful on queries involving columns stored off-page (long TEXT, BLOB and VARCHAR columns) It\u0026rsquo;s very useful on ORDER BY conditions served by secondary indexes It\u0026rsquo;s quite useful on moderate sized columns (still stored on page) or CPU-intensive expressions It\u0026rsquo;s almost useless on short columns without complex CPU-intensive processing å…¶å®ƒ PostgreSQLæŸ¥è¯¢è®¡åˆ’ é™¤ç¬¬ä¸€è¡Œä»¥å¤–æ¯ä¸ª-\u0026gt;è¡¨ç¤ºä¸€ä¸ªå­åŠ¨ä½œ æŸ¥è¯¢è®¡åˆ’çš„é˜…è¯»é¡ºåºéƒ½æ˜¯ä»åå¾€å‰ cost ç”± .. åˆ†å‰²æˆä¸¤ä¸ªæ•°å­—ï¼Œç¬¬ä¸€ä¸ªæ•°å­—è¡¨ç¤ºå¯åŠ¨æˆæœ¬ï¼Œå³è¿”å›ç¬¬ä¸€è¡Œçš„æˆæœ¬ï¼›ç¬¬äºŒä¸ªæ•°å­—è¡¨ç¤ºè¿”å›æ‰€æœ‰æ•°æ®çš„æˆæœ¬ã€‚ rows è¡¨ç¤ºè¿”å›è¡Œæ•° width è¡¨ç¤ºæ¯è¡Œå¹³å‡å®½åº¦ loops è¡¨ç¤ºç´¢å¼•æ‰«æè¢«æ‰§è¡Œè¿‡å‡ æ¬¡ Reference Documentation: 15: 14.1. Using EXPLAIN - PostgreSQL ","date":"2022-11-14T19:12:47+08:00","permalink":"https://zhumengzhu.github.io/2022/11/late-row-lookups-innodb/","title":"Late Row Lookups: InnoDB"},{"content":"ä¸€ã€æ·±åˆ†é¡µä¸ºä»€ä¹ˆæ…¢ æ·±åˆ†é¡µæŒ‡çš„æ˜¯å½¢å¦‚ select ... from ... where ... order by ... limit offset, size çš„æŸ¥è¯¢è¯­å¥ä¸­ offset ç‰¹åˆ«å¤§çš„æƒ…å†µã€‚é«˜æ€§èƒ½ MySQL(ç¬¬ä¸‰ç‰ˆ) çš„ç¬¬ 6.7.5 èŠ‚ä¸“é—¨è®²äº†æ­¤é—®é¢˜ï¼Œä½†æ¯”è¾ƒç®€ç•¥ã€‚\næœ‰å¤šæ…¢ å‡è®¾æœ‰ä¸€å¼  page è¡¨åŒ…å« 600 å¤šä¸‡æ¡æ•°æ®ï¼Œåˆ†åˆ«æ‰§è¡Œä¸‹é¢ä¸¤æ¡è¯­å¥ï¼š\n1 2 3 4 5 6 7 # SQL ä¸€ select * from page order by id limit 0, 10; # 10 rows in set (0.001 sec) # SQL äºŒ select * from page order by id limit 6000000, 10; # 10 rows in set (0.940 sec) æ³¨æ„åˆ° SQL äºŒå…¶å®æ˜¯æŒ‰ä¸»é”® ID æ’åºçš„(æ„å‘³ç€ä¸éœ€è¦è¿›è¡Œ filesortï¼Œç›´æ¥æŒ‰ä¸»é”®ç´¢å¼•é¡ºåºæ‰«æå³å¯)ï¼Œè€—æ—¶ä»ç„¶é«˜è¾¾ 0.940 ç§’ã€‚\nä¸ºä»€ä¹ˆæ…¢ ã€æŸ¥è¯¢è®¡åˆ’ã€\n1 2 3 4 5 6 explain select * from page order by id limit 6000000, 10; +------+-------------+-------+-------+---------------+---------+---------+------+---------+-------+ | id | select_type | table | type | possible_keys | key | key_len | ref | rows | Extra | +------+-------------+-------+-------+---------------+---------+---------+------+---------+-------+ | 1 | SIMPLE | page | index | NULL | PRIMARY | 4 | NULL | 5988448 | | +------+-------------+-------+-------+---------------+---------+---------+------+---------+-------+ ã€æ…¢æŸ¥è¯¢æ—¥å¿—ã€\n1 2 3 4 5 6 7 # Time: 221106 0:26:54 # User@Host: root[root] @ localhost [] # Thread_id: 18 Schema: test QC_hit: No # Query_time: 0.939618 Lock_time: 0.000735 Rows_sent: 10 Rows_examined: 6000010 # Rows_affected: 0 Bytes_sent: 533 SET timestamp=1667665614; select * from page order by id limit 6000000, 10; æ³¨æ„åˆ° rows å’Œ ä¸º rows_examined åˆ†åˆ«ä¸º 5988448ã€6000010ã€‚ åŸå› æ˜¾è€Œæ˜“è§ï¼šä¸ºäº†å®Œæˆ limit offset, size è¿™æ ·çš„æŸ¥è¯¢ï¼Œ MySQL è¦æ‰«æè‡³å°‘ offset + size è¡Œæ•°æ®ï¼›offset è¶Šå¤§ï¼Œåˆ™æ‰«ææ¬¡æ•°è¶Šå¤šï¼Œé€Ÿåº¦è¶Šæ…¢ã€‚\näºŒã€æ·±åˆ†é¡µæ€ä¹ˆä¼˜åŒ– åˆ†é¡µä»åŸç†ä¸Šæ¥è®²ï¼Œä¸»è¦æ˜¯ä¸¤ç§ï¼š\nä¸€ç§å°±æ˜¯å‰é¢è®²çš„åŸºäº limit offset, size çš„åˆ†é¡µï¼Œè‹±æ–‡ä¸€èˆ¬å« offset paginationï¼› å¦ä¸€ç§æ–¹æ³•æ”¾å¼ƒäº† offsetï¼Œæ”¹ç”¨ left off, SQL å½¢å¦‚ SELECT ... WHERE ... AND id \u0026lt; $left_off ORDER BY id DESC LIMIT 10, è‹±æ–‡ä¸€èˆ¬å« cursor pagination, ä¹Ÿæœ‰äººç§°ä¹‹ä¸º seek method æˆ– keyset paginationã€‚ Offset pagination å°±åƒåŸºäºæ¯”è¾ƒçš„æ’åºç®—æ³•çš„å¹³å‡æ—¶é—´å¤æ‚åº¦çš„ä¸‹ç•Œæ˜¯ O(nlogn) ä¸€æ ·ï¼Œå¯¹äº MySQL æ¥è¯´ï¼Œå‡¡æ˜¯å½¢å¦‚ limit offset, size çš„æŸ¥è¯¢ï¼Œæ‰«ææ¬¡æ•°çš„ä¸‹é™å°±æ˜¯ offset + sizeï¼Œæˆ‘ä»¬åªèƒ½å°½é‡é€¼è¿‘è¿™ä¸ªä¸‹é™ã€‚ ç”±äºåœ¨ä¸»é”®ç´¢å¼•ä¸Šçš„ä¼˜åŒ–æ¯”è¾ƒå¤æ‚ï¼ŒåŒæ ·çš„ SQL å¯¹äºä¸åŒçš„æ•°æ®è§„æ¨¡æ•ˆæœä¸ä¸€æ ·ï¼Œæš‚ä¸è®¨è®ºã€‚è¿™é‡Œä¸»è¦åˆ†æåœ¨äºŒçº§ç´¢å¼•ä¸Šçš„ä¼˜åŒ–ã€‚\nå¯¹äºæ‹¥æœ‰ 600 å¤šä¸‡æ¡æ•°æ®çš„ page è¡¨ï¼š\n1 2 3 4 5 6 7 8 9 10 -- åŸ SQL(å¼ºåˆ¶èµ°äºŒçº§ç´¢å¼•) select * from page force index(idx_name) order by name limit 6000000, 10; # 10 rows in set (4.833 sec) -- ä¼˜åŒ–æ–¹æ¡ˆä¸€ select t1.* from page t1, (select id from page order by name limit 6000000, 10) t2 where t1.id = t2.id order by t1.name; # 10 rows in set (0.746 sec) -- ä¼˜åŒ–æ–¹æ¡ˆäºŒ select t1.* from page t1 join (select id from page order by name limit 6000000, 10) t2 on t1.id = t2.id order by t1.name; # 10 rows in set (0.741 sec) é€šè¿‡ä½¿ç”¨åˆ©ç”¨äº†è¦†ç›–ç´¢å¼•çš„å­æŸ¥è¯¢ï¼Œæ€§èƒ½æå‡çº¦ 80%~90%ï¼š\nKeyset pagination 1 2 3 4 # First page (latest 10 items): SELECT ... WHERE ... ORDER BY id DESC LIMIT 10 # Next page (second 10): SELECT ... WHERE ... AND id \u0026lt; $left_off ORDER BY id DESC LIMIT 10 ä¸‰ã€ä¼˜åŒ–ä¸ºä»€ä¹ˆæœ‰æ•ˆ ä¼˜åŒ–å‰ è€ƒè™‘åŸå§‹ SQL select * from page force index(idx_name) order by name limit 6000000, 10 çš„æ‰§è¡Œè¿‡ç¨‹ï¼š\né¦–å…ˆ Sever å±‚å‘ InnoDB è¯·æ±‚ç¬¬ä¸€æ¡æ•°æ®ï¼›InnoDB ä» idx_name ä¸Šè·å–ç¬¬ä¸€æ¡äºŒçº§ç´¢å¼•è®°å½•ï¼Œç„¶åæŸ¥è¯¢èšç°‡ç´¢å¼•è·å–å®Œæ•´è®°å½•(å³å›è¡¨æ“ä½œ)ï¼Œè¿”å›ç»™ Server å±‚; ç”±äºå­˜åœ¨ limit 6000000 çš„é™åˆ¶, Server å±‚ä¼šå°†è¯¥æ•°æ®ä¸¢å¼ƒå¹¶è®¡æ•°ï¼Œç„¶åå‘ InnoDB è¯·æ±‚ä¸‹ä¸€æ¡æ•°æ®ï¼› ä¸Šè¿°æ“ä½œé‡å¤ 600 ä¸‡æ¬¡ï¼› ä¹‹åçš„ç¬¬ 6000001~6000010 10 æ¡æ•°æ®åˆ™ä¼šè¢«æ”¾å…¥æœ¬åœ°ç½‘ç»œç¼“å†²åŒºï¼Œå‘ç»™å®¢æˆ·ç«¯ï¼› é—®é¢˜åœ¨ç¬¬ 1 æ­¥çš„å›è¡¨æ“ä½œï¼š\nå›è¡¨é¦–å…ˆæ„å‘³ç€å…ˆè¯»ä¸€æ¬¡äºŒçº§ç´¢å¼•ï¼Œç„¶åè¯»ä¸€æ¬¡èšç°‡ç´¢å¼•ï¼Œå› æ­¤è®°å½•çš„æ‰«ææ€»æ•°å®é™…ä¼šæ˜¯ 2 * 600 ä¸‡æ¬¡=1200 ä¸‡æ¬¡ï¼› å…¶æ¬¡ï¼Œå›è¡¨æ“ä½œå¯èƒ½éœ€è¦ä¸€æ¬¡ç£ç›˜éšæœºè¯»ï¼› ä¼˜åŒ–å å†è€ƒè™‘ä¼˜åŒ–åçš„ SQL select t1.* from page t1 join (select id from page order by name limit 6000000, 10) t2 on t1.id = t2.id order by t1.name çš„æ‰§è¡Œè¿‡ç¨‹ï¼š\né¦–å…ˆ Sever å±‚å‘ InnoDB è¯·æ±‚ç¬¬ä¸€æ¡æ•°æ®ï¼›InnoDB ä» idx_name ä¸Šè·å–ç¬¬ä¸€æ¡äºŒçº§ç´¢å¼•è®°å½•ï¼Œç„¶åæŸ¥è¯¢èšç°‡ç´¢å¼•è·å–å®Œæ•´è®°å½•(è¿™ä¸€æ“ä½œå«å›è¡¨)ï¼Œç„¶åå°†ä¸»é”® ID è¿”å›ç»™ Server å±‚; ç”±äºå­˜åœ¨ limit 6000000 çš„é™åˆ¶, Server å±‚ä¼šå°†è¯¥æ•°æ®ä¸¢å¼ƒå¹¶è®¡æ•°ï¼Œç„¶åå‘ InnoDB è¯·æ±‚ä¸‹ä¸€æ¡æ•°æ®ï¼› ä¸Šè¿°æ“ä½œé‡å¤ 600 ä¸‡æ¬¡ï¼› ä¹‹åçš„ç¬¬ 6000001~6000010 10 æ¡æ•°æ®åˆ™ä¼šè¢«æ”¾å…¥å†…å­˜ç¼“å†²åŒºï¼› æŸ¥è¯¢èšç°‡ç´¢å¼•ï¼Œè·å– 10 ä¸ªä¸»é”® ID å¯¹åº”çš„å®Œæ•´è®°å½•ï¼› æ€»ç»“ åœ¨ä¼˜åŒ–åï¼š\nè®°å½•çš„æ€»æ‰«ææ¬¡æ•°ä» 1200 ä¸‡æ¬¡ å‡å°‘åˆ° 600 ä¸‡é›¶ 10 æ¬¡ï¼› ç£ç›˜éšæœºè¯»çš„æ¬¡æ•°ä» 600 ä¸‡æ¬¡ å‡å°‘åˆ° 10 æ¬¡ï¼› å››ã€è¯•éªŒæ–¹æ³• å»ºè¡¨å’Œæ•°æ®åˆå§‹åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 -- å»ºè¡¨ CREATE TABLE `page` ( `id` INT(11) NOT NULL AUTO_INCREMENT, `name` VARCHAR(16) DEFAULT NULL, `content` VARCHAR(255) DEFAULT NULL, PRIMARY KEY (`id`), KEY `idx_name` (`name`) ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4; -- åˆ›å»ºå­˜å‚¨è¿‡ç¨‹ç”¨äºåˆå§‹åŒ–æ•°æ® DELIMITER ;; CREATE PROCEDURE init_page() BEGIN DECLARE i INT; SET i = 1; WHILE(i \u0026lt;= 6000010) DO INSERT INTO page (`name`, `content`) VALUES (CONCAT(\u0026#39;å°ç“¦\u0026#39;, i), CONCAT(\u0026#39;xx\u0026#39;, i)); SET i = i + 1; END WHILE; END;; DELIMITER ; -- è°ƒç”¨å­˜å‚¨è¿‡ç¨‹ CALL init_page(); å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿— 1 2 3 4 5 6 -- å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿— SET GLOBAL slow_query_log=1; -- å°†æ…¢æŸ¥è¯¢æ—¶é—´é˜ˆå€¼è®¾ç½®ä¸º 0.1 ç§’ SET GLOBAL long_query_time=0.1; -- æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—å SHOW VARIABLES LIKE \u0026#39;%slow_query%\u0026#39;; å¯¹æ¯” SQL 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 -- æ¢ç´¢ä¸€çº§ç´¢å¼• --- åŸºç¡€ SQL select * from page order by id limit 6000000, 10; --- æœ€æ…¢ select * from page where id \u0026gt;= (select id from page order by id limit 6000000, 1) order by id limit 10; --- æœ€å¿« select t1.* from page t1, (select id from page order by id limit 6000000, 10) t2 where t1.id = t2.id order by t1.id; -- æ¢ç´¢äºŒçº§ç´¢å¼• --- åŸºç¡€ SQLï¼Œä¼šæ˜¯å…¨è¡¨æ‰«æï¼Œæœ€æ…¢ select * from page order by name limit 6000000, 10; --- å¼ºåˆ¶èµ°äºŒçº§ç´¢å¼•ï¼Œç¨å¿« select * from page force index(idx_name) order by name limit 6000000, 10; --- åˆ©ç”¨ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•çš„å­æŸ¥è¯¢ï¼Œå‡å°‘å›è¡¨ï¼Œæœ€å¿« select t1.* from page t1, (select id from page order by name limit 6000000, 10) t2 where t1.id = t2.id order by t1.name; æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—å’Œæ•°æ®å­˜å‚¨ä½ç½® 1 2 3 4 5 6 # æŸ¥çœ‹ mysql è¿›ç¨‹å‚æ•° ps aux | grep mysql # /opt/homebrew/opt/mariadb/bin/mariadbd --basedir=/opt/homebrew/opt/mariadb --datadir=/opt/homebrew/var/mysql --plugin-dir=/opt/homebrew/opt/mariadb/lib/plugin --log-error=/opt/homebrew/var/mysql/zmz.local.err --pid-file=zmz.local.pid # --basedir=/opt/homebrew/opt/mariadb å³æ…¢æŸ¥è¯¢æ—¥å¿—å’Œæ•°æ®æ–‡ä»¶æ‰€åœ¨ç›®å½• # ps. æ‰§è¡Œå‰é¢çš„å­˜å‚¨è®¡åˆ’ï¼Œåˆ›å»º 100 ä¸‡æ¡æ•°æ®ï¼Œå ç”¨ç£ç›˜ç©ºé—´å¤§çº¦ 100MBï¼›åˆ›å»º 600 ä¸‡æ¡æ•°æ®ï¼Œå ç”¨ç©ºé—´å¤§çº¦ 600MBï¼› äº”ã€References mysqlæŸ¥è¯¢ limit 1000,10 å’Œlimit 10 é€Ÿåº¦ä¸€æ ·å¿«å—ï¼Ÿå¦‚æœæˆ‘è¦åˆ†é¡µï¼Œæˆ‘è¯¥æ€ä¹ˆåŠï¼Ÿ è¦æƒ³é€šè¿‡é¢è¯•ï¼ŒMySQLçš„Limitå­å¥åº•å±‚åŸç†ä½ ä¸å¯ä¸çŸ¥ MySQL Logical Architecture Mysql index configuration MySQL ORDER BY / LIMIT performance: late row lookups Late Row Lookups: InnoDB MySQL ORDER BY LIMIT Performance Optimization mysql è¯æ˜ä¸ºä»€ä¹ˆç”¨limitæ—¶ï¼Œoffsetå¾ˆå¤§ä¼šå½±å“æ€§èƒ½ MySQL 5.7 Reference Manual/LIMIT Query Optimization Pagination Optimization We need tool support for keyset pagination ","date":"2022-11-05T12:36:01+08:00","permalink":"https://zhumengzhu.github.io/2022/11/mysql-order-by-limit-performance-optimization/","title":"Mysql çš„æ·±åˆ†é¡µé—®é¢˜åŠä¼˜åŒ–æ–¹æ³•"},{"content":"å¸¸ç”¨å‘½ä»¤ hugo new site SITE_NAME ç”Ÿæˆé™æ€åšå®¢é¡¹ç›® hugo server å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨ï¼ŒåŠ ä¸Š -D å¯ä»¥æ¸²æŸ“ draft=true çš„æ–‡ç«  hugo new post/new-content.md åœ¨ post ä¸‹æ–°å»ºä¸€ç¯‡æ–‡ç«  hugo ç”Ÿæˆç«™ç‚¹é™æ€æ–‡ä»¶(public å’Œ resources ç›®å½•) hugo list drafts/expired/future åˆ—å‡ºè‰ç¨¿/è¿‡æœŸ/æœªæ¥çš„æ–‡ä»¶ è¸©å‘è®° ä½¿ç”¨ä¸»é¢˜ Event æ—¶, æ–‡ç« å¿…é¡»æ”¾åœ¨ content/**post**/ ç›®å½•ä¸‹, å¦åˆ™ Home é¡µä¸ä¼šå±•ç¤ºæ–‡ç« é“¾æ¥, æ–‡ç« å†…ä¹Ÿä¸ä¼šå±•ç¤ºç›®å½• ä½¿ç”¨ä¸»é¢˜ Zzo æ—¶, è¦åˆ›å»º Archive é¡µ(ç±»ä¼¼ Event ä¸­çš„ Home é¡µ), éœ€è¦åˆ›å»ºæ–‡ä»¶ content/archive/_index.md(å‚è€ƒ How to automatically generate archive page content #47) ä½¿ç”¨ä¸»é¢˜ Zzo æ—¶, åœ¨ GigHub Actions é…ç½®ä¸­å¿…é¡»å¯ç”¨ Hugo extended æ¨¡å¼, å¦åˆ™æ„å»ºä¼šå¤±è´¥(å‚è€ƒHugo setup) å‚è€ƒé“¾æ¥ Hugo å®˜æ–¹æ–‡æ¡£ Hugo ä»å…¥é—¨åˆ°ä¼šç”¨ Hugo æ­å»ºåšå®¢å®è·µ Hugo+Stack åšå®¢ä¿®æ”¹è®°å½• hugoå‡çº§ä¸hugo-theme-stackä¸»é¢˜ä¿®æ”¹ä¸æœ€åä¿®æ”¹æ—¶é—´é—®é¢˜ ","date":"2022-10-30T22:22:52+08:00","permalink":"https://zhumengzhu.github.io/2022/10/hugo-quick-start/","title":"Hugo é…ç½®è®°å½•"},{"content":"Mac å®¢æˆ·ç«¯ æ¨è V2rayU Terminal ä»£ç† 1 2 # .config/fish/config.fish alias all_proxy=\u0026#39;export http_proxy=http://127.0.0.1:1087;export https_proxy=http://127.0.0.1:1087;export ALL_PROXY=socks5://127.0.0.1:1080\u0026#39; git ssh ä»£ç† 1 2 3 4 # .ssh/config Host github.com User git ProxyCommand nc -v -x 127.0.0.1:1080 %h %p ","date":"2022-10-16T19:09:32+08:00","permalink":"https://zhumengzhu.github.io/2022/10/how-to-set-network-proxy/","title":"ä»£ç†è®¾ç½®"},{"content":"PromQL å‚è€ƒï¼šhttps://blog.csdn.net/han949417140/article/details/113513227\nå®˜ç½‘ï¼šhttps://prometheus.io/docs/prometheus/latest/querying/basics/\nhttps://grafana.com/docs/grafana/v7.5/panels/queries/ https://prometheus.fuckcloudnative.io/di-san-zhang-prometheus/di-4-jie-cha-xun/basics https://github.com/google/re2/wiki/Syntax åŸºæœ¬æ¦‚å¿µ - æ—¶é—´åºåˆ—(time-series) - æ ·æœ¬ - time-series æ˜¯æŒ‰ç…§æ—¶é—´æˆ³å’Œå€¼çš„åºåˆ—é¡ºåºå­˜æ”¾çš„ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºå‘é‡(vector) - æ¯æ¡ time-series é€šè¿‡æŒ‡æ ‡åç§°(metrics name)å’Œä¸€ç»„æ ‡ç­¾é›†(labelset)å‘½å - åœ¨time-seriesä¸­çš„æ¯ä¸€ä¸ªç‚¹ç§°ä¸ºä¸€ä¸ªæ ·æœ¬ï¼ˆsampleï¼‰ï¼Œæ ·æœ¬ç”±ä»¥ä¸‹ä¸‰éƒ¨åˆ†ç»„æˆï¼š - æŒ‡æ ‡(metric)ï¼šmetric nameå’Œæè¿°å½“å‰æ ·æœ¬ç‰¹å¾çš„labelsets; - æ—¶é—´æˆ³(timestamp)ï¼šä¸€ä¸ªç²¾ç¡®åˆ°æ¯«ç§’çš„æ—¶é—´æˆ³; - æ ·æœ¬å€¼(value)ï¼š ä¸€ä¸ªfloat64çš„æµ®ç‚¹å‹æ•°æ®è¡¨ç¤ºå½“å‰æ ·æœ¬çš„å€¼ã€‚ - æŒ‡æ ‡(Metric) - åœ¨å½¢å¼ä¸Šï¼Œæ‰€æœ‰çš„æŒ‡æ ‡(Metric)éƒ½é€šè¿‡å¦‚ä¸‹æ ¼å¼æ ‡ç¤ºï¼š - \u0026lt;metric name\u0026gt;{\u0026lt;label name\u0026gt;=\u0026lt;label value\u0026gt;, ...} - æŒ‡æ ‡çš„åç§°(metric name)å¯ä»¥åæ˜ è¢«ç›‘æ§æ ·æœ¬çš„å«ä¹‰ï¼ˆæ¯”å¦‚ï¼Œhttp_request_total - è¡¨ç¤ºå½“å‰ç³»ç»Ÿæ¥æ”¶åˆ°çš„HTTPè¯·æ±‚æ€»é‡ï¼‰ - æ ‡ç­¾(label)åæ˜ äº†å½“å‰æ ·æœ¬çš„ç‰¹å¾ç»´åº¦ï¼Œé€šè¿‡è¿™äº›ç»´åº¦Prometheuså¯ä»¥å¯¹æ ·æœ¬æ•°æ®è¿›è¡Œè¿‡æ»¤ï¼Œèšåˆç­‰ - ä»¥__ä½œä¸ºå‰ç¼€çš„æ ‡ç­¾ï¼Œæ˜¯ç³»ç»Ÿä¿ç•™çš„å…³é”®å­—ï¼Œåªèƒ½åœ¨ç³»ç»Ÿå†…éƒ¨ä½¿ç”¨ - Metricsç±»å‹ - Prometheuså®šä¹‰äº†4ç§ä¸åŒçš„æŒ‡æ ‡ç±»å‹(metric type)ï¼šCounterï¼ˆè®¡æ•°å™¨ï¼‰ã€Gaugeï¼ˆä»ªè¡¨ç›˜ï¼‰ã€Histogramï¼ˆç›´æ–¹å›¾ï¼‰ã€Summaryï¼ˆæ‘˜è¦ï¼‰ - Counterï¼šåªå¢ä¸å‡çš„è®¡æ•°å™¨ - Counterç±»å‹çš„æŒ‡æ ‡å…¶å·¥ä½œæ–¹å¼å’Œè®¡æ•°å™¨ä¸€æ ·ï¼Œåªå¢ä¸å‡ï¼ˆé™¤éç³»ç»Ÿå‘ç”Ÿé‡ç½®ï¼‰ã€‚ - å¸¸è§çš„ç›‘æ§æŒ‡æ ‡ï¼Œå¦‚http_requests_totalï¼Œnode_cpuéƒ½æ˜¯Counterç±»å‹çš„ç›‘æ§æŒ‡æ ‡ã€‚ ä¸€èˆ¬åœ¨å®šä¹‰Counterç±»å‹æŒ‡æ ‡çš„åç§°æ—¶æ¨èä½¿ç”¨_totalä½œä¸ºåç¼€ã€‚ - //ä¾‹å¦‚ï¼Œé€šè¿‡rate()å‡½æ•°è·å–HTTPè¯·æ±‚é‡çš„å¢é•¿ç‡ï¼š rate(http_requests_total[5m]) - //æŸ¥è¯¢å½“å‰ç³»ç»Ÿä¸­ï¼Œè®¿é—®é‡å‰10çš„HTTPåœ°å€ï¼š topk(10, http_requests_total) - Gaugeï¼šå¯å¢å¯å‡çš„ä»ªè¡¨ç›˜ - ä¸Counterä¸åŒï¼ŒGaugeç±»å‹çš„æŒ‡æ ‡ä¾§é‡äºååº”ç³»ç»Ÿçš„å½“å‰çŠ¶æ€ã€‚å› æ­¤è¿™ç±»æŒ‡æ ‡çš„æ ·æœ¬æ•°æ®å¯å¢å¯å‡ã€‚ - å¸¸è§æŒ‡æ ‡å¦‚ï¼šnode_memory_MemFreeï¼ˆä¸»æœºå½“å‰ç©ºé—²çš„å†…å®¹å¤§å°ï¼‰ã€node_memory_MemAvailableï¼ˆå¯ç”¨å†…å­˜å¤§å°ï¼‰éƒ½æ˜¯Gaugeç±»å‹çš„ç›‘æ§æŒ‡æ ‡ã€‚ - //é€šè¿‡GaugeæŒ‡æ ‡ï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥æŸ¥çœ‹ç³»ç»Ÿçš„å½“å‰çŠ¶æ€ï¼šnode_memory_MemFree - //è¿˜å¯ä»¥ä½¿ç”¨deriv()è®¡ç®—æ ·æœ¬çš„çº¿æ€§å›å½’æ¨¡å‹ï¼Œç”šè‡³æ˜¯ç›´æ¥ä½¿ç”¨predict_linear()å¯¹æ•°æ®çš„å˜åŒ–è¶‹åŠ¿è¿›è¡Œé¢„æµ‹ã€‚ - ä¾‹å¦‚ï¼Œé¢„æµ‹ç³»ç»Ÿç£ç›˜ç©ºé—´åœ¨4ä¸ªå°æ—¶ä¹‹åçš„å‰©ä½™æƒ…å†µï¼špredict_linear(node_filesystem_free{job=\u0026quot;node\u0026quot;}[1h], 4 * 3600) - Histogramå’ŒSummaryåˆ†ææ•°æ®åˆ†å¸ƒæƒ…å†µ Instant vector vs Range vector https://stackoverflow.com/questions/68223824/prometheus-instant-vector-vs-range-vector https://satyanash.net/software/2021/01/04/understanding-prometheus-range-vectors.html https://promlabs.com/blog/2020/06/18/the-anatomy-of-a-promql-query/ Rate then sum, never sum then rate https://www.robustperception.io/rate-then-sum-never-sum-then-rate/ To help keep you on the straight and narrow, remember this:\nThe only mathematical operations you can safely directly apply to a counter\u0026rsquo;s values are rate, irate, increase, and resets. Anything else will cause you problems.\nThe problem of rate()/increase() extrapolation in Prometheus https://stackoverflow.com/questions/52697517/prometheus-how-to-rate-a-sum-of-the-same-counter-from-different-machines?rq=3 https://github.com/prometheus/prometheus/issues/3746 https://github.com/prometheus/prometheus/issues/3806 https://github.com/VictoriaMetrics/VictoriaMetrics/issues/1215 https://docs.google.com/document/d/1y2Mp041_2v0blnKnZk7keCnJZICeK2YWUQuXH_m4DVc/edit?pli=1\u0026tab=t.0#heading=h.bupciudrwmna https://lotabout.me/2019/QQA-Why-Prometheus-increase-return-float/ (ä¸­æ–‡å¸¦å›¾) Aggregating the precomputed quantiles from a summary makes no sense https://prometheus.io/docs/practices/histograms/#count-and-sum-of-observations avg(http_request_duration_seconds{quantile=\u0026ldquo;0.95\u0026rdquo;}) // BAD! histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) // GOOD.\nErrors of quantile estimation https://prometheus.io/docs/practices/histograms/#errors-of-quantile-estimation Quantiles, whether calculated client-side or server-side, are estimated. It is important to understand the errors of that estimation.\nContinuing the histogram example from above, imagine your usual request durations are almost all very close to 220ms, or in other words, if you could plot the \u0026ldquo;true\u0026rdquo; histogram, you would see a very sharp spike at 220ms. In the Prometheus histogram metric as configured above, almost all observations, and therefore also the 95th percentile, will fall into the bucket labeled {le=\u0026ldquo;0.3\u0026rdquo;}, i.e. the bucket from 200ms to 300ms. The histogram implementation guarantees that the true 95th percentile is somewhere between 200ms and 300ms. To return a single value (rather than an interval), it applies linear interpolation, which yields 295ms in this case. The calculated quantile gives you the impression that you are close to breaching the SLO, but in reality, the 95th percentile is a tiny bit above 220ms, a quite comfortable distance to your SLO.\nNext step in our thought experiment: A change in backend routing adds a fixed amount of 100ms to all request durations. Now the request duration has its sharp spike at 320ms and almost all observations will fall into the bucket from 300ms to 450ms. The 95th percentile is calculated to be 442.5ms, although the correct value is close to 320ms. While you are only a tiny bit outside of your SLO, the calculated 95th quantile looks much worse.\nBest practices https://grafana.com/docs/grafana/v7.5/best-practices/\nQueries Examples https://prometheus.io/docs/prometheus/2.39/querying/examples/\nPrometheus çš„å„ç§é—®é¢˜ http://www.xuyasong.com/?p=1921 https://aleiwu.com/post/prometheus-bp/ https://develotters.com/posts/high-cardinality/ é«˜åŸºæ•°é—®é¢˜(High-Cardinality Problem) 2.16 ç‰ˆæœ¬ä»¥ä¸Šçš„ Prometheus ç›´æ¥æ”¯æŒæŸ¥çœ‹ TSDB çš„çŠ¶æ€ï¼š\nCounter é‡ç½®å¯¼è‡´çš„é—®é¢˜ Counter æ˜¯å››ç§ Metrics ç±»å‹ä¸­çš„ä¸€ç§ï¼Œå®ƒçš„å€¼åªä¼šå¢åŠ (incr)æˆ–è€…é‡ç½®(reset, ä¸€èˆ¬æ˜¯å› ä¸ºå®ä¾‹é‡å¯)ã€‚\nPromQL çš„ rate()å’Œincrease() å‡½æ•°ä¼šè‡ªåŠ¨å¤„ç† Counter é‡ç½®çš„æƒ…å†µï¼Œä½† sum ä¸ä¼šï¼Œæ‰€ä»¥å¾ˆå¤šæ–‡æ¡£éƒ½å¼ºè°ƒä¸€å®šè¦å…ˆ rate å† sumï¼Œè€Œä¸èƒ½å…ˆ sum å† rateã€‚\nrate/increase æ˜¯å¦‚ä½•å¤„ç† counter é‡ç½®çš„ï¼Ÿ å…·ä½“çš„å¤„ç†ä»£ç ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 // Handle counter resets: resultFloat = samples.Floats[numSamplesMinusOne].F - samples.Floats[0].F prevValue := samples.Floats[0].F for _, currPoint := range samples.Floats[1:] { if currPoint.F \u0026lt; prevValue { resultFloat += prevValue } prevValue = currPoint.F } é¦–å…ˆéå†æ ·æœ¬ï¼Œå¦‚æœå‘ç° Counter å‡å°‘å°±è®¤ä¸ºå‘ç”Ÿäº†é‡ç½®ï¼Œåç»­æ‰€æœ‰æ ·æœ¬å€¼éƒ½ä¼šåŠ ä¸Šé‡ç½®å‰çš„å€¼ã€‚\nä¸¾ä¸ªæ —å­ï¼Œå‡è®¾æ—¶é—´åºåˆ—çš„å€¼ä¸º[5,10,4,6]ï¼Œé‚£ä¹ˆå®ƒä¼šè¢«å¤„ç†ä¸º[5,10,14,16]ã€‚\nPrometheus æŠ¥è­¦ä¸å‡†é—®é¢˜ https://aleiwu.com/post/prometheus-alert-why/ æŠ¥è­¦ä¸å‡†ï¼ŒæŒ‡çš„æ˜¯ä¸¤ç±»é—®é¢˜ï¼š ã€è¯¥æŠ¥ã€çš„è­¦æ²¡æŠ¥ï¼› ã€ä¸è¯¥æŠ¥ã€çš„è­¦æŠ¥äº†ï¼› è¿™é‡Œçš„ã€è¯¥æŠ¥ã€å’Œã€ä¸è¯¥æŠ¥ã€éƒ½æ˜¯åŸºäº Grafana è¿›è¡Œåˆ¤æ–­çš„ã€‚æ‰€ä»¥è¿™é‡Œè¯´æŠ¥è­¦ä¸å‡†ï¼Œæœ¬è´¨æ˜¯ Grafana çš„ä»ªè¡¨ç›˜å±•ç¤ºç»“æœå’Œ Prometheus å‘Šè­¦ä¸ä¸€è‡´ã€‚ è¿™ä¸ªé—®é¢˜æœ¬è´¨æ˜¯ã€é‡‡æ ·é—´éš”ã€ä¸ä¸€è‡´çš„ï¼š\nPrometheus çš„å‘Šè­¦å™¨ä¼šæŒ‰å›ºå®šçš„æ—¶é—´é—´éš”é‡‡æ ·ï¼Œåœ¨ä¸€ä¸ªå‘¨æœŸå†…ï¼Œå¦‚æœæ ·æœ¬æ»¡è¶³å‘Šè­¦è§„åˆ™ï¼› Grafana æ¸²æŸ“å›¾æ ‡çš„ç»“æœï¼Œåˆ™å–å†³äºåŸºäº Range Query é‡‡æ ·ç‚¹çš„åˆ†å¸ƒï¼› å¾ˆå¯èƒ½å‡ºç°ï¼ŒPrometheus é‡‡æ ·æ—¶æ•è·äº†ã€ä½è°·ã€ä½† Grafana å¿½ç•¥äº†ã€ä½è°·ã€å¯¼è‡´ã€ä¸è¯¥æŠ¥ã€çš„è­¦æŠ¥äº†ï¼Œæˆ–è€… Prometheus å¿½ç•¥äº†ã€ä½è°·ã€è€Œ Grafana æ•è·äº†ã€ä½è°·ã€å¯¼è‡´ã€è¯¥æŠ¥ã€çš„è­¦æ²¡æŠ¥ã€‚\nPrometheus: Alertmanager æ¶æ„å›¾ ä¸ºä»€ä¹ˆè¦ Alertmanagerï¼Ÿ å½“ Prometheus Server è®¡ç®—å‡ºä¸€äº›è­¦æŠ¥åï¼Œå®ƒè‡ªå·±å¹¶æ²¡æœ‰èƒ½åŠ›å°†è¿™äº›è­¦æŠ¥é€šçŸ¥å‡ºå»ï¼Œåªèƒ½å°†è­¦æŠ¥æ¨ç»™ Alertmanagerï¼Œç”± Alertmanager è¿›è¡Œå‘é€ã€‚\nè¿™ä¸ªåˆ‡åˆ†ï¼Œä¸€æ–¹é¢æ˜¯å‡ºäºå•ä¸€èŒè´£çš„è€ƒè™‘ï¼Œè®© Prometheus â€œdo one thing and do it wellâ€, å¦ä¸€æ–¹é¢åˆ™æ˜¯å› ä¸ºè­¦æŠ¥å‘é€ç¡®å®ä¸æ˜¯ä¸€ä»¶â€ç®€å•â€çš„äº‹ï¼Œéœ€è¦ä¸€ä¸ªä¸“é—¨çš„ç³»ç»Ÿæ¥åšå¥½å®ƒã€‚\nå¯ä»¥è¿™ä¹ˆè¯´ï¼ŒAlertmanager çš„ç›®æ ‡ä¸æ˜¯ç®€å•åœ°â€å‘å‡ºè­¦æŠ¥â€ï¼Œè€Œæ˜¯â€å‘å‡ºé«˜è´¨é‡çš„è­¦æŠ¥â€ã€‚å®ƒæä¾›çš„é«˜çº§åŠŸèƒ½åŒ…æ‹¬ä½†ä¸é™äºï¼š\nGo Template æ¸²æŸ“è­¦æŠ¥å†…å®¹ï¼› ç®¡ç†è­¦æŠ¥çš„é‡å¤æé†’æ—¶æœºä¸æ¶ˆé™¤åæ¶ˆé™¤é€šçŸ¥çš„å‘é€ï¼› æ ¹æ®æ ‡ç­¾å®šä¹‰è­¦æŠ¥è·¯ç”±ï¼Œå®ç°è­¦æŠ¥çš„ä¼˜å…ˆçº§ã€æ¥æ”¶äººåˆ’åˆ†ï¼Œå¹¶é’ˆå¯¹ä¸åŒçš„ä¼˜å…ˆçº§å’Œæ¥æ”¶äººå®šåˆ¶ä¸åŒçš„å‘é€ç­–ç•¥ï¼› å°†åŒç±»å‹è­¦æŠ¥æ‰“åŒ…æˆä¸€æ¡é€šçŸ¥å‘é€å‡ºå»ï¼Œé™ä½è­¦æŠ¥é€šçŸ¥çš„é¢‘ç‡ï¼› æ”¯æŒé™é»˜è§„åˆ™: ç”¨æˆ·å¯ä»¥å®šä¹‰ä¸€æ¡é™é»˜è§„åˆ™ï¼Œåœ¨ä¸€æ®µæ—¶é—´å†…åœæ­¢å‘é€éƒ¨åˆ†ç‰¹å®šçš„è­¦æŠ¥ï¼Œæ¯”å¦‚å·²ç»ç¡®è®¤æ˜¯æœç´¢é›†ç¾¤é—®é¢˜ï¼Œåœ¨ä¿®å¤æœç´¢é›†ç¾¤æ—¶ï¼Œå…ˆé™é»˜æ‰æœç´¢é›†ç¾¤ç›¸å…³è­¦æŠ¥ï¼› æ”¯æŒâ€æŠ‘åˆ¶â€è§„åˆ™(Inhibition Rule): ç”¨æˆ·å¯ä»¥å®šä¹‰ä¸€æ¡â€æŠ‘åˆ¶â€è§„åˆ™ï¼Œè§„å®šåœ¨æŸç§è­¦æŠ¥å‘ç”Ÿæ—¶ï¼Œä¸å‘é€å¦ä¸€ç§è­¦æŠ¥ï¼Œæ¯”å¦‚åœ¨â€A æœºæˆ¿ç½‘ç»œæ•…éšœâ€è¿™æ¡è­¦æŠ¥å‘ç”Ÿæ—¶ï¼Œä¸å‘é€æ‰€æœ‰â€A æœºæˆ¿ä¸­çš„è­¦æŠ¥â€ï¼› Routing Tree Routing Tree çš„è®¾è®¡æ„å›¾æ˜¯è®©ç”¨æˆ·èƒ½å¤Ÿéå¸¸è‡ªç”±åœ°ç»™è­¦æŠ¥å½’ç±»ï¼Œç„¶åæ ¹æ®å½’ç±»åçš„ç±»åˆ«æ¥é…ç½®è¦å‘é€ç»™è°ä»¥åŠæ€ä¹ˆå‘é€ï¼š\nå‘é€ç»™è°ï¼Ÿä¸Šé¢å·²ç»åšäº†å¾ˆå¥½çš„ç¤ºä¾‹ï¼Œâ€™æ•°æ®åº“è­¦æŠ¥â€™å’Œâ€™å‰ç«¯è­¦æŠ¥â€™éƒ½æœ‰ç‰¹å®šçš„æ¥æ”¶ç»„ï¼Œéƒ½æ²¡æœ‰åŒ¹é…ä¸Šé‚£ä¹ˆå°±æ˜¯â€™é»˜è®¤è­¦æŠ¥â€™, å‘é€ç»™é»˜è®¤æ¥æ”¶ç»„ æ€ä¹ˆå‘é€ï¼Ÿå¯¹äºä¸€ç±»è­¦æŠ¥ï¼Œæœ‰ä¸ªå¤šä¸ªå­—æ®µæ¥é…ç½®å‘é€è¡Œä¸ºï¼š group_byï¼šå†³å®šäº†è­¦æŠ¥æ€ä¹ˆåˆ†ç»„ï¼Œæ¯ä¸ª group åªä¼šå®šæ—¶äº§ç”Ÿä¸€æ¬¡é€šçŸ¥ï¼Œè¿™å°±è¾¾åˆ°äº†é™å™ªçš„æ•ˆæœï¼Œè€Œä¸åŒçš„è­¦æŠ¥ç±»åˆ«åˆ†ç»„æ–¹å¼æ˜¾ç„¶æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¸¾ä¸ªä¾‹å­ï¼š é…ç½®ä¸­çš„ â€˜æ•°æ®åº“è­¦æŠ¥â€™ æ˜¯æŒ‰ â€˜é›†ç¾¤â€™ å’Œ â€˜è§„åˆ™åâ€™ åˆ†ç»„çš„ï¼Œè¿™è¡¨æ˜å¯¹äºæ•°æ®åº“è­¦æŠ¥ï¼Œæˆ‘ä»¬å…³å¿ƒçš„æ˜¯â€œå“ªä¸ªé›†ç¾¤çš„å“ªä¸ªè§„åˆ™å‡ºé—®é¢˜äº†â€ï¼Œæ¯”å¦‚ä¸€ä¸ªæ—¶é—´æ®µå†…ï¼Œâ€™åä¸œâ€™é›†ç¾¤äº§ç”Ÿäº†10æ¡ â€˜APIå“åº”æ—¶é—´è¿‡é•¿â€™ è­¦æŠ¥ï¼Œ- è¿™äº›è­¦æŠ¥å°±ä¼šèšåˆåœ¨ä¸€ä¸ªé€šçŸ¥é‡Œå‘å‡ºæ¥ï¼› é…ç½®ä¸­çš„ â€˜å‰ç«¯è­¦æŠ¥â€™ æ˜¯æŒ‰ â€˜äº§å“â€™ å’Œ â€˜ç¯å¢ƒâ€™ åˆ†ç»„çš„ï¼Œ è¿™è¡¨æ˜å¯¹äºå‰ç«¯è­¦æŠ¥ï¼Œæˆ‘ä»¬å…³å¿ƒçš„æ˜¯â€œå“ªä¸ªäº§å“çš„å“ªä¸ªç¯å¢ƒå‡ºé—®é¢˜äº†â€ group_interval å’Œ group_wait: æ§åˆ¶åˆ†ç»„çš„ç»†èŠ‚ï¼Œä¸ç»†è°ˆï¼Œå…¶ä¸­ group_interval æ§åˆ¶äº†è¿™ä¸ªåˆ†ç»„æœ€å¿«å¤šä¹…æ‰§è¡Œä¸€æ¬¡ Notification Pipeline repeat_interval: å‡å¦‚ä¸€ä¸ªç›¸åŒçš„è­¦æŠ¥ä¸€ç›´ FIRINGï¼ŒAlertmanager å¹¶ä¸ä¼šä¸€ç›´å‘é€è­¦æŠ¥ï¼Œè€Œä¼šç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œè¿™ä¸ªç­‰å¾…æ—¶é—´å°±æ˜¯ repeat_intervalï¼Œæ˜¾ç„¶ï¼Œä¸åŒç±»å‹è­¦æŠ¥çš„å‘é€é¢‘ç‡ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ Notification Pipeline è¦é‡ç‚¹è¯´çš„æ˜¯DedupStageå’ŒNotifySetStageå®ƒä¿©ååŒè´Ÿè´£å»é‡å·¥ä½œï¼Œå…·ä½“åšæ³•æ˜¯ï¼š\nNotifySetStage ä¼šä¸ºå‘é€æˆåŠŸçš„è­¦æŠ¥è®°å½•ä¸€æ¡å‘é€é€šçŸ¥ï¼Œkey æ˜¯â€™æ¥æ”¶ç»„åå­—â€™+â€™GroupKey çš„ key å€¼â€™ï¼Œvalue æ˜¯å½“å‰ Stage æ”¶åˆ°çš„ []Alert (è¿™ä¸ªåˆ—è¡¨å’Œæœ€å¼€å§‹è¿›å…¥ Notification Pipeline çš„è­¦æŠ¥åˆ—è¡¨æœ‰å¯èƒ½æ˜¯ä¸åŒçš„ï¼Œå› ä¸ºå…¶ä¸­æœ‰äº› Alert å¯èƒ½åœ¨å‰ç½® Stage ä¸­å·²ç»è¢«è¿‡æ»¤æ‰äº†) DedupStage ä¸­ä¼šä»¥â€™æ¥æ”¶ç»„åå­—â€™+â€™GroupKey çš„ key å€¼â€™ä¸º key æŸ¥è¯¢é€šçŸ¥è®°å½•ï¼Œå‡å¦‚ï¼š æŸ¥è¯¢æ— ç»“æœï¼Œé‚£ä¹ˆè¿™æ¡é€šçŸ¥æ²¡å‘è¿‡ï¼Œä¸ºè¿™ç»„è­¦æŠ¥å‘é€ä¸€æ¡é€šçŸ¥ï¼› æŸ¥è¯¢æœ‰ç»“æœï¼Œé‚£ä¹ˆæŸ¥è¯¢å¾—åˆ°å·²ç»å‘é€è¿‡çš„ä¸€ç»„è­¦æŠ¥ Sï¼Œåˆ¤æ–­å½“å‰çš„è¿™ç»„è­¦æŠ¥ A æ˜¯å¦ä¸º S çš„å­é›†ï¼š å‡å¦‚ A æ˜¯ S çš„å­é›†ï¼Œé‚£ä¹ˆè¡¨æ˜ A å’Œ S é‡å¤ï¼Œè¿™æ—¶å€™è¦æ ¹æ® repeat_interval æ¥å†³å®šæ˜¯å¦å†æ¬¡å‘é€ï¼š è·ç¦» S çš„å‘é€æ—¶é—´å·²ç»è¿‡å»äº†è¶³å¤Ÿä¹…ï¼ˆrepeat_interval)ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦å†å‘é€ä¸€éï¼› è·ç¦» S çš„å‘é€æ—¶é—´è¿˜æ²¡æœ‰è¾¾åˆ° repeat_intervalï¼Œé‚£ä¹ˆä¸ºäº†é™ä½è­¦æŠ¥é¢‘ç‡ï¼Œè§¦å‘å»é‡é€»è¾‘ï¼Œè¿™æ¬¡æˆ‘ä»¬å°±ä¸å‘äº†ï¼› å‡å¦‚ A ä¸æ˜¯ S çš„å­é›†ï¼Œé‚£ä¹ˆ A å’Œ S ä¸é‡å¤ï¼Œéœ€è¦å†å‘é€ä¸€æ¬¡ï¼› ä¸Šé¢çš„è¡¨è¿°å¯èƒ½æœ‰äº›æŠ½è±¡ï¼Œæœ€åè¡¨ç°å‡ºæ¥çš„ç»“æœæ˜¯ï¼š å‡å¦‚ä¸€ä¸ª AlertGroup é‡Œçš„è­¦æŠ¥ä¸€ç›´å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆè™½ç„¶æ¯æ¬¡éƒ½æ˜¯æ–°è­¦æŠ¥ï¼Œä¸ä¼šè¢«å»é‡ï¼Œä½†æ˜¯ç”±äº group_interval ï¼ˆå‡è®¾æ˜¯5åˆ†é’Ÿï¼‰å­˜åœ¨ï¼Œè¿™ä¸ª AlertGroup æœ€å¤š 5 åˆ†é’Ÿè§¦å‘ä¸€æ¬¡ Notification Pipelineï¼Œå› æ­¤æœ€å¤šä¹Ÿåªä¼š 5 åˆ†é’Ÿå‘é€ä¸€æ¡é€šçŸ¥ï¼› å‡å¦‚ä¸€ä¸ª AlertGroup é‡Œçš„è­¦æŠ¥ä¸€ç›´ä¸å˜åŒ–ï¼Œå°±æ˜¯é‚£ä¹ˆå‡ æ¡ä¸€ç›´ FIRING ç€ï¼Œé‚£ä¹ˆè™½ç„¶æ¯ä¸ª group_interval éƒ½ä¼šè§¦å‘ Notification Pipelineï¼Œä½†æ˜¯ç”±äº repeate_intervalï¼ˆå‡è®¾æ˜¯1å°æ—¶ï¼‰å­˜åœ¨ï¼Œå› æ­¤æœ€å¤šä¹Ÿåªä¼šæ¯ 1 å°æ—¶ä¸ºè¿™ä¸ªé‡å¤çš„è­¦æŠ¥å‘é€ä¸€æ¡é€šçŸ¥ï¼› å†è¯´ä¸€ä¸‹ Silence å’Œ Inhibitï¼Œä¸¤è€…éƒ½æ˜¯åŸºäºç”¨æˆ·ä¸»åŠ¨å®šä¹‰çš„è§„åˆ™çš„ï¼š Silence Ruleï¼šé™é»˜è§„åˆ™ç”¨æ¥å…³é—­æ‰éƒ¨åˆ†è­¦æŠ¥çš„é€šçŸ¥ï¼Œæ¯”å¦‚æŸä¸ªæ€§èƒ½é—®é¢˜å·²ç»ä¿®å¤äº†ï¼Œä½†éœ€è¦æ’æœŸä¸Šçº¿ï¼Œé‚£ä¹ˆåœ¨ä¸Šçº¿å‰å°±å¯ä»¥æŠŠå¯¹åº”çš„è­¦æŠ¥é™é»˜æ‰æ¥å‡å°‘å™ªéŸ³ï¼› Inhibit Ruleï¼šæŠ‘åˆ¶è§„åˆ™ç”¨äºåœ¨æŸç±»è­¦æŠ¥å‘ç”Ÿæ—¶ï¼ŒæŠ‘åˆ¶æ‰å¦ä¸€ç±»è­¦æŠ¥ï¼Œæ¯”å¦‚æŸä¸ªæœºæˆ¿å®•æœºäº†ï¼Œé‚£ä¹ˆä¼šå½±å“æ‰€æœ‰ä¸Šå±‚æœåŠ¡ï¼Œäº§ç”Ÿçº§è”çš„è­¦æŠ¥æ´ªæµï¼Œåè€Œä¼šæ©ç›–æ‰æ ¹æœ¬åŸå› ï¼Œè¿™æ—¶å€™æŠ‘åˆ¶è§„åˆ™å°±æœ‰ç”¨äº†ï¼› å› æ­¤ Notification Pipeline çš„è®¾è®¡æ„å›¾å°±å¾ˆæ˜ç¡®äº†ï¼šé€šè¿‡ä¸€ç³»åˆ—é€»è¾‘ï¼ˆå¦‚æŠ‘åˆ¶ã€é™é»˜ã€å»é‡ï¼‰æ¥è·å¾—æ›´é«˜çš„è­¦æŠ¥è´¨é‡ï¼Œç”±äºè­¦æŠ¥è´¨é‡çš„ç»´åº¦å¾ˆå¤šï¼ˆå‰”é™¤é‡å¤ã€ç±»ä¼¼çš„è­¦æŠ¥ï¼Œé™é»˜æš‚æ—¶æ— ç”¨çš„è­¦æŠ¥ï¼ŒæŠ‘åˆ¶çº§è”è­¦æŠ¥ï¼‰ï¼Œå› æ­¤ Notification Pipeline è®¾è®¡æˆäº†è´£ä»»é“¾æ¨¡å¼ï¼Œä»¥ä¾¿äºéšæ—¶æ·»åŠ æ–°çš„ç¯èŠ‚æ¥ä¼˜åŒ–è­¦æŠ¥è´¨é‡ Prometheuså­˜å‚¨æœºåˆ¶ http://www.xuyasong.com/?p=1601 æ·±å…¥ PromQL Bascis https://stackoverflow.com/questions/68223824/prometheus-instant-vector-vs-range-vector https://satyanash.net/software/2021/01/04/understanding-prometheus-range-vectors.html https://promlabs.com/blog/2020/06/18/the-anatomy-of-a-promql-query/ Prometheus Querying - Breaking Down PromQL Functions Rate \u0026amp; Increase https://promlabs.com/blog/2021/01/29/how-exactly-does-promql-calculate-rates/ https://stackoverflow.com/questions/54494394/do-i-understand-prometheuss-rate-vs-increase-functions-correctly?rq=3 https://stackoverflow.com/questions/48218950/increase-in-prometheus-sometimes-doubles-values-how-to-avoid?rq=3 https://stackoverflow.com/questions/52697517/prometheus-how-to-rate-a-sum-of-the-same-counter-from-different-machines https://github.com/VictoriaMetrics/VictoriaMetrics/issues/1215 https://stackoverflow.com/questions/70835778/understanding-increase-and-rate-used-on-http-server-requests-seconds-count-w ç”±äº prometheus ä½¿ç”¨äº†çº¿æ€§æ’å€¼ç®—æ³•å–è®¡ç®— increase(å¢é‡)ï¼Œæ‰€ä»¥è®¡ç®—ç»“æœä¼šå¾—åˆ°å°æ•°ï¼Œè¿™ä¸€ç‚¹ç‰¹åˆ«å®¹æ˜“è®©äººè¯¯è§£ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 // === rate(node parser.ValueTypeMatrix) Vector === func funcRate(vals []parser.Value, args parser.Expressions, enh *EvalNodeHelper) Vector { return extrapolatedRate(vals, args, enh, true, true) } // === increase(node parser.ValueTypeMatrix) Vector === func funcIncrease(vals []parser.Value, args parser.Expressions, enh *EvalNodeHelper) Vector { return extrapolatedRate(vals, args, enh, true, false) } // extrapolatedRate is a utility function for rate/increase/delta. // It calculates the rate (allowing for counter resets if isCounter is true), // extrapolates if the first/last sample is close to the boundary, and returns // the result as either per-second (if isRate is true) or overall. func extrapolatedRate(vals []parser.Value, args parser.Expressions, enh *EvalNodeHelper, isCounter, isRate bool) Vector { ms := args[0].(*parser.MatrixSelector) vs := ms.VectorSelector.(*parser.VectorSelector) var ( samples = vals[0].(Matrix)[0] rangeStart = enh.Ts - durationMilliseconds(ms.Range+vs.Offset) rangeEnd = enh.Ts - durationMilliseconds(vs.Offset) resultFloat float64 resultHistogram *histogram.FloatHistogram firstT, lastT int64 numSamplesMinusOne int ) // We need either at least two Histograms and no Floats, or at least two // Floats and no Histograms to calculate a rate. Otherwise, drop this // Vector element. if len(samples.Histograms) \u0026gt; 0 \u0026amp;\u0026amp; len(samples.Floats) \u0026gt; 0 { // Mix of histograms and floats. TODO(beorn7): Communicate this failure reason. return enh.Out } switch { case len(samples.Histograms) \u0026gt; 1: numSamplesMinusOne = len(samples.Histograms) - 1 firstT = samples.Histograms[0].T lastT = samples.Histograms[numSamplesMinusOne].T resultHistogram = histogramRate(samples.Histograms, isCounter) if resultHistogram == nil { // The histograms are not compatible with each other. // TODO(beorn7): Communicate this failure reason. return enh.Out } case len(samples.Floats) \u0026gt; 1: numSamplesMinusOne = len(samples.Floats) - 1 firstT = samples.Floats[0].T lastT = samples.Floats[numSamplesMinusOne].T resultFloat = samples.Floats[numSamplesMinusOne].F - samples.Floats[0].F if !isCounter { break } // Handle counter resets: prevValue := samples.Floats[0].F for _, currPoint := range samples.Floats[1:] { if currPoint.F \u0026lt; prevValue { resultFloat += prevValue } prevValue = currPoint.F } default: // Not enough samples. TODO(beorn7): Communicate this failure reason. return enh.Out } // Duration between first/last samples and boundary of range. durationToStart := float64(firstT-rangeStart) / 1000 durationToEnd := float64(rangeEnd-lastT) / 1000 sampledInterval := float64(lastT-firstT) / 1000 averageDurationBetweenSamples := sampledInterval / float64(numSamplesMinusOne) // TODO(beorn7): Do this for histograms, too. if isCounter \u0026amp;\u0026amp; resultFloat \u0026gt; 0 \u0026amp;\u0026amp; len(samples.Floats) \u0026gt; 0 \u0026amp;\u0026amp; samples.Floats[0].F \u0026gt;= 0 { // Counters cannot be negative. If we have any slope at all // (i.e. resultFloat went up), we can extrapolate the zero point // of the counter. If the duration to the zero point is shorter // than the durationToStart, we take the zero point as the start // of the series, thereby avoiding extrapolation to negative // counter values. durationToZero := sampledInterval * (samples.Floats[0].F / resultFloat) if durationToZero \u0026lt; durationToStart { durationToStart = durationToZero } } // If the first/last samples are close to the boundaries of the range, // extrapolate the result. This is as we expect that another sample // will exist given the spacing between samples we\u0026#39;ve seen thus far, // with an allowance for noise. extrapolationThreshold := averageDurationBetweenSamples * 1.1 extrapolateToInterval := sampledInterval if durationToStart \u0026lt; extrapolationThreshold { extrapolateToInterval += durationToStart } else { extrapolateToInterval += averageDurationBetweenSamples / 2 } if durationToEnd \u0026lt; extrapolationThreshold { extrapolateToInterval += durationToEnd } else { extrapolateToInterval += averageDurationBetweenSamples / 2 } factor := extrapolateToInterval / sampledInterval if isRate { factor /= ms.Range.Seconds() } if resultHistogram == nil { resultFloat *= factor } else { resultHistogram.Mul(factor) } return append(enh.Out, Sample{F: resultFloat, H: resultHistogram}) } histogramQuantitle ç”¨æ³•ç¤ºä¾‹ï¼š\n1 TBD æºç è§ï¼š\nhttps://github.com/prometheus/prometheus/blob/caa173d2aac4c390546b1f78302104b1ccae0878/promql/functions.go#L615 https://github.com/prometheus/prometheus/blob/caa173d2aac4c390546b1f78302104b1ccae0878/promql/quantile.go#L73 æ ¸å¿ƒç®—æ³•æ˜¯ï¼šbucketStart + (bucketEnd-bucketStart)*(rank/count)ã€‚ åŒæ ·ä¹Ÿæ˜¯çº¿æ€§æ’å€¼ç®—æ³•ï¼Œæ¯”è¾ƒå¥½ç†è§£ã€‚å”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ histogram_quantile çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ sum(rate, \u0026hellip;)ï¼Œè¿™ä¸ªæ˜¯ QPS(count/time) è€Œä¸æ˜¯ç›´æ¥ç”¨çš„ countï¼Œä¸ºä»€ä¹ˆï¼Ÿè®¡ç®—å…¬å¼é‡Œæœ€åä¸€é¡¹æ˜¯ rank/countï¼Œè€Œ rank = q*countï¼Œä¸¤è€…ç›¸é™¤ time é¡¹ä¼šè¢«æ¶ˆé™¤ï¼Œç›¸å½“äºè¿˜æ˜¯ count\u0026rsquo; / countï¼Œä¹Ÿå°±æ˜¯ç»“æœæ˜¯ç­‰ä»·çš„ã€‚æ—¢ç„¶ç»“æœç­‰ä»·ï¼Œä¸ºä»€ä¹ˆè¦ç”¨ rate è€Œä¸ç›´æ¥ç”¨ countï¼Ÿå› ä¸º rate å‡½æ•°å¯ä»¥ä½¿ç”¨å¤„ç† resetï¼Œç›´æ¥ç”¨ count ä¸è¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 // === histogram_quantile(k parser.ValueTypeScalar, Vector parser.ValueTypeVector) Vector === func funcHistogramQuantile(vals []parser.Value, args parser.Expressions, enh *EvalNodeHelper) Vector { q := vals[0].(Vector)[0].F inVec := vals[1].(Vector) if enh.signatureToMetricWithBuckets == nil { enh.signatureToMetricWithBuckets = map[string]*metricWithBuckets{} } else { for _, v := range enh.signatureToMetricWithBuckets { v.buckets = v.buckets[:0] } } var histogramSamples []Sample for _, sample := range inVec { // We are only looking for conventional buckets here. Remember // the histograms for later treatment. if sample.H != nil { histogramSamples = append(histogramSamples, sample) continue } upperBound, err := strconv.ParseFloat( sample.Metric.Get(model.BucketLabel), 64, ) if err != nil { // Oops, no bucket label or malformed label value. Skip. // TODO(beorn7): Issue a warning somehow. continue } enh.lblBuf = sample.Metric.BytesWithoutLabels(enh.lblBuf, labels.BucketLabel) mb, ok := enh.signatureToMetricWithBuckets[string(enh.lblBuf)] if !ok { sample.Metric = labels.NewBuilder(sample.Metric). Del(excludedLabels...). Labels() mb = \u0026amp;metricWithBuckets{sample.Metric, nil} enh.signatureToMetricWithBuckets[string(enh.lblBuf)] = mb } mb.buckets = append(mb.buckets, bucket{upperBound, sample.F}) } // Now deal with the histograms. for _, sample := range histogramSamples { // We have to reconstruct the exact same signature as above for // a conventional histogram, just ignoring any le label. enh.lblBuf = sample.Metric.Bytes(enh.lblBuf) if mb, ok := enh.signatureToMetricWithBuckets[string(enh.lblBuf)]; ok \u0026amp;\u0026amp; len(mb.buckets) \u0026gt; 0 { // At this data point, we have conventional histogram // buckets and a native histogram with the same name and // labels. Do not evaluate anything. // TODO(beorn7): Issue a warning somehow. delete(enh.signatureToMetricWithBuckets, string(enh.lblBuf)) continue } enh.Out = append(enh.Out, Sample{ Metric: enh.DropMetricName(sample.Metric), F: histogramQuantile(q, sample.H), }) } for _, mb := range enh.signatureToMetricWithBuckets { if len(mb.buckets) \u0026gt; 0 { enh.Out = append(enh.Out, Sample{ Metric: mb.metric, F: bucketQuantile(q, mb.buckets), }) } } return enh.Out } // bucketQuantile calculates the quantile \u0026#39;q\u0026#39; based on the given buckets. The // buckets will be sorted by upperBound by this function (i.e. no sorting // needed before calling this function). The quantile value is interpolated // assuming a linear distribution within a bucket. However, if the quantile // falls into the highest bucket, the upper bound of the 2nd highest bucket is // returned. A natural lower bound of 0 is assumed if the upper bound of the // lowest bucket is greater 0. In that case, interpolation in the lowest bucket // happens linearly between 0 and the upper bound of the lowest bucket. // However, if the lowest bucket has an upper bound less or equal 0, this upper // bound is returned if the quantile falls into the lowest bucket. // // There are a number of special cases (once we have a way to report errors // happening during evaluations of AST functions, we should report those // explicitly): // // If \u0026#39;buckets\u0026#39; has 0 observations, NaN is returned. // // If \u0026#39;buckets\u0026#39; has fewer than 2 elements, NaN is returned. // // If the highest bucket is not +Inf, NaN is returned. // // If q==NaN, NaN is returned. // // If q\u0026lt;0, -Inf is returned. // // If q\u0026gt;1, +Inf is returned. func bucketQuantile(q float64, buckets buckets) float64 { if math.IsNaN(q) { return math.NaN() } if q \u0026lt; 0 { return math.Inf(-1) } if q \u0026gt; 1 { return math.Inf(+1) } slices.SortFunc(buckets, func(a, b bucket) bool { return a.upperBound \u0026lt; b.upperBound }) if !math.IsInf(buckets[len(buckets)-1].upperBound, +1) { return math.NaN() } buckets = coalesceBuckets(buckets) ensureMonotonic(buckets) if len(buckets) \u0026lt; 2 { return math.NaN() } observations := buckets[len(buckets)-1].count if observations == 0 { return math.NaN() } rank := q * observations b := sort.Search(len(buckets)-1, func(i int) bool { return buckets[i].count \u0026gt;= rank }) if b == len(buckets)-1 { return buckets[len(buckets)-2].upperBound } if b == 0 \u0026amp;\u0026amp; buckets[0].upperBound \u0026lt;= 0 { return buckets[0].upperBound } var ( bucketStart float64 bucketEnd = buckets[b].upperBound count = buckets[b].count ) if b \u0026gt; 0 { bucketStart = buckets[b-1].upperBound count -= buckets[b-1].count rank -= buckets[b-1].count } return bucketStart + (bucketEnd-bucketStart)*(rank/count) } ç›¸å…³èµ„æ–™\nhttps://stackoverflow.com/questions/55162093/understanding-histogram-quantile-based-on-rate-in-prometheus https://stackoverflow.com/questions/60962520/how-to-get-the-quantile-of-rate-in-prometheus/65418483#65418483 å¯ä»¥åœ¨ prometheus é¡¹ç›®ä¸‹æ‰§è¡Œä¸‹é¢çš„å•æµ‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 func TestBucketQuantile__rate5m(t *testing.T) { q := 0.4 myBuckets := buckets{ {10, 5}, {20, 8}, {30, 12}, {40, 15}, {math.Inf(1), 15}, } f := bucketQuantile(q, myBuckets) println(\u0026#34;==== before rate =====\u0026#34;) fmt.Println(myBuckets) fmt.Printf(\u0026#34;%.2f\\n\u0026#34;, f) for i, myBucket := range myBuckets { myBuckets[i].count = myBucket.count / float64(5*60) } println(\u0026#34;==== after rate =====\u0026#34;) fmt.Println(myBuckets) f1 := bucketQuantile(q, myBuckets) fmt.Printf(\u0026#34;%.2f\\n\u0026#34;, f1) } ","date":"2022-10-11T22:09:19+08:00","permalink":"https://zhumengzhu.github.io/2022/10/prometheus-and-grafana-learning-notes/","title":"Prometheus \u0026 Grafana å­¦ä¹ è®°å½•"},{"content":"èµ„æ–™ï¼š\nR æ ‘åŸºç¡€ï¼šç©ºé—´æ•°æ®ç´¢å¼•RTreeï¼ˆRæ ‘ï¼‰å®Œå…¨è§£æåŠJavaå®ç° å®ç”¨åœºæ™¯ åŸºäºHBaseä¸é™æ€å¤šçº§æ ¼ç½‘ç´¢å¼•çš„åœ°è¡¨è¦†ç›–æ•°æ®é«˜æ•ˆæ£€ç´¢æ–¹æ³• å¦‚ä½•ç†è§£ R æ ‘ R æ ‘æ˜¯å¹³è¡¡æ ‘ï¼› å¹³è¡¡æ ‘è¦æ±‚èŠ‚ç‚¹æœ‰åºï¼› R æ ‘çš„èŠ‚ç‚¹æ˜¯é«˜ç»´æ•°æ®ï¼Œæ¯”å¦‚å¯¹äºäºŒç»´æ¥è¯´ï¼Œå­˜å‚¨çš„æ˜¯ MBR(æœ€å°é™å®šçŸ©å½¢)ï¼› é«˜ç»´æ•°æ®çš„é¡ºåºå¦‚ä½•å®šä¹‰ï¼Ÿ å¯¹ä¸€ç»´çš„çº¿æ®µæ¥è¯´ï¼Œå®šä¹‰ä¸€ä¸ªåæ ‡ç³»ï¼Œå­˜åœ¨ä¸€ä¸ªåŸç‚¹ï¼Œçº¿æ®µå·¦ç«¯ç‚¹è·åŸç‚¹çš„è·ç¦»ä½œä¸ºæ’åºçš„ä¾æ®ï¼› å¯¹äºŒç»´çš„MBRæ¥è¯´(å¯ä»¥ç”¨å·¦ä¸‹ï¼Œå³ä¸Šä¸¤ä¸ªç‚¹çš„åæ ‡è¡¨ç¤ºä¸€ä¸ªçŸ©å½¢)ï¼Œæ€ä¹ˆå®šä¹‰ï¼Ÿ çŒœæƒ³ï¼Œå®šä¹‰å¹³é¢ç›´è§’åæ ‡ç³»ï¼Œä»¥å·¦ä¸‹ç‚¹çš„åæ ‡(x,y)ä½œä¸ºæ’åºçš„ä¾æ®ï¼šæ¯”å¦‚(1,2)\u0026lt;(1,3)\u0026lt;(2,1)ï¼› åŸºæœ¬æ¦‚å¿µ MBR Packed 1-D R-Tree 2-D R-Tree ä¸Šå›¾ä¸­ï¼Œæ€»è®¡ 12 ä¸ªå®çº¿æ¡†ï¼Œæ­£å¥½å¯¹åº” R æ ‘ä¸­ 12 ä¸ªå¶å­èŠ‚ç‚¹ R8~R19;\nå®é™…åº”ç”¨ é“è·¯ç´¢å¼• æ¯ä¸€æ¡è·¯ä½¿ç”¨ä¸€ä¸ªæœ€å°MBBæ¥è¿›è¡ŒåŒ…è£¹ï¼Œä½¿å®ƒæˆä¸ºRæ ‘çš„å¶å­ç»“ç‚¹ï¼ˆä¹Ÿå°±æ˜¯é‚£äº›æ•°æ®ç»“ç‚¹ï¼‰\nå°†æ¯ä¸€æ¡è·¯çš„æœ€å°MBBä½œä¸ºRæ ‘çš„æ•°æ®å•å…ƒæ¥è¿›è¡Œæ„å»ºRæ ‘(è¿™é‡Œé‡‡ç”¨çš„æ˜¯Ræ ‘çš„æ”¹è¿›ç‰ˆæœ¬R*æ ‘)\n","date":"2022-09-28T21:52:53+08:00","permalink":"https://zhumengzhu.github.io/2022/09/r-tree-and-its-family/","title":"Ræ ‘åŠå…¶å®¶æ—"},{"content":"èƒŒæ™¯ ä¸ºäº†å‘ç”¨æˆ·æä¾›å¤©æ°”æœåŠ¡ï¼Œè®¡åˆ’æ¥å…¥ä¸‰æ–¹å¤©æ°” APIï¼Œä½†æœ‰äº›ä¸‰æ–¹çš„ API æŒ‰è°ƒç”¨æ¬¡æ•°æ”¶è´¹ï¼›ä¸ºäº†èŠ‚çœæˆæœ¬ï¼Œè€ƒè™‘ä½¿ç”¨ç¼“å­˜ä»¥å‡å°‘è°ƒç”¨æ¬¡æ•°ã€‚å…·ä½“å¦‚ä½•å®ç°å‘¢ï¼Ÿ\nè€ƒè™‘åˆ°ç”¨æˆ·çš„è¯·æ±‚å‚æ•°ç»åº¦å’Œçº¬åº¦ä¸¤ä¸ªå‚æ•°ï¼Œç›´æ¥ä½¿ç”¨ç»çº¬åº¦ä½œä¸ºç¼“å­˜çš„ key æ˜¾ç„¶ä¸åˆé€‚ï¼Œå› ä¸ºç»çº¬åº¦æ˜¯è¿ç»­çš„ã€æ— é™çš„ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ç©ºé—´ç´¢å¼•æŠ€æœ¯ã€‚\né¦–å…ˆæƒ³åˆ°çš„è‡ªç„¶æ˜¯ GeoHashï¼Œå®ƒæ˜¯ç©ºé—´ç´¢å¼•çš„ä¸€ç§å®ç°ï¼Œå°†åœ°çƒä¸Šçš„äºŒç»´ç»çº¬åº¦æ˜ å°„åˆ°ä¸€ç»´çš„æ•´æ•°ç©ºé—´ï¼Œç„¶åä½¿ç”¨æ•´æ•°ç©ºé—´è¿›è¡Œç´¢å¼•ã€‚\nGeoHash å’Œ Redis èµ„æ–™ä¸€ https://medium.com/groupon-eng/scaling-millions-of-geospatial-queries-per-minute-using-redis-7c05bcf6b4db\nGEOADD command can be used to index spatial entities in Redis.\nThe time complexity for this command is O(log(N)) for each item added, where N is the number of elements in the sorted set.\nTo perform a spatial search of entities GEORADIUS or GEORADIUSBYMEMBER can be used in Redis 3.\u0026gt; 2.0 (and above) and GEOSEARCH or GEOSEARCHSTORE can be used in Redis 6.2 (and above).\nThe time complexity for these commands is approximately O(N+log(M)) where N is the number of \u0026gt; elements inside the bounding box of the circular area delimited by center and radius, and M is \u0026gt; the number of items inside the index.\nThere are plenty of solutions available for implementing spatial searches.\nData structures like Quadtree, R-tree, and K-d tree can be used to index the entities.\nGeospatial indexers like S2 and H3 can be used for similar queries.\nç–‘é—®ï¼š\nä¸ºä»€ä¹ˆ GEOADD å¤æ‚åº¦æ˜¯ O(log(N))ï¼Œä¸ºä»€ä¹ˆ ZADD å¤æ‚åº¦æ˜¯ O(log(N))ï¼Œä¸¤è€…æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ ä¸ºä»€ä¹ˆ GEORADIUS å¤æ‚åº¦æ˜¯ O(N + log(M)), ä¸ºä»€ä¹ˆ ZRANGE å¤æ‚åº¦æ˜¯ O(N+log(M))ï¼Œä¸¤è€…æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ è§£ç­”ï¼š\nZADD ä¸ ZRANGE çš„æ—¶é—´å¤æ‚åº¦ï¼šRedisä¸­Sorted-Setæ—¶é—´å¤æ‚åº¦å’Œå®æˆ˜ GEOADD åº•å±‚åŸºäº ZADDï¼Œæ‰€ä»¥å¤æ‚åº¦ç›¸åŒï¼› GEORADIUS åº•å±‚åŸºäº ZRANGEï¼Œä½†æ˜¯æ›´å¤æ‚ï¼Œæ‰€ä»¥å¤æ‚åº¦ç›¸åŒï¼Œä½†ç”±äºä¼šæœç´¢å‘¨è¾¹ 9 ä¸ªæ–¹æ ¼ï¼Œå› æ­¤ç³»æ•°æ›´å¤§ï¼› èµ„æ–™äºŒ https://www.memurai.com/blog/geospatial-queries-in-redis\nRedis ä¸å­˜å‚¨åŸå§‹çš„åæ ‡\nGEOADD cities -122.34 47.61 Seattle ZRANGE cities 0 -1 WITHSCORES GEOHASH cities Seattle GEOPOS cities Seattle\nNotice that we provided â€“122.34 as longitude and 47.61 as latitude when calling GEOADD, but \u0026gt; received â€“122.33999758958816528 and 47.61000085169597185, respectively, in return.\nThis is an unfortunate consequence of Redis using a 52-bit geohash to store the coordinates:\nRedis does not store the raw set of coordinates that we provide, but instead decodes the internally stored geohash to generate a GEOPOS response.\nèµ„æ–™ä¸‰ https://luoming1224.github.io/2019/04/08/%5Bredis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%5Dredis%E4%B8%ADGeo%E5%91%BD%E4%BB%A4%E4%BB%8B%E7%BB%8D/ https://luoming1224.github.io/2019/04/04/[redis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0]GeoHash%E7%AE%97%E6%B3%95%E8%AF%A6%E8%A7%A3%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0/ https://developer.aliyun.com/article/62844#slide-16 https://blog.huangz.me/diary/2015/annotated-redis-geo-source.html GeoSearch åŸç† geohashç¼–ç è¶Šé•¿ç²¾åº¦è¶Šé«˜ï¼Œç›¸åç¼–ç è¶ŠçŸ­ï¼Œè¡¨ç¤ºçš„èŒƒå›´è¶Šå¤§ï¼Œå‰ç¼€ç›¸åŒçš„å­—ç¬¦ä¸²è¡¨ç¤ºçš„èŒƒå›´æ¥è¿‘ï¼Œæ ¹æ®ä¸­å¿ƒç‚¹ä½ç½®å’Œæœç´¢èŒƒå›´\u0026gt; è·ç¦»è®¡ç®—geohashç¼–ç çš„é•¿åº¦å’Œgeohashç¼–ç ï¼Œç„¶åæœç´¢ä»¥è¯¥geohashç¼–ç ä¸ºå‰ç¼€çš„ç‚¹ä»¥åŠå‘¨è¾¹ï¼˜ä¸ªèŒƒå›´å†…çš„ç‚¹ï¼Œè¿”å›æ»¡è¶³è¦æ±‚\u0026gt; çš„ç‚¹ã€‚\nå‡½æ•°geohashGetAreasByRadiusWGS84æ ¹æ®ä¸­å¿ƒç‚¹ä½ç½®å’Œæœç´¢èŒƒå›´è·ç¦»è®¡ç®—geohashç¼–ç çš„é•¿åº¦å’Œgeohashç¼–ç ï¼Œä»¥åŠåœ¨\u0026gt; geohashé•¿åº¦ç¼–ç çš„åŸºç¡€ä¸Šï¼Œè®¡ç®—å‘¨è¾¹8ä¸ªåŒºå—çš„geohashã€‚\nå‡½æ•°membersOfAllNeighborså¯¹ä¸­å¿ƒç‚¹ä»¥åŠå®ƒå‘¨è¾¹å…«ä¸ªæ–¹å‘è¿›è¡ŒæŸ¥æ‰¾ï¼Œæ‰¾å‡ºæ‰€æœ‰èŒƒå›´å†…çš„å…ƒç´ ï¼Œè¿”å›æ»¡è¶³æœç´¢è·ç¦»èŒƒå›´çš„ç‚¹ã€‚\u0026gt; è¯¥å‡½æ•°ä¸­ä¾æ¬¡å¯¹ä¸­å¿ƒç‚¹åŠå‘¨è¾¹8ä¸ªåŒºå—è°ƒç”¨membersOfGeoHashBoxå‡½æ•°ã€‚\nlong_rangeå’Œlat_rangeä¸ºåœ°çƒç»çº¬åº¦çš„èŒƒå›´ï¼›hash-\u0026gt;bitsç”¨æˆ·ä¿å­˜æœ€ç»ˆäºŒè¿›åˆ¶ç¼–ç ç»“æœï¼Œhash-\u0026gt;stepæ˜¯ç»çº¬åº¦åˆ’åˆ†çš„æ¬¡\u0026gt; æ•°ï¼Œåœ¨redisä¸­è¯¥å€¼ä¸º26ï¼Œå³ç»åº¦/çº¬åº¦çš„äºŒè¿›åˆ¶ç¼–ç é•¿åº¦ä¸º26ï¼Œæœ€ç»ˆç»äº¤å‰ç»„åˆè€Œæˆçš„åœ°ç†ä½ç½®çš„äºŒè¿›åˆ¶ç¼–ç ä¸º52ä½ã€‚Base32\u0026gt; ç¼–ç ä¸ºæ¯5bitsç»„æˆä¸€ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥æœ€ç»ˆçš„GeoHashå­—ç¬¦ä¸²ä¸º11ä½ã€‚\nä¸ºä»€ä¹ˆæ˜¯52ä½ï¼Ÿå› ä¸ºåœ¨redisä¸­æ˜¯æŠŠåœ°ç†ä½ç½®ç¼–ç åçš„äºŒè¿›åˆ¶å€¼å­˜å…¥zsetæ•°æ®ç»“æ„ä¸­ï¼Œdoubleç±»å‹çš„å°¾æ•°éƒ¨åˆ†é•¿åº¦ä¸º52ä½ã€‚\nRedis çš„è®¾è®¡æ€è·¯æ¨æ¼” GeoHash é™¤äº†å¯ä»¥å¯¹ç©ºé—´è¿›è¡Œç¼–ç ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªå…³é”®ç‰¹æ€§ï¼Œä½¿å¾— Redis å¯ä»¥é€šè¿‡ç»„åˆ GeoHash ä¸ ZSETï¼Œå®ç°ç©ºé—´ç´¢å¼•åŠŸèƒ½ï¼Œè¿™ä¸¤ä¸ªç‰¹æ€§æ˜¯ï¼š\nå“ˆå¸Œå¯ä»¥æœ‰ä»»æ„ç²¾åº¦ï¼›\nç›¸è¿‘ç‚¹æœ‰ç›¸ä¼¼çš„å‰ç¼€ï¼Œè¿™ä½¿å¾—å¯ä»¥é€šè¿‡æ¯”è¾ƒ geohash å€¼æŸ¥æ‰¾é™„è¿‘çš„ç‚¹ï¼› æ€è·¯æ¨æ¼”ï¼š\nå½“åªä½¿ç”¨ GeoHash æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„åˆ¤å®šä¸¤ä¸ªç‚¹æ˜¯å¦åœ¨å±äºåŒä¸€ä¸ªåŒºåŸŸï¼š\nGeoHash(point1, precision=7) == GeoHash(point2, precision=7) å¦‚æœå°† hash å€¼ç›¸åŒçš„ç‚¹æ”¾å…¥ setï¼Œé‚£ä¹ˆå°±å¯ä»¥å®ç°â€œå‘¨è¾¹æœâ€ï¼š\né¦–å…ˆè®¡ç®—è¦æœç´¢ç‚¹éƒ½ geohash å€¼ï¼› ç„¶åä»¥è¯¥å€¼ä½œä¸º key å»æŸ¥æ‰¾å¯¹åº”çš„ setï¼› ä¸Šè¿°æ–¹æ³•ï¼Œéœ€è¦é¢„å…ˆæŒ‡å®š geohash çš„ç²¾åº¦ï¼Œå­˜å‚¨å’ŒæŸ¥è¯¢æ—¶éƒ½å¿…é¡»ä»¥ç›¸åŒçš„ç²¾åº¦è¿›è¡Œï¼Œå‡å¦‚ï¼š\nå­˜å‚¨æ—¶ï¼šsadd(GeoHash(point1, precision=7), point1); è¯»å–æ—¶ï¼šæ‰§è¡Œ smembers(GeoHash(point1, precision=6)), ç”±äºç²¾åº¦ä¸åŒï¼Œgeohash å€¼ä¸åŒï¼Œæ­¤æ—¶æ— æ³•å°† point1 æŸ¥æ‰¾å‡ºæ¥; å‡å¦‚ç”¨ä¸Šè¿°æ–¹æ³•å®ç°åœ°å›¾æœç´¢åŠŸèƒ½ï¼Œæ„å‘³ç€ï¼Œå¦‚æœä»¥ 3KM çš„ç½‘æ ¼å­˜å‚¨ï¼Œé‚£ä¹ˆæŸ¥è¯¢ä¹Ÿå¿…é¡»ä»¥ 3KM è¿›è¡ŒæŸ¥ï¼Œè¿™æ ·çš„é™åˆ¶å¤ªå¤§ï¼›\næ­¤æ—¶å¯ä»¥åˆ©ç”¨â€œç›¸è¿‘ç‚¹æœ‰ç›¸ä¼¼å‰ç¼€â€ç‰¹æ€§ï¼Œå¯¹ geohash è¿›è¡Œæ’åºï¼Œä¹Ÿå°±æ˜¯ç”¨ geohash ä½œä¸ºç´¢å¼•ï¼š\næ­¤æ—¶ï¼Œå¦‚æœå­˜å‚¨æ—¶ç²¾åº¦ä¸º 7ï¼Œé‚£ä¹ˆæœç´¢å¯ä»¥æ”¯æŒå¤§äºç­‰ 7 çš„ä»»æ„ç²¾åº¦ï¼›\nåœ¨ Redis ä¸­ï¼Œæ”¯æŒæ’åºçš„æ˜¾ç„¶æ˜¯ ZSETï¼Œå› æ­¤ï¼ŒRedis æœ€ç»ˆåœ¨ 3.2 ç‰ˆæœ¬é€‰æ‹©äº†ç»„åˆ GeoHash å’Œ ZSET å®ç°äº†ç›¸å…³çš„ç©ºé—´ç´¢å¼•åŠŸèƒ½ï¼› çœ‹èµ·æ¥å¾ˆå®Œç¾ï¼Œä½†æ˜¯ï¼ŒGeoHash åªæ˜¯å¯¹å¤§éƒ¨åˆ†ç‚¹æ¥è¯´ï¼Œç¼–ç ç›¸ä¼¼è·ç¦»ä¹Ÿç›¸è¿‘ï¼Œå®é™…å®ƒå­˜åœ¨çªå˜æ€§ï¼Œä¹Ÿå°±æ˜¯ç¼–ç ç›¸é‚»ä½†è·ç¦»å¯èƒ½å¾ˆè¿œï¼š\nGeoHash å­˜åœ¨ç¼ºé™·ï¼šhttps://www.jianshu.com/p/1ecf03293b9a\nç–‘é—®ï¼š\næ€ä¹ˆæ‰¾å‘¨å›´ 8 ä¸ªåŒºåŸŸçš„ GeoHashï¼Ÿ GeoHash çš„ç¼ºé™·åŠè§£å†³ https://patents.google.com/patent/CN103383682A/zh https://www.developers.pub/article/637 Google S2/Uber h3 https://juejin.cn/post/6921977063477870606 https://github.com/halfrost/Halfrost-Field/blob/master/contents/Go/go_s2_CellID.md https://www.jianshu.com/p/3dbaf73a09af https://blog.csdn.net/qq_43777978/article/details/116800460 https://blog.csdn.net/alinyua/article/details/105803546 ä¸ºä»€ä¹ˆèƒ½å¤Ÿåšç½‘æ ¼ç©ºé—´ç´¢å¼•çš„å½¢çŠ¶åªæœ‰ä¸‰è§’å½¢ã€çŸ©å½¢å’Œå…­è¾¹å½¢(https://www.biaodianfu.com/uber-h3.html): H3æ˜¯ä¸€ç§åŸºäºç½‘æ ¼çš„ç©ºé—´ç´¢å¼•ï¼Œä½†è·Ÿæ™®é€šçš„çŸ©å½¢ç½‘æ ¼ç´¢å¼•ä¸åŒçš„æ˜¯ï¼Œä»–çš„æ¯ä¸€ä¸ªç½‘æ ¼éƒ½æ˜¯æ­£å…­è¾¹å½¢ã€‚ä¸ºå•¥è¦é€‰æ­£å…­è¾¹å½¢å‘¢ï¼Œå› ä¸ºåœ¨åŸºäºç½‘æ ¼çš„ç©ºé—´ç´¢å¼•ä¸­ï¼Œä½¿ç”¨çš„å¤šè¾¹å½¢çš„è¾¹æ•°è¶Šå¤šï¼Œåˆ™ä¸€ä¸ªç½‘æ ¼è¶Šè¿‘ä¼¼åœ†å½¢ï¼Œåšç¼“å†²åŒºæŸ¥è¯¢ã€kNNæŸ¥è¯¢ä»€ä¹ˆçš„ä¹Ÿå°±è¶Šæ–¹ä¾¿ã€‚è€Œåšç½‘æ ¼ç´¢å¼•åˆè¦æ±‚ç©ºé—´èƒ½å¤Ÿè¢«ç½‘æ ¼é“ºæ»¡ï¼Œä¸èƒ½æœ‰ç¼éš™ã€‚æ ¹æ®åˆä¸­æ•°å­¦çŸ¥è¯†ï¼Œæˆ‘ä»¬çŸ¥é“ä¸€ä¸ªå¤šè¾¹å½¢çš„å†…è§’å’Œå…¬å¼ä¸ºï¼š\nğœƒ=(ğ‘¥â€“2)âˆ—180âˆ˜\nå…¶ä¸­ï¼Œxä¸ºå¤šè¾¹å½¢çš„è¾¹æ•°ï¼Œğœƒä¸ºå¤šè¾¹å½¢çš„å†…è§’å’Œã€‚åˆ™ä¸€ä¸ªæ­£å¤šè¾¹å½¢çš„æ¯ä¸ªè§’çš„è§’åº¦ä¸º ğœƒğ‘¥=(ğ‘¥â€“2)âˆ—180âˆ˜ğ‘¥ï¼Œè€Œå¦‚æœéœ€è¦å¤šè¾¹å½¢èƒ½å¤Ÿé“ºæ»¡ç©ºé—´ï¼Œåˆ™åœ¨å¤šè¾¹å½¢çš„é¡¶ç‚¹ç›¸äº¤å¤„ï¼Œè®¾æ¯ä¸ªé¡¶ç‚¹æœ‰yä¸ªå¤šè¾¹å½¢ç›¸äº¤ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹ç­‰å¼ï¼š\n360âˆ˜ğ‘¦=(ğ‘¥â€“2)âˆ—180âˆ˜ğ‘¥\nä»¥ä¸Šç­‰å¼çš„æ±‚è§£è¿‡ç¨‹æˆ‘ä¸å†èµ˜è¿°ï¼Œè¿™ä¸ªç­‰å¼åªæœ‰ä¸‰ç»„æ•´æ•°è§£ï¼šx=3,y=6ï¼›x=4,y=4ï¼›x=6,y=3ã€‚\nå› æ­¤ï¼Œèƒ½å¤Ÿåšç½‘æ ¼ç©ºé—´ç´¢å¼•çš„å½¢çŠ¶åªæœ‰ä¸‰è§’å½¢ã€çŸ©å½¢å’Œå…­è¾¹å½¢ï¼Œè€Œå…­è¾¹å½¢å› ä¸ºè¾¹æ•°æœ€å¤šï¼Œæœ€æ¥è¿‘åœ†ï¼Œæ‰€ä»¥ç†è®ºä¸Šæ¥è¯´åœ¨æŸäº›åœºæ™¯ä¸‹æ˜¯æœ€ä¼˜çš„é€‰æ‹©ã€‚\nå…¶å®ƒ ä»€ä¹ˆæ˜¯WGS84åæ ‡ç³» https://zhuanlan.zhihu.com/p/97363931\n","date":"2022-09-22T21:31:50+08:00","permalink":"https://zhumengzhu.github.io/2022/09/spatial-index-technology-first-glimpse/","title":"ç©ºé—´ç´¢å¼•æŠ€æœ¯åˆè§"}]