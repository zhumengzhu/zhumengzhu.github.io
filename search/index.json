[{"content":"è¦ç‚¹ç®€ä»‹ï¼š\næœåŠ¡è§„æ¨¡ï¼š40å°4C8Gæœºå™¨çš„ç”Ÿäº§çº§æ¨¡å‹æ¨ç†é›†ç¾¤ ä¸šåŠ¡åŸºå‡†ï¼šç¨³å®šæ”¯æ’‘1ä¸‡QPSï¼ŒæœåŠ¡SLAè¦æ±‚50ms@TP9999 é—®é¢˜ç‰¹å¾ï¼šæ— ä»£ç å˜æ›´çš„æƒ…å†µä¸‹å‡ºç°æ€§èƒ½æ–­å´– å¼•å‘æ€è€ƒï¼šçœ‹ä¼¼ç¨³å®šçš„ç³»ç»Ÿä¸ºä½•ä¼šçªç„¶æ€§èƒ½åŠ£åŒ–ï¼Ÿ Previous Next \u0026nbsp; \u0026nbsp; / [pdf] View the PDF file here. ","date":"2024-07-19T11:30:00+08:00","permalink":"https://zhumengzhu.github.io/2024/07/in-depth-jvm-performance-tuning-guide/","title":"JVMæ€§èƒ½è°ƒä¼˜å®æˆ˜åˆ†äº«"},{"content":"èƒŒæ™¯ staging ç¯å¢ƒï¼ŒæŸä¸ªè½¦è”ç½‘æœåŠ¡å†…å­˜å‡ºç°äº†å†…å­˜æ³„éœ²ï¼Œç›¸å…³åŒå­¦åœ¨ 06-14 åŠ 06-15 ä¸¤å¤©åˆ†åˆ«é‡‡é›†äº†ä¸¤ä¸ª dump æ–‡ä»¶ï¼Œä»¥ä¸‹ç®€å•è®°å½•åˆ†æè¿‡ç¨‹ã€‚\nå†…å­˜æ³„éœ²æœ€å¸¸ç”¨çš„æ’æŸ¥å·¥å…·æ˜¯ Eclipse Memory Analyzer (MAT)ï¼Œä½¿ç”¨ MAT æ‰“å¼€ä¸¤ä¸ª dump æ–‡ä»¶ã€‚\né¦–å…ˆçœ‹ Leak Suspects ç–‘ç‚¹ä¸€ï¼šJarFile org.springframework.boot.loader.jar.JarFile æ˜¯ Spring Boot çš„ç±»åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½ jar åŒ…ã€‚\nçŒœæµ‹æ­¤é—®é¢˜ä¸ Druid issue-3808 ç±»ä¼¼ï¼š\næ‰€æœ‰ jar åŒ…è¢«åŠ è½½çš„æ¬¡æ•°å‡ ä¹ç›¸åŒï¼› å†…å­˜ dump ä¸­ç›¸å…³å¯¹è±¡çš„æ•°é‡åªæœ‰å‡ åƒä¸ªï¼Œå’Œè¯·æ±‚é‡æ— å…³ï¼Œæ›´åƒæ˜¯æŸäº›å®šæ—¶ä»»åŠ¡åœ¨åšç±»åŠ è½½ï¼š 06-14 çš„ dump ä¸­åŠ è½½æ¬¡æ•°çº¦ä¸º 3250ï¼› 06-15 çš„ dump ä¸­åŠ è½½æ¬¡æ•°çº¦ä¸º 1260ï¼› å¯ä»¥é€šè¿‡å‡çº§æˆ–é™çº§ mysql-connector-java ç‰ˆæœ¬è¿›è¡ŒéªŒè¯ã€‚\nç–‘ç‚¹äºŒï¼šLockPubSub org.redisson.pubsub.LockPubSub æ˜¯ Redisson çš„åˆ†å¸ƒå¼é”å®ç°ï¼Œç”¨äºåˆ†å¸ƒå¼é”çš„è®¢é˜…å’Œæ¶ˆæ¯é€šçŸ¥ï¼šåŠ é”å¯¹è±¡å¦‚æœå·²ç»è¢«é”å®šéœ€è¦ç­‰å¾…çš„æ—¶å€™ï¼Œé€šè¿‡ pubsub è®¢é˜…æ¶ˆæ¯æ³¨å†Œä¸€ä¸ª listener æ¥ç­‰å¾…é”èµ„æºã€‚\nåˆ†æ 06-14 çš„å†…å­˜ dumpï¼Œå‘ç° key 7e5axxxc00:gateway:xx:zz:msg:task:lock:c53fxxxaa13a çš„ listeners è¾¾åˆ° 33206 ä¸ªï¼Œå†…å­˜å ç”¨è¾¾åˆ° 1.32 GBã€‚\næ­¤é—®é¢˜ä¸ redisson-issues-3577æœ‰äº›ç›¸ä¼¼ï¼Œä½†æˆ‘åœ¨æ—¥å¿—ä¸­æ²¡æœ‰æ‰¾åˆ°è¿™ä¸ªæœåŠ¡é”çš„ timeout æ—¥å¿—ï¼ˆå¯èƒ½å› ä¸ºä¸šåŠ¡ä»£ç æ²¡æ‰“å°ï¼‰ï¼Œè€Œåªæœ‰è·å–é”å¤±è´¥çš„æ—¥å¿—ã€‚\nå¦å¤–ï¼Œä¸šåŠ¡æ—¥å¿—ä¸­åªæœ‰é‡Šæ”¾é”çš„æ—¥å¿—ï¼Œè€Œæ²¡æœ‰åŠ é”çš„æ—¥å¿—(ä¹Ÿå¯èƒ½å› ä¸ºä¸šåŠ¡ä»£ç æ²¡æ‰“å°)ã€‚ è¿›ä¸€æ­¥åˆ†æ 1ã€å¯¹å†…å­˜æ³„éœ²éƒ¨åˆ†çš„ char æ•°ç»„è¿›è¡Œèšåˆçš„ç»“æœï¼ˆ2.12 GB çš„å†…å­˜æ³„éœ²ï¼Œæ—¥å¿—ä¿¡æ¯ 1.66GBï¼Œå æ¯”æ¥è¿‘ 80%ï¼‰ï¼š 2ã€å…¶ä¸­ä¸€ä¸ª char æ•°ç»„åˆ° gc roots çš„è·¯å¾„ï¼š è¿™ä¹Ÿæ˜¯å†…å­˜æ³„éœ²çš„è·¯å¾„ï¼šOpenTelemetry åœ¨åšé“¾è·¯è¿½è¸ªæ—¶ï¼Œä¼šå°†ä¸€æ¬¡ gRPCã€HTTP è°ƒç”¨æˆ– MQ æ¶ˆè´¹è¿‡ç¨‹ä¸­çš„ Metrics ä»¥åŠæ—¥å¿—ä¿¡æ¯éƒ½æ”¾åˆ°å®ƒçš„ Context å¯¹è±¡ä¸­ï¼Œè¿™æ¬¡è°ƒç”¨æˆ–æ¶ˆè´¹ä¸ç»“æŸï¼Œè¿™äº›å†…å­˜å°±ä¼šè¢«å¼•ç”¨è€Œé‡Šæ”¾ï¼›ä¸šåŠ¡ä½¿ç”¨åˆ†å¸ƒå¼é”çš„æ–¹å¼å¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œå¯¼è‡´å¾ˆå¤šè¯·æ±‚æ— æ³•ç»“æŸï¼Œå¤§é‡å¯¹è±¡å­˜æ´»æ— æ³•é‡Šæ”¾ã€‚\n3ã€ä»¥ä¸‹ä¸ºè¯¥æœåŠ¡æ‰“å°æ—¥å¿—çš„é¢‘ç‡ç›‘æ§\u0026mdash;-æ¯åˆ†é’Ÿå‡ åƒæ¡æ—¥å¿—ã€‚ 4ã€å¦å¤–é€šè¿‡Kibana æŸ¥è¯¢å‘ç°ï¼Œæœ‰å¾ˆå¤šåŠ¨è¾„å‡ å KB çš„ä¸šåŠ¡æ—¥å¿—ï¼ˆæ•æ„Ÿæ•°æ®å°±ä¸è´´å›¾äº†ï¼‰ã€‚ 5ã€æœåŠ¡çš„ GC ä¿¡æ¯ ç»¼åˆä¸Šè¿°ä¿¡æ¯ï¼Œå¯ä»¥ç¡®å®šæœåŠ¡å†…å­˜æ³„éœ²ï¼Œé«˜æ¦‚ç‡æ˜¯å¤§æ—¥å¿—å¯¼è‡´çš„ã€‚\nè§£å†³æ–¹æ³• å‡çº§æˆ–é™çº§ mysql-connector-java ç‰ˆæœ¬ é¿å…å¤§æ—¥å¿— å‚è€ƒèµ„æ–™ Redisåˆ†å¸ƒå¼é”-è¿™ä¸€ç¯‡å…¨äº†è§£(Redissionå®ç°åˆ†å¸ƒå¼é”å®Œç¾æ–¹æ¡ˆ) https://github.com/redisson/redisson/issues/4216 https://github.com/redisson/redisson/issues/4294 ","date":"2023-07-17T11:46:30+08:00","permalink":"https://zhumengzhu.github.io/2023/07/memory-leak-issue-in-a-service/","title":"è®°ä¸€æ¬¡æŸæœåŠ¡å†…å­˜æ³„éœ²é—®é¢˜"},{"content":"Q1ã€JDK å’Œ JRE çš„åŒºåˆ« ç­”ï¼šJDK æ˜¯ JRE çš„çˆ¶é›†ï¼Œæˆ‘ä»¬ POD ä¸­éœ€è¦å®‰è£… JDKï¼Œä»¥ä¾¿èƒ½è¿è¡Œä¸€äº›è¯Šæ–­å·¥å…·ã€‚\nJDK(Java Development Kitï¼ŒJava å¼€å‘å·¥å…·åŒ…) ï¼Œæ˜¯æ•´ä¸ªJAVAçš„æ ¸å¿ƒï¼ŒåŒ…æ‹¬äº†Javaè¿è¡Œç¯å¢ƒJREï¼ˆJava Runtime Envirnmentï¼‰ï¼Œä¸€å †Javaå·¥å…·ï¼ˆjavac/java/jdbç­‰ï¼‰å’ŒJavaåŸºç¡€çš„ç±»åº“ï¼‰ï¼ŒåŒ…å«JVMæ ‡å‡†å®ç°åŠJavaæ ¸å¿ƒç±»åº“ã€‚ JRE(Java Runtime Environment Java è¿è¡Œç¯å¢ƒ) ï¼Œæ˜¯ JDK çš„å­é›†ï¼Œä¹Ÿå°±æ˜¯åŒ…æ‹¬ JRE æ‰€æœ‰å†…å®¹ï¼Œä»¥åŠå¼€å‘åº”ç”¨ç¨‹åºæ‰€éœ€çš„ç¼–è¯‘å™¨å’Œè°ƒè¯•å™¨ç­‰å·¥å…·ã€‚ è§ï¼šhttps://docs.oracle.com/javase/8/docs/ Q2ã€Oracle JDK ç©¶ç«Ÿä»å“ªä¸ªç‰ˆæœ¬å¼€å§‹æ”¶è´¹ï¼Ÿ ç­”ï¼šjdk8u201 å’Œ jdk8u202 æ˜¯ orcale jdk8 æœ€åçš„å…è´¹ç‰ˆæœ¬ï¼Œä» jdk8u211 å’Œ jdk8u212 å¼€å§‹æ”¶è´¹ã€‚å‚è€ƒï¼šhttps://www.cnblogs.com/xuruiming/p/12881503.html\nå¦‚æœä½¿ç”¨ Orcale JDKï¼Œå»ºè®® jdk8u201: Q3ã€å¦‚ä½•ä¸‹è½½ Orcale JDK 8u201? ç­”ï¼šä» Oracle å®˜ç½‘ä¸‹è½½ï¼šhttps://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html\nQ4ã€Oracle JDK8u å’Œ OpenJDK8u æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ ç­”ï¼šæœ€ä¸»è¦çš„æ˜¯æˆæƒåè®®ä¸åŒã€‚Orcale çš„é«˜ç‰ˆæœ¬å•†ç”¨æ—¶æ”¶è´¹ï¼ŒOpenJDK åˆ™å®Œå…¨å…è´¹ã€‚\nå…¶æ¬¡è¿˜æœ‰OpenJDKæºä»£ç ä¸å®Œæ•´ã€éƒ¨åˆ†æºä»£ç ç”¨å¼€æºä»£ç æ›¿æ¢ã€OpenJDKåªåŒ…å«æœ€ç²¾ç®€çš„JDKç­‰é—®é¢˜ï¼Œä½†ä¸€èˆ¬æ¥è¯´ï¼Œè¿™äº›å½±å“å¯ä»¥å¿½ç•¥ã€‚\nQ5ã€JDK8 çš„æ”¯æŒåˆ°ä»€ä¹ˆæ—¶å€™ç»“æŸï¼Ÿ ç­”ï¼š2030å¹´12æœˆ31æ—¥ï¼Œhttps://endoflife.date/java Q6ã€OpenJDK æ”¯æŒ Java Flight Recorder å—ï¼Ÿ ç­”ï¼šæ”¯æŒï¼Œè§ï¼šä½å»¶è¿Ÿ Profile å·¥å…· Flight Recorder è¢«ç§»æ¤åˆ° Java 8ã€‚\nå¼€å¯æ–¹æ³•ï¼š\n1 -XX:+UnlockCommercialFeatures -XX:+FlightRecorder Q7ã€OpenJDK8 ä¸­çš„ Java Flight Recorder æ˜¯å•†ç”¨ç‰¹æ€§å—ï¼Ÿ ç­”ï¼šä¸æ˜¯ï¼Œè¯¥ç‰¹æ€§åœ¨ OpenJDK æ˜¯å®Œå…¨å…è´¹çš„ï¼Œè§ï¼šGet started with JDK Flight Recorder in OpenJDK 8uã€‚\nä½†è¦æ³¨æ„ï¼šOracle çš„ JDK11 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ JFR æ˜¯å•†ç”¨ç‰¹æ€§ï¼Œæ‰€ä»¥éœ€è¦åŠ  -XX:+UnlockCommercialFeatures å¼€å¯ï¼›åŒæ—¶ä¸ºäº†å…¼å®¹æ€§ï¼Œä½¿ç”¨ OpenJDK ä¹Ÿè¦æ·»åŠ è¯¥å‚æ•°ã€‚\nQ8ã€OpenJDK8 æ”¯æŒè¯†åˆ« Docker å®¹å™¨çš„èµ„æºé™åˆ¶å—ï¼Ÿ ç­”ï¼šå–å†³äºç‰ˆæœ¬ã€‚\næ¯”å¦‚ï¼šä» jdk8u191 å¼€å§‹å®Œæ•´æ”¯æŒï¼Œä¸éœ€è¦éœ€è¦ä½¿ç”¨ -XX:ParallelGCThreads=4 -XX:ConcGCThreads=1 -XX:G1ConcRefinementThreads=5 -XX:ActiveProcessorCount=8 è¿™äº›å‚æ•°æŒ‡å®š GC çº¿ç¨‹æ•°ã€‚\nè¯¦è§ï¼šJVM å¯¹å®¹å™¨åŒ–æ”¯æŒçš„å‚æ•°ï¼ˆå¼ºçƒˆå»ºè®®ï¼Œå‚è€ƒè¯¥æ–‡ç« åœ¨ docker ä¸­è¿›è¡ŒéªŒè¯ï¼‰ã€‚\nå°äº jdk8u131 ç‰ˆæœ¬ä¸æ”¯æŒï¼› å¤§äºç­‰äº jdk8u131ï¼Œå°äº jdk8u191 å®éªŒæ€§æ”¯æŒï¼› å¤§äºç­‰äº jdk8u191 å¼€å§‹å®Œæ•´çš„æ”¯æŒï¼› Q9ã€å¦‚ä½•ä¸‹è½½ OpenJDK8ï¼Ÿ ç­”ï¼š å¾ˆå¤šï¼Œè¿™é‡Œç»™å‡ºä¸¤ä¸ªï¼šAzul Zulu Downloadsï¼ŒOpenLogic OpenJDK Downloads ã€‚\nç‰¹åˆ«åœ°ï¼Œå¦‚æœæ˜¯åœ¨ä¸ªäººå¼€å‘ç”µè„‘ï¼Œåˆ™å¼ºçƒˆå»ºè®®ä½¿ç”¨ SDKMAN ï¼Œå®ƒæ”¯æŒå¹¶è¡Œç‰ˆæœ¬ç®¡ç†ï¼ŒJava ç”Ÿæ€çš„å„ç§è½¯ä»¶åŒ…ï¼ŒåŒ…æ‹¬ JDKã€ã€Kotlinã€Groovyã€Scalaã€Mavenã€Gradle ç­‰ç­‰ã€‚\n","date":"2023-07-11T12:35:11+08:00","permalink":"https://zhumengzhu.github.io/2023/07/oracle-jdk-vs-openjdk-selection-guide/","title":"Oracle JDK å’Œ OpenJDK å¦‚ä½•é€‰æ‹©ï¼Ÿ"},{"content":"å‚æ•°å»ºè®® è¿™äº›å»ºè®®åŸºäºä»¥ä¸‹å‰æï¼š\næœåŠ¡å™¨ CPU æ”¯æŒè¶…çº¿ç¨‹ï¼Œå³ä¸€ä¸ªæ ¸å¯ä»¥å½“æˆä¸¤ä¸ªæ ¸ç”¨ï¼Œå¦åˆ™ï¼ŒGC çº¿ç¨‹ç›¸å…³å‚æ•°å€¼åº”è¯¥å‡åŠï¼› å¦‚æœ JDK ç‰ˆæœ¬å°äº 1.8.0_191-b12(å¦‚JDK 1.8.0_151)ï¼Œåˆ™éœ€è¦è®¾ç½® -XX:ParallelGCThreads=n, -XX:ConcGCThreads=n, -XX:G1ConcRefinementThreads=n ä¸‰ä¸ªå‚æ•°ï¼› å¦‚æœ JDK ç‰ˆæœ¬å‡çº§åˆ° 1.8.0_191-b12 åŠä»¥ä¸Šï¼Œåˆ™æœ€å¥½ä¸è¦è®¾ç½®ä¸Šè¿°ä¸‰ä¸ªå‚æ•°ï¼Œæ”¹ä¸ºè®¾ç½® -XX:+UnlockExperimentalVMOptions -XX:ActiveProcessorCount=nï¼Œn å–å®¹å™¨æ ¸æ•°ï¼› ç»Ÿä¸€è®¾ç½®çš„å‚æ•° -XX:+UseG1GC ä½¿ç”¨åƒåœ¾ä¼˜å…ˆ(G1)æ”¶é›†å™¨ -XX:+PrintFlagsFinal æ‰“å°æ‰€æœ‰å‚æ•°çš„æœ€ç»ˆå€¼ï¼ˆå‚è€ƒï¼šJava -XX:+PrintFlagsFinalå‘½ä»¤è¡Œå‚æ•°è¯¦è§£ï¼‰ -XX:+PrintCommandLineFlags æ˜¯æ‰“å°é‚£äº›è¢«æ–°å€¼è¦†ç›–çš„é¡¹ -XX:+PrintStringTableStatistics åœ¨ JVM è¿›ç¨‹é€€å‡ºæ—¶ä¼šè¾“å‡º SymbolTable ç»Ÿè®¡å’Œ StringTable ç»Ÿè®¡ï¼ˆå‚è€ƒï¼šèŠèŠjvmçš„StringTableåŠSymbolTableï¼‰ -XX:+PrintGC æ‰“å°GCæ—¥å¿— -XX:+PrintGCDetails æ‰“å°è¯¦ç»†çš„GCæ—¥å¿—ï¼Œè¿˜ä¼šåœ¨é€€å‡ºå‰æ‰“å°å †çš„è¯¦ç»†ä¿¡æ¯ -XX:+PrintGCDateStamps æ‰“å°CGå‘ç”Ÿçš„æ—¥æœŸæ—¶é—´ -XX:+PrintGCTimeStamps æ‰“å°CGå‘ç”Ÿçš„ç›¸å¯¹æ—¶é—´æˆ³ -XX:+PrintHeapAtGC æ¯æ¬¡GCå‰åæ‰“å°å †ä¿¡æ¯ -XX:+PrintTenuringDistribution YGC æ—¶ï¼Œæ‰“å°å‡ºå¹¸å­˜åŒºä¸­å¯¹è±¡çš„å¹´é¾„åˆ†å¸ƒ -XX:+PrintAdaptiveSizePolicy æ‰“å°åˆ†ä»£å¤§å°è°ƒæ•´çš„ä¿¡æ¯ -XX:+PrintGCApplicationStoppedTime æ‰“å°åº”ç”¨ç”±äºGCè€Œäº§ç”Ÿçš„åœé¡¿æ—¶é—´ -XX:+PrintGCApplicationConcurrentTime æ‰“å°åº”ç”¨ç¨‹åºçš„æ‰§è¡Œæ—¶é—´ -XX:+PrintReferenceGC æ‰“å°è½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¼•ç”¨å’ŒFinallizeé˜Ÿåˆ—å¤„ç†æƒ…å†µ -XX:ParallelRefProcEnabled å¯ç”¨å¹¶è¡Œå¼•ç”¨å¤„ç† -XX:-OmitStackTraceInFastThrow ç¦ç”¨ FastThrow ä¼˜åŒ–ã€‚å¦‚æœå¼€å¯ï¼Œä¼šå¯¼è‡´æŠ›å‡ºå¼‚å¸¸æ—¶æ²¡æœ‰å †æ ˆä¿¡æ¯ï¼Œä¸åˆ©äºæ’æŸ¥é—®é¢˜ã€‚ -Xloggc:/app/logs/gc_$HOSTNAME.log GC æ—¥å¿—è·¯å¾„ -XX:GCLogFileSize=30M GC æ—¥å¿—æ–‡ä»¶å¤§å° -XX:+UseGCLogFileRotation å¯ç”¨ GC æ—¥å¿—æ–‡ä»¶æ»šåŠ¨ç­–ç•¥ï¼Œéœ€è¦å…ˆè®¾ç½® -Xloggc -XX:NumberOfGCLogFiles=10 è®¾ç½®æ»šåŠ¨æ—¥å¿—æ—¶çš„æ–‡ä»¶æ•° -XX:+HeapDumpOnOutOfMemoryError å½“å‘ç”Ÿ OOM æ—¶ï¼Œè‡ªåŠ¨ç”Ÿæˆ dump æ–‡ä»¶ -XX:HeapDumpPath=\u0026quot;/app/logs/java_%p_$HOSTNAME.hprof\u0026quot; æŒ‡å®š dump æ–‡ä»¶çš„è·¯å¾„ -XX:ErrorFile=/app/logs/hs_err_%p_$HOSTNAME.log é”™è¯¯å‘ç”Ÿæ—¶ï¼Œé”™è¯¯æ•°æ®çš„å­˜å‚¨è·¯å¾„ -Djava.security.egd=file:/dev/./urandom åŠ å¿«éšæœºæ•°äº§ç”Ÿè¿‡ç¨‹ å…è®¸è°ƒæ•´çš„å‚æ•° -Xms2g -Xms4g total_memory / 2 æœ€å°å †å†…å­˜ï¼ŒJVM åˆå§‹åŒ–æ—¶å°±ä¼šåˆ†é…çš„å †å†…å­˜å¤§å°ã€‚ -Xmx2g -Xms4g total_memory / 2 æœ€å¤§å †å†…å­˜ -XX:MaxDirectMemorySize=512m -XX:MaxDirectMemorySize=512m - è®¾ç½®æœ€å¤§ç›´æ¥å†…å­˜ï¼ˆå‚è€ƒ JVMæºç åˆ†æä¹‹å †å¤–å†…å­˜å®Œå…¨è§£è¯»ï¼‰ -XX:MaxMetaspaceSize=512m -XX:MaxMetaspaceSize=512m - è®¾ç½®æœ€å¤§å…ƒç©ºé—´ï¼ˆå‚è€ƒJVMæºç åˆ†æä¹‹Metaspaceè§£å¯†ï¼‰ -XX:MaxGCPauseMillis=200 -XX:MaxGCPauseMillis=200 - è®¾ç½®æœ€å¤§GCæš‚åœæ—¶é—´çš„ç›®æ ‡ã€‚è¿™æ˜¯ä¸€ä¸ªè½¯ç›®æ ‡ï¼ŒJVMå°†å°½æœ€å¤§åŠªåŠ›å®ç°å®ƒã€‚é»˜è®¤ 200msã€‚ -XX:ParallelGCThreads=4 -XX:ParallelGCThreads=8 - è®¾ç½®åƒåœ¾å›æ”¶å™¨å¹¶è¡Œé˜¶æ®µä½¿ç”¨çš„çº¿ç¨‹æ•°ã€‚è®¡ç®—å…¬å¼è§JVMè°ƒä¼˜ç³»åˆ—: é»˜è®¤GCçº¿ç¨‹æ•°çš„è®¡ç®—å…¬å¼ -XX:ConcGCThreads=1 -XX:ConcGCThreads=2 - è®¾ç½®åƒåœ¾å›æ”¶å™¨å¹¶å‘é˜¶æ®µä½¿ç”¨çš„çº¿ç¨‹æ•° -XX:G1ConcRefinementThreads=5 -XX:G1ConcRefinementThreads=9 ParallelGCThreads+1 è®¾ç½®å¹¶å‘ä¼˜åŒ–çº¿ç¨‹ï¼Œåªä¸“æ³¨æ‰«ææ—¥å¿—ç¼“å†²åŒºè®°å½•çš„å¡ç‰‡æ¥ç»´æŠ¤æ›´æ–° RSet -XX:G1ReservePercent=10 -XX:G1ReservePercent=10 - è®¾ç½®è¦ä¿æŒç©ºé—²çš„é¢„ç•™å†…å­˜çš„ç™¾åˆ†æ¯”ï¼Œä»¥å‡å°‘ç©ºé—´æº¢å‡ºçš„é£é™©ã€‚ é»˜è®¤å€¼æ˜¯10%ã€‚ å½“å¢åŠ æˆ–å‡å°‘è¿™ä¸ªç™¾åˆ†æ¯”æ—¶ï¼Œè¯·ç¡®ä¿å¯¹Javaå †æ€»é‡è¿›è¡Œç›¸åŒçš„è°ƒæ•´ã€‚ -XX:InitiatingHeapOccupancyPercent=45 -XX:InitiatingHeapOccupancyPercent=45 - å¯åŠ¨å¹¶å‘GCå‘¨æœŸçš„(æ•´ä¸ª)å †å ç”¨çš„ç™¾åˆ†æ¯”ã€‚ å®ƒç”±åŸºäºæ•´ä¸ªå †å ç”¨æƒ…å†µè§¦å‘å¹¶å‘GCå‘¨æœŸçš„GCä½¿ç”¨ï¼Œè€Œä¸ä»…ä»…æ˜¯å…¶ä¸­çš„ä¸€ä¸ªä»£(ä¾‹å¦‚G1)ã€‚ å€¼ä¸º0è¡¨ç¤ºâ€œæ‰§è¡Œæ’å®šçš„GCå‘¨æœŸâ€ã€‚ ç¼ºçœå€¼ä¸º45ã€‚ -XX:SoftRefLRUPolicyMSPerMB=1000 -XX:SoftRefLRUPolicyMSPerMB=1000 - æ¯1Mç©ºé—²ç©ºé—´å¯ä¿æŒçš„SoftReferenceå¯¹è±¡ç”Ÿå­˜çš„æ—¶é•¿ï¼ˆå•ä½msï¼‰ï¼ˆå‚è€ƒï¼šä¸€æ¬¡ JVM FullGC çš„æ’æŸ¥è¿‡ç¨‹åŠè§£å†³æ–¹æ¡ˆï¼ï¼‰ ä¸å»ºè®®è®¾ç½®çš„å‚æ•° ä¸è®¾ç½® -XX:+DisableExplicitGCï¼Œè¿™æ ·å…è®¸ä¸šåŠ¡ä½¿ç”¨ System.gc() åœ¨æŸäº›ç‰¹å®šæƒ…å†µä¸‹ä¸»åŠ¨ FullGCï¼› ä¸è¦æŒ‡å®š -Xmn å‚æ•°ï¼Œè®© G1 è‡ªå·±å»è°ƒæ•´ï¼›å¦‚æœè®¾ç½®äº†å¹´è½»ä»£å¤§å°ï¼Œä¼šå¯¼è‡´ G1 æ— æ³•ä½¿ç”¨æš‚åœæ—¶é—´ç›®æ ‡ï¼› å®Œæ•´å‚æ•°ç¤ºä¾‹ ä»¥ä¸‹é’ˆå¯¹ 4C8G æœºå™¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 -Xms4g -Xmx4g -XX:MaxDirectMemorySize=512m -XX:MaxMetaspaceSize=512m -XX:+PrintFlagsFinal -XX:+PrintCommandLineFlags -XX:+PrintStringTableStatistics -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:ParallelGCThreads=8 -XX:ConcGCThreads=2 -XX:G1ConcRefinementThreads=9 -XX:+PrintGC -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps -XX:+PrintHeapAtGC -XX:+PrintTenuringDistribution -XX:+PrintAdaptiveSizePolicy -XX:+PrintGCApplicationStoppedTime -XX:+PrintGCApplicationConcurrentTime -XX:G1ReservePercent=10 -XX:InitiatingHeapOccupancyPercent=45 -XX:SoftRefLRUPolicyMSPerMB=1000 -XX:+PrintReferenceGC -XX:ParallelRefProcEnabled -Xloggc:/app/logs/gc_$HOSTNAME.log -XX:GCLogFileSize=30M -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=\u0026#34;/app/logs/java_%p_$HOSTNAME.hprof\u0026#34; -XX:ErrorFile=/app/logs/hs_err_%p_$HOSTNAME.log -XX:-OmitStackTraceInFastThrow -Djava.security.egd=file:/dev/./urandom å…¶å®ƒ å»ºè®®å‡çº§ JDK è‡³å°‘åˆ° 1.8.0_191-b12 åŠä»¥ä¸Šï¼ŒåŸå› å‚è€ƒ JVMå¦‚ä½•è·å–å½“å‰å®¹å™¨çš„èµ„æºé™åˆ¶ï¼Ÿ å’Œ äº‘åŸç”Ÿæ¶æ„ï¼šå®¹å™¨èµ„æºé™åˆ¶åŠèµ„æºå¯è§æ€§ å‚è€ƒèµ„æ–™ Java HotSpot VM Options 10 Garbage-First Garbage Collector Tuning Collecting and reading G1 garbage collector logs - part 2 JVMæ€§èƒ½â€”â€”JVMè°ƒä¼˜å‚æ•°åˆ—è¡¨ è¯¦è§£ G1 åƒåœ¾æ”¶é›†å™¨ JVMä¹‹G1å›æ”¶å™¨å’Œå¸¸è§å‚æ•°é…ç½® ","date":"2023-06-18T12:18:18+08:00","permalink":"https://zhumengzhu.github.io/2023/06/jvm-parameter-recommendations-and-reasons/","title":"JVM å‚æ•°å»ºè®®åŠç†ç”±"},{"content":"Contention in java.util.Random it\u0026rsquo;s thread-safe it\u0026rsquo;s lock-free To better understand this, let\u0026rsquo;s see how one of its primary operations, next(int), is implemented:\n1 2 3 4 5 6 7 8 9 protected int next(int bits) { long oldseed, nextseed; AtomicLong seed = this.seed; do { oldseed = seed.get(); nextseed = (oldseed * multiplier + addend) \u0026amp; mask; } while (!seed.compareAndSet(oldseed, nextseed)); return (int)(nextseed \u0026gt;\u0026gt;\u0026gt; (48 - bits)); } Instead of a dedicated instance of Random per thread, each thread only needs to maintain its own seed value. As of Java 8, the Thread class itself has been retrofitted to maintain the seed value:\n1 2 3 4 5 6 7 8 9 10 11 12 public class Thread implements Runnable { // omitted @jdk.internal.vm.annotation.Contended(\u0026#34;tlr\u0026#34;) long threadLocalRandomSeed; @jdk.internal.vm.annotation.Contended(\u0026#34;tlr\u0026#34;) int threadLocalRandomProbe; @jdk.internal.vm.annotation.Contended(\u0026#34;tlr\u0026#34;) int threadLocalRandomSecondarySeed; } The threadLocalRandomSeed variable is responsible for maintaining the current seed value for ThreadLocalRandom. Moreover, the secondary seed, threadLocalRandomSecondarySeed, is usually used internally by the likes of ForkJoinPool.\nThis implementation incorporates a few optimizations to make ThreadLocalRandom even more performant:\nAvoiding false sharing by using the @Contented annotation, which basically adds enough padding to isolate the contended variables in their own cache lines Using sun.misc.Unsafe to update these three variables instead of using the Reflection API Avoiding extra hashtable lookups associated with the ThreadLocal implementation Contention in java.util.SecureRandom it\u0026rsquo;s the subclass of java.util.Random\none of the most common locking issues within Java applications is triggered through an innocent-looking java.io.File.createTempFile() calls. Under the hood, this temporary file creation is relying upon a SecureRandom class to calculate the name of the file.\n1 2 3 4 5 6 7 8 9 10 private static final SecureRandom random = new SecureRandom(); static File generateFile(String prefix, String suffix, File dir) { long n = random.nextLong(); if (n == Long.MIN_VALUE) { n = 0; // corner case } else { n = Math.abs(n); } return new File(dir, prefix + Long.toString(n) + suffix); } And SecureRandom, when nextLong is called, eventually calls its method nextBytes(), which is defined as synchronized:\n1 2 3 synchronized public void nextBytes(byte[] bytes) { secureRandomSpi.engineNextBytes(bytes); } One may say, that if I create new SecureRandom in each thread, I will not get any issues. Unfortunately, itâ€™s not that simple. SecureRandom uses an implementation of java.security.SecureRandomSpi, which will eventually be contended anyhow (you may look at the following bug discussion with some benchmarks in Jenkins issue tracker)\nThis in combination with certain application usage patterns (especially if you have lots of SSL connections which rely on SecureRandom for their crypto-handshaking magic) has a tendency to build up into long-lasting contention issues.\nThe fix to the situation is simple if you can control the source code â€“ just rebuild the solution to rely upon the java.util.ThreadLocalRandom for multithreaded designs. In cases where you are stuck with a standard API making the decisions for you the solution can be more complex and require significant refactoring.\nurandom and random Devices https://www.ibm.com/docs/en/aix/7.2?topic=files-urandom-random-devices\nLinux Kernel 5.8 ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œå¦‚æœç†µæ± çš„æ•°æ®ä¸è¶³ï¼Œä» /dev/random è¯»å–æ•°æ®å¯èƒ½é˜»å¡ï¼Œä½†æ˜¯ä» /dev/urandom ä¸ä¼šé˜»å¡ã€‚Java ç¨‹åºä¸€èˆ¬ä¼šæŒ‡å®š -Djava.security.egd=file:/dev/./urandom å‚æ•°é¿å…é˜»å¡çš„å‘ç”Ÿ(ä½†ä¸ä¸€å®šç”Ÿæ•ˆ)ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ\n-Djava.security.egd=file:/dev/urandom æ˜¯é”™è¯¯çš„ï¼› -Djava.security.egd=file:/dev/./urandom æ‰æ˜¯æ­£ç¡®çš„ï¼› è§ï¼šhttps://stackoverflow.com/questions/137212/how-to-deal-with-a-slow-securerandom-generator å…³äºæ€§èƒ½ ThreadLocalRandom å’Œ SecureRandom éƒ½æ˜¯ Random çš„å­ç±»ï¼› æ€§èƒ½ï¼šThreadLocalRandom \u0026gt; Random \u0026gt; SecureRandomï¼› Random å’Œ ThreadLocalRandom ä½¿ç”¨çš„éƒ½æ˜¯ã€Œçº¿æ€§åŒä½™å‘ç”Ÿå™¨ã€ç®—æ³•ï¼Œé€Ÿåº¦å¾ˆå¿«ï¼ŒåŒºåˆ«æ˜¯ï¼š Random ä½¿ç”¨ CAS æ–¹å¼æ›´æ–°ç§å­ï¼Œé«˜å¹¶å‘æƒ…å†µä¸‹ç«äº‰å¤§ï¼Œæ€§èƒ½ä¼šä¸‹é™ï¼› ThreadLocalRandom å°†ç§å­å­˜åœ¨åœ¨ Thread å¯¹è±¡ä¸Šï¼Œæ€§èƒ½æ›´å¥½ï¼š ç§å­å°é—­åœ¨çº¿ç¨‹å†…ï¼Œä¸éœ€è¦ CASï¼› é¿å…é¢å¤–çš„ã€é—´æ¥ã€è®¡ç®—ï¼š ç›¸æ¯” ThreadLocal + Randomï¼Œåœ¨ Java8 ä¸­ï¼ŒThreadLocalRandom åªéœ€è¦ç›´æ¥è¯»å–å­˜å‚¨åœ¨ Thread å¯¹è±¡ä¸Šçš„ threadLocalRandomSeed ç„¶åç›´æ¥æ›´æ–°å°±å¯ä»¥ï¼Œä¸éœ€è¦è°ƒç”¨ ThreadLocal.get è¿›è¡Œä¸€æ¬¡ HashTable Lookupï¼› é€šè¿‡ UNSAFE çš„ native æ–¹æ³•æ›´æ–°ç§å­å€¼ï¼Œè€Œä¸æ˜¯åå°„ï¼Œæ•ˆç‡æ›´é«˜ï¼› é€šè¿‡ä½¿ç”¨ Contended æ³¨è§£ï¼Œé¿å…ä¼ªå…±äº«é—®é¢˜ï¼› SecureRandom ä½¿ç”¨ OS ç»´æŠ¤çš„éšæœºæ•°æ®æ¥ç”Ÿæˆéšæœºæ•°ï¼Œåº•å±‚ä¼šä½¿ç”¨ synchronized é”ï¼Œå› æ­¤æ€§èƒ½æ¯”è¾ƒå·®ï¼Œä¸”å¯èƒ½å‘ç”Ÿé˜»å¡ï¼› SecureRandom ä½¿ç”¨çš„æŸäº›ç®—æ³•ï¼Œéœ€è¦è¯»å– /dev/random æ¥è·å–éšæœºæ•°æ®ï¼Œå½“ OS ç»´æŠ¤çš„ç†µæ± ä¸­çš„ç†µä¸è¶³æ—¶ï¼Œä¼šå‘ç”Ÿé˜»å¡ï¼Œå¯¼è‡´ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼› åœ¨ Linux çš„ v5.6 åŠå…¶ä»¥åçš„å†…æ ¸ä¸­ï¼Œè¯»å– /dev/random ä¸ä¼šå†è¢«é˜»å¡äº†ï¼Œä½†æ˜¯å°±åƒ /dev/urandom ä¸€æ ·ï¼Œåœ¨ä¸€ä¸ªå…¨æ–°çš„ç³»ç»Ÿåˆšå¯åŠ¨æ—¶ç”±äºç³»ç»Ÿå°šæœªäº§ç”Ÿç†µå€¼ï¼Œæ­¤æ—¶è¿˜æ˜¯å¯èƒ½é˜»å¡ç­‰å¾…è¶³å¤Ÿçš„ç†µå€¼äº§ç”Ÿï¼› UUID.randomUUID åº•å±‚ä½¿ç”¨çš„å°±æ˜¯ SecureRandomï¼Œå› æ­¤æ€§èƒ½ä¼šæ¯”è¾ƒå·®ï¼› File.createTempFile åº•å±‚ä¹Ÿä¼šä½¿ç”¨ SecureRandomï¼Œå› æ­¤æ€§èƒ½ä¼šæ¯”è¾ƒå·®ï¼› å»ºç«‹ SSL è¿æ¥åŒæ ·ä¾èµ– SecureRandomï¼Œå› æ­¤ä¹Ÿè¦å°å¿ƒï¼› å¦‚ä½•é¢„æµ‹ä¸‹ä¸€ä¸ªéšæœºæ•° ä»¥ä¸‹æ–¹æ³•ä»…å¯¹åŸºäº LCG ç®—æ³•æœ‰æ•ˆï¼Œåˆ©ç”¨å…¬å¼ ğ‘‹ğ‘›+1=(ğ‘ğ‘‹ğ‘›+ğ‘) mod ğ‘šã€‚\nç»™å®šä¸¤ä¸ªè¿ç»­çš„ int ç±»å‹å€¼ï¼Œæˆ–ä¸€ä¸ª doubleï¼Œæˆ–ä¸€ä¸ª long ç±»å‹å€¼ï¼Œå³å¯é¢„æµ‹åç»­çš„éšæœºæ•°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 Predict Next Random Number.java import java.util.ArrayList; import java.util.Random; public class ReplicatedRandom extends Random { public static void main(String[] args) { predictByNextDouble(); predictByNextInt(); } private static void predictByNextInt() { long seed = System.currentTimeMillis(); Random r = new Random(seed); int v1 = r.nextInt(); int v2 = r.nextInt(); ReplicatedRandom rr = new ReplicatedRandom(); rr.replicateState(v1, v2); System.out.println(r.nextInt() == rr.nextInt()); // True System.out.println(r.nextInt() == rr.nextInt()); // True System.out.println(r.nextInt() == rr.nextInt()); // True } private static void predictByNextDouble() { long seed = System.currentTimeMillis(); Random r = new Random(seed); ReplicatedRandom rr = new ReplicatedRandom(); rr.replicateState(r.nextDouble()); System.out.println(r.nextDouble() == rr.nextDouble()); // True System.out.println(r.nextDouble() == rr.nextDouble()); // True System.out.println(r.nextDouble() == rr.nextDouble()); // True } // Replicate the state of a Random using a single value from its nextDouble public boolean replicateState(double nextDouble) { // nextDouble() is generated from ((next(26) \u0026lt;\u0026lt; 27) + next(27)) / (1L \u0026lt;\u0026lt; 53) // Inverting those operations will get us the values of next(26) and next(27) long numerator = (long) (nextDouble * (1L \u0026lt;\u0026lt; 53)); int first26 = (int) (numerator \u0026gt;\u0026gt;\u0026gt; 27); int last27 = (int) (numerator \u0026amp; ((1L \u0026lt;\u0026lt; 27) - 1)); return replicateState(first26, 26, last27, 27); } // Replicate the state of a Random using a single value from its nextLong public boolean replicateState(long nextLong) { int last32 = (int) (nextLong \u0026amp; ((1L \u0026lt;\u0026lt; 32) - 1)); int first32 = (int) ((nextLong - last32) \u0026gt;\u0026gt; 32); return replicateState(first32, 32, last32, 32); } // Replicate the state of a Random using two consecutive values from its nextInt public boolean replicateState(int firstNextInt, int secondNextInt) { return replicateState(firstNextInt, 32, secondNextInt, 32); } // Replicate the state of a Random using two consecutive values from its nextFloat public boolean replicateState(float firstNextFloat, float secondNextFloat) { return replicateState((int) (firstNextFloat * (1 \u0026lt;\u0026lt; 24)), 24, (int) (secondNextFloat * (1 \u0026lt;\u0026lt; 24)), 24); } public boolean replicateState(int nextN, int n, int nextM, int m) { // Constants copied from java.util.Random final long multiplier = 0x5DEECE66DL; final long addend = 0xBL; final long mask = (1L \u0026lt;\u0026lt; 48) - 1; long upperMOf48Mask = ((1L \u0026lt;\u0026lt; m) - 1) \u0026lt;\u0026lt; (48 - m); // next(x) is generated by taking the upper x bits of 48 bits of (oldSeed * multiplier + addend) mod (mask + 1) // So now we have the upper n and m bits of two consecutive calls of next(n) and next(m) long oldSeedUpperN = ((long) nextN \u0026lt;\u0026lt; (48 - n)) \u0026amp; mask; long newSeedUpperM = ((long) nextM \u0026lt;\u0026lt; (48 - m)) \u0026amp; mask; // Bruteforce the lower (48 - n) bits of the oldSeed that was truncated. // Calculate the next seed for each guess of oldSeed and check if it has the same top m bits as our newSeed. // If it does then the guess is right and we can add that to our candidate seeds. ArrayList\u0026lt;Long\u0026gt; possibleSeeds = new ArrayList\u0026lt;Long\u0026gt;(); for (long oldSeed = oldSeedUpperN; oldSeed \u0026lt;= (oldSeedUpperN | ((1L \u0026lt;\u0026lt; (48 - n)) - 1)); oldSeed++) { long newSeed = (oldSeed * multiplier + addend) \u0026amp; mask; if ((newSeed \u0026amp; upperMOf48Mask) == newSeedUpperM) { possibleSeeds.add(newSeed); } } if (possibleSeeds.size() == 1) { // If there\u0026#39;s only one candidate seed, then we found it! setSeed(possibleSeeds.get(0) ^ multiplier); // setSeed(x) sets seed to `(x ^ multiplier) \u0026amp; mask`, so we need another `^ multiplier` to cancel it out return true; } if (possibleSeeds.size() \u0026gt;= 1) { System.out.println(\u0026#34;Didn\u0026#39;t find a unique seed. Possible seeds were: \u0026#34; + possibleSeeds); } else { System.out.println(\u0026#34;Failed to find seed!\u0026#34;); } return false; } } è¯´æ˜ï¼š\nä¸Šé¢çš„ç®—æ³•åˆ©ç”¨äº† Java ç”Ÿæˆçš„éšæœºæ•°æœ‰ 48 ä¸ªæœ‰æ•ˆä½è¿™ä¸€ä¿¡æ¯ï¼› å¯¹äº nextInt æ¥è¯´ï¼Œè¿”å›å€¼æ˜¯ 32 ä½ï¼Œå› æ­¤åœ¨è¿”å›ç»“æœæ—¶ï¼Œä¼šèˆå¼ƒä½ 16 ä½ï¼Œè¿™æ˜¯é€šè¿‡ \u0026raquo;\u0026gt; ä½ç§»æ“ä½œå®ç°çš„ï¼› å¯¹äº nextLong æ¥è¯´ï¼Œå®ƒæ˜¯ç”±ä¸¤ä¸ªè¿ç»­çš„ nextInt ç»„æˆçš„ï¼› å¯¹äº nextDouble æ¥è¯´ï¼Œå®ƒæ˜¯ç”±ä¸¤ä¸ªè¿ç»­çš„åˆ†åˆ«æ˜¯ 27 bits å’Œ 26 bits æ•°å­—ç»„æˆçš„ï¼› å› æ­¤ï¼Œå½“ç»™å®šä¸€ä¸ª nextInt å€¼æ—¶ï¼Œå°†å…¶å·¦ç§» 16 ä½ï¼Œå³å¾—åˆ°ç§å­çš„æœ€å°å¯èƒ½å€¼ï¼Œè¯¥å€¼åŠ ä¸Š 2^16 - 1ï¼Œå°±æ˜¯ç§å­çš„æœ€å¤§å¯èƒ½å€¼ï¼›å› æ­¤ï¼Œåªéœ€éå†è¯¥ç©ºé—´(åŒ…å« 2^16 ä¸ªæ•°å­—)ï¼Œå³å¯æ¨æµ‹å‡ºç§å­çš„å®é™…å€¼ï¼› ç°ä»£ CPU å¯ä»¥åœ¨ 1 ç§’å†…ç”¨æš´åŠ›æ–¹æ³•é€†å‘çš„æ¨æµ‹å‡ºå½“å‰çš„ç§å­å€¼ï¼› Benchmark å•çº¿ç¨‹ç»“æœï¼š 4 çº¿ç¨‹ç»“æœï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 RandomBenchmark.java package benchmark; import org.openjdk.jmh.annotations.Benchmark; import org.openjdk.jmh.annotations.BenchmarkMode; import org.openjdk.jmh.annotations.Fork; import org.openjdk.jmh.annotations.Measurement; import org.openjdk.jmh.annotations.Mode; import org.openjdk.jmh.annotations.OutputTimeUnit; import org.openjdk.jmh.annotations.Scope; import org.openjdk.jmh.annotations.State; import org.openjdk.jmh.annotations.Threads; import org.openjdk.jmh.annotations.Warmup; import org.openjdk.jmh.results.format.ResultFormatType; import org.openjdk.jmh.runner.Runner; import org.openjdk.jmh.runner.RunnerException; import org.openjdk.jmh.runner.options.Options; import org.openjdk.jmh.runner.options.OptionsBuilder; import java.time.LocalDateTime; import java.time.format.DateTimeFormatter; import java.util.Random; import java.util.concurrent.ThreadLocalRandom; import java.util.concurrent.TimeUnit; /** */ @BenchmarkMode({Mode.AverageTime, Mode.Throughput}) @Warmup(iterations = 3, time = 1) @Measurement(iterations = 5, time = 5) @Threads(4) @Fork(1) @State(value = Scope.Benchmark) @OutputTimeUnit(TimeUnit.NANOSECONDS) public class RandomBenchmark { private final Random random = new Random(); private final ThreadLocal\u0026lt;Random\u0026gt; simpleThreadLocal = ThreadLocal.withInitial(Random::new); public static void main(String[] args) throws RunnerException { // å°†ç»“æœæ–‡ä»¶ä¸Šä¼ åˆ° https://jmh.morethan.io/ å¯ä»¥å¾—åˆ°å¯è§†åŒ–ç»“æœ String now = LocalDateTime.now().format(DateTimeFormatter.ofPattern(\u0026#34;yyyyMMddHHmmss\u0026#34;)); String filePath = \u0026#34;/tmp/jmh_result_\u0026#34; + now + \u0026#34;.json\u0026#34;; Options opt = new OptionsBuilder() .include(RandomBenchmark.class.getSimpleName()) .result(filePath) .resultFormat(ResultFormatType.JSON).build(); new Runner(opt).run(); } @Benchmark // @BenchmarkMode(Throughput) public int regularRandom() { return random.nextInt(); } @Benchmark // @BenchmarkMode(Throughput) public int simpleThreadLocal() { return simpleThreadLocal.get().nextInt(); } @Benchmark // @BenchmarkMode(Throughput) public int builtinThreadLocal() { return ThreadLocalRandom.current().nextInt(); } } Reference https://www.baeldung.com/java-thread-local-random https://alidg.me/blog/2020/4/24/thread-local-random https://stackoverflow.com/questions/11051205/difference-between-java-util-random-and-java-security-securerandom https://resources.infosecinstitute.com/topic/random-number-generation-java/ https://jazzy.id.au/2010/09/21/cracking_random_number_generators_part_2.html https://jazzy.id.au/2010/09/22/cracking_random_number_generators_part_3.html https://blogs.oracle.com/linux/post/rngd1 https://blogweb.cn/article/1642969777211 https://lwn.net/Articles/808575/ https://unix.stackexchange.com/questions/243127/how-to-check-if-reading-from-dev-random-will-block https://crypto.stackexchange.com/questions/51686/how-to-determine-the-next-number-from-javas-random-method https://franklinta.com/2014/08/31/predicting-the-next-math-random-in-java/ https://jazzy.id.au/2010/09/20/cracking_random_number_generators_part_1.html (è®²è§£äº†ç ´è§£éšæœºæ•°ç”Ÿæˆå™¨çš„ç†è®ºåŸºç¡€) ","date":"2023-01-30T10:33:47+08:00","permalink":"https://zhumengzhu.github.io/2023/01/java-random-number-issues-overview/","title":"Java éšæœºæ•°é—®é¢˜ç»¼è¿°"},{"content":"ç®€ä»‹ æœ¬æ–‡ä»ã€ä¼˜æƒ åˆ¸å‘æ”¾ã€é—®é¢˜çš„è®¨è®ºå‡ºå‘ï¼Œä»‹ç»å‡ ä¸ªè§£å†³æ–¹æ¡ˆå¹¶åˆ†æå…¶ä¼˜ç¼ºç‚¹ï¼Œç„¶åè®¨è®ºä¸€ä¸‹å¸¸è§çš„update just one unused rowæ¨¡å¼ï¼Œæœ€åèŠä¸€ä¸‹ MySQL 8.0.1 çš„ SKIP LOCKED å’Œ NOWAIT ç‰¹æ€§ã€‚\nã€åˆ¸å‘æ”¾ã€é—®é¢˜ åˆ¸å‘æ”¾ï¼Œä¸€èˆ¬ä½¿ç”¨ã€é¢„ç”Ÿæˆã€æ¨¡å¼ã€‚åœ¨å‘æ”¾å‰ï¼Œå…ˆå°†åˆ¸å…¨éƒ¨ç”Ÿæˆå¥½ï¼Œå­˜åœ¨ä¸€å¼ å…¨è¡¨ï¼Œè¿™å¼ è¡¨ä¸€èˆ¬è‡³å°‘åŒ…å«ä¸‰ä¸ªå­—æ®µï¼š\nä¸€ä¸ªå…¨å±€å”¯ä¸€çš„åˆ¸ç å­—æ®µï¼› ä¸€ä¸ªçŠ¶æ€å­—æ®µè¡¨ç¤ºæ˜¯å¦å‘æ”¾ï¼› ä¸€ä¸ªç”¨æˆ· ID å­—æ®µè®°å½•åˆ¸å‘ç»™äº†è°ï¼› å½“ç”¨æˆ·è¯·æ±‚é¢†åˆ¸æ—¶ï¼Œä¼šä»è¡¨ä¸­é€‰æ‹©ä¸€æ¡çŠ¶æ€ä¸ºã€æœªé¢†å–ã€çš„è®°å½•ï¼Œå°†å…¶çŠ¶æ€ç½®ä¸ºã€å·²é¢†å–ã€ï¼Œç”¨æˆ· IDç½®ä¸ºã€é¢†åˆ¸è€…çš„ IDã€ï¼Œæœ€åå°†åˆ¸ç è¿”ç»™ç”¨æˆ·ã€‚\nå‡è®¾åˆ¸è¡¨ç»“æ„å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 CREATE TABLE `coupon` ( `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT \u0026#39;ä¸»é”®id\u0026#39;, `code` VARCHAR(64) NOT NULL DEFAULT \u0026#39;\u0026#39; COMMENT \u0026#39;å”¯ä¸€åŠµç \u0026#39;, `status` TINYINT(10) NOT NULL DEFAULT 0 COMMENT \u0026#39;åŠµçŠ¶æ€, 0: æœªé¢†å–ï¼Œ1ï¼šå·²é¢†å–ï¼Œ2ï¼šå·²æ ¸é”€\u0026#39;, `user_id` BIGINT(20) NOT NULL DEFAULT 0 COMMENT \u0026#39;ç”¨æˆ· ID\u0026#39;, `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, PRIMARY KEY (`id`), UNIQUE KEY `uk_code` (`code`), KEY `idx_status` (`status`) ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COMMENT =\u0026#39;ä¼˜æƒ åˆ¸è¡¨\u0026#39;; åˆ¸è¡¨ä¸­çš„æ•°æ®å¦‚ä¸‹ï¼š\nID CODE status user_id 1 c1 0 0 2 c2 0 0 3 c3 0 0 4 c4 0 0 5 c5 0 0 å‡è®¾é¢†åˆ¸çš„ç”¨æˆ· ID ä¸º 1000ã€‚\næ–¹æ³•ä¸€ï¼šä¹è§‚é”-CAS 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # 1ã€é€‰æ‹©ä¸€å¼ åˆ¸ï¼Œå‡è®¾é€‰ä¸­çš„åˆ¸ç ä¸º `c1`ï¼› SELECT * FROM coupon WHERE `status` = 0 LIMIT 1; # 2ã€ä¿®æ”¹åˆ¸è®°å½•çš„çŠ¶æ€ UPDATE coupon SET `status` = 1, `user_id` = 1000 WHERE `code` = \u0026#39;c1\u0026#39; AND `status` = 0; # 3ã€è¿”å›åˆ¸ç  `c1` ä¸Šè¿°æ–¹æ³•ï¼Œåœ¨å¹¶å‘æƒ…å†µä¸‹å¯èƒ½å­˜åœ¨é—®é¢˜ï¼š\næ“ä½œé¡ºåº çº¿ç¨‹ä¸€ çº¿ç¨‹äºŒ 1 SELECT * FROM coupon WHERE status = 0 LIMIT 1; # å‡è®¾è¿”å›è®°å½•åˆ¸ç ä¸º c1 2 SELECT * FROM coupon WHERE status = 0 LIMIT 1; # å‡è®¾è¿”å›è®°å½•åˆ¸ç ä¹Ÿæ˜¯ c1 3 UPDATE coupon SET status = 1, user_id = 1000 WHERE code = \u0026lsquo;c1\u0026rsquo; AND status = 0; # æˆåŠŸ 4 UPDATE coupon SET status = 1, user_id = 1000 WHERE code = \u0026lsquo;c1\u0026rsquo; AND status = 0; # å¤±è´¥ ç”±äºçº¿ç¨‹ä¸€æ‰§è¡Œå®Œç¬¬ä¸‰æ­¥åï¼Œå·²å°†c1è¿™æ¡è®°å½•çš„statusçš„å€¼æ”¹ä¸º 1ï¼Œå› æ­¤çº¿ç¨‹äºŒæ‰§è¡Œç¬¬å››æ­¥ä¼šå¤±è´¥ã€‚æ‰€ä»¥éœ€è¦é‡è¯•ã€‚\nè¿™å¯ä»¥çœ‹åšä¸€ç§ã€ä¹è§‚é”ã€æ¨¡å¼ï¼Œã€ä¹è§‚é”ã€ä¸é€‚åˆé«˜å¹¶å‘åœºæ™¯ã€‚\næ–¹æ³•äºŒï¼šæ‚²è§‚é”-SELECT FOR UPDATE 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # 1ã€å¼€å¯äº‹åŠ¡ï¼ˆInnoDB é»˜è®¤çš„ RR çº§åˆ«ï¼‰ begin; # 2ã€é€‰æ‹©ä¸€å¼ åˆ¸ï¼Œå‡è®¾é€‰ä¸­çš„åˆ¸ç ä¸º `c1`ï¼› SELECT * FROM coupon WHERE `status` = 0 LIMIT 1 FOR UPDATE; # 3ã€ä¿®æ”¹åˆ¸è®°å½•çš„çŠ¶æ€ UPDATE coupon SET `status` = 1, `user_id` = 1000 WHERE `code` = \u0026#39;c1\u0026#39; AND `status` = 0; # 4ã€æäº¤äº‹åŠ¡ commit; # 5ã€è¿”å›åˆ¸ç  `c1` ä¸ºäº†è§£å†³å¹¶å‘çš„æƒ…å†µä¸‹æŸä¸ªæ“ä½œå¤±è´¥ï¼Œ å¯ä»¥å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œç„¶åä½¿ç”¨ select for update å…ˆå¯¹è®°å½•è¿›è¡ŒåŠ é”ï¼Œç„¶åå†ä¿®æ”¹è®°å½•çŠ¶æ€ã€‚ å‡è®¾æ“ä½œé¡ºåºå¦‚ä¸‹ï¼š\næ“ä½œé¡ºåº çº¿ç¨‹ä¸€ çº¿ç¨‹äºŒ 1 begin; 2 begin; 3 SELECT * FROM coupon WHERE status = 0 LIMIT 1 FOR UPDATE; # å‡è®¾è¿”å›è®°å½•åˆ¸ç ä¸º c1 4 SELECT * FROM coupon WHERE status = 0 LIMIT 1 FOR UPDATE; # é˜»å¡ 5 UPDATE coupon SET status = 1, user_id = 1000 WHERE code = \u0026lsquo;c1\u0026rsquo; AND status = 0; # æˆåŠŸ 6 commit; # é‡Šæ”¾è®°å½•c1çš„é” 7 SELECT * FROM coupon WHERE status = 0 LIMIT 1; # æˆåŠŸï¼Œè¿”å›åˆ¸ç  c2 8 UPDATE coupon SET status = 1, user_id = 1000 WHERE code = \u0026lsquo;c2\u0026rsquo; AND status = 0; # æˆåŠŸ 9 commit; # é‡Šæ”¾è®°å½•c2çš„é” çº¿ç¨‹äºŒåœ¨æ‰§è¡Œç¬¬ 4 æ­¥æ—¶ï¼Œç”±äºçº¿ç¨‹ä¸€å·²ç»æŠ¢åˆ°è®°å½•c1çš„é”ï¼Œçº¿ç¨‹äºŒä¼šè¢«é˜»å¡ï¼Œç›´åˆ°çº¿ç¨‹ä¸€æäº¤äº‹åŠ¡ï¼ˆ æ ¹æ®2PLï¼Œæäº¤äº‹åŠ¡æ—¶æ‰ä¼šé‡Šæ”¾é”ï¼‰ï¼›çº¿ç¨‹äºŒåœ¨ 7 æ­¥è·å–é”åï¼Œç”±äºè®°å½•c1çš„statusçš„å€¼å·²è¢«çº¿ç¨‹ä¸€æ”¹ä¸º 1ï¼Œæ‰€ä»¥æ­¤æ—¶æŸ¥è¯¢åˆ°çš„è®°å½•æ˜¯c2ã€‚\næ–¹æ³•äºŒè™½ç„¶å¯ä»¥ä¿è¯åˆ¸å‘æ”¾ä¸ä¼šå¤±è´¥ï¼Œä½†åœ¨é«˜å¹¶å‘ä¸‹ï¼Œä¼šæœ‰å¤§é‡çº¿ç¨‹é˜»å¡ã€‚\næ–¹æ³•ä¸‰ï¼šä½¿ç”¨ LAST_INSERT_ID ä¼˜åŒ–é”çš„æŒæœ‰æ—¶é—´ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # 1ã€å°†çŠ¶æ€ä¸ºæœªé¢†å–çš„ä¸€å¼ åˆ¸å‘æ”¾ç»™ç”¨æˆ· UPDATE coupon SET `status` = 1, `user_id` = 1000, `id` = LAST_INSERT_ID(`id`) WHERE `status` = 0 LIMIT 1; # 2ã€æŸ¥è¯¢æ­¥éª¤ 1 ä¿®æ”¹çš„åˆ¸çš„ IDï¼Œå‡è®¾ id ä¸º 1 SELECT LAST_INSERT_ID(); # 3ã€æŸ¥è¯¢åˆ¸ç ï¼Œå‡è®¾åˆ¸ç å€¼ä¸º `c1` SELECT `code` FROM coupon WHERE id = 1; # 4ã€è¿”å›åˆ¸ç  `c1` æ–¹æ³•äºŒä¸­ï¼Œæ ¹æ® 2PLï¼ˆä¸¤é˜¶æ®µé”åè®®ï¼‰ï¼Œé”çš„æŒæœ‰æ—¶é—´ä» select for update ä¸€ç›´æŒç»­åˆ° commitã€‚ é€šè¿‡ä½¿ç”¨ LAST_INSERT_ID å¯ä»¥é¿å…å¼€å¯äº‹åŠ¡ï¼Œé”çš„æŒæœ‰æ—¶é—´éå¸¸çŸ­ã€‚\nä¸è¿‡è¿™ä¸ªæ–¹æ³•æ²¡æ³•é¿å…é”äº‰æŠ¢ï¼Œå› ä¸ºæ ¹æ® InnoDB çš„é”æœºåˆ¶ï¼Œåœ¨æ‰«æåˆ°æ»¡è¶³æ¡ä»¶çš„è®°å½•æ—¶ä¼šè¿›è¡ŒåŠ é”(ç”±äº idx_status æ˜¯éå”¯ä¸€ç´¢å¼•ï¼Œå› æ­¤ä¼šåŠ  next-key é”) ï¼Œæ‰€ä»¥å¹¶å‘æ‰§è¡Œæ—¶ä»ç„¶ä¼šå­˜åœ¨é˜»å¡çš„æƒ…å†µã€‚\nè¿™å…¶å®å°±æ˜¯ç»å…¸çš„**ã€çƒ­ç‚¹æ•°æ®æ›´æ–°ã€**é—®é¢˜ã€‚\næ­¤å¤–ï¼Œè¦è¿™ä¸ªæ–¹æ³•æ˜¯ multi-user safe çš„ï¼Œæ‰€ä»¥åœ¨å¹¶å‘æƒ…å†µä¸‹ä¹Ÿæ˜¯å®‰å…¨çš„:\nIt is multi-user safe because multiple clients can issue the UPDATE statement and get their own sequence value with the SELECT statement (or mysql_insert_id()), without affecting or being affected by other clients that generate their own sequence values.\nsee MySQL 8.0 Reference Manual\næœ€åï¼Œè¿˜å¯ä»¥å¯¹ä¸Šé¢çš„ SQL è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œä½¿å¾—åªéœ€æ‰§è¡Œ 2 æ¬¡ SQLï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # 1ã€å°†çŠ¶æ€ä¸ºæœªé¢†å–çš„ä¸€å¼ åˆ¸å‘æ”¾ç»™ç”¨æˆ· UPDATE coupon SET `status` = 1, `user_id` = 1000, `id` = LAST_INSERT_ID(`id`) WHERE `status` = 0 LIMIT 1; # 2ã€æŸ¥è¯¢åˆ¸ç  SELECT `code` FROM coupon, (SELECT LAST_INSERT_ID() id) AS t WHERE coupon.id = t.id; # 3ã€è¿”å›åˆ¸ç  `c1` æ–¹æ³•å››ï¼šä½¿ç”¨ SKIP LOCKED é¿å…é”äº‰æŠ¢ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # 1ã€å¼€å¯äº‹åŠ¡ï¼ˆInnoDB é»˜è®¤çš„ RR çº§åˆ«ï¼‰ begin; # 2ã€æ˜¯ç”¨ `SELECT FOR UPDATE SKIP LOCKED` é€‰æ‹©ä¸€æ¡åˆ¸ SELECT * FROM coupon WHERE `status` = 0 LIMIT 1 FOR UPDATE SKIP LOCKED; # 3ã€ä¿®æ”¹åˆ¸è®°å½•çš„çŠ¶æ€ UPDATE coupon SET `status` = 1, `user_id` = 1000 WHERE `code` = \u0026#39;c1\u0026#39; AND `status` = 0; # 4ã€æäº¤äº‹åŠ¡ commit; # 5ã€è¿”å›åˆ¸ç  `c1` å‡è®¾æ“ä½œé¡ºåºå¦‚ä¸‹ï¼š\næ“ä½œé¡ºåº çº¿ç¨‹ä¸€ çº¿ç¨‹äºŒ 1 begin; 2 begin; 3 SELECT * FROM coupon WHERE status = 0 LIMIT 1 FOR UPDATE SKIP LOCKED; # å‡è®¾è¿”å›è®°å½•åˆ¸ç ä¸º c1 4 SELECT * FROM coupon WHERE status = 0 LIMIT 1 FOR UPDATE SKIP LOCKED; # æˆåŠŸï¼Œè¿”å›åˆ¸ç  c2 5 UPDATE coupon SET status = 1, user_id = 1000 WHERE code = \u0026lsquo;c1\u0026rsquo; AND status = 0; # æˆåŠŸ 6 commit; # é‡Šæ”¾è®°å½•c1çš„é” 8 UPDATE coupon SET status = 1, user_id = 1000 WHERE code = \u0026lsquo;c2\u0026rsquo; AND status = 0; # æˆåŠŸ 9 commit; # é‡Šæ”¾è®°å½•c2çš„é” ä¸åŒäºæ–¹æ³•äºŒï¼Œçº¿ç¨‹äºŒåœ¨æ‰§è¡Œç¬¬ 4 æ­¥æ—¶ï¼Œä¸ä¼šé˜»å¡åœ¨è®°å½•c1ä¸Šï¼Œè€Œæ˜¯ä¼šè·³è¿‡è¿™æ¡è®°å½•ï¼Œç›´æ¥å¯¹ä¸‹ä¸€æ¡è®°å½•c2è¿›è¡ŒåŠ é”ã€‚\nè¿™ä¸ªæ–¹æ³•ï¼Œé”çš„æŒæœ‰æ—¶é—´ä¸æ–¹æ³•äºŒç›¸åŒï¼Œä½†é¿å…äº†äº‰æŠ¢é”ï¼Œä¹Ÿèƒ½è¾¾åˆ°ä¸€ä¸ªå¾ˆå¥½çš„æ€§èƒ½ã€‚\næ³¨æ„ï¼ŒSKIP LOCKED æ˜¯ MySQL 8.0.1 å¼•å…¥çš„æ–°ç‰¹æ€§ã€‚\næ–¹æ³•äº”ï¼šä½¿ç”¨ Redis å‡å°‘ SQL çš„æ‰§è¡Œæ¬¡æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # 0ã€åˆå§‹åŒ– Redis: åœ¨æ´»åŠ¨å¼€å§‹å‰ï¼Œå…ˆä»æ•°æ®åº“ä¸­æŸ¥è¯¢æ‰€æœ‰æœªå‘æ”¾åˆ¸çš„åˆ¸ç ï¼Œæ”¾å…¥ Redis ä¸­çš„é˜Ÿåˆ—ä¸­ LPUSH coupon_list_key (SELECT code from coupon WHERE status = 0) # 1ã€å‘æ”¾æ—¶ï¼Œä» Redis é˜Ÿåˆ—ä¸­ç§»é™¤å¹¶è¿”å›ä¸€ä¸ªåˆ¸ç ï¼Œå‡è®¾å€¼ä¸º`c1` LPOP coupon_list_key # 2ã€ä¿®æ”¹åˆ¸è®°å½•çš„çŠ¶æ€ UPDATE coupon SET `status` = 1, `user_id` = 1000 WHERE `code` = \u0026#39;c1\u0026#39; AND `status` = 0; # 3ã€è¿”å›åˆ¸ç  `c1` ä½¿ç”¨ Redisï¼Œæ—¢èƒ½ä¿è¯æ­£ç¡®æ€§ï¼Œä¹Ÿæœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œå› ä¸ºï¼š\nRedis æ˜¯å•çº¿ç¨‹æ‰§è¡Œå‘½ä»¤çš„ï¼Œå› æ­¤ä» Redis è¿”å›çš„åˆ¸ç æ˜¯å”¯ä¸€çš„ï¼Œæ‰§è¡Œç¬¬ 2 æ­¥ä¸ä¼šäº‰æŠ¢é”ä¹Ÿä¸ä¼šå¤±è´¥ï¼› LPOP å‘½ä»¤æ˜¯ä»é˜Ÿåˆ—å¤´ç§»é™¤ä¸€ä¸ªå…ƒç´ ï¼Œæ—¶é—´å¤æ‚åº¦ä»…ä¸º O(1)ï¼› ä»…éœ€è¦æ‰§è¡Œä¸€æ¡ UPDATE è¯­å¥ï¼› é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡å¼•å…¥ MQ å°† UPDATE è¯­å¥æ”¹ä¸ºå¼‚æ­¥æ‰§è¡Œï¼Œè¿›ä¸€æ­¥æé«˜å¹¶å‘åº¦ã€‚\nä¸è¿‡ï¼Œå¼•å…¥ Redis ä¼šä½¿å¾—ç³»ç»Ÿå˜å¾—æ›´å¤æ‚ï¼Œå› ä¸ºï¼š\néœ€è¦é¢å¤–ç¼–å†™ä¸€ä¸ªæ¨¡å—ç”¨æ¥åˆå§‹åŒ– Redisï¼› åœ¨åˆå§‹åŒ– Redis è¦ç‰¹åˆ«å°å¿ƒï¼Œä¸èƒ½å°†ã€å·²å‘æ”¾ã€çš„åˆ¸æ”¾å…¥ Redisï¼› ä» Redis å‡ºé˜ŸæˆåŠŸï¼Œä½†å†™æ•°æ®åº“å¤±è´¥ï¼Œä¼šå¯¼è‡´åˆ¸ç è¢«æµªè´¹ï¼Œéœ€è¦å›æ»š Redisï¼› å›æ»š Redis å¯èƒ½å®ç°èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œå› ä¸ºå°†åˆ¸ç æ”¾å› Redis æ—¶å¯èƒ½å¤±è´¥ï¼Œéœ€è¦é‡è¯•æœºï¼› Redis ä¸»ä»åŒæ­¥å¯èƒ½å­˜åœ¨å»¶è¿Ÿï¼Œæ­¤æ—¶ä¸»ä»åˆ‡æ¢å¯èƒ½å¯¼è‡´ Redis è¿”å›é‡å¤çš„åˆ¸ç ï¼Œå¯¼è‡´æ–¹æ³•å¤±è´¥ï¼Œéœ€è¦é‡è¯•æœºåˆ¶ï¼› å°èŠ‚ æ–¹æ³•ä¸€å’Œæ–¹æ³•äºŒä¸é€‚åˆé«˜å¹¶å‘åœºæ™¯ï¼Œå‰è€…å¤±è´¥ç‡é«˜ï¼Œåè€…æ€§èƒ½ç‰¹åˆ«å·®ï¼› æ–¹æ³•ä¸‰æŒæœ‰é”çš„æ—¶é—´å¾ˆçŸ­ï¼Œæ€§èƒ½æ¯”è¾ƒå¥½ï¼Œå®ç°ä¹Ÿå¾ˆç®€å•ï¼Œä½†å­˜åœ¨çƒ­ç‚¹æ•°æ®æ›´æ–°é—®é¢˜ï¼› æ–¹æ³•å››æŒæœ‰é”çš„æ—¶é—´ç¨é•¿ï¼Œå› ä¸ºé”çš„æ˜¯ä¸åŒçš„è®°å½•ï¼Œå› æ­¤ä¸å­˜åœ¨çƒ­ç‚¹æ•°æ®ï¼Œæ€§èƒ½æ¯”è¾ƒå¥½ï¼Œå®ç°ä¹Ÿç®€å•ï¼Œä½†åªèƒ½åœ¨ MySQL 8.0.1 åŠä»¥ä¸Šæ‰èƒ½ä½¿ç”¨ï¼› æ–¹æ³•äº”å¼•å…¥ Redisï¼Œåœ¨æ€§èƒ½ä¸Šæœ‰æœ€å¤§çš„æ½œåŠ›ï¼Œä½†å®ç°èµ·æ¥æ›´å¤æ‚ï¼› æ–¹æ³•ä¸‰ã€å››ã€äº”å­°ä¼˜å­°åŠ£ï¼Œç•™å¾…å®è·µè¿›è¡Œæ£€éªŒã€‚\nUpdate just one unused row ä»…æ›´æ–°ä¸€è¡Œæœªä½¿ç”¨çš„æ•°æ®ï¼Œæ˜¯ä¸€ç§éå¸¸å¸¸è§çš„åœºæ™¯ï¼Œçœ‹ä¼¼éå¸¸å®¹æ˜“è§£å†³ï¼š\n1 2 3 4 5 # ä¹è§‚é” CAS æ›´æ–° UPDATE record SET `status` = \u0026#39;used\u0026#39; WHERE `status` = \u0026#39;unused\u0026#39; LIMIT 1; ä½†å½“æˆ‘ä»¬éœ€è¦è·å–è¢«æ›´æ–°æ•°æ®çš„ ID æ—¶ï¼Œé—®é¢˜ç¬é—´å˜å¾—å¤æ‚èµ·æ¥ã€‚\nè·å–å˜æ›´ IDï¼Œé™¤äº†ä¸Šé¢ä»‹ç»çš„ä½¿ç”¨æ‚²è§‚é”SELECT FOR UPDATEå’ŒLAST_INSERT_IDä¸¤ä¸ªæ–¹æ³•å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡ä¸´æ—¶å˜é‡æ¥å®ç°ï¼š\nSET @update_id := 0; UPDATE some_table SET column_name = \u0026lsquo;value\u0026rsquo;, id = (SELECT @update_id := id) WHERE some_other_column = \u0026lsquo;blah\u0026rsquo; LIMIT 1; SELECT @update_id;\nè¯¦æƒ…è§ï¼šHow to get ID of the last updated row in MySQL?:\nè¿™ç§æ–¹æ³•åœ¨éœ€è¦ä¸€æ¬¡æ›´æ–°å¤šæ¡è®°å½•æ—¶ç‰¹åˆ«æœ‰ç”¨ã€‚\nMySQL 8.0.1 SKIP LOCKED and NOWAIT æ¨èä¸€ç¯‡æ–‡ç« ï¼šMySQL 8.0.1: Using SKIP LOCKED and NOWAIT to handle hot rows è¿™ç¯‡æ–‡ç« æ˜¯åœ¨ 2017 å¹´ 4 æœˆ 12 ç”± Martin Hansson å‘å¸ƒåœ¨ MySQL å®˜æ–¹åšå®¢ä¸Šçš„ã€‚å®ƒä¸»è¦æ˜¯é€šè¿‡ä¸€ä¸ªè®¢ç¥¨ç³»ç»Ÿï¼Œè®²è§£ SKIP LOCKED å’Œ NOWAIT çš„ä½¿ç”¨æ–¹æ³•ã€‚\nå¦å¤–ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ï¼š\nStatements that use NOWAIT or SKIP LOCKED are unsafe for statement based replication.\nReference https://dba.stackexchange.com/questions/131051/update-just-one-unused-row https://stackoverflow.com/questions/1388025/how-to-get-id-of-the-last-updated-row-in-mysql https://gist.github.com/PieterScheffers/189cad9510d304118c33135965e9cddb https://dev.mysql.com/blog-archive/mysql-8-0-1-using-skip-locked-and-nowait-to-handle-hot-rows/ https://dev.mysql.com/doc/refman/8.0/en/information-functions.html#function_last-insert-id https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html ","date":"2022-11-20T17:21:39+08:00","permalink":"https://zhumengzhu.github.io/2022/11/mysql-update-just-one-unused-row/","title":"Mysql åªæ›´æ–°æœªä½¿ç”¨çš„ä¸€è¡Œæ•°æ®é—®é¢˜"},{"content":"èƒŒæ™¯ è¿™æ˜¯ä¸€ç¯‡åšå®¢é˜…è¯»ç¬”è®°ï¼ŒåŸåšå®¢Late row lookups: InnoDBå†™äº 2011 å¹´ï¼Œä½œè€…æ˜¯ä¸€ä¸ªå« Quassnoi çš„ä¿„ç½—æ–¯äººã€‚\nQuassnoi åœ¨ 2009 å¹´æ—¶å†™äº†ä¸€ç¯‡æ–‡ç« è®² MySQL Limit çš„æ€§èƒ½ä¼˜åŒ–(MySQL ORDER BY / LIMIT performance: late row lookups)ï¼Œåæ¥æœ‰è¯»è€…æäº†ä¸¤ä¸ªé—®é¢˜ï¼š\nIs this workaround specific to MyISAM engine? How does PostgreSQL handle this? Quassnoi å†™ä¸‹è¿™ç¯‡æ–°åšå®¢ï¼Œå³ä¸ºäº†å›ç­”ä¸Šè¿°ä¸¤ä¸ªé—®é¢˜ã€‚\næ­£æ–‡ The questions concerns a certain workaround for MySQL LIMIT â€¦ OFFSET queries like this:\n1 2 3 4 SELECT * FROM mytable ORDER BY id LIMIT 10 OFFSET 10000; which can be improved using a little rewrite:\n1 2 3 4 5 6 7 8 SELECT m.* FROM (SELECT id FROM mytable ORDER BY id LIMIT 10 OFFSET 10000) q JOIN mytable m ON m.id = q.id ORDER BY m.id; æ³¨æ„ï¼šä½œè€…ä¹‹å‰çš„æ–‡ç« è®¨è®ºçš„æ˜¯è¿™ä¸ªæ–¹æ³•å¯¹ MyISAM æ˜¯æœ‰æ•ˆçš„ï¼›é—®é¢˜æ˜¯ï¼Œå¯¹äº InnoDB å’Œ PostgreSQL å‘¢ï¼Ÿ\nPostgreSQL The Answer The second questions is easy: PostgreSQL won\u0026rsquo;t pull the fields from the table until it really needs them. If a query involving an ORDER BY along with LIMIT and OFFSET is optimized to use the index for the ORDER BY part, the table lookups won\u0026rsquo;t happen for the records skipped.\nè¿™å¥è¯æ˜¯è¯´ï¼ŒPostgreSQL åªä¼šåœ¨éœ€è¦çš„æ—¶å€™æ‰å›è¡¨æŸ¥è¯¢ã€‚å¦‚æœä¸€ä¸ªæŸ¥è¯¢æ¶‰åŠ ORDER BYã€LIMIT å’Œ OFFSETï¼Œé‚£ä¹ˆå¯ä»¥å…ˆåˆ©ç”¨ç´¢å¼•è·³è¿‡ä¸éœ€è¦çš„è®°å½•ï¼Œåªå¯¹éœ€è¦çš„è®°å½•è¿›è¡Œè¿›è¡Œå›è¡¨ã€‚\nè¿™å…¶å®å°±æ˜¯ã€Late Row Lookupsã€ï¼›ä¸ä¹‹ç›¸å¯¹çš„ï¼ŒMySQL æ‰§è¡Œçš„æ˜¯ã€Early Row Lookupsã€ã€‚\nä½œè€…åé¢è¯´è™½ç„¶ PostgreSQL çš„æŸ¥è¯¢è®¡åˆ’ä¸ä¼šè¾“å‡ºå›è¡¨ä¿¡æ¯ï¼Œä½†å¯ä»¥é€šè¿‡ä¸€ä¸ªç®€å•çš„æµ‹è¯•è¿›è¡ŒéªŒè¯ã€‚ä½†å…·ä½“æ€ä¹ˆè¿›è¡Œè¿™ä¸ªå®éªŒï¼Œä½œè€…æ²¡è®²ï¼Œä¸‹é¢è¯•ç€åšä¸ªè¡¥å……ã€‚\néªŒè¯(å­˜ç–‘) å»ºè¡¨è¯¦æƒ… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 -- å»ºè¡¨ CREATE TABLE page ( id SERIAL PRIMARY KEY, name VARCHAR(16) DEFAULT NULL, content VARCHAR(255) DEFAULT NULL ); -- ä¸º name å­—æ®µåˆ›å»ºäºŒçº§ç´¢å¼• CREATE INDEX idx_name ON page (name); -- åˆå§‹åŒ– 600 ä¸‡æ¡æ•°æ® INSERT INTO page (name, content) (SELECT CONCAT(\u0026#39;å°ç“¦\u0026#39;, s.id) AS name, CONCAT(\u0026#39;xx\u0026#39;, s.id) AS content FROM GENERATE_SERIES(1, 6000010) AS s(id)); æ‰§è¡Œ SQL ä¸€ï¼šç›´æ¥æŸ¥è¯¢ 1 2 3 4 5 6 7 postgres=# EXPLAIN ANALYZE SELECT * FROM page ORDER BY id OFFSET 6000000 LIMIT 10; QUERY PLAN ------------------------------------------------------------------------------------------------------------------------------------------ Limit (cost=199830.43..199830.76 rows=10 width=26) (actual time=540.002..540.003 rows=10 loops=1) -\u0026gt; Index Scan using page_pkey on page (cost=0.43..199846.81 rows=6000492 width=26) (actual time=0.087..427.982 rows=6000010 loops=1) Planning Time: 0.108 ms Execution Time: 540.022 ms æ‰§è¡Œ SQL äºŒï¼šä½¿ç”¨å­æŸ¥è¯¢ 1 2 3 4 5 6 7 8 9 10 11 postgres=# EXPLAIN ANALYZE SELECT t1.* FROM page t1, (SELECT id FROM page ORDER BY id OFFSET 6000000 LIMIT 10) t2 where t1.id=t2.id ORDER BY t1.id; QUERY PLAN ---------------------------------------------------------------------------------------------------------------------------------------------------- Nested Loop (cost=155811.47..155895.90 rows=10 width=26) (actual time=368.952..368.960 rows=10 loops=1) -\u0026gt; Limit (cost=155811.04..155811.30 rows=10 width=4) (actual time=368.941..368.942 rows=10 loops=1) -\u0026gt; Index Only Scan using page_pkey on page (cost=0.43..155823.81 rows=6000492 width=4) (actual time=0.015..248.584 rows=6000010 loops=1) Heap Fetches: 50 -\u0026gt; Index Scan using page_pkey on page t1 (cost=0.43..8.45 rows=1 width=26) (actual time=0.001..0.001 rows=1 loops=10) Index Cond: (id = page.id) Planning Time: 0.375 ms Execution Time: 369.004 ms æ‰§è¡Œ SQL ä¸‰ï¼šä½¿ç”¨å­æŸ¥è¯¢ 1 2 3 4 5 6 7 8 9 10 11 postgres=# EXPLAIN ANALYZE SELECT t1.* FROM page t1 join (SELECT id FROM page ORDER BY id OFFSET 6000000 LIMIT 10) t2 ON t1.id=t2.id ORDER BY t1.id; QUERY PLAN ---------------------------------------------------------------------------------------------------------------------------------------------------- Nested Loop (cost=155811.47..155895.90 rows=10 width=26) (actual time=362.645..362.652 rows=10 loops=1) -\u0026gt; Limit (cost=155811.04..155811.30 rows=10 width=4) (actual time=362.633..362.634 rows=10 loops=1) -\u0026gt; Index Only Scan using page_pkey on page (cost=0.43..155823.81 rows=6000492 width=4) (actual time=0.017..243.148 rows=6000010 loops=1) Heap Fetches: 50 -\u0026gt; Index Scan using page_pkey on page t1 (cost=0.43..8.45 rows=1 width=26) (actual time=0.001..0.001 rows=1 loops=10) Index Cond: (id = page.id) Planning Time: 4.609 ms Execution Time: 362.707 ms ä¸‰ä¸ªæŸ¥è¯¢çš„è€—æ—¶ä¸ºï¼š`540.022 ms` vs `369.004 ms` vs `362.707 ms`ã€‚ \u003e Tips: ä½¿ç”¨ `EXPLAIN ANALYZE` æ—¢å¯ä»¥è·å¾—æŸ¥è¯¢è®¡åˆ’ï¼Œåˆèƒ½æ‰§è¡Œè¯­å¥ã€‚ ç»“è®º ä¸Šè¿°å®éªŒå¯ä»¥è¯æ˜è¯¥ä¼˜åŒ–å¯¹äº PostgreSQL åŒæ ·å¯ä»¥æœ‰æ•ˆã€‚\nInnoDB ä¸ºäº†å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œä½œè€…é¦–å…ˆåˆ›å»ºäº†ä¸€å¼ è¡¨ã€‚\nå»ºè¡¨ å»ºè¡¨è¯¦æƒ… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 # åˆ›å»ºä¸€å¼ å†…å­˜è¡¨ CREATE TABLE filler ( id INT NOT NULL PRIMARY KEY AUTO_INCREMENT ) ENGINE = Memory; # åˆ›å»º InnoDB è¡¨ CREATE TABLE lookup ( id INT NOT NULL PRIMARY KEY, value INT NOT NULL, shorttxt TEXT NOT NULL, longtxt TEXT NOT NULL ) ENGINE = InnoDB ROW_FORMAT = COMPACT; # ä¸º value å­—æ®µåˆ›å»ºç´¢å¼• CREATE INDEX ix_lookup_value ON lookup (value); # åˆ›å»ºå­˜å‚¨è®¡åˆ’ DELIMITER $$ CREATE PROCEDURE prc_filler(cnt INT) BEGIN DECLARE _cnt INT; SET _cnt = 1; WHILE _cnt \u0026lt;= cnt DO INSERT INTO filler SELECT _cnt; SET _cnt = _cnt + 1; END WHILE; END $$ # åˆå§‹åŒ–å†…å­˜è¡¨ DELIMITER ; START TRANSACTION; CALL prc_filler(100000); COMMIT; # åˆå§‹åŒ– InnoDB è¡¨ INSERT INTO lookup SELECT id, CEILING(RAND(20110211) * 1000000), RPAD(\u0026#39;\u0026#39;, CEILING(RAND(20110211 \u0026lt;\u0026lt; 1) * 100), \u0026#39;*\u0026#39;), RPAD(\u0026#39;\u0026#39;, CEILING(8192 + RAND(20110211 \u0026lt;\u0026lt; 1) * 100), \u0026#39;*\u0026#39;) FROM filler; ä¸Šé¢åˆ©ç”¨ä¸€å¼ å†…å­˜è¡¨å’Œå­˜å‚¨è®¡åˆ’åˆ›å»ºäº†ä¸€å¼  InnoDB è¡¨ `lookup`ï¼šè¿™å¼ è¡¨åŒ…å«ä¸€ä¸ªåŠ äº†ç´¢å¼•çš„ `INT` åˆ—ï¼Œä»¥åŠä¸¤ä¸ª `TEXT` åˆ—ï¼Œå…¶ä¸­ shorttxt å­˜å‚¨çŸ­å­—ç¬¦ä¸²(åŒ…å« 1~100 ä¸ªå­—ç¬¦)ï¼Œlongtxt å­˜å‚¨é•¿å­—ç¬¦ä¸²(åŒ…å« 8193~8293 ä¸ªå­—ç¬¦)ã€‚ é€šè¿‡ä¸»é”®ç´¢å¼•æŸ¥è¯¢ value å’Œ shottxt ä¸¤ä¸ªå­—æ®µæ—¶ï¼Œæ˜¯å¦ä½¿ç”¨å­æŸ¥è¯¢ä¼˜åŒ–å¯¹è€—æ—¶å½±å“ä¸å¤§ï¼Œç•¥å»ä¸è®¨è®ºã€‚\né€šè¿‡ä¸»é”®ç´¢å¼•æŸ¥è¯¢ longtxt åˆ— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Rewrite SELECT LENGTH(l.longtxt) FROM (SELECT id FROM lookup ORDER BY id LIMIT 10 OFFSET 90000) q JOIN lookup l ON l.id = q.id ORDER BY q.id; # 10 rows in set (0.133 sec) # No rewrite SELECT LENGTH(longtxt) FROM lookup ORDER BY id LIMIT 10 OFFSET 90000; # 10 rows in set (1.579 sec) 0.133 sec vs 1.579 secã€‚\nWhy such a difference?\nThe reason is that InnoDB, despite the fact it stores the data in the clustered index, is still able to move \u0026gt; some data out of the index. This is called external storage.\nåœ¨ InnoDB ä¸­ï¼Œå°äº 768 å­—èŠ‚çš„åˆ—ä¼šå…¨éƒ¨å­˜å‚¨åœ¨é¡µä¸Šï¼Œå¤§äº 768 å­—èŠ‚åˆ™ä¼šåˆ†å¼€å­˜å‚¨ã€‚åœ¨ä¸Šé¢çš„ lookup è¡¨ä¸­ï¼Œshottxt åˆ—æ€»æ˜¯ on-page å­˜å‚¨çš„ï¼Œè€Œ longtxt åˆ™æ˜¯ off-pageçš„ã€‚\nå› æ­¤ï¼Œç›´æ¥æŸ¥è¯¢ longtxt æ—¶ï¼Œæ¯æ‰«æä¸€æ¡è®°å½•éƒ½è¦å‡ºå‘ä¸¤æ¬¡page lookupsï¼šç¬¬ä¸€æ¬¡æŸ¥èšç°‡ç´¢å¼•ï¼Œç¬¬äºŒæ¬¡æŸ¥å¤–éƒ¨å­˜å‚¨ã€‚è¿™æ—¢ä¼šèŠ±è´¹å¾ˆå¤šæ—¶é—´ï¼Œä¹Ÿå¯èƒ½ç ´å InnoDB ç¼“å­˜ï¼Œå¯¼è‡´ç¼“å­˜å‘½ä¸­ç‡ä¸‹é™ã€‚\né€šè¿‡äºŒçº§ç´¢å¼•æŸ¥è¯¢ shorttxt åˆ— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # Rewrite SELECT LENGTH(l.shorttxt) FROM (SELECT id, value FROM lookup ORDER BY value LIMIT 10 OFFSET 90000) q JOIN lookup l ON l.id = q.id ORDER BY q.value; # 10 rows in set (0.022 sec) # No rewrite SELECT LENGTH(shorttxt) FROM lookup ORDER BY value LIMIT 10 OFFSET 90000;# 10 rows in set (0.209 sec) 0.022 sec vs 0.209 secï¼Œè€—æ—¶ç›¸å·® 10 å€ã€‚ InnoDBçš„äºŒçº§ç´¢å¼•æŸ¥è¯¢æœ‰ç‚¹ç±»ä¼¼MyISAMï¼Œéƒ½éœ€è¦ä¸€æ¬¡é¢å¤–çš„å›è¡¨æŸ¥è¯¢å»è·å–æ­£åœ¨çš„æ•°æ®ã€‚\nä¸Šé¢ç¬¬ä¸€ä¸ªæŸ¥è¯¢å¯¹äºè·³è¿‡çš„è®°å½•ä¸ä¼šæ‰§è¡Œå›è¡¨æŸ¥è¯¢ï¼Œå› æ­¤é€Ÿåº¦æ˜¯åŸæ¥çš„ 10 å€ã€‚å®ƒç”šè‡³æ¯”åœ¨ä¸»é”®ç´¢å¼•ä¸Šçš„æŸ¥è¯¢(0.044 sec)è¿˜å¿«ï¼ŒåŸå› æ˜¯äºŒçº§ç´¢å¼•åŒ…å«çš„æ•°æ®æ¯”ä¸»é”®ç´¢å¼•æ›´å°‘ï¼Œæ¯é¡µä¿å­˜çš„æ•°æ®æ›´å¤šï¼Œå› æ­¤ç´¢å¼•å¯èƒ½æ›´åŠ çŸ®èƒ–ï¼Œæ‰«æé€Ÿåº¦æ›´å¿«ã€‚\nå½“ç„¶ï¼ŒäºŒçº§ç´¢å¼•ä¸ŠåŒæ ·æ˜¯Early Row Lookupsã€‚\nç»“è®º A trick used to avoid early row lookups for the LIMIT â€¦ OFFSET queries is useful on InnoDB tables too, though to different extent, depending on the ORDER BY condition and the columns involved:\nIt\u0026rsquo;s very useful on queries involving columns stored off-page (long TEXT, BLOB and VARCHAR columns) It\u0026rsquo;s very useful on ORDER BY conditions served by secondary indexes It\u0026rsquo;s quite useful on moderate sized columns (still stored on page) or CPU-intensive expressions It\u0026rsquo;s almost useless on short columns without complex CPU-intensive processing å…¶å®ƒ PostgreSQLæŸ¥è¯¢è®¡åˆ’ é™¤ç¬¬ä¸€è¡Œä»¥å¤–æ¯ä¸ª-\u0026gt;è¡¨ç¤ºä¸€ä¸ªå­åŠ¨ä½œ æŸ¥è¯¢è®¡åˆ’çš„é˜…è¯»é¡ºåºéƒ½æ˜¯ä»åå¾€å‰ cost ç”± .. åˆ†å‰²æˆä¸¤ä¸ªæ•°å­—ï¼Œç¬¬ä¸€ä¸ªæ•°å­—è¡¨ç¤ºå¯åŠ¨æˆæœ¬ï¼Œå³è¿”å›ç¬¬ä¸€è¡Œçš„æˆæœ¬ï¼›ç¬¬äºŒä¸ªæ•°å­—è¡¨ç¤ºè¿”å›æ‰€æœ‰æ•°æ®çš„æˆæœ¬ã€‚ rows è¡¨ç¤ºè¿”å›è¡Œæ•° width è¡¨ç¤ºæ¯è¡Œå¹³å‡å®½åº¦ loops è¡¨ç¤ºç´¢å¼•æ‰«æè¢«æ‰§è¡Œè¿‡å‡ æ¬¡ Reference Documentation: 15: 14.1. Using EXPLAIN - PostgreSQL ","date":"2022-11-14T19:12:47+08:00","permalink":"https://zhumengzhu.github.io/2022/11/late-row-lookups-innodb/","title":"Late Row Lookups: InnoDB"},{"content":"ä¸€ã€æ·±åˆ†é¡µä¸ºä»€ä¹ˆæ…¢ æ·±åˆ†é¡µæŒ‡çš„æ˜¯å½¢å¦‚ select ... from ... where ... order by ... limit offset, size çš„æŸ¥è¯¢è¯­å¥ä¸­ offset ç‰¹åˆ«å¤§çš„æƒ…å†µã€‚é«˜æ€§èƒ½ MySQL(ç¬¬ä¸‰ç‰ˆ) çš„ç¬¬ 6.7.5 èŠ‚ä¸“é—¨è®²äº†æ­¤é—®é¢˜ï¼Œä½†æ¯”è¾ƒç®€ç•¥ã€‚\næœ‰å¤šæ…¢ å‡è®¾æœ‰ä¸€å¼  page è¡¨åŒ…å« 600 å¤šä¸‡æ¡æ•°æ®ï¼Œåˆ†åˆ«æ‰§è¡Œä¸‹é¢ä¸¤æ¡è¯­å¥ï¼š\n1 2 3 4 5 6 7 # SQL ä¸€ select * from page order by id limit 0, 10; # 10 rows in set (0.001 sec) # SQL äºŒ select * from page order by id limit 6000000, 10; # 10 rows in set (0.940 sec) æ³¨æ„åˆ° SQL äºŒå…¶å®æ˜¯æŒ‰ä¸»é”® ID æ’åºçš„(æ„å‘³ç€ä¸éœ€è¦è¿›è¡Œ filesortï¼Œç›´æ¥æŒ‰ä¸»é”®ç´¢å¼•é¡ºåºæ‰«æå³å¯)ï¼Œè€—æ—¶ä»ç„¶é«˜è¾¾ 0.940 ç§’ã€‚\nä¸ºä»€ä¹ˆæ…¢ ã€æŸ¥è¯¢è®¡åˆ’ã€\n1 2 3 4 5 6 explain select * from page order by id limit 6000000, 10; +------+-------------+-------+-------+---------------+---------+---------+------+---------+-------+ | id | select_type | table | type | possible_keys | key | key_len | ref | rows | Extra | +------+-------------+-------+-------+---------------+---------+---------+------+---------+-------+ | 1 | SIMPLE | page | index | NULL | PRIMARY | 4 | NULL | 5988448 | | +------+-------------+-------+-------+---------------+---------+---------+------+---------+-------+ ã€æ…¢æŸ¥è¯¢æ—¥å¿—ã€\n1 2 3 4 5 6 7 # Time: 221106 0:26:54 # User@Host: root[root] @ localhost [] # Thread_id: 18 Schema: test QC_hit: No # Query_time: 0.939618 Lock_time: 0.000735 Rows_sent: 10 Rows_examined: 6000010 # Rows_affected: 0 Bytes_sent: 533 SET timestamp=1667665614; select * from page order by id limit 6000000, 10; æ³¨æ„åˆ° rows å’Œ ä¸º rows_examined åˆ†åˆ«ä¸º 5988448ã€6000010ã€‚ åŸå› æ˜¾è€Œæ˜“è§ï¼šä¸ºäº†å®Œæˆ limit offset, size è¿™æ ·çš„æŸ¥è¯¢ï¼Œ MySQL è¦æ‰«æè‡³å°‘ offset + size è¡Œæ•°æ®ï¼›offset è¶Šå¤§ï¼Œåˆ™æ‰«ææ¬¡æ•°è¶Šå¤šï¼Œé€Ÿåº¦è¶Šæ…¢ã€‚\näºŒã€æ·±åˆ†é¡µæ€ä¹ˆä¼˜åŒ– åˆ†é¡µä»åŸç†ä¸Šæ¥è®²ï¼Œä¸»è¦æ˜¯ä¸¤ç§ï¼š\nä¸€ç§å°±æ˜¯å‰é¢è®²çš„åŸºäº limit offset, size çš„åˆ†é¡µï¼Œè‹±æ–‡ä¸€èˆ¬å« offset paginationï¼› å¦ä¸€ç§æ–¹æ³•æ”¾å¼ƒäº† offsetï¼Œæ”¹ç”¨ left off, SQL å½¢å¦‚ SELECT ... WHERE ... AND id \u0026lt; $left_off ORDER BY id DESC LIMIT 10, è‹±æ–‡ä¸€èˆ¬å« cursor pagination, ä¹Ÿæœ‰äººç§°ä¹‹ä¸º seek method æˆ– keyset paginationã€‚ Offset pagination å°±åƒåŸºäºæ¯”è¾ƒçš„æ’åºç®—æ³•çš„å¹³å‡æ—¶é—´å¤æ‚åº¦çš„ä¸‹ç•Œæ˜¯ O(nlogn) ä¸€æ ·ï¼Œå¯¹äº MySQL æ¥è¯´ï¼Œå‡¡æ˜¯å½¢å¦‚ limit offset, size çš„æŸ¥è¯¢ï¼Œæ‰«ææ¬¡æ•°çš„ä¸‹é™å°±æ˜¯ offset + sizeï¼Œæˆ‘ä»¬åªèƒ½å°½é‡é€¼è¿‘è¿™ä¸ªä¸‹é™ã€‚ ç”±äºåœ¨ä¸»é”®ç´¢å¼•ä¸Šçš„ä¼˜åŒ–æ¯”è¾ƒå¤æ‚ï¼ŒåŒæ ·çš„ SQL å¯¹äºä¸åŒçš„æ•°æ®è§„æ¨¡æ•ˆæœä¸ä¸€æ ·ï¼Œæš‚ä¸è®¨è®ºã€‚è¿™é‡Œä¸»è¦åˆ†æåœ¨äºŒçº§ç´¢å¼•ä¸Šçš„ä¼˜åŒ–ã€‚\nå¯¹äºæ‹¥æœ‰ 600 å¤šä¸‡æ¡æ•°æ®çš„ page è¡¨ï¼š\n1 2 3 4 5 6 7 8 9 10 -- åŸ SQL(å¼ºåˆ¶èµ°äºŒçº§ç´¢å¼•) select * from page force index(idx_name) order by name limit 6000000, 10; # 10 rows in set (4.833 sec) -- ä¼˜åŒ–æ–¹æ¡ˆä¸€ select t1.* from page t1, (select id from page order by name limit 6000000, 10) t2 where t1.id = t2.id order by t1.name; # 10 rows in set (0.746 sec) -- ä¼˜åŒ–æ–¹æ¡ˆäºŒ select t1.* from page t1 join (select id from page order by name limit 6000000, 10) t2 on t1.id = t2.id order by t1.name; # 10 rows in set (0.741 sec) é€šè¿‡ä½¿ç”¨åˆ©ç”¨äº†è¦†ç›–ç´¢å¼•çš„å­æŸ¥è¯¢ï¼Œæ€§èƒ½æå‡çº¦ 80%~90%ï¼š\nKeyset pagination 1 2 3 4 # First page (latest 10 items): SELECT ... WHERE ... ORDER BY id DESC LIMIT 10 # Next page (second 10): SELECT ... WHERE ... AND id \u0026lt; $left_off ORDER BY id DESC LIMIT 10 ä¸‰ã€ä¼˜åŒ–ä¸ºä»€ä¹ˆæœ‰æ•ˆ ä¼˜åŒ–å‰ è€ƒè™‘åŸå§‹ SQL select * from page force index(idx_name) order by name limit 6000000, 10 çš„æ‰§è¡Œè¿‡ç¨‹ï¼š\né¦–å…ˆ Sever å±‚å‘ InnoDB è¯·æ±‚ç¬¬ä¸€æ¡æ•°æ®ï¼›InnoDB ä» idx_name ä¸Šè·å–ç¬¬ä¸€æ¡äºŒçº§ç´¢å¼•è®°å½•ï¼Œç„¶åæŸ¥è¯¢èšç°‡ç´¢å¼•è·å–å®Œæ•´è®°å½•(å³å›è¡¨æ“ä½œ)ï¼Œè¿”å›ç»™ Server å±‚; ç”±äºå­˜åœ¨ limit 6000000 çš„é™åˆ¶, Server å±‚ä¼šå°†è¯¥æ•°æ®ä¸¢å¼ƒå¹¶è®¡æ•°ï¼Œç„¶åå‘ InnoDB è¯·æ±‚ä¸‹ä¸€æ¡æ•°æ®ï¼› ä¸Šè¿°æ“ä½œé‡å¤ 600 ä¸‡æ¬¡ï¼› ä¹‹åçš„ç¬¬ 6000001~6000010 10 æ¡æ•°æ®åˆ™ä¼šè¢«æ”¾å…¥æœ¬åœ°ç½‘ç»œç¼“å†²åŒºï¼Œå‘ç»™å®¢æˆ·ç«¯ï¼› é—®é¢˜åœ¨ç¬¬ 1 æ­¥çš„å›è¡¨æ“ä½œï¼š\nå›è¡¨é¦–å…ˆæ„å‘³ç€å…ˆè¯»ä¸€æ¬¡äºŒçº§ç´¢å¼•ï¼Œç„¶åè¯»ä¸€æ¬¡èšç°‡ç´¢å¼•ï¼Œå› æ­¤è®°å½•çš„æ‰«ææ€»æ•°å®é™…ä¼šæ˜¯ 2 * 600 ä¸‡æ¬¡=1200 ä¸‡æ¬¡ï¼› å…¶æ¬¡ï¼Œå›è¡¨æ“ä½œå¯èƒ½éœ€è¦ä¸€æ¬¡ç£ç›˜éšæœºè¯»ï¼› ä¼˜åŒ–å å†è€ƒè™‘ä¼˜åŒ–åçš„ SQL select t1.* from page t1 join (select id from page order by name limit 6000000, 10) t2 on t1.id = t2.id order by t1.name çš„æ‰§è¡Œè¿‡ç¨‹ï¼š\né¦–å…ˆ Sever å±‚å‘ InnoDB è¯·æ±‚ç¬¬ä¸€æ¡æ•°æ®ï¼›InnoDB ä» idx_name ä¸Šè·å–ç¬¬ä¸€æ¡äºŒçº§ç´¢å¼•è®°å½•ï¼Œç„¶åæŸ¥è¯¢èšç°‡ç´¢å¼•è·å–å®Œæ•´è®°å½•(è¿™ä¸€æ“ä½œå«å›è¡¨)ï¼Œç„¶åå°†ä¸»é”® ID è¿”å›ç»™ Server å±‚; ç”±äºå­˜åœ¨ limit 6000000 çš„é™åˆ¶, Server å±‚ä¼šå°†è¯¥æ•°æ®ä¸¢å¼ƒå¹¶è®¡æ•°ï¼Œç„¶åå‘ InnoDB è¯·æ±‚ä¸‹ä¸€æ¡æ•°æ®ï¼› ä¸Šè¿°æ“ä½œé‡å¤ 600 ä¸‡æ¬¡ï¼› ä¹‹åçš„ç¬¬ 6000001~6000010 10 æ¡æ•°æ®åˆ™ä¼šè¢«æ”¾å…¥å†…å­˜ç¼“å†²åŒºï¼› æŸ¥è¯¢èšç°‡ç´¢å¼•ï¼Œè·å– 10 ä¸ªä¸»é”® ID å¯¹åº”çš„å®Œæ•´è®°å½•ï¼› æ€»ç»“ åœ¨ä¼˜åŒ–åï¼š\nè®°å½•çš„æ€»æ‰«ææ¬¡æ•°ä» 1200 ä¸‡æ¬¡ å‡å°‘åˆ° 600 ä¸‡é›¶ 10 æ¬¡ï¼› ç£ç›˜éšæœºè¯»çš„æ¬¡æ•°ä» 600 ä¸‡æ¬¡ å‡å°‘åˆ° 10 æ¬¡ï¼› å››ã€è¯•éªŒæ–¹æ³• å»ºè¡¨å’Œæ•°æ®åˆå§‹åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 -- å»ºè¡¨ CREATE TABLE `page` ( `id` INT(11) NOT NULL AUTO_INCREMENT, `name` VARCHAR(16) DEFAULT NULL, `content` VARCHAR(255) DEFAULT NULL, PRIMARY KEY (`id`), KEY `idx_name` (`name`) ) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4; -- åˆ›å»ºå­˜å‚¨è¿‡ç¨‹ç”¨äºåˆå§‹åŒ–æ•°æ® DELIMITER ;; CREATE PROCEDURE init_page() BEGIN DECLARE i INT; SET i = 1; WHILE(i \u0026lt;= 6000010) DO INSERT INTO page (`name`, `content`) VALUES (CONCAT(\u0026#39;å°ç“¦\u0026#39;, i), CONCAT(\u0026#39;xx\u0026#39;, i)); SET i = i + 1; END WHILE; END;; DELIMITER ; -- è°ƒç”¨å­˜å‚¨è¿‡ç¨‹ CALL init_page(); å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿— 1 2 3 4 5 6 -- å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿— SET GLOBAL slow_query_log=1; -- å°†æ…¢æŸ¥è¯¢æ—¶é—´é˜ˆå€¼è®¾ç½®ä¸º 0.1 ç§’ SET GLOBAL long_query_time=0.1; -- æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—å SHOW VARIABLES LIKE \u0026#39;%slow_query%\u0026#39;; å¯¹æ¯” SQL 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 -- æ¢ç´¢ä¸€çº§ç´¢å¼• --- åŸºç¡€ SQL select * from page order by id limit 6000000, 10; --- æœ€æ…¢ select * from page where id \u0026gt;= (select id from page order by id limit 6000000, 1) order by id limit 10; --- æœ€å¿« select t1.* from page t1, (select id from page order by id limit 6000000, 10) t2 where t1.id = t2.id order by t1.id; -- æ¢ç´¢äºŒçº§ç´¢å¼• --- åŸºç¡€ SQLï¼Œä¼šæ˜¯å…¨è¡¨æ‰«æï¼Œæœ€æ…¢ select * from page order by name limit 6000000, 10; --- å¼ºåˆ¶èµ°äºŒçº§ç´¢å¼•ï¼Œç¨å¿« select * from page force index(idx_name) order by name limit 6000000, 10; --- åˆ©ç”¨ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•çš„å­æŸ¥è¯¢ï¼Œå‡å°‘å›è¡¨ï¼Œæœ€å¿« select t1.* from page t1, (select id from page order by name limit 6000000, 10) t2 where t1.id = t2.id order by t1.name; æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—å’Œæ•°æ®å­˜å‚¨ä½ç½® 1 2 3 4 5 6 # æŸ¥çœ‹ mysql è¿›ç¨‹å‚æ•° ps aux | grep mysql # /opt/homebrew/opt/mariadb/bin/mariadbd --basedir=/opt/homebrew/opt/mariadb --datadir=/opt/homebrew/var/mysql --plugin-dir=/opt/homebrew/opt/mariadb/lib/plugin --log-error=/opt/homebrew/var/mysql/zmz.local.err --pid-file=zmz.local.pid # --basedir=/opt/homebrew/opt/mariadb å³æ…¢æŸ¥è¯¢æ—¥å¿—å’Œæ•°æ®æ–‡ä»¶æ‰€åœ¨ç›®å½• # ps. æ‰§è¡Œå‰é¢çš„å­˜å‚¨è®¡åˆ’ï¼Œåˆ›å»º 100 ä¸‡æ¡æ•°æ®ï¼Œå ç”¨ç£ç›˜ç©ºé—´å¤§çº¦ 100MBï¼›åˆ›å»º 600 ä¸‡æ¡æ•°æ®ï¼Œå ç”¨ç©ºé—´å¤§çº¦ 600MBï¼› äº”ã€References mysqlæŸ¥è¯¢ limit 1000,10 å’Œlimit 10 é€Ÿåº¦ä¸€æ ·å¿«å—ï¼Ÿå¦‚æœæˆ‘è¦åˆ†é¡µï¼Œæˆ‘è¯¥æ€ä¹ˆåŠï¼Ÿ è¦æƒ³é€šè¿‡é¢è¯•ï¼ŒMySQLçš„Limitå­å¥åº•å±‚åŸç†ä½ ä¸å¯ä¸çŸ¥ MySQL Logical Architecture Mysql index configuration MySQL ORDER BY / LIMIT performance: late row lookups Late Row Lookups: InnoDB MySQL ORDER BY LIMIT Performance Optimization mysql è¯æ˜ä¸ºä»€ä¹ˆç”¨limitæ—¶ï¼Œoffsetå¾ˆå¤§ä¼šå½±å“æ€§èƒ½ MySQL 5.7 Reference Manual/LIMIT Query Optimization Pagination Optimization We need tool support for keyset pagination ","date":"2022-11-05T12:36:01+08:00","permalink":"https://zhumengzhu.github.io/2022/11/mysql-order-by-limit-performance-optimization/","title":"Mysql çš„æ·±åˆ†é¡µé—®é¢˜åŠä¼˜åŒ–æ–¹æ³•"},{"content":"å¸¸ç”¨å‘½ä»¤ hugo new site SITE_NAME ç”Ÿæˆé™æ€åšå®¢é¡¹ç›® hugo server å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨ï¼ŒåŠ ä¸Š -D å¯ä»¥æ¸²æŸ“ draft=true çš„æ–‡ç«  hugo new post/new-content.md åœ¨ post ä¸‹æ–°å»ºä¸€ç¯‡æ–‡ç«  hugo ç”Ÿæˆç«™ç‚¹é™æ€æ–‡ä»¶(public å’Œ resources ç›®å½•) hugo list drafts/expired/future åˆ—å‡ºè‰ç¨¿/è¿‡æœŸ/æœªæ¥çš„æ–‡ä»¶ è¸©å‘è®° ä½¿ç”¨ä¸»é¢˜ Event æ—¶, æ–‡ç« å¿…é¡»æ”¾åœ¨ content/**post**/ ç›®å½•ä¸‹, å¦åˆ™ Home é¡µä¸ä¼šå±•ç¤ºæ–‡ç« é“¾æ¥, æ–‡ç« å†…ä¹Ÿä¸ä¼šå±•ç¤ºç›®å½• ä½¿ç”¨ä¸»é¢˜ Zzo æ—¶, è¦åˆ›å»º Archive é¡µ(ç±»ä¼¼ Event ä¸­çš„ Home é¡µ), éœ€è¦åˆ›å»ºæ–‡ä»¶ content/archive/_index.md(å‚è€ƒ How to automatically generate archive page content #47) ä½¿ç”¨ä¸»é¢˜ Zzo æ—¶, åœ¨ GigHub Actions é…ç½®ä¸­å¿…é¡»å¯ç”¨ Hugo extended æ¨¡å¼, å¦åˆ™æ„å»ºä¼šå¤±è´¥(å‚è€ƒHugo setup) å‚è€ƒé“¾æ¥ Hugo å®˜æ–¹æ–‡æ¡£ Hugo ä»å…¥é—¨åˆ°ä¼šç”¨ Hugo æ­å»ºåšå®¢å®è·µ Hugo+Stack åšå®¢ä¿®æ”¹è®°å½• hugoå‡çº§ä¸hugo-theme-stackä¸»é¢˜ä¿®æ”¹ä¸æœ€åä¿®æ”¹æ—¶é—´é—®é¢˜ ","date":"2022-10-30T22:22:52+08:00","permalink":"https://zhumengzhu.github.io/2022/10/hugo-quick-start/","title":"Hugo é…ç½®è®°å½•"},{"content":"Mac å®¢æˆ·ç«¯ æ¨è V2rayU Terminal ä»£ç† 1 2 # .config/fish/config.fish alias all_proxy=\u0026#39;export http_proxy=http://127.0.0.1:1087;export https_proxy=http://127.0.0.1:1087;export ALL_PROXY=socks5://127.0.0.1:1080\u0026#39; git ssh ä»£ç† 1 2 3 4 # .ssh/config Host github.com User git ProxyCommand nc -v -x 127.0.0.1:1080 %h %p ","date":"2022-10-16T19:09:32+08:00","permalink":"https://zhumengzhu.github.io/2022/10/how-to-set-network-proxy/","title":"ä»£ç†è®¾ç½®"}]