<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="PromQL 参考：https://blog.csdn.net/han949417140/article/details/113513227\n官网：https://prometheus.io/docs/prometheus/latest/querying/basics/\nhttps://grafana.com/docs/grafana/v7.5/panels/queries/ https://prometheus.fuckcloudnative.io/di-san-zhang-prometheus/di-4-jie-cha-xun/basics https://github.com/google/re2/wiki/Syntax 基本概念 - 时间序列(time-series) - 样本 - time-series 是按照时间戳和值的序列顺序存放的，我们称之为向量(vector) - 每条 time-series 通过指标名称(metrics name)和一组标签集(labelset)命名 - 在time-series中的每一个点称为一个样本（sample），样本由以下三部分组成： - 指标(metric)：metric name和描述当前样本特征的labelsets; - 时间戳(timestamp)：一个精确到毫秒的时间戳; - 样本值(value)： 一个float64的浮点型数据表示当前样本的值。 - 指标(Metric) - 在形式上，所有的指标(Metric)都通过如下格式标示： - &lt;metric name&gt;{&lt;label name&gt;=&lt;label value&gt;, ...} - 指标的名称(metric name)可以反映被监控样本的含义（比如，http_request_total - 表示当前系统接收到的HTTP请求总量） - 标签(label)反映了当前样本的特征维度，通过这些维度Prometheus可以对样本数据进行过滤，聚合等 - 以__作为前缀的标签，是系统保留的关键字，只能在系统内部使用 - Metrics类型 - Prometheus定义了4种不同的指标类型(metric type)：Counter（计数器）、Gauge（仪表盘）、Histogram（直方图）、Summary（摘要） - Counter：只增不减的计数器 - Counter类型的指标其工作方式和计数器一样，只增不减（除非系统发生重置）。 - 常见的监控指标，如http_requests_total，node_cpu都是Counter类型的监控指标。 一般在定义Counter类型指标的名称时推荐使用_total作为后缀。 - //例如，通过rate()函数获取HTTP请求量的增长率： rate(http_requests_total[5m]) - //查询当前系统中，访问量前10的HTTP地址： topk(10, http_requests_total) - Gauge：可增可减的仪表盘 - 与Counter不同，Gauge类型的指标侧重于反应系统的当前状态。因此这类指标的样本数据可增可减。 - 常见指标如：node_memory_MemFree（主机当前空闲的内容大小）、node_memory_MemAvailable（可用内存大小）都是Gauge类型的监控指标。 - //通过Gauge指标，用户可以直接查看系统的当前状态：node_memory_MemFree - //还可以使用deriv()计算样本的线性回归模型，甚至是直接使用predict_linear()对数据的变化趋势进行预测。 - 例如，预测系统磁盘空间在4个小时之后的剩余情况：predict_linear(node_filesystem_free{job=&quot;node&quot;}[1h], 4 * 3600) - Histogram和Summary分析数据分布情况 Instant vector vs Range vector https://stackoverflow.com/questions/68223824/prometheus-instant-vector-vs-range-vector https://satyanash.net/software/2021/01/04/understanding-prometheus-range-vectors.html https://promlabs.com/blog/2020/06/18/the-anatomy-of-a-promql-query/ Rate then sum, never sum then rate https://www.robustperception.io/rate-then-sum-never-sum-then-rate/ To help keep you on the straight and narrow, remember this:\nThe only mathematical operations you can safely directly apply to a counter&rsquo;s values are rate, irate, increase, and resets. Anything else will cause you problems.\nThe problem of rate()/increase() extrapolation in Prometheus https://stackoverflow.com/questions/52697517/prometheus-how-to-rate-a-sum-of-the-same-counter-from-different-machines?rq=3 https://github.com/prometheus/prometheus/issues/3746 https://github.com/prometheus/prometheus/issues/3806 https://github.com/VictoriaMetrics/VictoriaMetrics/issues/1215 https://docs.google.com/document/d/1y2Mp041_2v0blnKnZk7keCnJZICeK2YWUQuXH_m4DVc/edit?pli=1&tab=t.0#heading=h.bupciudrwmna https://lotabout.me/2019/QQA-Why-Prometheus-increase-return-float/ (中文带图) Aggregating the precomputed quantiles from a summary makes no sense https://prometheus.io/docs/practices/histograms/#count-and-sum-of-observations avg(http_request_duration_seconds{quantile=&ldquo;0.95&rdquo;}) // BAD! histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) // GOOD.\nErrors of quantile estimation https://prometheus.io/docs/practices/histograms/#errors-of-quantile-estimation Quantiles, whether calculated client-side or server-side, are estimated. It is important to understand the errors of that estimation.\nContinuing the histogram example from above, imagine your usual request durations are almost all very close to 220ms, or in other words, if you could plot the &ldquo;true&rdquo; histogram, you would see a very sharp spike at 220ms. In the Prometheus histogram metric as configured above, almost all observations, and therefore also the 95th percentile, will fall into the bucket labeled {le=&ldquo;0.3&rdquo;}, i.e. the bucket from 200ms to 300ms. The histogram implementation guarantees that the true 95th percentile is somewhere between 200ms and 300ms. To return a single value (rather than an interval), it applies linear interpolation, which yields 295ms in this case. The calculated quantile gives you the impression that you are close to breaching the SLO, but in reality, the 95th percentile is a tiny bit above 220ms, a quite comfortable distance to your SLO.\nNext step in our thought experiment: A change in backend routing adds a fixed amount of 100ms to all request durations. Now the request duration has its sharp spike at 320ms and almost all observations will fall into the bucket from 300ms to 450ms. The 95th percentile is calculated to be 442.5ms, although the correct value is close to 320ms. While you are only a tiny bit outside of your SLO, the calculated 95th quantile looks much worse.\nBest practices https://grafana.com/docs/grafana/v7.5/best-practices/\nQueries Examples https://prometheus.io/docs/prometheus/2.39/querying/examples/\nPrometheus 的各种问题 http://www.xuyasong.com/?p=1921 https://aleiwu.com/post/prometheus-bp/ https://develotters.com/posts/high-cardinality/ 高基数问题(High-Cardinality Problem) 2.16 版本以上的 Prometheus 直接支持查看 TSDB 的状态：\nCounter 重置导致的问题 Counter 是四种 Metrics 类型中的一种，它的值只会增加(incr)或者重置(reset, 一般是因为实例重启)。\nPromQL 的 rate()和increase() 函数会自动处理 Counter 重置的情况，但 sum 不会，所以很多文档都强调一定要先 rate 再 sum，而不能先 sum 再 rate。\nrate/increase 是如何处理 counter 重置的？ 具体的处理代码为：\n1 2 3 4 5 6 7 8 9 // Handle counter resets: resultFloat = samples.Floats[numSamplesMinusOne].F - samples.Floats[0].F prevValue := samples.Floats[0].F for _, currPoint := range samples.Floats[1:] { if currPoint.F &lt; prevValue { resultFloat += prevValue } prevValue = currPoint.F } 首先遍历样本，如果发现 Counter 减少就认为发生了重置，后续所有样本值都会加上重置前的值。\n举个栗子，假设时间序列的值为[5,10,4,6]，那么它会被处理为[5,10,14,16]。\nPrometheus 报警不准问题 https://aleiwu.com/post/prometheus-alert-why/ 报警不准，指的是两类问题： 『该报』的警没报； 『不该报』的警报了； 这里的『该报』和『不该报』都是基于 Grafana 进行判断的。所以这里说报警不准，本质是 Grafana 的仪表盘展示结果和 Prometheus 告警不一致。 这个问题本质是『采样间隔』不一致的：\nPrometheus 的告警器会按固定的时间间隔采样，在一个周期内，如果样本满足告警规则； Grafana 渲染图标的结果，则取决于基于 Range Query 采样点的分布； 很可能出现，Prometheus 采样时捕获了『低谷』但 Grafana 忽略了『低谷』导致『不该报』的警报了，或者 Prometheus 忽略了『低谷』而 Grafana 捕获了『低谷』导致『该报』的警没报。\nPrometheus: Alertmanager 架构图 为什么要 Alertmanager？ 当 Prometheus Server 计算出一些警报后，它自己并没有能力将这些警报通知出去，只能将警报推给 Alertmanager，由 Alertmanager 进行发送。\n这个切分，一方面是出于单一职责的考虑，让 Prometheus “do one thing and do it well”, 另一方面则是因为警报发送确实不是一件”简单”的事，需要一个专门的系统来做好它。\n可以这么说，Alertmanager 的目标不是简单地”发出警报”，而是”发出高质量的警报”。它提供的高级功能包括但不限于：\nGo Template 渲染警报内容； 管理警报的重复提醒时机与消除后消除通知的发送； 根据标签定义警报路由，实现警报的优先级、接收人划分，并针对不同的优先级和接收人定制不同的发送策略； 将同类型警报打包成一条通知发送出去，降低警报通知的频率； 支持静默规则: 用户可以定义一条静默规则，在一段时间内停止发送部分特定的警报，比如已经确认是搜索集群问题，在修复搜索集群时，先静默掉搜索集群相关警报； 支持”抑制”规则(Inhibition Rule): 用户可以定义一条”抑制”规则，规定在某种警报发生时，不发送另一种警报，比如在”A 机房网络故障”这条警报发生时，不发送所有”A 机房中的警报”； Routing Tree Routing Tree 的设计意图是让用户能够非常自由地给警报归类，然后根据归类后的类别来配置要发送给谁以及怎么发送：\n发送给谁？上面已经做了很好的示例，’数据库警报’和’前端警报’都有特定的接收组，都没有匹配上那么就是’默认警报’, 发送给默认接收组 怎么发送？对于一类警报，有个多个字段来配置发送行为： group_by：决定了警报怎么分组，每个 group 只会定时产生一次通知，这就达到了降噪的效果，而不同的警报类别分组方式显然是不一样的，举个例子： 配置中的 ‘数据库警报’ 是按 ‘集群’ 和 ‘规则名’ 分组的，这表明对于数据库警报，我们关心的是“哪个集群的哪个规则出问题了”，比如一个时间段内，’华东’集群产生了10条 ‘API响应时间过长’ 警报，- 这些警报就会聚合在一个通知里发出来； 配置中的 ‘前端警报’ 是按 ‘产品’ 和 ‘环境’ 分组的， 这表明对于前端警报，我们关心的是“哪个产品的哪个环境出问题了” group_interval 和 group_wait: 控制分组的细节，不细谈，其中 group_interval 控制了这个分组最快多久执行一次 Notification Pipeline repeat_interval: 假如一个相同的警报一直 FIRING，Alertmanager 并不会一直发送警报，而会等待一段时间，这个等待时间就是 repeat_interval，显然，不同类型警报的发送频率也是不一样的 Notification Pipeline 要重点说的是DedupStage和NotifySetStage它俩协同负责去重工作，具体做法是：\nNotifySetStage 会为发送成功的警报记录一条发送通知，key 是’接收组名字’+’GroupKey 的 key 值’，value 是当前 Stage 收到的 []Alert (这个列表和最开始进入 Notification Pipeline 的警报列表有可能是不同的，因为其中有些 Alert 可能在前置 Stage 中已经被过滤掉了) DedupStage 中会以’接收组名字’+’GroupKey 的 key 值’为 key 查询通知记录，假如： 查询无结果，那么这条通知没发过，为这组警报发送一条通知； 查询有结果，那么查询得到已经发送过的一组警报 S，判断当前的这组警报 A 是否为 S 的子集： 假如 A 是 S 的子集，那么表明 A 和 S 重复，这时候要根据 repeat_interval 来决定是否再次发送： 距离 S 的发送时间已经过去了足够久（repeat_interval)，那么我们要再发送一遍； 距离 S 的发送时间还没有达到 repeat_interval，那么为了降低警报频率，触发去重逻辑，这次我们就不发了； 假如 A 不是 S 的子集，那么 A 和 S 不重复，需要再发送一次； 上面的表述可能有些抽象，最后表现出来的结果是： 假如一个 AlertGroup 里的警报一直发生变化，那么虽然每次都是新警报，不会被去重，但是由于 group_interval （假设是5分钟）存在，这个 AlertGroup 最多 5 分钟触发一次 Notification Pipeline，因此最多也只会 5 分钟发送一条通知； 假如一个 AlertGroup 里的警报一直不变化，就是那么几条一直 FIRING 着，那么虽然每个 group_interval 都会触发 Notification Pipeline，但是由于 repeate_interval（假设是1小时）存在，因此最多也只会每 1 小时为这个重复的警报发送一条通知； 再说一下 Silence 和 Inhibit，两者都是基于用户主动定义的规则的： Silence Rule：静默规则用来关闭掉部分警报的通知，比如某个性能问题已经修复了，但需要排期上线，那么在上线前就可以把对应的警报静默掉来减少噪音； Inhibit Rule：抑制规则用于在某类警报发生时，抑制掉另一类警报，比如某个机房宕机了，那么会影响所有上层服务，产生级联的警报洪流，反而会掩盖掉根本原因，这时候抑制规则就有用了； 因此 Notification Pipeline 的设计意图就很明确了：通过一系列逻辑（如抑制、静默、去重）来获得更高的警报质量，由于警报质量的维度很多（剔除重复、类似的警报，静默暂时无用的警报，抑制级联警报），因此 Notification Pipeline 设计成了责任链模式，以便于随时添加新的环节来优化警报质量 Prometheus存储机制 http://www.xuyasong.com/?p=1601 深入 PromQL Bascis https://stackoverflow.com/questions/68223824/prometheus-instant-vector-vs-range-vector https://satyanash.net/software/2021/01/04/understanding-prometheus-range-vectors.html https://promlabs.com/blog/2020/06/18/the-anatomy-of-a-promql-query/ Prometheus Querying - Breaking Down PromQL Functions Rate &amp; Increase https://promlabs.com/blog/2021/01/29/how-exactly-does-promql-calculate-rates/ https://stackoverflow.com/questions/54494394/do-i-understand-prometheuss-rate-vs-increase-functions-correctly?rq=3 https://stackoverflow.com/questions/48218950/increase-in-prometheus-sometimes-doubles-values-how-to-avoid?rq=3 https://stackoverflow.com/questions/52697517/prometheus-how-to-rate-a-sum-of-the-same-counter-from-different-machines https://github.com/VictoriaMetrics/VictoriaMetrics/issues/1215 https://stackoverflow.com/questions/70835778/understanding-increase-and-rate-used-on-http-server-requests-seconds-count-w 由于 prometheus 使用了线性插值算法取计算 increase(增量)，所以计算结果会得到小数，这一点特别容易让人误解。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 // === rate(node parser.ValueTypeMatrix) Vector === func funcRate(vals []parser.Value, args parser.Expressions, enh *EvalNodeHelper) Vector { return extrapolatedRate(vals, args, enh, true, true) } // === increase(node parser.ValueTypeMatrix) Vector === func funcIncrease(vals []parser.Value, args parser.Expressions, enh *EvalNodeHelper) Vector { return extrapolatedRate(vals, args, enh, true, false) } // extrapolatedRate is a utility function for rate/increase/delta. // It calculates the rate (allowing for counter resets if isCounter is true), // extrapolates if the first/last sample is close to the boundary, and returns // the result as either per-second (if isRate is true) or overall. func extrapolatedRate(vals []parser.Value, args parser.Expressions, enh *EvalNodeHelper, isCounter, isRate bool) Vector { ms := args[0].(*parser.MatrixSelector) vs := ms.VectorSelector.(*parser.VectorSelector) var ( samples = vals[0].(Matrix)[0] rangeStart = enh.Ts - durationMilliseconds(ms.Range+vs.Offset) rangeEnd = enh.Ts - durationMilliseconds(vs.Offset) resultFloat float64 resultHistogram *histogram.FloatHistogram firstT, lastT int64 numSamplesMinusOne int ) // We need either at least two Histograms and no Floats, or at least two // Floats and no Histograms to calculate a rate. Otherwise, drop this // Vector element. if len(samples.Histograms) &gt; 0 &amp;&amp; len(samples.Floats) &gt; 0 { // Mix of histograms and floats. TODO(beorn7): Communicate this failure reason. return enh.Out } switch { case len(samples.Histograms) &gt; 1: numSamplesMinusOne = len(samples.Histograms) - 1 firstT = samples.Histograms[0].T lastT = samples.Histograms[numSamplesMinusOne].T resultHistogram = histogramRate(samples.Histograms, isCounter) if resultHistogram == nil { // The histograms are not compatible with each other. // TODO(beorn7): Communicate this failure reason. return enh.Out } case len(samples.Floats) &gt; 1: numSamplesMinusOne = len(samples.Floats) - 1 firstT = samples.Floats[0].T lastT = samples.Floats[numSamplesMinusOne].T resultFloat = samples.Floats[numSamplesMinusOne].F - samples.Floats[0].F if !isCounter { break } // Handle counter resets: prevValue := samples.Floats[0].F for _, currPoint := range samples.Floats[1:] { if currPoint.F &lt; prevValue { resultFloat += prevValue } prevValue = currPoint.F } default: // Not enough samples. TODO(beorn7): Communicate this failure reason. return enh.Out } // Duration between first/last samples and boundary of range. durationToStart := float64(firstT-rangeStart) / 1000 durationToEnd := float64(rangeEnd-lastT) / 1000 sampledInterval := float64(lastT-firstT) / 1000 averageDurationBetweenSamples := sampledInterval / float64(numSamplesMinusOne) // TODO(beorn7): Do this for histograms, too. if isCounter &amp;&amp; resultFloat &gt; 0 &amp;&amp; len(samples.Floats) &gt; 0 &amp;&amp; samples.Floats[0].F &gt;= 0 { // Counters cannot be negative. If we have any slope at all // (i.e. resultFloat went up), we can extrapolate the zero point // of the counter. If the duration to the zero point is shorter // than the durationToStart, we take the zero point as the start // of the series, thereby avoiding extrapolation to negative // counter values. durationToZero := sampledInterval * (samples.Floats[0].F / resultFloat) if durationToZero &lt; durationToStart { durationToStart = durationToZero } } // If the first/last samples are close to the boundaries of the range, // extrapolate the result. This is as we expect that another sample // will exist given the spacing between samples we&#39;ve seen thus far, // with an allowance for noise. extrapolationThreshold := averageDurationBetweenSamples * 1.1 extrapolateToInterval := sampledInterval if durationToStart &lt; extrapolationThreshold { extrapolateToInterval += durationToStart } else { extrapolateToInterval += averageDurationBetweenSamples / 2 } if durationToEnd &lt; extrapolationThreshold { extrapolateToInterval += durationToEnd } else { extrapolateToInterval += averageDurationBetweenSamples / 2 } factor := extrapolateToInterval / sampledInterval if isRate { factor /= ms.Range.Seconds() } if resultHistogram == nil { resultFloat *= factor } else { resultHistogram.Mul(factor) } return append(enh.Out, Sample{F: resultFloat, H: resultHistogram}) } histogramQuantitle 用法示例：\n1 TBD 源码见：\nhttps://github.com/prometheus/prometheus/blob/caa173d2aac4c390546b1f78302104b1ccae0878/promql/functions.go#L615 https://github.com/prometheus/prometheus/blob/caa173d2aac4c390546b1f78302104b1ccae0878/promql/quantile.go#L73 核心算法是：bucketStart + (bucketEnd-bucketStart)*(rank/count)。 同样也是线性插值算法，比较好理解。唯一需要注意的是，在 histogram_quantile 的第二个参数是 sum(rate, &hellip;)，这个是 QPS(count/time) 而不是直接用的 count，为什么？计算公式里最后一项是 rank/count，而 rank = q*count，两者相除 time 项会被消除，相当于还是 count&rsquo; / count，也就是结果是等价的。既然结果等价，为什么要用 rate 而不直接用 count？因为 rate 函数可以使用处理 reset，直接用 count 不行。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 // === histogram_quantile(k parser.ValueTypeScalar, Vector parser.ValueTypeVector) Vector === func funcHistogramQuantile(vals []parser.Value, args parser.Expressions, enh *EvalNodeHelper) Vector { q := vals[0].(Vector)[0].F inVec := vals[1].(Vector) if enh.signatureToMetricWithBuckets == nil { enh.signatureToMetricWithBuckets = map[string]*metricWithBuckets{} } else { for _, v := range enh.signatureToMetricWithBuckets { v.buckets = v.buckets[:0] } } var histogramSamples []Sample for _, sample := range inVec { // We are only looking for conventional buckets here. Remember // the histograms for later treatment. if sample.H != nil { histogramSamples = append(histogramSamples, sample) continue } upperBound, err := strconv.ParseFloat( sample.Metric.Get(model.BucketLabel), 64, ) if err != nil { // Oops, no bucket label or malformed label value. Skip. // TODO(beorn7): Issue a warning somehow. continue } enh.lblBuf = sample.Metric.BytesWithoutLabels(enh.lblBuf, labels.BucketLabel) mb, ok := enh.signatureToMetricWithBuckets[string(enh.lblBuf)] if !ok { sample.Metric = labels.NewBuilder(sample.Metric). Del(excludedLabels...). Labels() mb = &amp;metricWithBuckets{sample.Metric, nil} enh.signatureToMetricWithBuckets[string(enh.lblBuf)] = mb } mb.buckets = append(mb.buckets, bucket{upperBound, sample.F}) } // Now deal with the histograms. for _, sample := range histogramSamples { // We have to reconstruct the exact same signature as above for // a conventional histogram, just ignoring any le label. enh.lblBuf = sample.Metric.Bytes(enh.lblBuf) if mb, ok := enh.signatureToMetricWithBuckets[string(enh.lblBuf)]; ok &amp;&amp; len(mb.buckets) &gt; 0 { // At this data point, we have conventional histogram // buckets and a native histogram with the same name and // labels. Do not evaluate anything. // TODO(beorn7): Issue a warning somehow. delete(enh.signatureToMetricWithBuckets, string(enh.lblBuf)) continue } enh.Out = append(enh.Out, Sample{ Metric: enh.DropMetricName(sample.Metric), F: histogramQuantile(q, sample.H), }) } for _, mb := range enh.signatureToMetricWithBuckets { if len(mb.buckets) &gt; 0 { enh.Out = append(enh.Out, Sample{ Metric: mb.metric, F: bucketQuantile(q, mb.buckets), }) } } return enh.Out } // bucketQuantile calculates the quantile &#39;q&#39; based on the given buckets. The // buckets will be sorted by upperBound by this function (i.e. no sorting // needed before calling this function). The quantile value is interpolated // assuming a linear distribution within a bucket. However, if the quantile // falls into the highest bucket, the upper bound of the 2nd highest bucket is // returned. A natural lower bound of 0 is assumed if the upper bound of the // lowest bucket is greater 0. In that case, interpolation in the lowest bucket // happens linearly between 0 and the upper bound of the lowest bucket. // However, if the lowest bucket has an upper bound less or equal 0, this upper // bound is returned if the quantile falls into the lowest bucket. // // There are a number of special cases (once we have a way to report errors // happening during evaluations of AST functions, we should report those // explicitly): // // If &#39;buckets&#39; has 0 observations, NaN is returned. // // If &#39;buckets&#39; has fewer than 2 elements, NaN is returned. // // If the highest bucket is not +Inf, NaN is returned. // // If q==NaN, NaN is returned. // // If q&lt;0, -Inf is returned. // // If q&gt;1, +Inf is returned. func bucketQuantile(q float64, buckets buckets) float64 { if math.IsNaN(q) { return math.NaN() } if q &lt; 0 { return math.Inf(-1) } if q &gt; 1 { return math.Inf(+1) } slices.SortFunc(buckets, func(a, b bucket) bool { return a.upperBound &lt; b.upperBound }) if !math.IsInf(buckets[len(buckets)-1].upperBound, +1) { return math.NaN() } buckets = coalesceBuckets(buckets) ensureMonotonic(buckets) if len(buckets) &lt; 2 { return math.NaN() } observations := buckets[len(buckets)-1].count if observations == 0 { return math.NaN() } rank := q * observations b := sort.Search(len(buckets)-1, func(i int) bool { return buckets[i].count &gt;= rank }) if b == len(buckets)-1 { return buckets[len(buckets)-2].upperBound } if b == 0 &amp;&amp; buckets[0].upperBound &lt;= 0 { return buckets[0].upperBound } var ( bucketStart float64 bucketEnd = buckets[b].upperBound count = buckets[b].count ) if b &gt; 0 { bucketStart = buckets[b-1].upperBound count -= buckets[b-1].count rank -= buckets[b-1].count } return bucketStart + (bucketEnd-bucketStart)*(rank/count) } 相关资料\nhttps://stackoverflow.com/questions/55162093/understanding-histogram-quantile-based-on-rate-in-prometheus https://stackoverflow.com/questions/60962520/how-to-get-the-quantile-of-rate-in-prometheus/65418483#65418483 可以在 prometheus 项目下执行下面的单测：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 func TestBucketQuantile__rate5m(t *testing.T) { q := 0.4 myBuckets := buckets{ {10, 5}, {20, 8}, {30, 12}, {40, 15}, {math.Inf(1), 15}, } f := bucketQuantile(q, myBuckets) println(&#34;==== before rate =====&#34;) fmt.Println(myBuckets) fmt.Printf(&#34;%.2f\\n&#34;, f) for i, myBucket := range myBuckets { myBuckets[i].count = myBucket.count / float64(5*60) } println(&#34;==== after rate =====&#34;) fmt.Println(myBuckets) f1 := bucketQuantile(q, myBuckets) fmt.Printf(&#34;%.2f\\n&#34;, f1) } ">
<meta name="keywords" content="Prometheus, Grafana"><title>Prometheus &amp; Grafana 学习记录</title>

<link rel='canonical' href='https://zhumengzhu.github.io/2022/10/prometheus-and-grafana-learning-notes/'>

<link rel="stylesheet" href="/scss/style.min.6446795889a0bfe2ea25aab66389947bb9b57419e0370d7fa9eeb9c5bd4d30f4.css"><meta property='og:title' content="Prometheus & Grafana 学习记录">
<meta property='og:description' content="PromQL 参考：https://blog.csdn.net/han949417140/article/details/113513227\n官网：https://prometheus.io/docs/prometheus/latest/querying/basics/\nhttps://grafana.com/docs/grafana/v7.5/panels/queries/ https://prometheus.fuckcloudnative.io/di-san-zhang-prometheus/di-4-jie-cha-xun/basics https://github.com/google/re2/wiki/Syntax 基本概念 - 时间序列(time-series) - 样本 - time-series 是按照时间戳和值的序列顺序存放的，我们称之为向量(vector) - 每条 time-series 通过指标名称(metrics name)和一组标签集(labelset)命名 - 在time-series中的每一个点称为一个样本（sample），样本由以下三部分组成： - 指标(metric)：metric name和描述当前样本特征的labelsets; - 时间戳(timestamp)：一个精确到毫秒的时间戳; - 样本值(value)： 一个float64的浮点型数据表示当前样本的值。 - 指标(Metric) - 在形式上，所有的指标(Metric)都通过如下格式标示： - &lt;metric name&gt;{&lt;label name&gt;=&lt;label value&gt;, ...} - 指标的名称(metric name)可以反映被监控样本的含义（比如，http_request_total - 表示当前系统接收到的HTTP请求总量） - 标签(label)反映了当前样本的特征维度，通过这些维度Prometheus可以对样本数据进行过滤，聚合等 - 以__作为前缀的标签，是系统保留的关键字，只能在系统内部使用 - Metrics类型 - Prometheus定义了4种不同的指标类型(metric type)：Counter（计数器）、Gauge（仪表盘）、Histogram（直方图）、Summary（摘要） - Counter：只增不减的计数器 - Counter类型的指标其工作方式和计数器一样，只增不减（除非系统发生重置）。 - 常见的监控指标，如http_requests_total，node_cpu都是Counter类型的监控指标。 一般在定义Counter类型指标的名称时推荐使用_total作为后缀。 - //例如，通过rate()函数获取HTTP请求量的增长率： rate(http_requests_total[5m]) - //查询当前系统中，访问量前10的HTTP地址： topk(10, http_requests_total) - Gauge：可增可减的仪表盘 - 与Counter不同，Gauge类型的指标侧重于反应系统的当前状态。因此这类指标的样本数据可增可减。 - 常见指标如：node_memory_MemFree（主机当前空闲的内容大小）、node_memory_MemAvailable（可用内存大小）都是Gauge类型的监控指标。 - //通过Gauge指标，用户可以直接查看系统的当前状态：node_memory_MemFree - //还可以使用deriv()计算样本的线性回归模型，甚至是直接使用predict_linear()对数据的变化趋势进行预测。 - 例如，预测系统磁盘空间在4个小时之后的剩余情况：predict_linear(node_filesystem_free{job=&quot;node&quot;}[1h], 4 * 3600) - Histogram和Summary分析数据分布情况 Instant vector vs Range vector https://stackoverflow.com/questions/68223824/prometheus-instant-vector-vs-range-vector https://satyanash.net/software/2021/01/04/understanding-prometheus-range-vectors.html https://promlabs.com/blog/2020/06/18/the-anatomy-of-a-promql-query/ Rate then sum, never sum then rate https://www.robustperception.io/rate-then-sum-never-sum-then-rate/ To help keep you on the straight and narrow, remember this:\nThe only mathematical operations you can safely directly apply to a counter&rsquo;s values are rate, irate, increase, and resets. Anything else will cause you problems.\nThe problem of rate()/increase() extrapolation in Prometheus https://stackoverflow.com/questions/52697517/prometheus-how-to-rate-a-sum-of-the-same-counter-from-different-machines?rq=3 https://github.com/prometheus/prometheus/issues/3746 https://github.com/prometheus/prometheus/issues/3806 https://github.com/VictoriaMetrics/VictoriaMetrics/issues/1215 https://docs.google.com/document/d/1y2Mp041_2v0blnKnZk7keCnJZICeK2YWUQuXH_m4DVc/edit?pli=1&tab=t.0#heading=h.bupciudrwmna https://lotabout.me/2019/QQA-Why-Prometheus-increase-return-float/ (中文带图) Aggregating the precomputed quantiles from a summary makes no sense https://prometheus.io/docs/practices/histograms/#count-and-sum-of-observations avg(http_request_duration_seconds{quantile=&ldquo;0.95&rdquo;}) // BAD! histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) // GOOD.\nErrors of quantile estimation https://prometheus.io/docs/practices/histograms/#errors-of-quantile-estimation Quantiles, whether calculated client-side or server-side, are estimated. It is important to understand the errors of that estimation.\nContinuing the histogram example from above, imagine your usual request durations are almost all very close to 220ms, or in other words, if you could plot the &ldquo;true&rdquo; histogram, you would see a very sharp spike at 220ms. In the Prometheus histogram metric as configured above, almost all observations, and therefore also the 95th percentile, will fall into the bucket labeled {le=&ldquo;0.3&rdquo;}, i.e. the bucket from 200ms to 300ms. The histogram implementation guarantees that the true 95th percentile is somewhere between 200ms and 300ms. To return a single value (rather than an interval), it applies linear interpolation, which yields 295ms in this case. The calculated quantile gives you the impression that you are close to breaching the SLO, but in reality, the 95th percentile is a tiny bit above 220ms, a quite comfortable distance to your SLO.\nNext step in our thought experiment: A change in backend routing adds a fixed amount of 100ms to all request durations. Now the request duration has its sharp spike at 320ms and almost all observations will fall into the bucket from 300ms to 450ms. The 95th percentile is calculated to be 442.5ms, although the correct value is close to 320ms. While you are only a tiny bit outside of your SLO, the calculated 95th quantile looks much worse.\nBest practices https://grafana.com/docs/grafana/v7.5/best-practices/\nQueries Examples https://prometheus.io/docs/prometheus/2.39/querying/examples/\nPrometheus 的各种问题 http://www.xuyasong.com/?p=1921 https://aleiwu.com/post/prometheus-bp/ https://develotters.com/posts/high-cardinality/ 高基数问题(High-Cardinality Problem) 2.16 版本以上的 Prometheus 直接支持查看 TSDB 的状态：\nCounter 重置导致的问题 Counter 是四种 Metrics 类型中的一种，它的值只会增加(incr)或者重置(reset, 一般是因为实例重启)。\nPromQL 的 rate()和increase() 函数会自动处理 Counter 重置的情况，但 sum 不会，所以很多文档都强调一定要先 rate 再 sum，而不能先 sum 再 rate。\nrate/increase 是如何处理 counter 重置的？ 具体的处理代码为：\n1 2 3 4 5 6 7 8 9 // Handle counter resets: resultFloat = samples.Floats[numSamplesMinusOne].F - samples.Floats[0].F prevValue := samples.Floats[0].F for _, currPoint := range samples.Floats[1:] { if currPoint.F &lt; prevValue { resultFloat += prevValue } prevValue = currPoint.F } 首先遍历样本，如果发现 Counter 减少就认为发生了重置，后续所有样本值都会加上重置前的值。\n举个栗子，假设时间序列的值为[5,10,4,6]，那么它会被处理为[5,10,14,16]。\nPrometheus 报警不准问题 https://aleiwu.com/post/prometheus-alert-why/ 报警不准，指的是两类问题： 『该报』的警没报； 『不该报』的警报了； 这里的『该报』和『不该报』都是基于 Grafana 进行判断的。所以这里说报警不准，本质是 Grafana 的仪表盘展示结果和 Prometheus 告警不一致。 这个问题本质是『采样间隔』不一致的：\nPrometheus 的告警器会按固定的时间间隔采样，在一个周期内，如果样本满足告警规则； Grafana 渲染图标的结果，则取决于基于 Range Query 采样点的分布； 很可能出现，Prometheus 采样时捕获了『低谷』但 Grafana 忽略了『低谷』导致『不该报』的警报了，或者 Prometheus 忽略了『低谷』而 Grafana 捕获了『低谷』导致『该报』的警没报。\nPrometheus: Alertmanager 架构图 为什么要 Alertmanager？ 当 Prometheus Server 计算出一些警报后，它自己并没有能力将这些警报通知出去，只能将警报推给 Alertmanager，由 Alertmanager 进行发送。\n这个切分，一方面是出于单一职责的考虑，让 Prometheus “do one thing and do it well”, 另一方面则是因为警报发送确实不是一件”简单”的事，需要一个专门的系统来做好它。\n可以这么说，Alertmanager 的目标不是简单地”发出警报”，而是”发出高质量的警报”。它提供的高级功能包括但不限于：\nGo Template 渲染警报内容； 管理警报的重复提醒时机与消除后消除通知的发送； 根据标签定义警报路由，实现警报的优先级、接收人划分，并针对不同的优先级和接收人定制不同的发送策略； 将同类型警报打包成一条通知发送出去，降低警报通知的频率； 支持静默规则: 用户可以定义一条静默规则，在一段时间内停止发送部分特定的警报，比如已经确认是搜索集群问题，在修复搜索集群时，先静默掉搜索集群相关警报； 支持”抑制”规则(Inhibition Rule): 用户可以定义一条”抑制”规则，规定在某种警报发生时，不发送另一种警报，比如在”A 机房网络故障”这条警报发生时，不发送所有”A 机房中的警报”； Routing Tree Routing Tree 的设计意图是让用户能够非常自由地给警报归类，然后根据归类后的类别来配置要发送给谁以及怎么发送：\n发送给谁？上面已经做了很好的示例，’数据库警报’和’前端警报’都有特定的接收组，都没有匹配上那么就是’默认警报’, 发送给默认接收组 怎么发送？对于一类警报，有个多个字段来配置发送行为： group_by：决定了警报怎么分组，每个 group 只会定时产生一次通知，这就达到了降噪的效果，而不同的警报类别分组方式显然是不一样的，举个例子： 配置中的 ‘数据库警报’ 是按 ‘集群’ 和 ‘规则名’ 分组的，这表明对于数据库警报，我们关心的是“哪个集群的哪个规则出问题了”，比如一个时间段内，’华东’集群产生了10条 ‘API响应时间过长’ 警报，- 这些警报就会聚合在一个通知里发出来； 配置中的 ‘前端警报’ 是按 ‘产品’ 和 ‘环境’ 分组的， 这表明对于前端警报，我们关心的是“哪个产品的哪个环境出问题了” group_interval 和 group_wait: 控制分组的细节，不细谈，其中 group_interval 控制了这个分组最快多久执行一次 Notification Pipeline repeat_interval: 假如一个相同的警报一直 FIRING，Alertmanager 并不会一直发送警报，而会等待一段时间，这个等待时间就是 repeat_interval，显然，不同类型警报的发送频率也是不一样的 Notification Pipeline 要重点说的是DedupStage和NotifySetStage它俩协同负责去重工作，具体做法是：\nNotifySetStage 会为发送成功的警报记录一条发送通知，key 是’接收组名字’+’GroupKey 的 key 值’，value 是当前 Stage 收到的 []Alert (这个列表和最开始进入 Notification Pipeline 的警报列表有可能是不同的，因为其中有些 Alert 可能在前置 Stage 中已经被过滤掉了) DedupStage 中会以’接收组名字’+’GroupKey 的 key 值’为 key 查询通知记录，假如： 查询无结果，那么这条通知没发过，为这组警报发送一条通知； 查询有结果，那么查询得到已经发送过的一组警报 S，判断当前的这组警报 A 是否为 S 的子集： 假如 A 是 S 的子集，那么表明 A 和 S 重复，这时候要根据 repeat_interval 来决定是否再次发送： 距离 S 的发送时间已经过去了足够久（repeat_interval)，那么我们要再发送一遍； 距离 S 的发送时间还没有达到 repeat_interval，那么为了降低警报频率，触发去重逻辑，这次我们就不发了； 假如 A 不是 S 的子集，那么 A 和 S 不重复，需要再发送一次； 上面的表述可能有些抽象，最后表现出来的结果是： 假如一个 AlertGroup 里的警报一直发生变化，那么虽然每次都是新警报，不会被去重，但是由于 group_interval （假设是5分钟）存在，这个 AlertGroup 最多 5 分钟触发一次 Notification Pipeline，因此最多也只会 5 分钟发送一条通知； 假如一个 AlertGroup 里的警报一直不变化，就是那么几条一直 FIRING 着，那么虽然每个 group_interval 都会触发 Notification Pipeline，但是由于 repeate_interval（假设是1小时）存在，因此最多也只会每 1 小时为这个重复的警报发送一条通知； 再说一下 Silence 和 Inhibit，两者都是基于用户主动定义的规则的： Silence Rule：静默规则用来关闭掉部分警报的通知，比如某个性能问题已经修复了，但需要排期上线，那么在上线前就可以把对应的警报静默掉来减少噪音； Inhibit Rule：抑制规则用于在某类警报发生时，抑制掉另一类警报，比如某个机房宕机了，那么会影响所有上层服务，产生级联的警报洪流，反而会掩盖掉根本原因，这时候抑制规则就有用了； 因此 Notification Pipeline 的设计意图就很明确了：通过一系列逻辑（如抑制、静默、去重）来获得更高的警报质量，由于警报质量的维度很多（剔除重复、类似的警报，静默暂时无用的警报，抑制级联警报），因此 Notification Pipeline 设计成了责任链模式，以便于随时添加新的环节来优化警报质量 Prometheus存储机制 http://www.xuyasong.com/?p=1601 深入 PromQL Bascis https://stackoverflow.com/questions/68223824/prometheus-instant-vector-vs-range-vector https://satyanash.net/software/2021/01/04/understanding-prometheus-range-vectors.html https://promlabs.com/blog/2020/06/18/the-anatomy-of-a-promql-query/ Prometheus Querying - Breaking Down PromQL Functions Rate &amp; Increase https://promlabs.com/blog/2021/01/29/how-exactly-does-promql-calculate-rates/ https://stackoverflow.com/questions/54494394/do-i-understand-prometheuss-rate-vs-increase-functions-correctly?rq=3 https://stackoverflow.com/questions/48218950/increase-in-prometheus-sometimes-doubles-values-how-to-avoid?rq=3 https://stackoverflow.com/questions/52697517/prometheus-how-to-rate-a-sum-of-the-same-counter-from-different-machines https://github.com/VictoriaMetrics/VictoriaMetrics/issues/1215 https://stackoverflow.com/questions/70835778/understanding-increase-and-rate-used-on-http-server-requests-seconds-count-w 由于 prometheus 使用了线性插值算法取计算 increase(增量)，所以计算结果会得到小数，这一点特别容易让人误解。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 // === rate(node parser.ValueTypeMatrix) Vector === func funcRate(vals []parser.Value, args parser.Expressions, enh *EvalNodeHelper) Vector { return extrapolatedRate(vals, args, enh, true, true) } // === increase(node parser.ValueTypeMatrix) Vector === func funcIncrease(vals []parser.Value, args parser.Expressions, enh *EvalNodeHelper) Vector { return extrapolatedRate(vals, args, enh, true, false) } // extrapolatedRate is a utility function for rate/increase/delta. // It calculates the rate (allowing for counter resets if isCounter is true), // extrapolates if the first/last sample is close to the boundary, and returns // the result as either per-second (if isRate is true) or overall. func extrapolatedRate(vals []parser.Value, args parser.Expressions, enh *EvalNodeHelper, isCounter, isRate bool) Vector { ms := args[0].(*parser.MatrixSelector) vs := ms.VectorSelector.(*parser.VectorSelector) var ( samples = vals[0].(Matrix)[0] rangeStart = enh.Ts - durationMilliseconds(ms.Range+vs.Offset) rangeEnd = enh.Ts - durationMilliseconds(vs.Offset) resultFloat float64 resultHistogram *histogram.FloatHistogram firstT, lastT int64 numSamplesMinusOne int ) // We need either at least two Histograms and no Floats, or at least two // Floats and no Histograms to calculate a rate. Otherwise, drop this // Vector element. if len(samples.Histograms) &gt; 0 &amp;&amp; len(samples.Floats) &gt; 0 { // Mix of histograms and floats. TODO(beorn7): Communicate this failure reason. return enh.Out } switch { case len(samples.Histograms) &gt; 1: numSamplesMinusOne = len(samples.Histograms) - 1 firstT = samples.Histograms[0].T lastT = samples.Histograms[numSamplesMinusOne].T resultHistogram = histogramRate(samples.Histograms, isCounter) if resultHistogram == nil { // The histograms are not compatible with each other. // TODO(beorn7): Communicate this failure reason. return enh.Out } case len(samples.Floats) &gt; 1: numSamplesMinusOne = len(samples.Floats) - 1 firstT = samples.Floats[0].T lastT = samples.Floats[numSamplesMinusOne].T resultFloat = samples.Floats[numSamplesMinusOne].F - samples.Floats[0].F if !isCounter { break } // Handle counter resets: prevValue := samples.Floats[0].F for _, currPoint := range samples.Floats[1:] { if currPoint.F &lt; prevValue { resultFloat += prevValue } prevValue = currPoint.F } default: // Not enough samples. TODO(beorn7): Communicate this failure reason. return enh.Out } // Duration between first/last samples and boundary of range. durationToStart := float64(firstT-rangeStart) / 1000 durationToEnd := float64(rangeEnd-lastT) / 1000 sampledInterval := float64(lastT-firstT) / 1000 averageDurationBetweenSamples := sampledInterval / float64(numSamplesMinusOne) // TODO(beorn7): Do this for histograms, too. if isCounter &amp;&amp; resultFloat &gt; 0 &amp;&amp; len(samples.Floats) &gt; 0 &amp;&amp; samples.Floats[0].F &gt;= 0 { // Counters cannot be negative. If we have any slope at all // (i.e. resultFloat went up), we can extrapolate the zero point // of the counter. If the duration to the zero point is shorter // than the durationToStart, we take the zero point as the start // of the series, thereby avoiding extrapolation to negative // counter values. durationToZero := sampledInterval * (samples.Floats[0].F / resultFloat) if durationToZero &lt; durationToStart { durationToStart = durationToZero } } // If the first/last samples are close to the boundaries of the range, // extrapolate the result. This is as we expect that another sample // will exist given the spacing between samples we&#39;ve seen thus far, // with an allowance for noise. extrapolationThreshold := averageDurationBetweenSamples * 1.1 extrapolateToInterval := sampledInterval if durationToStart &lt; extrapolationThreshold { extrapolateToInterval += durationToStart } else { extrapolateToInterval += averageDurationBetweenSamples / 2 } if durationToEnd &lt; extrapolationThreshold { extrapolateToInterval += durationToEnd } else { extrapolateToInterval += averageDurationBetweenSamples / 2 } factor := extrapolateToInterval / sampledInterval if isRate { factor /= ms.Range.Seconds() } if resultHistogram == nil { resultFloat *= factor } else { resultHistogram.Mul(factor) } return append(enh.Out, Sample{F: resultFloat, H: resultHistogram}) } histogramQuantitle 用法示例：\n1 TBD 源码见：\nhttps://github.com/prometheus/prometheus/blob/caa173d2aac4c390546b1f78302104b1ccae0878/promql/functions.go#L615 https://github.com/prometheus/prometheus/blob/caa173d2aac4c390546b1f78302104b1ccae0878/promql/quantile.go#L73 核心算法是：bucketStart + (bucketEnd-bucketStart)*(rank/count)。 同样也是线性插值算法，比较好理解。唯一需要注意的是，在 histogram_quantile 的第二个参数是 sum(rate, &hellip;)，这个是 QPS(count/time) 而不是直接用的 count，为什么？计算公式里最后一项是 rank/count，而 rank = q*count，两者相除 time 项会被消除，相当于还是 count&rsquo; / count，也就是结果是等价的。既然结果等价，为什么要用 rate 而不直接用 count？因为 rate 函数可以使用处理 reset，直接用 count 不行。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 // === histogram_quantile(k parser.ValueTypeScalar, Vector parser.ValueTypeVector) Vector === func funcHistogramQuantile(vals []parser.Value, args parser.Expressions, enh *EvalNodeHelper) Vector { q := vals[0].(Vector)[0].F inVec := vals[1].(Vector) if enh.signatureToMetricWithBuckets == nil { enh.signatureToMetricWithBuckets = map[string]*metricWithBuckets{} } else { for _, v := range enh.signatureToMetricWithBuckets { v.buckets = v.buckets[:0] } } var histogramSamples []Sample for _, sample := range inVec { // We are only looking for conventional buckets here. Remember // the histograms for later treatment. if sample.H != nil { histogramSamples = append(histogramSamples, sample) continue } upperBound, err := strconv.ParseFloat( sample.Metric.Get(model.BucketLabel), 64, ) if err != nil { // Oops, no bucket label or malformed label value. Skip. // TODO(beorn7): Issue a warning somehow. continue } enh.lblBuf = sample.Metric.BytesWithoutLabels(enh.lblBuf, labels.BucketLabel) mb, ok := enh.signatureToMetricWithBuckets[string(enh.lblBuf)] if !ok { sample.Metric = labels.NewBuilder(sample.Metric). Del(excludedLabels...). Labels() mb = &amp;metricWithBuckets{sample.Metric, nil} enh.signatureToMetricWithBuckets[string(enh.lblBuf)] = mb } mb.buckets = append(mb.buckets, bucket{upperBound, sample.F}) } // Now deal with the histograms. for _, sample := range histogramSamples { // We have to reconstruct the exact same signature as above for // a conventional histogram, just ignoring any le label. enh.lblBuf = sample.Metric.Bytes(enh.lblBuf) if mb, ok := enh.signatureToMetricWithBuckets[string(enh.lblBuf)]; ok &amp;&amp; len(mb.buckets) &gt; 0 { // At this data point, we have conventional histogram // buckets and a native histogram with the same name and // labels. Do not evaluate anything. // TODO(beorn7): Issue a warning somehow. delete(enh.signatureToMetricWithBuckets, string(enh.lblBuf)) continue } enh.Out = append(enh.Out, Sample{ Metric: enh.DropMetricName(sample.Metric), F: histogramQuantile(q, sample.H), }) } for _, mb := range enh.signatureToMetricWithBuckets { if len(mb.buckets) &gt; 0 { enh.Out = append(enh.Out, Sample{ Metric: mb.metric, F: bucketQuantile(q, mb.buckets), }) } } return enh.Out } // bucketQuantile calculates the quantile &#39;q&#39; based on the given buckets. The // buckets will be sorted by upperBound by this function (i.e. no sorting // needed before calling this function). The quantile value is interpolated // assuming a linear distribution within a bucket. However, if the quantile // falls into the highest bucket, the upper bound of the 2nd highest bucket is // returned. A natural lower bound of 0 is assumed if the upper bound of the // lowest bucket is greater 0. In that case, interpolation in the lowest bucket // happens linearly between 0 and the upper bound of the lowest bucket. // However, if the lowest bucket has an upper bound less or equal 0, this upper // bound is returned if the quantile falls into the lowest bucket. // // There are a number of special cases (once we have a way to report errors // happening during evaluations of AST functions, we should report those // explicitly): // // If &#39;buckets&#39; has 0 observations, NaN is returned. // // If &#39;buckets&#39; has fewer than 2 elements, NaN is returned. // // If the highest bucket is not +Inf, NaN is returned. // // If q==NaN, NaN is returned. // // If q&lt;0, -Inf is returned. // // If q&gt;1, +Inf is returned. func bucketQuantile(q float64, buckets buckets) float64 { if math.IsNaN(q) { return math.NaN() } if q &lt; 0 { return math.Inf(-1) } if q &gt; 1 { return math.Inf(+1) } slices.SortFunc(buckets, func(a, b bucket) bool { return a.upperBound &lt; b.upperBound }) if !math.IsInf(buckets[len(buckets)-1].upperBound, +1) { return math.NaN() } buckets = coalesceBuckets(buckets) ensureMonotonic(buckets) if len(buckets) &lt; 2 { return math.NaN() } observations := buckets[len(buckets)-1].count if observations == 0 { return math.NaN() } rank := q * observations b := sort.Search(len(buckets)-1, func(i int) bool { return buckets[i].count &gt;= rank }) if b == len(buckets)-1 { return buckets[len(buckets)-2].upperBound } if b == 0 &amp;&amp; buckets[0].upperBound &lt;= 0 { return buckets[0].upperBound } var ( bucketStart float64 bucketEnd = buckets[b].upperBound count = buckets[b].count ) if b &gt; 0 { bucketStart = buckets[b-1].upperBound count -= buckets[b-1].count rank -= buckets[b-1].count } return bucketStart + (bucketEnd-bucketStart)*(rank/count) } 相关资料\nhttps://stackoverflow.com/questions/55162093/understanding-histogram-quantile-based-on-rate-in-prometheus https://stackoverflow.com/questions/60962520/how-to-get-the-quantile-of-rate-in-prometheus/65418483#65418483 可以在 prometheus 项目下执行下面的单测：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 func TestBucketQuantile__rate5m(t *testing.T) { q := 0.4 myBuckets := buckets{ {10, 5}, {20, 8}, {30, 12}, {40, 15}, {math.Inf(1), 15}, } f := bucketQuantile(q, myBuckets) println(&#34;==== before rate =====&#34;) fmt.Println(myBuckets) fmt.Printf(&#34;%.2f\\n&#34;, f) for i, myBucket := range myBuckets { myBuckets[i].count = myBucket.count / float64(5*60) } println(&#34;==== after rate =====&#34;) fmt.Println(myBuckets) f1 := bucketQuantile(q, myBuckets) fmt.Printf(&#34;%.2f\\n&#34;, f1) } ">
<meta property='og:url' content='https://zhumengzhu.github.io/2022/10/prometheus-and-grafana-learning-notes/'>
<meta property='og:site_name' content='Somnus'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='Prometheus' /><meta property='article:tag' content='Grafana' /><meta property='article:published_time' content='2022-10-11T22:09:19&#43;08:00'/><meta property='article:modified_time' content='2024-12-10T22:09:19&#43;08:00'/>
<meta name="twitter:site" content="@@zhumengzhu">
    <meta name="twitter:creator" content="@@zhumengzhu"><meta name="twitter:title" content="Prometheus & Grafana 学习记录">
<meta name="twitter:description" content="PromQL 参考：https://blog.csdn.net/han949417140/article/details/113513227\n官网：https://prometheus.io/docs/prometheus/latest/querying/basics/\nhttps://grafana.com/docs/grafana/v7.5/panels/queries/ https://prometheus.fuckcloudnative.io/di-san-zhang-prometheus/di-4-jie-cha-xun/basics https://github.com/google/re2/wiki/Syntax 基本概念 - 时间序列(time-series) - 样本 - time-series 是按照时间戳和值的序列顺序存放的，我们称之为向量(vector) - 每条 time-series 通过指标名称(metrics name)和一组标签集(labelset)命名 - 在time-series中的每一个点称为一个样本（sample），样本由以下三部分组成： - 指标(metric)：metric name和描述当前样本特征的labelsets; - 时间戳(timestamp)：一个精确到毫秒的时间戳; - 样本值(value)： 一个float64的浮点型数据表示当前样本的值。 - 指标(Metric) - 在形式上，所有的指标(Metric)都通过如下格式标示： - &lt;metric name&gt;{&lt;label name&gt;=&lt;label value&gt;, ...} - 指标的名称(metric name)可以反映被监控样本的含义（比如，http_request_total - 表示当前系统接收到的HTTP请求总量） - 标签(label)反映了当前样本的特征维度，通过这些维度Prometheus可以对样本数据进行过滤，聚合等 - 以__作为前缀的标签，是系统保留的关键字，只能在系统内部使用 - Metrics类型 - Prometheus定义了4种不同的指标类型(metric type)：Counter（计数器）、Gauge（仪表盘）、Histogram（直方图）、Summary（摘要） - Counter：只增不减的计数器 - Counter类型的指标其工作方式和计数器一样，只增不减（除非系统发生重置）。 - 常见的监控指标，如http_requests_total，node_cpu都是Counter类型的监控指标。 一般在定义Counter类型指标的名称时推荐使用_total作为后缀。 - //例如，通过rate()函数获取HTTP请求量的增长率： rate(http_requests_total[5m]) - //查询当前系统中，访问量前10的HTTP地址： topk(10, http_requests_total) - Gauge：可增可减的仪表盘 - 与Counter不同，Gauge类型的指标侧重于反应系统的当前状态。因此这类指标的样本数据可增可减。 - 常见指标如：node_memory_MemFree（主机当前空闲的内容大小）、node_memory_MemAvailable（可用内存大小）都是Gauge类型的监控指标。 - //通过Gauge指标，用户可以直接查看系统的当前状态：node_memory_MemFree - //还可以使用deriv()计算样本的线性回归模型，甚至是直接使用predict_linear()对数据的变化趋势进行预测。 - 例如，预测系统磁盘空间在4个小时之后的剩余情况：predict_linear(node_filesystem_free{job=&quot;node&quot;}[1h], 4 * 3600) - Histogram和Summary分析数据分布情况 Instant vector vs Range vector https://stackoverflow.com/questions/68223824/prometheus-instant-vector-vs-range-vector https://satyanash.net/software/2021/01/04/understanding-prometheus-range-vectors.html https://promlabs.com/blog/2020/06/18/the-anatomy-of-a-promql-query/ Rate then sum, never sum then rate https://www.robustperception.io/rate-then-sum-never-sum-then-rate/ To help keep you on the straight and narrow, remember this:\nThe only mathematical operations you can safely directly apply to a counter&rsquo;s values are rate, irate, increase, and resets. Anything else will cause you problems.\nThe problem of rate()/increase() extrapolation in Prometheus https://stackoverflow.com/questions/52697517/prometheus-how-to-rate-a-sum-of-the-same-counter-from-different-machines?rq=3 https://github.com/prometheus/prometheus/issues/3746 https://github.com/prometheus/prometheus/issues/3806 https://github.com/VictoriaMetrics/VictoriaMetrics/issues/1215 https://docs.google.com/document/d/1y2Mp041_2v0blnKnZk7keCnJZICeK2YWUQuXH_m4DVc/edit?pli=1&tab=t.0#heading=h.bupciudrwmna https://lotabout.me/2019/QQA-Why-Prometheus-increase-return-float/ (中文带图) Aggregating the precomputed quantiles from a summary makes no sense https://prometheus.io/docs/practices/histograms/#count-and-sum-of-observations avg(http_request_duration_seconds{quantile=&ldquo;0.95&rdquo;}) // BAD! histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) // GOOD.\nErrors of quantile estimation https://prometheus.io/docs/practices/histograms/#errors-of-quantile-estimation Quantiles, whether calculated client-side or server-side, are estimated. It is important to understand the errors of that estimation.\nContinuing the histogram example from above, imagine your usual request durations are almost all very close to 220ms, or in other words, if you could plot the &ldquo;true&rdquo; histogram, you would see a very sharp spike at 220ms. In the Prometheus histogram metric as configured above, almost all observations, and therefore also the 95th percentile, will fall into the bucket labeled {le=&ldquo;0.3&rdquo;}, i.e. the bucket from 200ms to 300ms. The histogram implementation guarantees that the true 95th percentile is somewhere between 200ms and 300ms. To return a single value (rather than an interval), it applies linear interpolation, which yields 295ms in this case. The calculated quantile gives you the impression that you are close to breaching the SLO, but in reality, the 95th percentile is a tiny bit above 220ms, a quite comfortable distance to your SLO.\nNext step in our thought experiment: A change in backend routing adds a fixed amount of 100ms to all request durations. Now the request duration has its sharp spike at 320ms and almost all observations will fall into the bucket from 300ms to 450ms. The 95th percentile is calculated to be 442.5ms, although the correct value is close to 320ms. While you are only a tiny bit outside of your SLO, the calculated 95th quantile looks much worse.\nBest practices https://grafana.com/docs/grafana/v7.5/best-practices/\nQueries Examples https://prometheus.io/docs/prometheus/2.39/querying/examples/\nPrometheus 的各种问题 http://www.xuyasong.com/?p=1921 https://aleiwu.com/post/prometheus-bp/ https://develotters.com/posts/high-cardinality/ 高基数问题(High-Cardinality Problem) 2.16 版本以上的 Prometheus 直接支持查看 TSDB 的状态：\nCounter 重置导致的问题 Counter 是四种 Metrics 类型中的一种，它的值只会增加(incr)或者重置(reset, 一般是因为实例重启)。\nPromQL 的 rate()和increase() 函数会自动处理 Counter 重置的情况，但 sum 不会，所以很多文档都强调一定要先 rate 再 sum，而不能先 sum 再 rate。\nrate/increase 是如何处理 counter 重置的？ 具体的处理代码为：\n1 2 3 4 5 6 7 8 9 // Handle counter resets: resultFloat = samples.Floats[numSamplesMinusOne].F - samples.Floats[0].F prevValue := samples.Floats[0].F for _, currPoint := range samples.Floats[1:] { if currPoint.F &lt; prevValue { resultFloat += prevValue } prevValue = currPoint.F } 首先遍历样本，如果发现 Counter 减少就认为发生了重置，后续所有样本值都会加上重置前的值。\n举个栗子，假设时间序列的值为[5,10,4,6]，那么它会被处理为[5,10,14,16]。\nPrometheus 报警不准问题 https://aleiwu.com/post/prometheus-alert-why/ 报警不准，指的是两类问题： 『该报』的警没报； 『不该报』的警报了； 这里的『该报』和『不该报』都是基于 Grafana 进行判断的。所以这里说报警不准，本质是 Grafana 的仪表盘展示结果和 Prometheus 告警不一致。 这个问题本质是『采样间隔』不一致的：\nPrometheus 的告警器会按固定的时间间隔采样，在一个周期内，如果样本满足告警规则； Grafana 渲染图标的结果，则取决于基于 Range Query 采样点的分布； 很可能出现，Prometheus 采样时捕获了『低谷』但 Grafana 忽略了『低谷』导致『不该报』的警报了，或者 Prometheus 忽略了『低谷』而 Grafana 捕获了『低谷』导致『该报』的警没报。\nPrometheus: Alertmanager 架构图 为什么要 Alertmanager？ 当 Prometheus Server 计算出一些警报后，它自己并没有能力将这些警报通知出去，只能将警报推给 Alertmanager，由 Alertmanager 进行发送。\n这个切分，一方面是出于单一职责的考虑，让 Prometheus “do one thing and do it well”, 另一方面则是因为警报发送确实不是一件”简单”的事，需要一个专门的系统来做好它。\n可以这么说，Alertmanager 的目标不是简单地”发出警报”，而是”发出高质量的警报”。它提供的高级功能包括但不限于：\nGo Template 渲染警报内容； 管理警报的重复提醒时机与消除后消除通知的发送； 根据标签定义警报路由，实现警报的优先级、接收人划分，并针对不同的优先级和接收人定制不同的发送策略； 将同类型警报打包成一条通知发送出去，降低警报通知的频率； 支持静默规则: 用户可以定义一条静默规则，在一段时间内停止发送部分特定的警报，比如已经确认是搜索集群问题，在修复搜索集群时，先静默掉搜索集群相关警报； 支持”抑制”规则(Inhibition Rule): 用户可以定义一条”抑制”规则，规定在某种警报发生时，不发送另一种警报，比如在”A 机房网络故障”这条警报发生时，不发送所有”A 机房中的警报”； Routing Tree Routing Tree 的设计意图是让用户能够非常自由地给警报归类，然后根据归类后的类别来配置要发送给谁以及怎么发送：\n发送给谁？上面已经做了很好的示例，’数据库警报’和’前端警报’都有特定的接收组，都没有匹配上那么就是’默认警报’, 发送给默认接收组 怎么发送？对于一类警报，有个多个字段来配置发送行为： group_by：决定了警报怎么分组，每个 group 只会定时产生一次通知，这就达到了降噪的效果，而不同的警报类别分组方式显然是不一样的，举个例子： 配置中的 ‘数据库警报’ 是按 ‘集群’ 和 ‘规则名’ 分组的，这表明对于数据库警报，我们关心的是“哪个集群的哪个规则出问题了”，比如一个时间段内，’华东’集群产生了10条 ‘API响应时间过长’ 警报，- 这些警报就会聚合在一个通知里发出来； 配置中的 ‘前端警报’ 是按 ‘产品’ 和 ‘环境’ 分组的， 这表明对于前端警报，我们关心的是“哪个产品的哪个环境出问题了” group_interval 和 group_wait: 控制分组的细节，不细谈，其中 group_interval 控制了这个分组最快多久执行一次 Notification Pipeline repeat_interval: 假如一个相同的警报一直 FIRING，Alertmanager 并不会一直发送警报，而会等待一段时间，这个等待时间就是 repeat_interval，显然，不同类型警报的发送频率也是不一样的 Notification Pipeline 要重点说的是DedupStage和NotifySetStage它俩协同负责去重工作，具体做法是：\nNotifySetStage 会为发送成功的警报记录一条发送通知，key 是’接收组名字’+’GroupKey 的 key 值’，value 是当前 Stage 收到的 []Alert (这个列表和最开始进入 Notification Pipeline 的警报列表有可能是不同的，因为其中有些 Alert 可能在前置 Stage 中已经被过滤掉了) DedupStage 中会以’接收组名字’+’GroupKey 的 key 值’为 key 查询通知记录，假如： 查询无结果，那么这条通知没发过，为这组警报发送一条通知； 查询有结果，那么查询得到已经发送过的一组警报 S，判断当前的这组警报 A 是否为 S 的子集： 假如 A 是 S 的子集，那么表明 A 和 S 重复，这时候要根据 repeat_interval 来决定是否再次发送： 距离 S 的发送时间已经过去了足够久（repeat_interval)，那么我们要再发送一遍； 距离 S 的发送时间还没有达到 repeat_interval，那么为了降低警报频率，触发去重逻辑，这次我们就不发了； 假如 A 不是 S 的子集，那么 A 和 S 不重复，需要再发送一次； 上面的表述可能有些抽象，最后表现出来的结果是： 假如一个 AlertGroup 里的警报一直发生变化，那么虽然每次都是新警报，不会被去重，但是由于 group_interval （假设是5分钟）存在，这个 AlertGroup 最多 5 分钟触发一次 Notification Pipeline，因此最多也只会 5 分钟发送一条通知； 假如一个 AlertGroup 里的警报一直不变化，就是那么几条一直 FIRING 着，那么虽然每个 group_interval 都会触发 Notification Pipeline，但是由于 repeate_interval（假设是1小时）存在，因此最多也只会每 1 小时为这个重复的警报发送一条通知； 再说一下 Silence 和 Inhibit，两者都是基于用户主动定义的规则的： Silence Rule：静默规则用来关闭掉部分警报的通知，比如某个性能问题已经修复了，但需要排期上线，那么在上线前就可以把对应的警报静默掉来减少噪音； Inhibit Rule：抑制规则用于在某类警报发生时，抑制掉另一类警报，比如某个机房宕机了，那么会影响所有上层服务，产生级联的警报洪流，反而会掩盖掉根本原因，这时候抑制规则就有用了； 因此 Notification Pipeline 的设计意图就很明确了：通过一系列逻辑（如抑制、静默、去重）来获得更高的警报质量，由于警报质量的维度很多（剔除重复、类似的警报，静默暂时无用的警报，抑制级联警报），因此 Notification Pipeline 设计成了责任链模式，以便于随时添加新的环节来优化警报质量 Prometheus存储机制 http://www.xuyasong.com/?p=1601 深入 PromQL Bascis https://stackoverflow.com/questions/68223824/prometheus-instant-vector-vs-range-vector https://satyanash.net/software/2021/01/04/understanding-prometheus-range-vectors.html https://promlabs.com/blog/2020/06/18/the-anatomy-of-a-promql-query/ Prometheus Querying - Breaking Down PromQL Functions Rate &amp; Increase https://promlabs.com/blog/2021/01/29/how-exactly-does-promql-calculate-rates/ https://stackoverflow.com/questions/54494394/do-i-understand-prometheuss-rate-vs-increase-functions-correctly?rq=3 https://stackoverflow.com/questions/48218950/increase-in-prometheus-sometimes-doubles-values-how-to-avoid?rq=3 https://stackoverflow.com/questions/52697517/prometheus-how-to-rate-a-sum-of-the-same-counter-from-different-machines https://github.com/VictoriaMetrics/VictoriaMetrics/issues/1215 https://stackoverflow.com/questions/70835778/understanding-increase-and-rate-used-on-http-server-requests-seconds-count-w 由于 prometheus 使用了线性插值算法取计算 increase(增量)，所以计算结果会得到小数，这一点特别容易让人误解。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 // === rate(node parser.ValueTypeMatrix) Vector === func funcRate(vals []parser.Value, args parser.Expressions, enh *EvalNodeHelper) Vector { return extrapolatedRate(vals, args, enh, true, true) } // === increase(node parser.ValueTypeMatrix) Vector === func funcIncrease(vals []parser.Value, args parser.Expressions, enh *EvalNodeHelper) Vector { return extrapolatedRate(vals, args, enh, true, false) } // extrapolatedRate is a utility function for rate/increase/delta. // It calculates the rate (allowing for counter resets if isCounter is true), // extrapolates if the first/last sample is close to the boundary, and returns // the result as either per-second (if isRate is true) or overall. func extrapolatedRate(vals []parser.Value, args parser.Expressions, enh *EvalNodeHelper, isCounter, isRate bool) Vector { ms := args[0].(*parser.MatrixSelector) vs := ms.VectorSelector.(*parser.VectorSelector) var ( samples = vals[0].(Matrix)[0] rangeStart = enh.Ts - durationMilliseconds(ms.Range+vs.Offset) rangeEnd = enh.Ts - durationMilliseconds(vs.Offset) resultFloat float64 resultHistogram *histogram.FloatHistogram firstT, lastT int64 numSamplesMinusOne int ) // We need either at least two Histograms and no Floats, or at least two // Floats and no Histograms to calculate a rate. Otherwise, drop this // Vector element. if len(samples.Histograms) &gt; 0 &amp;&amp; len(samples.Floats) &gt; 0 { // Mix of histograms and floats. TODO(beorn7): Communicate this failure reason. return enh.Out } switch { case len(samples.Histograms) &gt; 1: numSamplesMinusOne = len(samples.Histograms) - 1 firstT = samples.Histograms[0].T lastT = samples.Histograms[numSamplesMinusOne].T resultHistogram = histogramRate(samples.Histograms, isCounter) if resultHistogram == nil { // The histograms are not compatible with each other. // TODO(beorn7): Communicate this failure reason. return enh.Out } case len(samples.Floats) &gt; 1: numSamplesMinusOne = len(samples.Floats) - 1 firstT = samples.Floats[0].T lastT = samples.Floats[numSamplesMinusOne].T resultFloat = samples.Floats[numSamplesMinusOne].F - samples.Floats[0].F if !isCounter { break } // Handle counter resets: prevValue := samples.Floats[0].F for _, currPoint := range samples.Floats[1:] { if currPoint.F &lt; prevValue { resultFloat += prevValue } prevValue = currPoint.F } default: // Not enough samples. TODO(beorn7): Communicate this failure reason. return enh.Out } // Duration between first/last samples and boundary of range. durationToStart := float64(firstT-rangeStart) / 1000 durationToEnd := float64(rangeEnd-lastT) / 1000 sampledInterval := float64(lastT-firstT) / 1000 averageDurationBetweenSamples := sampledInterval / float64(numSamplesMinusOne) // TODO(beorn7): Do this for histograms, too. if isCounter &amp;&amp; resultFloat &gt; 0 &amp;&amp; len(samples.Floats) &gt; 0 &amp;&amp; samples.Floats[0].F &gt;= 0 { // Counters cannot be negative. If we have any slope at all // (i.e. resultFloat went up), we can extrapolate the zero point // of the counter. If the duration to the zero point is shorter // than the durationToStart, we take the zero point as the start // of the series, thereby avoiding extrapolation to negative // counter values. durationToZero := sampledInterval * (samples.Floats[0].F / resultFloat) if durationToZero &lt; durationToStart { durationToStart = durationToZero } } // If the first/last samples are close to the boundaries of the range, // extrapolate the result. This is as we expect that another sample // will exist given the spacing between samples we&#39;ve seen thus far, // with an allowance for noise. extrapolationThreshold := averageDurationBetweenSamples * 1.1 extrapolateToInterval := sampledInterval if durationToStart &lt; extrapolationThreshold { extrapolateToInterval += durationToStart } else { extrapolateToInterval += averageDurationBetweenSamples / 2 } if durationToEnd &lt; extrapolationThreshold { extrapolateToInterval += durationToEnd } else { extrapolateToInterval += averageDurationBetweenSamples / 2 } factor := extrapolateToInterval / sampledInterval if isRate { factor /= ms.Range.Seconds() } if resultHistogram == nil { resultFloat *= factor } else { resultHistogram.Mul(factor) } return append(enh.Out, Sample{F: resultFloat, H: resultHistogram}) } histogramQuantitle 用法示例：\n1 TBD 源码见：\nhttps://github.com/prometheus/prometheus/blob/caa173d2aac4c390546b1f78302104b1ccae0878/promql/functions.go#L615 https://github.com/prometheus/prometheus/blob/caa173d2aac4c390546b1f78302104b1ccae0878/promql/quantile.go#L73 核心算法是：bucketStart + (bucketEnd-bucketStart)*(rank/count)。 同样也是线性插值算法，比较好理解。唯一需要注意的是，在 histogram_quantile 的第二个参数是 sum(rate, &hellip;)，这个是 QPS(count/time) 而不是直接用的 count，为什么？计算公式里最后一项是 rank/count，而 rank = q*count，两者相除 time 项会被消除，相当于还是 count&rsquo; / count，也就是结果是等价的。既然结果等价，为什么要用 rate 而不直接用 count？因为 rate 函数可以使用处理 reset，直接用 count 不行。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 // === histogram_quantile(k parser.ValueTypeScalar, Vector parser.ValueTypeVector) Vector === func funcHistogramQuantile(vals []parser.Value, args parser.Expressions, enh *EvalNodeHelper) Vector { q := vals[0].(Vector)[0].F inVec := vals[1].(Vector) if enh.signatureToMetricWithBuckets == nil { enh.signatureToMetricWithBuckets = map[string]*metricWithBuckets{} } else { for _, v := range enh.signatureToMetricWithBuckets { v.buckets = v.buckets[:0] } } var histogramSamples []Sample for _, sample := range inVec { // We are only looking for conventional buckets here. Remember // the histograms for later treatment. if sample.H != nil { histogramSamples = append(histogramSamples, sample) continue } upperBound, err := strconv.ParseFloat( sample.Metric.Get(model.BucketLabel), 64, ) if err != nil { // Oops, no bucket label or malformed label value. Skip. // TODO(beorn7): Issue a warning somehow. continue } enh.lblBuf = sample.Metric.BytesWithoutLabels(enh.lblBuf, labels.BucketLabel) mb, ok := enh.signatureToMetricWithBuckets[string(enh.lblBuf)] if !ok { sample.Metric = labels.NewBuilder(sample.Metric). Del(excludedLabels...). Labels() mb = &amp;metricWithBuckets{sample.Metric, nil} enh.signatureToMetricWithBuckets[string(enh.lblBuf)] = mb } mb.buckets = append(mb.buckets, bucket{upperBound, sample.F}) } // Now deal with the histograms. for _, sample := range histogramSamples { // We have to reconstruct the exact same signature as above for // a conventional histogram, just ignoring any le label. enh.lblBuf = sample.Metric.Bytes(enh.lblBuf) if mb, ok := enh.signatureToMetricWithBuckets[string(enh.lblBuf)]; ok &amp;&amp; len(mb.buckets) &gt; 0 { // At this data point, we have conventional histogram // buckets and a native histogram with the same name and // labels. Do not evaluate anything. // TODO(beorn7): Issue a warning somehow. delete(enh.signatureToMetricWithBuckets, string(enh.lblBuf)) continue } enh.Out = append(enh.Out, Sample{ Metric: enh.DropMetricName(sample.Metric), F: histogramQuantile(q, sample.H), }) } for _, mb := range enh.signatureToMetricWithBuckets { if len(mb.buckets) &gt; 0 { enh.Out = append(enh.Out, Sample{ Metric: mb.metric, F: bucketQuantile(q, mb.buckets), }) } } return enh.Out } // bucketQuantile calculates the quantile &#39;q&#39; based on the given buckets. The // buckets will be sorted by upperBound by this function (i.e. no sorting // needed before calling this function). The quantile value is interpolated // assuming a linear distribution within a bucket. However, if the quantile // falls into the highest bucket, the upper bound of the 2nd highest bucket is // returned. A natural lower bound of 0 is assumed if the upper bound of the // lowest bucket is greater 0. In that case, interpolation in the lowest bucket // happens linearly between 0 and the upper bound of the lowest bucket. // However, if the lowest bucket has an upper bound less or equal 0, this upper // bound is returned if the quantile falls into the lowest bucket. // // There are a number of special cases (once we have a way to report errors // happening during evaluations of AST functions, we should report those // explicitly): // // If &#39;buckets&#39; has 0 observations, NaN is returned. // // If &#39;buckets&#39; has fewer than 2 elements, NaN is returned. // // If the highest bucket is not +Inf, NaN is returned. // // If q==NaN, NaN is returned. // // If q&lt;0, -Inf is returned. // // If q&gt;1, +Inf is returned. func bucketQuantile(q float64, buckets buckets) float64 { if math.IsNaN(q) { return math.NaN() } if q &lt; 0 { return math.Inf(-1) } if q &gt; 1 { return math.Inf(+1) } slices.SortFunc(buckets, func(a, b bucket) bool { return a.upperBound &lt; b.upperBound }) if !math.IsInf(buckets[len(buckets)-1].upperBound, +1) { return math.NaN() } buckets = coalesceBuckets(buckets) ensureMonotonic(buckets) if len(buckets) &lt; 2 { return math.NaN() } observations := buckets[len(buckets)-1].count if observations == 0 { return math.NaN() } rank := q * observations b := sort.Search(len(buckets)-1, func(i int) bool { return buckets[i].count &gt;= rank }) if b == len(buckets)-1 { return buckets[len(buckets)-2].upperBound } if b == 0 &amp;&amp; buckets[0].upperBound &lt;= 0 { return buckets[0].upperBound } var ( bucketStart float64 bucketEnd = buckets[b].upperBound count = buckets[b].count ) if b &gt; 0 { bucketStart = buckets[b-1].upperBound count -= buckets[b-1].count rank -= buckets[b-1].count } return bucketStart + (bucketEnd-bucketStart)*(rank/count) } 相关资料\nhttps://stackoverflow.com/questions/55162093/understanding-histogram-quantile-based-on-rate-in-prometheus https://stackoverflow.com/questions/60962520/how-to-get-the-quantile-of-rate-in-prometheus/65418483#65418483 可以在 prometheus 项目下执行下面的单测：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 func TestBucketQuantile__rate5m(t *testing.T) { q := 0.4 myBuckets := buckets{ {10, 5}, {20, 8}, {30, 12}, {40, 15}, {math.Inf(1), 15}, } f := bucketQuantile(q, myBuckets) println(&#34;==== before rate =====&#34;) fmt.Println(myBuckets) fmt.Printf(&#34;%.2f\\n&#34;, f) for i, myBucket := range myBuckets { myBuckets[i].count = myBucket.count / float64(5*60) } println(&#34;==== after rate =====&#34;) fmt.Println(myBuckets) f1 := bucketQuantile(q, myBuckets) fmt.Printf(&#34;%.2f\\n&#34;, f1) } ">
    <link rel="shortcut icon" href="/favicon.ico" />

      <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZVWGDHM98D"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-ZVWGDHM98D');
        }
      </script><script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "\"Prometheus \\u0026 Grafana 学习记录\"",
  "description": "\"\\u003ch2 id=\\\"promql\\\"\\u003ePromQL\\n\\u003c/h2\\u003e\\u003cp\\u003e参考：https://blog.csdn.net/han949417140/article/details/113513227\\u003c/p\\u003e\\n\\u003cp\\u003e官网：https://prometheus.io/docs/prometheus/latest/querying/basics/\\u003c/p\\u003e\\n\\u003cul\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://grafana.com/docs/grafana/v7.5/panels/queries/\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://grafana.com/docs/grafana/v7.5/panels/queries/\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://prometheus.fuckcloudnative.io/di-san-zhang-prometheus/di-4-jie-cha-xun/basics\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://prometheus.fuckcloudnative.io/di-san-zhang-prometheus/di-4-jie-cha-xun/basics\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://github.com/google/re2/wiki/Syntax\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://github.com/google/re2/wiki/Syntax\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003c/ul\\u003e\\n\\u003ch3 id=\\\"基本概念\\\"\\u003e基本概念\\n\\u003c/h3\\u003e\\u003cpre\\u003e\\u003ccode\\u003e- 时间序列(time-series)\\n    - 样本\\n        - time-series 是按照时间戳和值的序列顺序存放的，我们称之为向量(vector)\\n            - 每条 time-series 通过指标名称(metrics name)和一组标签集(labelset)命名\\n        - 在time-series中的每一个点称为一个样本（sample），样本由以下三部分组成：\\n            - 指标(metric)：metric name和描述当前样本特征的labelsets;\\n            - 时间戳(timestamp)：一个精确到毫秒的时间戳;\\n            - 样本值(value)： 一个float64的浮点型数据表示当前样本的值。\\n    - 指标(Metric)\\n        - 在形式上，所有的指标(Metric)都通过如下格式标示：\\n            - \\u0026lt;metric name\\u0026gt;{\\u0026lt;label name\\u0026gt;=\\u0026lt;label value\\u0026gt;, ...}\\n                - 指标的名称(metric name)可以反映被监控样本的含义（比如，http_request_total - 表示当前系统接收到的HTTP请求总量）\\n                - 标签(label)反映了当前样本的特征维度，通过这些维度Prometheus可以对样本数据进行过滤，聚合等\\n        - 以__作为前缀的标签，是系统保留的关键字，只能在系统内部使用\\n- Metrics类型\\n    - Prometheus定义了4种不同的指标类型(metric type)：Counter（计数器）、Gauge（仪表盘）、Histogram（直方图）、Summary（摘要）\\n    - Counter：只增不减的计数器\\n        - Counter类型的指标其工作方式和计数器一样，只增不减（除非系统发生重置）。\\n        - 常见的监控指标，如http_requests_total，node_cpu都是Counter类型的监控指标。 一般在定义Counter类型指标的名称时推荐使用_total作为后缀。\\n        - //例如，通过rate()函数获取HTTP请求量的增长率： rate(http_requests_total[5m])\\n        - //查询当前系统中，访问量前10的HTTP地址： topk(10, http_requests_total)\\n    - Gauge：可增可减的仪表盘\\n        - 与Counter不同，Gauge类型的指标侧重于反应系统的当前状态。因此这类指标的样本数据可增可减。\\n        - 常见指标如：node_memory_MemFree（主机当前空闲的内容大小）、node_memory_MemAvailable（可用内存大小）都是Gauge类型的监控指标。\\n        - //通过Gauge指标，用户可以直接查看系统的当前状态：node_memory_MemFree\\n        - //还可以使用deriv()计算样本的线性回归模型，甚至是直接使用predict_linear()对数据的变化趋势进行预测。\\n            - 例如，预测系统磁盘空间在4个小时之后的剩余情况：predict_linear(node_filesystem_free{job=\\u0026quot;node\\u0026quot;}[1h], 4 * 3600)\\n    - Histogram和Summary分析数据分布情况\\n\\u003c/code\\u003e\\u003c/pre\\u003e\\n\\u003ch3 id=\\\"instant-vector-vs-range-vector\\\"\\u003eInstant vector vs Range vector\\n\\u003c/h3\\u003e\\u003cul\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://stackoverflow.com/questions/68223824/prometheus-instant-vector-vs-range-vector\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://stackoverflow.com/questions/68223824/prometheus-instant-vector-vs-range-vector\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://satyanash.net/software/2021/01/04/understanding-prometheus-range-vectors.html\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://satyanash.net/software/2021/01/04/understanding-prometheus-range-vectors.html\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://promlabs.com/blog/2020/06/18/the-anatomy-of-a-promql-query/\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://promlabs.com/blog/2020/06/18/the-anatomy-of-a-promql-query/\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003c/ul\\u003e\\n\\u003ch3 id=\\\"rate-then-sum-never-sum-then-rate\\\"\\u003eRate then sum, never sum then rate\\n\\u003c/h3\\u003e\\u003cul\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://www.robustperception.io/rate-then-sum-never-sum-then-rate/\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://www.robustperception.io/rate-then-sum-never-sum-then-rate/\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003c/ul\\u003e\\n\\u003cblockquote\\u003e\\n\\u003cp\\u003eTo help keep you on the straight and narrow, remember this:\\u003c/p\\u003e\\n\\u003cp\\u003eThe only mathematical operations you can safely directly apply to a counter\\u0026rsquo;s values are rate, irate, increase, and resets. Anything else will cause you problems.\\u003c/p\\u003e\\u003c/blockquote\\u003e\\n\\u003ch3 id=\\\"the-problem-of-rateincrease-extrapolation-in-prometheus\\\"\\u003eThe problem of rate()/increase() extrapolation in Prometheus\\n\\u003c/h3\\u003e\\u003cul\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://stackoverflow.com/questions/52697517/prometheus-how-to-rate-a-sum-of-the-same-counter-from-different-machines?rq=3\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://stackoverflow.com/questions/52697517/prometheus-how-to-rate-a-sum-of-the-same-counter-from-different-machines?rq=3\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://github.com/prometheus/prometheus/issues/3746\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://github.com/prometheus/prometheus/issues/3746\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://github.com/prometheus/prometheus/issues/3806\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://github.com/prometheus/prometheus/issues/3806\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://github.com/VictoriaMetrics/VictoriaMetrics/issues/1215\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://github.com/VictoriaMetrics/VictoriaMetrics/issues/1215\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://docs.google.com/document/d/1y2Mp041_2v0blnKnZk7keCnJZICeK2YWUQuXH_m4DVc/edit?pli=1\\u0026amp;tab=t.0#heading=h.bupciudrwmna\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://docs.google.com/document/d/1y2Mp041_2v0blnKnZk7keCnJZICeK2YWUQuXH_m4DVc/edit?pli=1\\u0026tab=t.0#heading=h.bupciudrwmna\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://lotabout.me/2019/QQA-Why-Prometheus-increase-return-float/\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://lotabout.me/2019/QQA-Why-Prometheus-increase-return-float/\\u003c/a\\u003e (中文带图)\\u003c/li\\u003e\\n\\u003c/ul\\u003e\\n\\u003ch3 id=\\\"aggregating-the-precomputed-quantiles-from-a-summary-makes-no-sense\\\"\\u003eAggregating the precomputed quantiles from a summary makes no sense\\n\\u003c/h3\\u003e\\u003cblockquote\\u003e\\n\\u003cp\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://prometheus.io/docs/practices/histograms/#count-and-sum-of-observations\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://prometheus.io/docs/practices/histograms/#count-and-sum-of-observations\\u003c/a\\u003e\\navg(http_request_duration_seconds{quantile=\\u0026ldquo;0.95\\u0026rdquo;}) // BAD!\\nhistogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) // GOOD.\\u003c/p\\u003e\\u003c/blockquote\\u003e\\n\\u003ch3 id=\\\"errors-of-quantile-estimation\\\"\\u003eErrors of quantile estimation\\n\\u003c/h3\\u003e\\u003cblockquote\\u003e\\n\\u003cp\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://prometheus.io/docs/practices/histograms/#errors-of-quantile-estimation\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://prometheus.io/docs/practices/histograms/#errors-of-quantile-estimation\\u003c/a\\u003e\\nQuantiles, whether calculated client-side or server-side, are estimated. It is important to understand the errors of that estimation.\\u003c/p\\u003e\\u003c/blockquote\\u003e\\n\\u003cblockquote\\u003e\\n\\u003cp\\u003eContinuing the histogram example from above, imagine your usual request durations are almost all very close to 220ms, or in other words, if you could plot the \\u0026ldquo;true\\u0026rdquo; histogram, you would see a very sharp spike at 220ms. In the Prometheus histogram metric as configured above, almost all observations, and therefore also the 95th percentile, will fall into the bucket labeled {le=\\u0026ldquo;0.3\\u0026rdquo;}, i.e. the bucket from 200ms to 300ms. The histogram implementation guarantees that the true 95th percentile is somewhere between 200ms and 300ms. To return a single value (rather than an interval), it applies linear interpolation, which yields 295ms in this case. The calculated quantile gives you the impression that you are close to breaching the SLO, but in reality, the 95th percentile is a tiny bit above 220ms, a quite comfortable distance to your SLO.\\u003c/p\\u003e\\u003c/blockquote\\u003e\\n\\u003cblockquote\\u003e\\n\\u003cp\\u003eNext step in our thought experiment: A change in backend routing adds a fixed amount of 100ms to all request durations. Now the request duration has its sharp spike at 320ms and almost all observations will fall into the bucket from 300ms to 450ms. The 95th percentile is calculated to be 442.5ms, although the correct value is close to 320ms. While you are only a tiny bit outside of your SLO, the calculated 95th quantile looks much worse.\\u003c/p\\u003e\\u003c/blockquote\\u003e\\n\\u003ch3 id=\\\"best-practices\\\"\\u003eBest practices\\n\\u003c/h3\\u003e\\u003cp\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://grafana.com/docs/grafana/v7.5/best-practices/\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://grafana.com/docs/grafana/v7.5/best-practices/\\u003c/a\\u003e\\u003c/p\\u003e\\n\\u003ch3 id=\\\"queries-examples\\\"\\u003eQueries Examples\\n\\u003c/h3\\u003e\\u003cp\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://prometheus.io/docs/prometheus/2.39/querying/examples/\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://prometheus.io/docs/prometheus/2.39/querying/examples/\\u003c/a\\u003e\\u003c/p\\u003e\\n\\u003ch2 id=\\\"prometheus-的各种问题\\\"\\u003ePrometheus 的各种问题\\n\\u003c/h2\\u003e\\u003cul\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"http://www.xuyasong.com/?p=1921\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttp://www.xuyasong.com/?p=1921\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://aleiwu.com/post/prometheus-bp/\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://aleiwu.com/post/prometheus-bp/\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://develotters.com/posts/high-cardinality/\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://develotters.com/posts/high-cardinality/\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003c/ul\\u003e\\n\\u003ch3 id=\\\"高基数问题high-cardinality-problem\\\"\\u003e高基数问题(High-Cardinality Problem)\\n\\u003c/h3\\u003e\\u003cp\\u003e2.16 版本以上的 Prometheus 直接支持查看 TSDB 的状态：\\u003c/p\\u003e\\n\\u003ch3 id=\\\"counter-重置导致的问题\\\"\\u003eCounter 重置导致的问题\\n\\u003c/h3\\u003e\\u003cp\\u003eCounter 是四种 Metrics 类型中的一种，它的值只会增加(incr)或者重置(reset, 一般是因为实例重启)。\\u003c/p\\u003e\\n\\u003cp\\u003ePromQL 的 rate()和increase() 函数会自动处理 Counter 重置的情况，但 sum 不会，所以很多文档都强调一定要先 rate 再 sum，而不能先 sum 再 rate。\\u003c/p\\u003e\\n\\u003ch4 id=\\\"rateincrease-是如何处理-counter-重置的\\\"\\u003erate/increase 是如何处理 counter 重置的？\\n\\u003c/h4\\u003e\\u003cp\\u003e具体的处理代码为：\\u003c/p\\u003e\\n\\u003cdiv class=\\\"highlight\\\"\\u003e\\u003cdiv class=\\\"chroma\\\"\\u003e\\n\\u003ctable class=\\\"lntable\\\"\\u003e\\u003ctr\\u003e\\u003ctd class=\\\"lntd\\\"\\u003e\\n\\u003cpre tabindex=\\\"0\\\" class=\\\"chroma\\\"\\u003e\\u003ccode\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e1\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e2\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e3\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e4\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e5\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e6\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e7\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e8\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e9\\n\\u003c/span\\u003e\\u003c/code\\u003e\\u003c/pre\\u003e\\u003c/td\\u003e\\n\\u003ctd class=\\\"lntd\\\"\\u003e\\n\\u003cpre tabindex=\\\"0\\\" class=\\\"chroma\\\"\\u003e\\u003ccode class=\\\"language-Go\\\" data-lang=\\\"Go\\\"\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// Handle counter resets:\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eresultFloat\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esamples\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eFloats\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003enumSamplesMinusOne\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eF\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e-\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esamples\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eFloats\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eF\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eprevValue\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esamples\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eFloats\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eF\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003efor\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003e_\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ecurrPoint\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003erange\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esamples\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eFloats\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e1\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e:]\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ecurrPoint\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eF\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e\\u0026lt;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eprevValue\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eresultFloat\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e+=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eprevValue\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eprevValue\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ecurrPoint\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eF\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/code\\u003e\\u003c/pre\\u003e\\u003c/td\\u003e\\u003c/tr\\u003e\\u003c/table\\u003e\\n\\u003c/div\\u003e\\n\\u003c/div\\u003e\\u003cp\\u003e首先遍历样本，如果发现 Counter 减少就认为发生了重置，后续所有样本值都会加上重置前的值。\\u003c/p\\u003e\\n\\u003cp\\u003e举个栗子，假设时间序列的值为[5,10,4,6]，那么它会被处理为[5,10,14,16]。\\u003c/p\\u003e\\n\\u003ch3 id=\\\"prometheus-报警不准问题\\\"\\u003ePrometheus 报警不准问题\\n\\u003c/h3\\u003e\\u003cul\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://aleiwu.com/post/prometheus-alert-why/\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://aleiwu.com/post/prometheus-alert-why/\\u003c/a\\u003e\\n报警不准，指的是两类问题：\\u003c/li\\u003e\\n\\u003cli\\u003e『该报』的警没报；\\u003c/li\\u003e\\n\\u003cli\\u003e『不该报』的警报了；\\n这里的『该报』和『不该报』都是基于 Grafana 进行判断的。所以这里说报警不准，本质是 Grafana 的仪表盘展示结果和 Prometheus 告警不一致。\\u003c/li\\u003e\\n\\u003c/ul\\u003e\\n\\u003cp\\u003e这个问题本质是『采样间隔』不一致的：\\u003c/p\\u003e\\n\\u003cul\\u003e\\n\\u003cli\\u003ePrometheus 的告警器会按固定的时间间隔采样，在一个周期内，如果样本满足告警规则；\\u003c/li\\u003e\\n\\u003cli\\u003eGrafana 渲染图标的结果，则取决于基于 Range Query 采样点的分布；\\u003c/li\\u003e\\n\\u003c/ul\\u003e\\n\\u003cp\\u003e很可能出现，Prometheus 采样时捕获了『低谷』但 Grafana 忽略了『低谷』导致『不该报』的警报了，或者 Prometheus 忽略了『低谷』而 Grafana 捕获了『低谷』导致『该报』的警没报。\\u003c/p\\u003e\\n\\u003ch2 id=\\\"prometheus-alertmanager\\\"\\u003ePrometheus: Alertmanager\\n\\u003c/h2\\u003e\\u003ch3 id=\\\"架构图\\\"\\u003e架构图\\n\\u003c/h3\\u003e\\u003cp\\u003e\\u003cimg src=\\\"/images/alertmanager.png\\\"\\n\\t\\n\\t\\n\\t\\n\\tloading=\\\"lazy\\\"\\n\\t\\n\\t\\talt=\\\"image1\\\"\\n\\t\\n\\t\\n\\u003e\\u003c/p\\u003e\\n\\u003ch3 id=\\\"为什么要-alertmanager\\\"\\u003e为什么要 Alertmanager？\\n\\u003c/h3\\u003e\\u003cp\\u003e当 Prometheus Server 计算出一些警报后，它自己并没有能力将这些警报通知出去，只能将警报推给 Alertmanager，由 Alertmanager 进行发送。\\u003c/p\\u003e\\n\\u003cp\\u003e这个切分，一方面是出于单一职责的考虑，让 Prometheus “do one thing and do it well”, 另一方面则是因为\\u003cstrong\\u003e警报发送确实不是一件”简单”的事，需要一个专门的系统来做好它\\u003c/strong\\u003e。\\u003c/p\\u003e\\n\\u003cp\\u003e可以这么说，\\u003cstrong\\u003eAlertmanager 的目标不是简单地”发出警报”，而是”发出高质量的警报”\\u003c/strong\\u003e。它提供的高级功能包括但不限于：\\u003c/p\\u003e\\n\\u003cul\\u003e\\n\\u003cli\\u003eGo Template 渲染警报内容；\\u003c/li\\u003e\\n\\u003cli\\u003e管理警报的重复提醒时机与消除后消除通知的发送；\\u003c/li\\u003e\\n\\u003cli\\u003e根据标签定义警报路由，实现警报的优先级、接收人划分，并针对不同的优先级和接收人定制不同的发送策略；\\u003c/li\\u003e\\n\\u003cli\\u003e将同类型警报打包成一条通知发送出去，降低警报通知的频率；\\u003c/li\\u003e\\n\\u003cli\\u003e支持静默规则: 用户可以定义一条静默规则，在一段时间内停止发送部分特定的警报，比如已经确认是搜索集群问题，在修复搜索集群时，先静默掉搜索集群相关警报；\\u003c/li\\u003e\\n\\u003cli\\u003e支持”抑制”规则(Inhibition Rule): 用户可以定义一条”抑制”规则，规定在某种警报发生时，不发送另一种警报，比如在”A 机房网络故障”这条警报发生时，不发送所有”A 机房中的警报”；\\u003c/li\\u003e\\n\\u003c/ul\\u003e\\n\\u003ch3 id=\\\"routing-tree\\\"\\u003eRouting Tree\\n\\u003c/h3\\u003e\\u003cp\\u003eRouting Tree 的设计意图是让用户能够非常自由地给警报归类，然后根据归类后的类别来配置要发送给谁以及怎么发送：\\u003c/p\\u003e\\n\\u003cul\\u003e\\n\\u003cli\\u003e发送给谁？上面已经做了很好的示例，’数据库警报’和’前端警报’都有特定的接收组，都没有匹配上那么就是’默认警报’, 发送给默认接收组\\u003c/li\\u003e\\n\\u003cli\\u003e怎么发送？对于一类警报，有个多个字段来配置发送行为：\\n\\u003cul\\u003e\\n\\u003cli\\u003egroup_by：决定了警报怎么分组，每个 group 只会定时产生一次通知，这就达到了降噪的效果，而不同的警报类别分组方式显然是不一样的，举个例子：\\n\\u003cul\\u003e\\n\\u003cli\\u003e配置中的 ‘数据库警报’ 是按 ‘集群’ 和 ‘规则名’ 分组的，这表明对于数据库警报，我们关心的是“哪个集群的哪个规则出问题了”，比如一个时间段内，’华东’集群产生了10条 ‘API响应时间过长’ 警报，- 这些警报就会聚合在一个通知里发出来；\\u003c/li\\u003e\\n\\u003cli\\u003e配置中的 ‘前端警报’ 是按 ‘产品’ 和 ‘环境’ 分组的， 这表明对于前端警报，我们关心的是“哪个产品的哪个环境出问题了”\\u003c/li\\u003e\\n\\u003c/ul\\u003e\\n\\u003c/li\\u003e\\n\\u003cli\\u003egroup_interval 和 group_wait: 控制分组的细节，不细谈，其中 group_interval 控制了这个分组最快多久执行一次 Notification Pipeline\\u003c/li\\u003e\\n\\u003cli\\u003erepeat_interval: 假如一个相同的警报一直 FIRING，Alertmanager 并不会一直发送警报，而会等待一段时间，这个等待时间就是 repeat_interval，显然，不同类型警报的发送频率也是不一样的\\u003c/li\\u003e\\n\\u003c/ul\\u003e\\n\\u003c/li\\u003e\\n\\u003c/ul\\u003e\\n\\u003ch3 id=\\\"notification-pipeline\\\"\\u003eNotification Pipeline\\n\\u003c/h3\\u003e\\u003cp\\u003e要重点说的是DedupStage和NotifySetStage它俩协同负责去重工作，具体做法是：\\u003c/p\\u003e\\n\\u003cul\\u003e\\n\\u003cli\\u003eNotifySetStage 会为发送成功的警报记录一条发送通知，key 是’接收组名字’+’GroupKey 的 key 值’，value 是当前 Stage 收到的 []Alert (这个列表和最开始进入 Notification Pipeline 的警报列表有可能是不同的，因为其中有些 Alert 可能在前置 Stage 中已经被过滤掉了)\\u003c/li\\u003e\\n\\u003cli\\u003eDedupStage 中会以’接收组名字’+’GroupKey 的 key 值’为 key 查询通知记录，假如：\\n\\u003cul\\u003e\\n\\u003cli\\u003e查询无结果，那么这条通知没发过，为这组警报发送一条通知；\\u003c/li\\u003e\\n\\u003cli\\u003e查询有结果，那么查询得到已经发送过的一组警报 S，判断当前的这组警报 A 是否为 S 的子集：\\n\\u003cul\\u003e\\n\\u003cli\\u003e假如 A 是 S 的子集，那么表明 A 和 S 重复，这时候要根据 repeat_interval 来决定是否再次发送：\\n\\u003cul\\u003e\\n\\u003cli\\u003e距离 S 的发送时间已经过去了足够久（repeat_interval)，那么我们要再发送一遍；\\u003c/li\\u003e\\n\\u003cli\\u003e距离 S 的发送时间还没有达到 repeat_interval，那么为了降低警报频率，触发去重逻辑，这次我们就不发了；\\u003c/li\\u003e\\n\\u003c/ul\\u003e\\n\\u003c/li\\u003e\\n\\u003cli\\u003e假如 A 不是 S 的子集，那么 A 和 S 不重复，需要再发送一次； 上面的表述可能有些抽象，最后表现出来的结果是：\\u003c/li\\u003e\\n\\u003c/ul\\u003e\\n\\u003c/li\\u003e\\n\\u003c/ul\\u003e\\n\\u003c/li\\u003e\\n\\u003cli\\u003e假如一个 AlertGroup 里的警报一直发生变化，那么虽然每次都是新警报，不会被去重，但是由于 group_interval （假设是5分钟）存在，这个 AlertGroup 最多 5 分钟触发一次 Notification Pipeline，因此最多也只会 5 分钟发送一条通知；\\u003c/li\\u003e\\n\\u003cli\\u003e假如一个 AlertGroup 里的警报一直不变化，就是那么几条一直 FIRING 着，那么虽然每个 group_interval 都会触发 Notification Pipeline，但是由于 repeate_interval（假设是1小时）存在，因此最多也只会每 1 小时为这个重复的警报发送一条通知；\\n再说一下 Silence 和 Inhibit，两者都是基于用户主动定义的规则的：\\u003c/li\\u003e\\n\\u003cli\\u003eSilence Rule：静默规则用来关闭掉部分警报的通知，比如某个性能问题已经修复了，但需要排期上线，那么在上线前就可以把对应的警报静默掉来减少噪音；\\u003c/li\\u003e\\n\\u003cli\\u003eInhibit Rule：抑制规则用于在某类警报发生时，抑制掉另一类警报，比如某个机房宕机了，那么会影响所有上层服务，产生级联的警报洪流，反而会掩盖掉根本原因，这时候抑制规则就有用了； 因此 Notification Pipeline 的设计意图就很明确了：通过一系列逻辑（如抑制、静默、去重）来获得更高的警报质量，由于警报质量的维度很多（剔除重复、类似的警报，静默暂时无用的警报，抑制级联警报），因此 Notification Pipeline 设计成了责任链模式，以便于随时添加新的环节来优化警报质量\\u003c/li\\u003e\\n\\u003c/ul\\u003e\\n\\u003ch2 id=\\\"prometheus存储机制\\\"\\u003ePrometheus存储机制\\n\\u003c/h2\\u003e\\u003cul\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"http://www.xuyasong.com/?p=1601\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttp://www.xuyasong.com/?p=1601\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003c/ul\\u003e\\n\\u003ch2 id=\\\"深入-promql\\\"\\u003e深入 PromQL\\n\\u003c/h2\\u003e\\u003ch3 id=\\\"bascis\\\"\\u003eBascis\\n\\u003c/h3\\u003e\\u003cul\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://stackoverflow.com/questions/68223824/prometheus-instant-vector-vs-range-vector\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://stackoverflow.com/questions/68223824/prometheus-instant-vector-vs-range-vector\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://satyanash.net/software/2021/01/04/understanding-prometheus-range-vectors.html\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://satyanash.net/software/2021/01/04/understanding-prometheus-range-vectors.html\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://promlabs.com/blog/2020/06/18/the-anatomy-of-a-promql-query/\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://promlabs.com/blog/2020/06/18/the-anatomy-of-a-promql-query/\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003cli\\u003ePrometheus Querying - Breaking Down PromQL\\u003c/li\\u003e\\n\\u003c/ul\\u003e\\n\\u003ch3 id=\\\"functions\\\"\\u003eFunctions\\n\\u003c/h3\\u003e\\u003ch4 id=\\\"rate--increase\\\"\\u003eRate \\u0026amp; Increase\\n\\u003c/h4\\u003e\\u003cul\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://promlabs.com/blog/2021/01/29/how-exactly-does-promql-calculate-rates/\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://promlabs.com/blog/2021/01/29/how-exactly-does-promql-calculate-rates/\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://stackoverflow.com/questions/54494394/do-i-understand-prometheuss-rate-vs-increase-functions-correctly?rq=3\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://stackoverflow.com/questions/54494394/do-i-understand-prometheuss-rate-vs-increase-functions-correctly?rq=3\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://stackoverflow.com/questions/48218950/increase-in-prometheus-sometimes-doubles-values-how-to-avoid?rq=3\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://stackoverflow.com/questions/48218950/increase-in-prometheus-sometimes-doubles-values-how-to-avoid?rq=3\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://stackoverflow.com/questions/52697517/prometheus-how-to-rate-a-sum-of-the-same-counter-from-different-machines\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://stackoverflow.com/questions/52697517/prometheus-how-to-rate-a-sum-of-the-same-counter-from-different-machines\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://github.com/VictoriaMetrics/VictoriaMetrics/issues/1215\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://github.com/VictoriaMetrics/VictoriaMetrics/issues/1215\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://stackoverflow.com/questions/70835778/understanding-increase-and-rate-used-on-http-server-requests-seconds-count-w\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://stackoverflow.com/questions/70835778/understanding-increase-and-rate-used-on-http-server-requests-seconds-count-w\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003c/ul\\u003e\\n\\u003cp\\u003e由于 prometheus 使用了线性插值算法取计算 increase(增量)，所以计算结果会得到小数，这一点特别容易让人误解。\\u003c/p\\u003e\\n\\u003cdiv class=\\\"highlight\\\"\\u003e\\u003cdiv class=\\\"chroma\\\"\\u003e\\n\\u003ctable class=\\\"lntable\\\"\\u003e\\u003ctr\\u003e\\u003ctd class=\\\"lntd\\\"\\u003e\\n\\u003cpre tabindex=\\\"0\\\" class=\\\"chroma\\\"\\u003e\\u003ccode\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e  1\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e  2\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e  3\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e  4\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e  5\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e  6\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e  7\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e  8\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e  9\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 10\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 11\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 12\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 13\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 14\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 15\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 16\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 17\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 18\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 19\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 20\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 21\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 22\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 23\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 24\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 25\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 26\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 27\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 28\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 29\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 30\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 31\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 32\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 33\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 34\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 35\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 36\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 37\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 38\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 39\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 40\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 41\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 42\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 43\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 44\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 45\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 46\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 47\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 48\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 49\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 50\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 51\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 52\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 53\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 54\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 55\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 56\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 57\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 58\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 59\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 60\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 61\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 62\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 63\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 64\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 65\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 66\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 67\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 68\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 69\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 70\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 71\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 72\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 73\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 74\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 75\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 76\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 77\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 78\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 79\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 80\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 81\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 82\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 83\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 84\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 85\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 86\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 87\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 88\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 89\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 90\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 91\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 92\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 93\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 94\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 95\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 96\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 97\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 98\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 99\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e100\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e101\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e102\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e103\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e104\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e105\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e106\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e107\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e108\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e109\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e110\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e111\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e112\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e113\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e114\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e115\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e116\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e117\\n\\u003c/span\\u003e\\u003c/code\\u003e\\u003c/pre\\u003e\\u003c/td\\u003e\\n\\u003ctd class=\\\"lntd\\\"\\u003e\\n\\u003cpre tabindex=\\\"0\\\" class=\\\"chroma\\\"\\u003e\\u003ccode class=\\\"language-GO\\\" data-lang=\\\"GO\\\"\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// === rate(node parser.ValueTypeMatrix) Vector ===\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"kd\\\"\\u003efunc\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003efuncRate\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003evals\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[]\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eparser\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eValue\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eargs\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eparser\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eExpressions\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e*\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eEvalNodeHelper\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eVector\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003ereturn\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eextrapolatedRate\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003evals\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eargs\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"kc\\\"\\u003etrue\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"kc\\\"\\u003etrue\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// === increase(node parser.ValueTypeMatrix) Vector ===\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"kd\\\"\\u003efunc\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003efuncIncrease\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003evals\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[]\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eparser\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eValue\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eargs\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eparser\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eExpressions\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e*\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eEvalNodeHelper\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eVector\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003ereturn\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eextrapolatedRate\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003evals\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eargs\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"kc\\\"\\u003etrue\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"kc\\\"\\u003efalse\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// extrapolatedRate is a utility function for rate/increase/delta.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// It calculates the rate (allowing for counter resets if isCounter is true),\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// extrapolates if the first/last sample is close to the boundary, and returns\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// the result as either per-second (if isRate is true) or overall.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"kd\\\"\\u003efunc\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eextrapolatedRate\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003evals\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[]\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eparser\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eValue\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eargs\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eparser\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eExpressions\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e*\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eEvalNodeHelper\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eisCounter\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eisRate\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"kt\\\"\\u003ebool\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eVector\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ems\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eargs\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].(\\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e*\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eparser\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eMatrixSelector\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003evs\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ems\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eVectorSelector\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.(\\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e*\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eparser\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eVectorSelector\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"kd\\\"\\u003evar\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esamples\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003evals\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eMatrix\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)[\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e]\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003erangeStart\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e         \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eTs\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e-\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003edurationMilliseconds\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ems\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eRange\\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e+\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003evs\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eOffset\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003erangeEnd\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e           \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eTs\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e-\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003edurationMilliseconds\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003evs\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eOffset\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eresultFloat\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"kt\\\"\\u003efloat64\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eresultHistogram\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e*\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ehistogram\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eFloatHistogram\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003efirstT\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003elastT\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e      \\u003c/span\\u003e\\u003cspan class=\\\"kt\\\"\\u003eint64\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003enumSamplesMinusOne\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"kt\\\"\\u003eint\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// We need either at least two Histograms and no Floats, or at least two\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// Floats and no Histograms to calculate a rate. Otherwise, drop this\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// Vector element.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003elen\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esamples\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eHistograms\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e\\u0026gt;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e\\u0026amp;\\u0026amp;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003elen\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esamples\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eFloats\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e\\u0026gt;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// Mix of histograms and floats. TODO(beorn7): Communicate this failure reason.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003ereturn\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eOut\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eswitch\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003ecase\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003elen\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esamples\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eHistograms\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e\\u0026gt;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e1\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e:\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003enumSamplesMinusOne\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003elen\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esamples\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eHistograms\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e-\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e1\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003efirstT\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esamples\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eHistograms\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eT\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003elastT\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esamples\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eHistograms\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003enumSamplesMinusOne\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eT\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eresultHistogram\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003ehistogramRate\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esamples\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eHistograms\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eisCounter\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eresultHistogram\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e==\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"kc\\\"\\u003enil\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// The histograms are not compatible with each other.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// TODO(beorn7): Communicate this failure reason.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003ereturn\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eOut\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003ecase\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003elen\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esamples\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eFloats\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e\\u0026gt;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e1\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e:\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003enumSamplesMinusOne\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003elen\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esamples\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eFloats\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e-\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e1\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003efirstT\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esamples\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eFloats\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eT\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003elastT\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esamples\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eFloats\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003enumSamplesMinusOne\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eT\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eresultFloat\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esamples\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eFloats\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003enumSamplesMinusOne\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eF\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e-\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esamples\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eFloats\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eF\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e!\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eisCounter\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003ebreak\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// Handle counter resets:\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eprevValue\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esamples\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eFloats\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eF\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003efor\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003e_\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ecurrPoint\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003erange\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esamples\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eFloats\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e1\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e:]\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ecurrPoint\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eF\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e\\u0026lt;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eprevValue\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e                \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eresultFloat\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e+=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eprevValue\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eprevValue\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ecurrPoint\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eF\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003edefault\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e:\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// Not enough samples. TODO(beorn7): Communicate this failure reason.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003ereturn\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eOut\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// Duration between first/last samples and boundary of range.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003edurationToStart\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003efloat64\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003efirstT\\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e-\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003erangeStart\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e/\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e1000\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003edurationToEnd\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003efloat64\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003erangeEnd\\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e-\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003elastT\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e/\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e1000\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esampledInterval\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003efloat64\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003elastT\\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e-\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003efirstT\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e/\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e1000\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eaverageDurationBetweenSamples\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esampledInterval\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e/\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003efloat64\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003enumSamplesMinusOne\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// TODO(beorn7): Do this for histograms, too.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eisCounter\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e\\u0026amp;\\u0026amp;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eresultFloat\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e\\u0026gt;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e\\u0026amp;\\u0026amp;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003elen\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esamples\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eFloats\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e\\u0026gt;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e\\u0026amp;\\u0026amp;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esamples\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eFloats\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eF\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e\\u0026gt;=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// Counters cannot be negative. If we have any slope at all\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// (i.e. resultFloat went up), we can extrapolate the zero point\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// of the counter. If the duration to the zero point is shorter\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// than the durationToStart, we take the zero point as the start\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// of the series, thereby avoiding extrapolation to negative\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// counter values.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003edurationToZero\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esampledInterval\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e*\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esamples\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eFloats\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eF\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e/\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eresultFloat\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003edurationToZero\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e\\u0026lt;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003edurationToStart\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003edurationToStart\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003edurationToZero\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// If the first/last samples are close to the boundaries of the range,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// extrapolate the result. This is as we expect that another sample\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// will exist given the spacing between samples we\\u0026#39;ve seen thus far,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// with an allowance for noise.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eextrapolationThreshold\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eaverageDurationBetweenSamples\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e*\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mf\\\"\\u003e1.1\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eextrapolateToInterval\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esampledInterval\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003edurationToStart\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e\\u0026lt;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eextrapolationThreshold\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eextrapolateToInterval\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e+=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003edurationToStart\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eelse\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eextrapolateToInterval\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e+=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eaverageDurationBetweenSamples\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e/\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e2\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003edurationToEnd\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e\\u0026lt;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eextrapolationThreshold\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eextrapolateToInterval\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e+=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003edurationToEnd\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eelse\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eextrapolateToInterval\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e+=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eaverageDurationBetweenSamples\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e/\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e2\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003efactor\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eextrapolateToInterval\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e/\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esampledInterval\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eisRate\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003efactor\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e/=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ems\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eRange\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eSeconds\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e()\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eresultHistogram\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e==\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"kc\\\"\\u003enil\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eresultFloat\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e*=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003efactor\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eelse\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eresultHistogram\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eMul\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003efactor\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003ereturn\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003eappend\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eOut\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eSample\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eF\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e:\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eresultFloat\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eH\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e:\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eresultHistogram\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e})\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/code\\u003e\\u003c/pre\\u003e\\u003c/td\\u003e\\u003c/tr\\u003e\\u003c/table\\u003e\\n\\u003c/div\\u003e\\n\\u003c/div\\u003e\\u003ch4 id=\\\"histogramquantitle\\\"\\u003ehistogramQuantitle\\n\\u003c/h4\\u003e\\u003cp\\u003e用法示例：\\u003c/p\\u003e\\n\\u003cdiv class=\\\"highlight\\\"\\u003e\\u003cdiv class=\\\"chroma\\\"\\u003e\\n\\u003ctable class=\\\"lntable\\\"\\u003e\\u003ctr\\u003e\\u003ctd class=\\\"lntd\\\"\\u003e\\n\\u003cpre tabindex=\\\"0\\\" class=\\\"chroma\\\"\\u003e\\u003ccode\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e1\\n\\u003c/span\\u003e\\u003c/code\\u003e\\u003c/pre\\u003e\\u003c/td\\u003e\\n\\u003ctd class=\\\"lntd\\\"\\u003e\\n\\u003cpre tabindex=\\\"0\\\" class=\\\"chroma\\\"\\u003e\\u003ccode class=\\\"language-GO\\\" data-lang=\\\"GO\\\"\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"nx\\\"\\u003eTBD\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/code\\u003e\\u003c/pre\\u003e\\u003c/td\\u003e\\u003c/tr\\u003e\\u003c/table\\u003e\\n\\u003c/div\\u003e\\n\\u003c/div\\u003e\\u003cp\\u003e源码见：\\u003c/p\\u003e\\n\\u003cul\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://github.com/prometheus/prometheus/blob/caa173d2aac4c390546b1f78302104b1ccae0878/promql/functions.go#L615\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://github.com/prometheus/prometheus/blob/caa173d2aac4c390546b1f78302104b1ccae0878/promql/functions.go#L615\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://github.com/prometheus/prometheus/blob/caa173d2aac4c390546b1f78302104b1ccae0878/promql/quantile.go#L73\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://github.com/prometheus/prometheus/blob/caa173d2aac4c390546b1f78302104b1ccae0878/promql/quantile.go#L73\\u003c/a\\u003e\\n核心算法是：bucketStart + (bucketEnd-bucketStart)*(rank/count)。\\u003c/li\\u003e\\n\\u003c/ul\\u003e\\n\\u003cp\\u003e同样也是线性插值算法，比较好理解。唯一需要注意的是，在 histogram_quantile 的第二个参数是 sum(rate, \\u0026hellip;)，这个是 QPS(count/time) 而不是直接用的 count，为什么？计算公式里最后一项是 rank/count，而 rank = q*count，两者相除 time 项会被消除，相当于还是 count\\u0026rsquo; / count，也就是结果是等价的。既然结果等价，为什么要用 rate 而不直接用 count？因为 rate 函数可以使用处理 reset，直接用 count 不行。\\u003c/p\\u003e\\n\\u003cdiv class=\\\"highlight\\\"\\u003e\\u003cdiv class=\\\"chroma\\\"\\u003e\\n\\u003ctable class=\\\"lntable\\\"\\u003e\\u003ctr\\u003e\\u003ctd class=\\\"lntd\\\"\\u003e\\n\\u003cpre tabindex=\\\"0\\\" class=\\\"chroma\\\"\\u003e\\u003ccode\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e  1\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e  2\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e  3\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e  4\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e  5\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e  6\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e  7\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e  8\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e  9\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 10\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 11\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 12\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 13\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 14\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 15\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 16\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 17\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 18\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 19\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 20\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 21\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 22\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 23\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 24\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 25\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 26\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 27\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 28\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 29\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 30\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 31\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 32\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 33\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 34\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 35\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 36\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 37\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 38\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 39\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 40\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 41\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 42\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 43\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 44\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 45\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 46\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 47\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 48\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 49\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 50\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 51\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 52\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 53\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 54\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 55\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 56\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 57\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 58\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 59\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 60\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 61\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 62\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 63\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 64\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 65\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 66\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 67\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 68\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 69\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 70\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 71\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 72\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 73\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 74\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 75\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 76\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 77\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 78\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 79\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 80\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 81\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 82\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 83\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 84\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 85\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 86\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 87\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 88\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 89\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 90\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 91\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 92\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 93\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 94\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 95\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 96\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 97\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 98\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 99\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e100\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e101\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e102\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e103\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e104\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e105\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e106\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e107\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e108\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e109\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e110\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e111\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e112\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e113\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e114\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e115\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e116\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e117\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e118\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e119\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e120\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e121\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e122\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e123\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e124\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e125\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e126\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e127\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e128\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e129\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e130\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e131\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e132\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e133\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e134\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e135\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e136\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e137\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e138\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e139\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e140\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e141\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e142\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e143\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e144\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e145\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e146\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e147\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e148\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e149\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e150\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e151\\n\\u003c/span\\u003e\\u003c/code\\u003e\\u003c/pre\\u003e\\u003c/td\\u003e\\n\\u003ctd class=\\\"lntd\\\"\\u003e\\n\\u003cpre tabindex=\\\"0\\\" class=\\\"chroma\\\"\\u003e\\u003ccode class=\\\"language-GO\\\" data-lang=\\\"GO\\\"\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// === histogram_quantile(k parser.ValueTypeScalar, Vector parser.ValueTypeVector) Vector ===\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"kd\\\"\\u003efunc\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003efuncHistogramQuantile\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003evals\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[]\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eparser\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eValue\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eargs\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eparser\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eExpressions\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e*\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eEvalNodeHelper\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eVector\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eq\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003evals\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eVector\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)[\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eF\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003einVec\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003evals\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e1\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eVector\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esignatureToMetricWithBuckets\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e==\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"kc\\\"\\u003enil\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esignatureToMetricWithBuckets\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"kd\\\"\\u003emap\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"kt\\\"\\u003estring\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e]\\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e*\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emetricWithBuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eelse\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003efor\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003e_\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ev\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003erange\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esignatureToMetricWithBuckets\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ev\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ev\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[:\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e]\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"kd\\\"\\u003evar\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ehistogramSamples\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[]\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eSample\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003efor\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003e_\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esample\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003erange\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003einVec\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// We are only looking for conventional buckets here. Remember\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// the histograms for later treatment.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esample\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eH\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e!=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"kc\\\"\\u003enil\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ehistogramSamples\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003eappend\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ehistogramSamples\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esample\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003econtinue\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eupperBound\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eerr\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003estrconv\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eParseFloat\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esample\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eMetric\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eGet\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emodel\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eBucketLabel\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e),\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e64\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eerr\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e!=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"kc\\\"\\u003enil\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// Oops, no bucket label or malformed label value. Skip.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// TODO(beorn7): Issue a warning somehow.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003econtinue\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003elblBuf\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esample\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eMetric\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eBytesWithoutLabels\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003elblBuf\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003elabels\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eBucketLabel\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emb\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eok\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esignatureToMetricWithBuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003estring\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003elblBuf\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)]\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e!\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eok\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esample\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eMetric\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003elabels\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eNewBuilder\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esample\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eMetric\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e).\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e                \\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eDel\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eexcludedLabels\\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e...\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e).\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e                \\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eLabels\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e()\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emb\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e\\u0026amp;\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emetricWithBuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esample\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eMetric\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"kc\\\"\\u003enil\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esignatureToMetricWithBuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003estring\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003elblBuf\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)]\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emb\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emb\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003eappend\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emb\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebucket\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eupperBound\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esample\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eF\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e})\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// Now deal with the histograms.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003efor\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003e_\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esample\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003erange\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ehistogramSamples\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// We have to reconstruct the exact same signature as above for\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// a conventional histogram, just ignoring any le label.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003elblBuf\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esample\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eMetric\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eBytes\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003elblBuf\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emb\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eok\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esignatureToMetricWithBuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003estring\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003elblBuf\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)];\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eok\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e\\u0026amp;\\u0026amp;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003elen\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emb\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e\\u0026gt;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// At this data point, we have conventional histogram\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// buckets and a native histogram with the same name and\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// labels. Do not evaluate anything.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// TODO(beorn7): Issue a warning somehow.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003edelete\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esignatureToMetricWithBuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003estring\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003elblBuf\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e))\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003econtinue\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eOut\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003eappend\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eOut\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eSample\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eMetric\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e:\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eDropMetricName\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esample\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eMetric\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e),\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eF\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e:\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e      \\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003ehistogramQuantile\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eq\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esample\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eH\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e),\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e})\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003efor\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003e_\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emb\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003erange\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esignatureToMetricWithBuckets\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003elen\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emb\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e\\u0026gt;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eOut\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003eappend\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eOut\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eSample\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e                \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eMetric\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e:\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emb\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emetric\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e                \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eF\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e:\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e      \\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003ebucketQuantile\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eq\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emb\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e),\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e            \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e})\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003ereturn\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eenh\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eOut\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// bucketQuantile calculates the quantile \\u0026#39;q\\u0026#39; based on the given buckets. The\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// buckets will be sorted by upperBound by this function (i.e. no sorting\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// needed before calling this function). The quantile value is interpolated\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// assuming a linear distribution within a bucket. However, if the quantile\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// falls into the highest bucket, the upper bound of the 2nd highest bucket is\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// returned. A natural lower bound of 0 is assumed if the upper bound of the\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// lowest bucket is greater 0. In that case, interpolation in the lowest bucket\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// happens linearly between 0 and the upper bound of the lowest bucket.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// However, if the lowest bucket has an upper bound less or equal 0, this upper\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// bound is returned if the quantile falls into the lowest bucket.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e//\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// There are a number of special cases (once we have a way to report errors\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// happening during evaluations of AST functions, we should report those\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// explicitly):\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e//\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// If \\u0026#39;buckets\\u0026#39; has 0 observations, NaN is returned.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e//\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// If \\u0026#39;buckets\\u0026#39; has fewer than 2 elements, NaN is returned.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e//\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// If the highest bucket is not +Inf, NaN is returned.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e//\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// If q==NaN, NaN is returned.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e//\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// If q\\u0026lt;0, -Inf is returned.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"c1\\\"\\u003e//\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"c1\\\"\\u003e// If q\\u0026gt;1, +Inf is returned.\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"kd\\\"\\u003efunc\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003ebucketQuantile\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eq\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"kt\\\"\\u003efloat64\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"kt\\\"\\u003efloat64\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emath\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eIsNaN\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eq\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003ereturn\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emath\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eNaN\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e()\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eq\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e\\u0026lt;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003ereturn\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emath\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eInf\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e-\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e1\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eq\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e\\u0026gt;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e1\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003ereturn\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emath\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eInf\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e+\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e1\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eslices\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eSortFunc\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"kd\\\"\\u003efunc\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ea\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eb\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebucket\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"kt\\\"\\u003ebool\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003ereturn\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ea\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eupperBound\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e\\u0026lt;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eb\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eupperBound\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e})\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e!\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emath\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eIsInf\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003elen\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e-\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e1\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eupperBound\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e+\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e1\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003ereturn\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emath\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eNaN\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e()\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003ecoalesceBuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eensureMonotonic\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003elen\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e\\u0026lt;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e2\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003ereturn\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emath\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eNaN\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e()\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eobservations\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003elen\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e-\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e1\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ecount\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eobservations\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e==\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003ereturn\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emath\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eNaN\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e()\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003erank\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eq\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e*\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eobservations\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eb\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003esort\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eSearch\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003elen\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e-\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e1\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"kd\\\"\\u003efunc\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ei\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"kt\\\"\\u003eint\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"kt\\\"\\u003ebool\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003ereturn\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ei\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ecount\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e\\u0026gt;=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003erank\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e})\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eb\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e==\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003elen\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e-\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e1\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003ereturn\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003elen\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e-\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e2\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eupperBound\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eb\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e==\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e\\u0026amp;\\u0026amp;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eupperBound\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e\\u0026lt;=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003ereturn\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eupperBound\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"kd\\\"\\u003evar\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebucketStart\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"kt\\\"\\u003efloat64\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebucketEnd\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e   \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eb\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eupperBound\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ecount\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e       \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eb\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ecount\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003eif\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eb\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e\\u0026gt;\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e0\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebucketStart\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eb\\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e-\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e1\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eupperBound\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ecount\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e-=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eb\\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e-\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e1\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ecount\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003erank\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e-=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eb\\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e-\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e1\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ecount\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003ereturn\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebucketStart\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e+\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebucketEnd\\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e-\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebucketStart\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e*\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003erank\\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e/\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ecount\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/code\\u003e\\u003c/pre\\u003e\\u003c/td\\u003e\\u003c/tr\\u003e\\u003c/table\\u003e\\n\\u003c/div\\u003e\\n\\u003c/div\\u003e\\u003cp\\u003e相关资料\\u003c/p\\u003e\\n\\u003cul\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://stackoverflow.com/questions/55162093/understanding-histogram-quantile-based-on-rate-in-prometheus\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://stackoverflow.com/questions/55162093/understanding-histogram-quantile-based-on-rate-in-prometheus\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003cli\\u003e\\u003ca class=\\\"link\\\" href=\\\"https://stackoverflow.com/questions/60962520/how-to-get-the-quantile-of-rate-in-prometheus/65418483#65418483\\\"  target=\\\"_blank\\\" rel=\\\"noopener\\\"\\n    \\u003ehttps://stackoverflow.com/questions/60962520/how-to-get-the-quantile-of-rate-in-prometheus/65418483#65418483\\u003c/a\\u003e\\u003c/li\\u003e\\n\\u003c/ul\\u003e\\n\\u003cp\\u003e可以在 prometheus 项目下执行下面的单测：\\u003c/p\\u003e\\n\\u003cdiv class=\\\"highlight\\\"\\u003e\\u003cdiv class=\\\"chroma\\\"\\u003e\\n\\u003ctable class=\\\"lntable\\\"\\u003e\\u003ctr\\u003e\\u003ctd class=\\\"lntd\\\"\\u003e\\n\\u003cpre tabindex=\\\"0\\\" class=\\\"chroma\\\"\\u003e\\u003ccode\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 1\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 2\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 3\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 4\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 5\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 6\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 7\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 8\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e 9\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e10\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e11\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e12\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e13\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e14\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e15\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e16\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e17\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e18\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e19\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e20\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e21\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e22\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e23\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e24\\n\\u003c/span\\u003e\\u003cspan class=\\\"lnt\\\"\\u003e25\\n\\u003c/span\\u003e\\u003c/code\\u003e\\u003c/pre\\u003e\\u003c/td\\u003e\\n\\u003ctd class=\\\"lntd\\\"\\u003e\\n\\u003cpre tabindex=\\\"0\\\" class=\\\"chroma\\\"\\u003e\\u003ccode class=\\\"language-GO\\\" data-lang=\\\"GO\\\"\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"kd\\\"\\u003efunc\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eTestBucketQuantile__rate5m\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003et\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e*\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003etesting\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eT\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eq\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mf\\\"\\u003e0.4\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emyBuckets\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ebuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e10\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e5\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e},\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e20\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e8\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e},\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e30\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e12\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e},\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e40\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e15\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e},\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emath\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003eInf\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e1\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e),\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e15\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e},\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ef\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003ebucketQuantile\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eq\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emyBuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003eprintln\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"s\\\"\\u003e\\u0026#34;==== before rate =====\\u0026#34;\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003efmt\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003ePrintln\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emyBuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003efmt\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003ePrintf\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"s\\\"\\u003e\\u0026#34;%.2f\\\\n\\u0026#34;\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ef\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003efor\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ei\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emyBucket\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"k\\\"\\u003erange\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emyBuckets\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e{\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e        \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emyBuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e[\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ei\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e].\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ecount\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emyBucket\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ecount\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e/\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003efloat64\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e5\\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e*\\u003c/span\\u003e\\u003cspan class=\\\"mi\\\"\\u003e60\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nb\\\"\\u003eprintln\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"s\\\"\\u003e\\u0026#34;==== after rate =====\\u0026#34;\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003efmt\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003ePrintln\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emyBuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ef1\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"o\\\"\\u003e:=\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003ebucketQuantile\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003eq\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003emyBuckets\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e    \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003efmt\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e.\\u003c/span\\u003e\\u003cspan class=\\\"nf\\\"\\u003ePrintf\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e(\\u003c/span\\u003e\\u003cspan class=\\\"s\\\"\\u003e\\u0026#34;%.2f\\\\n\\u0026#34;\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e,\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e \\u003c/span\\u003e\\u003cspan class=\\\"nx\\\"\\u003ef1\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e)\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"line\\\"\\u003e\\u003cspan class=\\\"cl\\\"\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\u003c/span\\u003e\\u003cspan class=\\\"p\\\"\\u003e}\\u003c/span\\u003e\\u003cspan class=\\\"w\\\"\\u003e\\n\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/span\\u003e\\u003c/code\\u003e\\u003c/pre\\u003e\\u003c/td\\u003e\\u003c/tr\\u003e\\u003c/table\\u003e\\n\\u003c/div\\u003e\\n\\u003c/div\\u003e\"",
  "author": {
    "@type": "Person",
    "name": "\"孟柱\"",
    "image": "\"https://zhumengzhu.github.io//img/avatar.jpg\"",
    "description": "\"一个有点懒、有点笨，又爱刨根问底的程序员。A programmer who is a bit lazy, a bit slow-witted, yet loves to dig deep into the roots of things.\""
  },
  "datePublished": "\"2022-10-11T22:09:19+08:00\"",
  "dateModified": "\"2024-12-10T22:09:19+08:00\"",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "\"https://zhumengzhu.github.io/2022/10/prometheus-and-grafana-learning-notes/\""
  },
  "publisher": {
    "@type": "Organization",
    "name": "\"Somnus\"",
    "url": "\"https://zhumengzhu.github.io/\""
  },
  "keywords": "\"Prometheus, Grafana\"",
  "articleSection": "\"post\"",
  "url": "\"https://zhumengzhu.github.io/2022/10/prometheus-and-grafana-learning-notes/\""
}
</script>
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_5215dd1208300fe9.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">💯</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Somnus</a></h1>
            <h2 class="site-description">孟柱的小窝</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/zhumengzhu'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://stackoverflow.com/users/3496176/zhumengzhu'
                        target="_blank"
                        title="stack overflow"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-brand-stackoverflow"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 17v1a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-1" /><path d="M8 16h8" /><path d="M8.322 12.582l7.956 .836" /><path d="M8.787 9.168l7.826 1.664" /><path d="M10.096 5.764l7.608 2.472" /></svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
    
    
    
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#promql">PromQL</a>
      <ol>
        <li><a href="#基本概念">基本概念</a></li>
        <li><a href="#instant-vector-vs-range-vector">Instant vector vs Range vector</a></li>
        <li><a href="#rate-then-sum-never-sum-then-rate">Rate then sum, never sum then rate</a></li>
        <li><a href="#the-problem-of-rateincrease-extrapolation-in-prometheus">The problem of rate()/increase() extrapolation in Prometheus</a></li>
        <li><a href="#aggregating-the-precomputed-quantiles-from-a-summary-makes-no-sense">Aggregating the precomputed quantiles from a summary makes no sense</a></li>
        <li><a href="#errors-of-quantile-estimation">Errors of quantile estimation</a></li>
        <li><a href="#best-practices">Best practices</a></li>
        <li><a href="#queries-examples">Queries Examples</a></li>
      </ol>
    </li>
    <li><a href="#prometheus-的各种问题">Prometheus 的各种问题</a>
      <ol>
        <li><a href="#高基数问题high-cardinality-problem">高基数问题(High-Cardinality Problem)</a></li>
        <li><a href="#counter-重置导致的问题">Counter 重置导致的问题</a>
          <ol>
            <li><a href="#rateincrease-是如何处理-counter-重置的">rate/increase 是如何处理 counter 重置的？</a></li>
          </ol>
        </li>
        <li><a href="#prometheus-报警不准问题">Prometheus 报警不准问题</a></li>
      </ol>
    </li>
    <li><a href="#prometheus-alertmanager">Prometheus: Alertmanager</a>
      <ol>
        <li><a href="#架构图">架构图</a></li>
        <li><a href="#为什么要-alertmanager">为什么要 Alertmanager？</a></li>
        <li><a href="#routing-tree">Routing Tree</a></li>
        <li><a href="#notification-pipeline">Notification Pipeline</a></li>
      </ol>
    </li>
    <li><a href="#prometheus存储机制">Prometheus存储机制</a></li>
    <li><a href="#深入-promql">深入 PromQL</a>
      <ol>
        <li><a href="#bascis">Bascis</a></li>
        <li><a href="#functions">Functions</a>
          <ol>
            <li><a href="#rate--increase">Rate &amp; Increase</a></li>
            <li><a href="#histogramquantitle">histogramQuantitle</a></li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

    
    
    
</aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/learning-journal/" >
                Learning Journal
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/2022/10/prometheus-and-grafana-learning-notes/">Prometheus &amp; Grafana 学习记录</a>
        </h2>
    
        
    </div>

    
        <footer class="article-time">
            
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                    <time class="article-time--published">2022/10/11</time>
                </div>
            

            
            
                        最后修改于:
                        <time class="article-time--updated" datetime="2024-12-10 22:09:19 &#43;0800 CST" title="2024-12-10 22:09:19 &#43;0800 CST">
                            2024/12/10 22:09 CST
                        </time>

            
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                    <time class="article-time--reading">
                        阅读时长: 12 分钟
                    </time>
                </div>
            
        </footer>
    


    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="promql">PromQL
</h2><p>参考：https://blog.csdn.net/han949417140/article/details/113513227</p>
<p>官网：https://prometheus.io/docs/prometheus/latest/querying/basics/</p>
<ul>
<li><a class="link" href="https://grafana.com/docs/grafana/v7.5/panels/queries/"  target="_blank" rel="noopener"
    >https://grafana.com/docs/grafana/v7.5/panels/queries/</a></li>
<li><a class="link" href="https://prometheus.fuckcloudnative.io/di-san-zhang-prometheus/di-4-jie-cha-xun/basics"  target="_blank" rel="noopener"
    >https://prometheus.fuckcloudnative.io/di-san-zhang-prometheus/di-4-jie-cha-xun/basics</a></li>
<li><a class="link" href="https://github.com/google/re2/wiki/Syntax"  target="_blank" rel="noopener"
    >https://github.com/google/re2/wiki/Syntax</a></li>
</ul>
<h3 id="基本概念">基本概念
</h3><pre><code>- 时间序列(time-series)
    - 样本
        - time-series 是按照时间戳和值的序列顺序存放的，我们称之为向量(vector)
            - 每条 time-series 通过指标名称(metrics name)和一组标签集(labelset)命名
        - 在time-series中的每一个点称为一个样本（sample），样本由以下三部分组成：
            - 指标(metric)：metric name和描述当前样本特征的labelsets;
            - 时间戳(timestamp)：一个精确到毫秒的时间戳;
            - 样本值(value)： 一个float64的浮点型数据表示当前样本的值。
    - 指标(Metric)
        - 在形式上，所有的指标(Metric)都通过如下格式标示：
            - &lt;metric name&gt;{&lt;label name&gt;=&lt;label value&gt;, ...}
                - 指标的名称(metric name)可以反映被监控样本的含义（比如，http_request_total - 表示当前系统接收到的HTTP请求总量）
                - 标签(label)反映了当前样本的特征维度，通过这些维度Prometheus可以对样本数据进行过滤，聚合等
        - 以__作为前缀的标签，是系统保留的关键字，只能在系统内部使用
- Metrics类型
    - Prometheus定义了4种不同的指标类型(metric type)：Counter（计数器）、Gauge（仪表盘）、Histogram（直方图）、Summary（摘要）
    - Counter：只增不减的计数器
        - Counter类型的指标其工作方式和计数器一样，只增不减（除非系统发生重置）。
        - 常见的监控指标，如http_requests_total，node_cpu都是Counter类型的监控指标。 一般在定义Counter类型指标的名称时推荐使用_total作为后缀。
        - //例如，通过rate()函数获取HTTP请求量的增长率： rate(http_requests_total[5m])
        - //查询当前系统中，访问量前10的HTTP地址： topk(10, http_requests_total)
    - Gauge：可增可减的仪表盘
        - 与Counter不同，Gauge类型的指标侧重于反应系统的当前状态。因此这类指标的样本数据可增可减。
        - 常见指标如：node_memory_MemFree（主机当前空闲的内容大小）、node_memory_MemAvailable（可用内存大小）都是Gauge类型的监控指标。
        - //通过Gauge指标，用户可以直接查看系统的当前状态：node_memory_MemFree
        - //还可以使用deriv()计算样本的线性回归模型，甚至是直接使用predict_linear()对数据的变化趋势进行预测。
            - 例如，预测系统磁盘空间在4个小时之后的剩余情况：predict_linear(node_filesystem_free{job=&quot;node&quot;}[1h], 4 * 3600)
    - Histogram和Summary分析数据分布情况
</code></pre>
<h3 id="instant-vector-vs-range-vector">Instant vector vs Range vector
</h3><ul>
<li><a class="link" href="https://stackoverflow.com/questions/68223824/prometheus-instant-vector-vs-range-vector"  target="_blank" rel="noopener"
    >https://stackoverflow.com/questions/68223824/prometheus-instant-vector-vs-range-vector</a></li>
<li><a class="link" href="https://satyanash.net/software/2021/01/04/understanding-prometheus-range-vectors.html"  target="_blank" rel="noopener"
    >https://satyanash.net/software/2021/01/04/understanding-prometheus-range-vectors.html</a></li>
<li><a class="link" href="https://promlabs.com/blog/2020/06/18/the-anatomy-of-a-promql-query/"  target="_blank" rel="noopener"
    >https://promlabs.com/blog/2020/06/18/the-anatomy-of-a-promql-query/</a></li>
</ul>
<h3 id="rate-then-sum-never-sum-then-rate">Rate then sum, never sum then rate
</h3><ul>
<li><a class="link" href="https://www.robustperception.io/rate-then-sum-never-sum-then-rate/"  target="_blank" rel="noopener"
    >https://www.robustperception.io/rate-then-sum-never-sum-then-rate/</a></li>
</ul>
<blockquote>
<p>To help keep you on the straight and narrow, remember this:</p>
<p>The only mathematical operations you can safely directly apply to a counter&rsquo;s values are rate, irate, increase, and resets. Anything else will cause you problems.</p></blockquote>
<h3 id="the-problem-of-rateincrease-extrapolation-in-prometheus">The problem of rate()/increase() extrapolation in Prometheus
</h3><ul>
<li><a class="link" href="https://stackoverflow.com/questions/52697517/prometheus-how-to-rate-a-sum-of-the-same-counter-from-different-machines?rq=3"  target="_blank" rel="noopener"
    >https://stackoverflow.com/questions/52697517/prometheus-how-to-rate-a-sum-of-the-same-counter-from-different-machines?rq=3</a></li>
<li><a class="link" href="https://github.com/prometheus/prometheus/issues/3746"  target="_blank" rel="noopener"
    >https://github.com/prometheus/prometheus/issues/3746</a></li>
<li><a class="link" href="https://github.com/prometheus/prometheus/issues/3806"  target="_blank" rel="noopener"
    >https://github.com/prometheus/prometheus/issues/3806</a></li>
<li><a class="link" href="https://github.com/VictoriaMetrics/VictoriaMetrics/issues/1215"  target="_blank" rel="noopener"
    >https://github.com/VictoriaMetrics/VictoriaMetrics/issues/1215</a></li>
<li><a class="link" href="https://docs.google.com/document/d/1y2Mp041_2v0blnKnZk7keCnJZICeK2YWUQuXH_m4DVc/edit?pli=1&amp;tab=t.0#heading=h.bupciudrwmna"  target="_blank" rel="noopener"
    >https://docs.google.com/document/d/1y2Mp041_2v0blnKnZk7keCnJZICeK2YWUQuXH_m4DVc/edit?pli=1&tab=t.0#heading=h.bupciudrwmna</a></li>
<li><a class="link" href="https://lotabout.me/2019/QQA-Why-Prometheus-increase-return-float/"  target="_blank" rel="noopener"
    >https://lotabout.me/2019/QQA-Why-Prometheus-increase-return-float/</a> (中文带图)</li>
</ul>
<h3 id="aggregating-the-precomputed-quantiles-from-a-summary-makes-no-sense">Aggregating the precomputed quantiles from a summary makes no sense
</h3><blockquote>
<p><a class="link" href="https://prometheus.io/docs/practices/histograms/#count-and-sum-of-observations"  target="_blank" rel="noopener"
    >https://prometheus.io/docs/practices/histograms/#count-and-sum-of-observations</a>
avg(http_request_duration_seconds{quantile=&ldquo;0.95&rdquo;}) // BAD!
histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) // GOOD.</p></blockquote>
<h3 id="errors-of-quantile-estimation">Errors of quantile estimation
</h3><blockquote>
<p><a class="link" href="https://prometheus.io/docs/practices/histograms/#errors-of-quantile-estimation"  target="_blank" rel="noopener"
    >https://prometheus.io/docs/practices/histograms/#errors-of-quantile-estimation</a>
Quantiles, whether calculated client-side or server-side, are estimated. It is important to understand the errors of that estimation.</p></blockquote>
<blockquote>
<p>Continuing the histogram example from above, imagine your usual request durations are almost all very close to 220ms, or in other words, if you could plot the &ldquo;true&rdquo; histogram, you would see a very sharp spike at 220ms. In the Prometheus histogram metric as configured above, almost all observations, and therefore also the 95th percentile, will fall into the bucket labeled {le=&ldquo;0.3&rdquo;}, i.e. the bucket from 200ms to 300ms. The histogram implementation guarantees that the true 95th percentile is somewhere between 200ms and 300ms. To return a single value (rather than an interval), it applies linear interpolation, which yields 295ms in this case. The calculated quantile gives you the impression that you are close to breaching the SLO, but in reality, the 95th percentile is a tiny bit above 220ms, a quite comfortable distance to your SLO.</p></blockquote>
<blockquote>
<p>Next step in our thought experiment: A change in backend routing adds a fixed amount of 100ms to all request durations. Now the request duration has its sharp spike at 320ms and almost all observations will fall into the bucket from 300ms to 450ms. The 95th percentile is calculated to be 442.5ms, although the correct value is close to 320ms. While you are only a tiny bit outside of your SLO, the calculated 95th quantile looks much worse.</p></blockquote>
<h3 id="best-practices">Best practices
</h3><p><a class="link" href="https://grafana.com/docs/grafana/v7.5/best-practices/"  target="_blank" rel="noopener"
    >https://grafana.com/docs/grafana/v7.5/best-practices/</a></p>
<h3 id="queries-examples">Queries Examples
</h3><p><a class="link" href="https://prometheus.io/docs/prometheus/2.39/querying/examples/"  target="_blank" rel="noopener"
    >https://prometheus.io/docs/prometheus/2.39/querying/examples/</a></p>
<h2 id="prometheus-的各种问题">Prometheus 的各种问题
</h2><ul>
<li><a class="link" href="http://www.xuyasong.com/?p=1921"  target="_blank" rel="noopener"
    >http://www.xuyasong.com/?p=1921</a></li>
<li><a class="link" href="https://aleiwu.com/post/prometheus-bp/"  target="_blank" rel="noopener"
    >https://aleiwu.com/post/prometheus-bp/</a></li>
<li><a class="link" href="https://develotters.com/posts/high-cardinality/"  target="_blank" rel="noopener"
    >https://develotters.com/posts/high-cardinality/</a></li>
</ul>
<h3 id="高基数问题high-cardinality-problem">高基数问题(High-Cardinality Problem)
</h3><p>2.16 版本以上的 Prometheus 直接支持查看 TSDB 的状态：</p>
<h3 id="counter-重置导致的问题">Counter 重置导致的问题
</h3><p>Counter 是四种 Metrics 类型中的一种，它的值只会增加(incr)或者重置(reset, 一般是因为实例重启)。</p>
<p>PromQL 的 rate()和increase() 函数会自动处理 Counter 重置的情况，但 sum 不会，所以很多文档都强调一定要先 rate 再 sum，而不能先 sum 再 rate。</p>
<h4 id="rateincrease-是如何处理-counter-重置的">rate/increase 是如何处理 counter 重置的？
</h4><p>具体的处理代码为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="line"><span class="cl"><span class="c1">// Handle counter resets:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nx">resultFloat</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">samples</span><span class="p">.</span><span class="nx">Floats</span><span class="p">[</span><span class="nx">numSamplesMinusOne</span><span class="p">].</span><span class="nx">F</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">samples</span><span class="p">.</span><span class="nx">Floats</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">F</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nx">prevValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">samples</span><span class="p">.</span><span class="nx">Floats</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">F</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">currPoint</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">samples</span><span class="p">.</span><span class="nx">Floats</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">currPoint</span><span class="p">.</span><span class="nx">F</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">prevValue</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">resultFloat</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">prevValue</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">prevValue</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">currPoint</span><span class="p">.</span><span class="nx">F</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>首先遍历样本，如果发现 Counter 减少就认为发生了重置，后续所有样本值都会加上重置前的值。</p>
<p>举个栗子，假设时间序列的值为[5,10,4,6]，那么它会被处理为[5,10,14,16]。</p>
<h3 id="prometheus-报警不准问题">Prometheus 报警不准问题
</h3><ul>
<li><a class="link" href="https://aleiwu.com/post/prometheus-alert-why/"  target="_blank" rel="noopener"
    >https://aleiwu.com/post/prometheus-alert-why/</a>
报警不准，指的是两类问题：</li>
<li>『该报』的警没报；</li>
<li>『不该报』的警报了；
这里的『该报』和『不该报』都是基于 Grafana 进行判断的。所以这里说报警不准，本质是 Grafana 的仪表盘展示结果和 Prometheus 告警不一致。</li>
</ul>
<p>这个问题本质是『采样间隔』不一致的：</p>
<ul>
<li>Prometheus 的告警器会按固定的时间间隔采样，在一个周期内，如果样本满足告警规则；</li>
<li>Grafana 渲染图标的结果，则取决于基于 Range Query 采样点的分布；</li>
</ul>
<p>很可能出现，Prometheus 采样时捕获了『低谷』但 Grafana 忽略了『低谷』导致『不该报』的警报了，或者 Prometheus 忽略了『低谷』而 Grafana 捕获了『低谷』导致『该报』的警没报。</p>
<h2 id="prometheus-alertmanager">Prometheus: Alertmanager
</h2><h3 id="架构图">架构图
</h3><p><img src="/images/alertmanager.png"
	
	
	
	loading="lazy"
	
		alt="image1"
	
	
></p>
<h3 id="为什么要-alertmanager">为什么要 Alertmanager？
</h3><p>当 Prometheus Server 计算出一些警报后，它自己并没有能力将这些警报通知出去，只能将警报推给 Alertmanager，由 Alertmanager 进行发送。</p>
<p>这个切分，一方面是出于单一职责的考虑，让 Prometheus “do one thing and do it well”, 另一方面则是因为<strong>警报发送确实不是一件”简单”的事，需要一个专门的系统来做好它</strong>。</p>
<p>可以这么说，<strong>Alertmanager 的目标不是简单地”发出警报”，而是”发出高质量的警报”</strong>。它提供的高级功能包括但不限于：</p>
<ul>
<li>Go Template 渲染警报内容；</li>
<li>管理警报的重复提醒时机与消除后消除通知的发送；</li>
<li>根据标签定义警报路由，实现警报的优先级、接收人划分，并针对不同的优先级和接收人定制不同的发送策略；</li>
<li>将同类型警报打包成一条通知发送出去，降低警报通知的频率；</li>
<li>支持静默规则: 用户可以定义一条静默规则，在一段时间内停止发送部分特定的警报，比如已经确认是搜索集群问题，在修复搜索集群时，先静默掉搜索集群相关警报；</li>
<li>支持”抑制”规则(Inhibition Rule): 用户可以定义一条”抑制”规则，规定在某种警报发生时，不发送另一种警报，比如在”A 机房网络故障”这条警报发生时，不发送所有”A 机房中的警报”；</li>
</ul>
<h3 id="routing-tree">Routing Tree
</h3><p>Routing Tree 的设计意图是让用户能够非常自由地给警报归类，然后根据归类后的类别来配置要发送给谁以及怎么发送：</p>
<ul>
<li>发送给谁？上面已经做了很好的示例，’数据库警报’和’前端警报’都有特定的接收组，都没有匹配上那么就是’默认警报’, 发送给默认接收组</li>
<li>怎么发送？对于一类警报，有个多个字段来配置发送行为：
<ul>
<li>group_by：决定了警报怎么分组，每个 group 只会定时产生一次通知，这就达到了降噪的效果，而不同的警报类别分组方式显然是不一样的，举个例子：
<ul>
<li>配置中的 ‘数据库警报’ 是按 ‘集群’ 和 ‘规则名’ 分组的，这表明对于数据库警报，我们关心的是“哪个集群的哪个规则出问题了”，比如一个时间段内，’华东’集群产生了10条 ‘API响应时间过长’ 警报，- 这些警报就会聚合在一个通知里发出来；</li>
<li>配置中的 ‘前端警报’ 是按 ‘产品’ 和 ‘环境’ 分组的， 这表明对于前端警报，我们关心的是“哪个产品的哪个环境出问题了”</li>
</ul>
</li>
<li>group_interval 和 group_wait: 控制分组的细节，不细谈，其中 group_interval 控制了这个分组最快多久执行一次 Notification Pipeline</li>
<li>repeat_interval: 假如一个相同的警报一直 FIRING，Alertmanager 并不会一直发送警报，而会等待一段时间，这个等待时间就是 repeat_interval，显然，不同类型警报的发送频率也是不一样的</li>
</ul>
</li>
</ul>
<h3 id="notification-pipeline">Notification Pipeline
</h3><p>要重点说的是DedupStage和NotifySetStage它俩协同负责去重工作，具体做法是：</p>
<ul>
<li>NotifySetStage 会为发送成功的警报记录一条发送通知，key 是’接收组名字’+’GroupKey 的 key 值’，value 是当前 Stage 收到的 []Alert (这个列表和最开始进入 Notification Pipeline 的警报列表有可能是不同的，因为其中有些 Alert 可能在前置 Stage 中已经被过滤掉了)</li>
<li>DedupStage 中会以’接收组名字’+’GroupKey 的 key 值’为 key 查询通知记录，假如：
<ul>
<li>查询无结果，那么这条通知没发过，为这组警报发送一条通知；</li>
<li>查询有结果，那么查询得到已经发送过的一组警报 S，判断当前的这组警报 A 是否为 S 的子集：
<ul>
<li>假如 A 是 S 的子集，那么表明 A 和 S 重复，这时候要根据 repeat_interval 来决定是否再次发送：
<ul>
<li>距离 S 的发送时间已经过去了足够久（repeat_interval)，那么我们要再发送一遍；</li>
<li>距离 S 的发送时间还没有达到 repeat_interval，那么为了降低警报频率，触发去重逻辑，这次我们就不发了；</li>
</ul>
</li>
<li>假如 A 不是 S 的子集，那么 A 和 S 不重复，需要再发送一次； 上面的表述可能有些抽象，最后表现出来的结果是：</li>
</ul>
</li>
</ul>
</li>
<li>假如一个 AlertGroup 里的警报一直发生变化，那么虽然每次都是新警报，不会被去重，但是由于 group_interval （假设是5分钟）存在，这个 AlertGroup 最多 5 分钟触发一次 Notification Pipeline，因此最多也只会 5 分钟发送一条通知；</li>
<li>假如一个 AlertGroup 里的警报一直不变化，就是那么几条一直 FIRING 着，那么虽然每个 group_interval 都会触发 Notification Pipeline，但是由于 repeate_interval（假设是1小时）存在，因此最多也只会每 1 小时为这个重复的警报发送一条通知；
再说一下 Silence 和 Inhibit，两者都是基于用户主动定义的规则的：</li>
<li>Silence Rule：静默规则用来关闭掉部分警报的通知，比如某个性能问题已经修复了，但需要排期上线，那么在上线前就可以把对应的警报静默掉来减少噪音；</li>
<li>Inhibit Rule：抑制规则用于在某类警报发生时，抑制掉另一类警报，比如某个机房宕机了，那么会影响所有上层服务，产生级联的警报洪流，反而会掩盖掉根本原因，这时候抑制规则就有用了； 因此 Notification Pipeline 的设计意图就很明确了：通过一系列逻辑（如抑制、静默、去重）来获得更高的警报质量，由于警报质量的维度很多（剔除重复、类似的警报，静默暂时无用的警报，抑制级联警报），因此 Notification Pipeline 设计成了责任链模式，以便于随时添加新的环节来优化警报质量</li>
</ul>
<h2 id="prometheus存储机制">Prometheus存储机制
</h2><ul>
<li><a class="link" href="http://www.xuyasong.com/?p=1601"  target="_blank" rel="noopener"
    >http://www.xuyasong.com/?p=1601</a></li>
</ul>
<h2 id="深入-promql">深入 PromQL
</h2><h3 id="bascis">Bascis
</h3><ul>
<li><a class="link" href="https://stackoverflow.com/questions/68223824/prometheus-instant-vector-vs-range-vector"  target="_blank" rel="noopener"
    >https://stackoverflow.com/questions/68223824/prometheus-instant-vector-vs-range-vector</a></li>
<li><a class="link" href="https://satyanash.net/software/2021/01/04/understanding-prometheus-range-vectors.html"  target="_blank" rel="noopener"
    >https://satyanash.net/software/2021/01/04/understanding-prometheus-range-vectors.html</a></li>
<li><a class="link" href="https://promlabs.com/blog/2020/06/18/the-anatomy-of-a-promql-query/"  target="_blank" rel="noopener"
    >https://promlabs.com/blog/2020/06/18/the-anatomy-of-a-promql-query/</a></li>
<li>Prometheus Querying - Breaking Down PromQL</li>
</ul>
<h3 id="functions">Functions
</h3><h4 id="rate--increase">Rate &amp; Increase
</h4><ul>
<li><a class="link" href="https://promlabs.com/blog/2021/01/29/how-exactly-does-promql-calculate-rates/"  target="_blank" rel="noopener"
    >https://promlabs.com/blog/2021/01/29/how-exactly-does-promql-calculate-rates/</a></li>
<li><a class="link" href="https://stackoverflow.com/questions/54494394/do-i-understand-prometheuss-rate-vs-increase-functions-correctly?rq=3"  target="_blank" rel="noopener"
    >https://stackoverflow.com/questions/54494394/do-i-understand-prometheuss-rate-vs-increase-functions-correctly?rq=3</a></li>
<li><a class="link" href="https://stackoverflow.com/questions/48218950/increase-in-prometheus-sometimes-doubles-values-how-to-avoid?rq=3"  target="_blank" rel="noopener"
    >https://stackoverflow.com/questions/48218950/increase-in-prometheus-sometimes-doubles-values-how-to-avoid?rq=3</a></li>
<li><a class="link" href="https://stackoverflow.com/questions/52697517/prometheus-how-to-rate-a-sum-of-the-same-counter-from-different-machines"  target="_blank" rel="noopener"
    >https://stackoverflow.com/questions/52697517/prometheus-how-to-rate-a-sum-of-the-same-counter-from-different-machines</a></li>
<li><a class="link" href="https://github.com/VictoriaMetrics/VictoriaMetrics/issues/1215"  target="_blank" rel="noopener"
    >https://github.com/VictoriaMetrics/VictoriaMetrics/issues/1215</a></li>
<li><a class="link" href="https://stackoverflow.com/questions/70835778/understanding-increase-and-rate-used-on-http-server-requests-seconds-count-w"  target="_blank" rel="noopener"
    >https://stackoverflow.com/questions/70835778/understanding-increase-and-rate-used-on-http-server-requests-seconds-count-w</a></li>
</ul>
<p>由于 prometheus 使用了线性插值算法取计算 increase(增量)，所以计算结果会得到小数，这一点特别容易让人误解。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-GO" data-lang="GO"><span class="line"><span class="cl"><span class="c1">// === rate(node parser.ValueTypeMatrix) Vector ===</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">func</span><span class="w"> </span><span class="nf">funcRate</span><span class="p">(</span><span class="nx">vals</span><span class="w"> </span><span class="p">[]</span><span class="nx">parser</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="w"> </span><span class="nx">parser</span><span class="p">.</span><span class="nx">Expressions</span><span class="p">,</span><span class="w"> </span><span class="nx">enh</span><span class="w"> </span><span class="o">*</span><span class="nx">EvalNodeHelper</span><span class="p">)</span><span class="w"> </span><span class="nx">Vector</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nf">extrapolatedRate</span><span class="p">(</span><span class="nx">vals</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">,</span><span class="w"> </span><span class="nx">enh</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// === increase(node parser.ValueTypeMatrix) Vector ===</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">func</span><span class="w"> </span><span class="nf">funcIncrease</span><span class="p">(</span><span class="nx">vals</span><span class="w"> </span><span class="p">[]</span><span class="nx">parser</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="w"> </span><span class="nx">parser</span><span class="p">.</span><span class="nx">Expressions</span><span class="p">,</span><span class="w"> </span><span class="nx">enh</span><span class="w"> </span><span class="o">*</span><span class="nx">EvalNodeHelper</span><span class="p">)</span><span class="w"> </span><span class="nx">Vector</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nf">extrapolatedRate</span><span class="p">(</span><span class="nx">vals</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">,</span><span class="w"> </span><span class="nx">enh</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// extrapolatedRate is a utility function for rate/increase/delta.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// It calculates the rate (allowing for counter resets if isCounter is true),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// extrapolates if the first/last sample is close to the boundary, and returns</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// the result as either per-second (if isRate is true) or overall.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">func</span><span class="w"> </span><span class="nf">extrapolatedRate</span><span class="p">(</span><span class="nx">vals</span><span class="w"> </span><span class="p">[]</span><span class="nx">parser</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="w"> </span><span class="nx">parser</span><span class="p">.</span><span class="nx">Expressions</span><span class="p">,</span><span class="w"> </span><span class="nx">enh</span><span class="w"> </span><span class="o">*</span><span class="nx">EvalNodeHelper</span><span class="p">,</span><span class="w"> </span><span class="nx">isCounter</span><span class="p">,</span><span class="w"> </span><span class="nx">isRate</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="nx">Vector</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">ms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].(</span><span class="o">*</span><span class="nx">parser</span><span class="p">.</span><span class="nx">MatrixSelector</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">vs</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ms</span><span class="p">.</span><span class="nx">VectorSelector</span><span class="p">.(</span><span class="o">*</span><span class="nx">parser</span><span class="p">.</span><span class="nx">VectorSelector</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">samples</span><span class="w">            </span><span class="p">=</span><span class="w"> </span><span class="nx">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">].(</span><span class="nx">Matrix</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">rangeStart</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="nx">enh</span><span class="p">.</span><span class="nx">Ts</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">durationMilliseconds</span><span class="p">(</span><span class="nx">ms</span><span class="p">.</span><span class="nx">Range</span><span class="o">+</span><span class="nx">vs</span><span class="p">.</span><span class="nx">Offset</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">rangeEnd</span><span class="w">           </span><span class="p">=</span><span class="w"> </span><span class="nx">enh</span><span class="p">.</span><span class="nx">Ts</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">durationMilliseconds</span><span class="p">(</span><span class="nx">vs</span><span class="p">.</span><span class="nx">Offset</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">resultFloat</span><span class="w">        </span><span class="kt">float64</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">resultHistogram</span><span class="w">    </span><span class="o">*</span><span class="nx">histogram</span><span class="p">.</span><span class="nx">FloatHistogram</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">firstT</span><span class="p">,</span><span class="w"> </span><span class="nx">lastT</span><span class="w">      </span><span class="kt">int64</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">numSamplesMinusOne</span><span class="w"> </span><span class="kt">int</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// We need either at least two Histograms and no Floats, or at least two</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Floats and no Histograms to calculate a rate. Otherwise, drop this</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Vector element.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">samples</span><span class="p">.</span><span class="nx">Histograms</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">samples</span><span class="p">.</span><span class="nx">Floats</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Mix of histograms and floats. TODO(beorn7): Communicate this failure reason.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">enh</span><span class="p">.</span><span class="nx">Out</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">samples</span><span class="p">.</span><span class="nx">Histograms</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">numSamplesMinusOne</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">samples</span><span class="p">.</span><span class="nx">Histograms</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">firstT</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">samples</span><span class="p">.</span><span class="nx">Histograms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">T</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">lastT</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">samples</span><span class="p">.</span><span class="nx">Histograms</span><span class="p">[</span><span class="nx">numSamplesMinusOne</span><span class="p">].</span><span class="nx">T</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">resultHistogram</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">histogramRate</span><span class="p">(</span><span class="nx">samples</span><span class="p">.</span><span class="nx">Histograms</span><span class="p">,</span><span class="w"> </span><span class="nx">isCounter</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">resultHistogram</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// The histograms are not compatible with each other.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// TODO(beorn7): Communicate this failure reason.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">enh</span><span class="p">.</span><span class="nx">Out</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">samples</span><span class="p">.</span><span class="nx">Floats</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">numSamplesMinusOne</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">samples</span><span class="p">.</span><span class="nx">Floats</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">firstT</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">samples</span><span class="p">.</span><span class="nx">Floats</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">T</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">lastT</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">samples</span><span class="p">.</span><span class="nx">Floats</span><span class="p">[</span><span class="nx">numSamplesMinusOne</span><span class="p">].</span><span class="nx">T</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">resultFloat</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">samples</span><span class="p">.</span><span class="nx">Floats</span><span class="p">[</span><span class="nx">numSamplesMinusOne</span><span class="p">].</span><span class="nx">F</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">samples</span><span class="p">.</span><span class="nx">Floats</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">F</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">isCounter</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">break</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Handle counter resets:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">prevValue</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">samples</span><span class="p">.</span><span class="nx">Floats</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">F</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">currPoint</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">samples</span><span class="p">.</span><span class="nx">Floats</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">currPoint</span><span class="p">.</span><span class="nx">F</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">prevValue</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nx">resultFloat</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">prevValue</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nx">prevValue</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">currPoint</span><span class="p">.</span><span class="nx">F</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">default</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Not enough samples. TODO(beorn7): Communicate this failure reason.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">enh</span><span class="p">.</span><span class="nx">Out</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Duration between first/last samples and boundary of range.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">durationToStart</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="nx">firstT</span><span class="o">-</span><span class="nx">rangeStart</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">durationToEnd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="nx">rangeEnd</span><span class="o">-</span><span class="nx">lastT</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">sampledInterval</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="nx">lastT</span><span class="o">-</span><span class="nx">firstT</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">averageDurationBetweenSamples</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sampledInterval</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="nx">numSamplesMinusOne</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// TODO(beorn7): Do this for histograms, too.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">isCounter</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">resultFloat</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">samples</span><span class="p">.</span><span class="nx">Floats</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">samples</span><span class="p">.</span><span class="nx">Floats</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">F</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Counters cannot be negative. If we have any slope at all</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// (i.e. resultFloat went up), we can extrapolate the zero point</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// of the counter. If the duration to the zero point is shorter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// than the durationToStart, we take the zero point as the start</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// of the series, thereby avoiding extrapolation to negative</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// counter values.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">durationToZero</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sampledInterval</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">samples</span><span class="p">.</span><span class="nx">Floats</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">F</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">resultFloat</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">durationToZero</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">durationToStart</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nx">durationToStart</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">durationToZero</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// If the first/last samples are close to the boundaries of the range,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// extrapolate the result. This is as we expect that another sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// will exist given the spacing between samples we&#39;ve seen thus far,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// with an allowance for noise.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">extrapolationThreshold</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">averageDurationBetweenSamples</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">extrapolateToInterval</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sampledInterval</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">durationToStart</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">extrapolationThreshold</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">extrapolateToInterval</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">durationToStart</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">extrapolateToInterval</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">averageDurationBetweenSamples</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">durationToEnd</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">extrapolationThreshold</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">extrapolateToInterval</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">durationToEnd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">extrapolateToInterval</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">averageDurationBetweenSamples</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">factor</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">extrapolateToInterval</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">sampledInterval</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">isRate</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">factor</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="nx">ms</span><span class="p">.</span><span class="nx">Range</span><span class="p">.</span><span class="nf">Seconds</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">resultHistogram</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">resultFloat</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="nx">factor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">resultHistogram</span><span class="p">.</span><span class="nf">Mul</span><span class="p">(</span><span class="nx">factor</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">enh</span><span class="p">.</span><span class="nx">Out</span><span class="p">,</span><span class="w"> </span><span class="nx">Sample</span><span class="p">{</span><span class="nx">F</span><span class="p">:</span><span class="w"> </span><span class="nx">resultFloat</span><span class="p">,</span><span class="w"> </span><span class="nx">H</span><span class="p">:</span><span class="w"> </span><span class="nx">resultHistogram</span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="histogramquantitle">histogramQuantitle
</h4><p>用法示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-GO" data-lang="GO"><span class="line"><span class="cl"><span class="nx">TBD</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>源码见：</p>
<ul>
<li><a class="link" href="https://github.com/prometheus/prometheus/blob/caa173d2aac4c390546b1f78302104b1ccae0878/promql/functions.go#L615"  target="_blank" rel="noopener"
    >https://github.com/prometheus/prometheus/blob/caa173d2aac4c390546b1f78302104b1ccae0878/promql/functions.go#L615</a></li>
<li><a class="link" href="https://github.com/prometheus/prometheus/blob/caa173d2aac4c390546b1f78302104b1ccae0878/promql/quantile.go#L73"  target="_blank" rel="noopener"
    >https://github.com/prometheus/prometheus/blob/caa173d2aac4c390546b1f78302104b1ccae0878/promql/quantile.go#L73</a>
核心算法是：bucketStart + (bucketEnd-bucketStart)*(rank/count)。</li>
</ul>
<p>同样也是线性插值算法，比较好理解。唯一需要注意的是，在 histogram_quantile 的第二个参数是 sum(rate, &hellip;)，这个是 QPS(count/time) 而不是直接用的 count，为什么？计算公式里最后一项是 rank/count，而 rank = q*count，两者相除 time 项会被消除，相当于还是 count&rsquo; / count，也就是结果是等价的。既然结果等价，为什么要用 rate 而不直接用 count？因为 rate 函数可以使用处理 reset，直接用 count 不行。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-GO" data-lang="GO"><span class="line"><span class="cl"><span class="c1">// === histogram_quantile(k parser.ValueTypeScalar, Vector parser.ValueTypeVector) Vector ===</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">func</span><span class="w"> </span><span class="nf">funcHistogramQuantile</span><span class="p">(</span><span class="nx">vals</span><span class="w"> </span><span class="p">[]</span><span class="nx">parser</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="w"> </span><span class="nx">parser</span><span class="p">.</span><span class="nx">Expressions</span><span class="p">,</span><span class="w"> </span><span class="nx">enh</span><span class="w"> </span><span class="o">*</span><span class="nx">EvalNodeHelper</span><span class="p">)</span><span class="w"> </span><span class="nx">Vector</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">q</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">].(</span><span class="nx">Vector</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">F</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">inVec</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">].(</span><span class="nx">Vector</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">enh</span><span class="p">.</span><span class="nx">signatureToMetricWithBuckets</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">enh</span><span class="p">.</span><span class="nx">signatureToMetricWithBuckets</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">metricWithBuckets</span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">enh</span><span class="p">.</span><span class="nx">signatureToMetricWithBuckets</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nx">v</span><span class="p">.</span><span class="nx">buckets</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">v</span><span class="p">.</span><span class="nx">buckets</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">histogramSamples</span><span class="w"> </span><span class="p">[]</span><span class="nx">Sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">sample</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">inVec</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// We are only looking for conventional buckets here. Remember</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// the histograms for later treatment.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">sample</span><span class="p">.</span><span class="nx">H</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nx">histogramSamples</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">histogramSamples</span><span class="p">,</span><span class="w"> </span><span class="nx">sample</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">continue</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">upperBound</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strconv</span><span class="p">.</span><span class="nf">ParseFloat</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nx">sample</span><span class="p">.</span><span class="nx">Metric</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">BucketLabel</span><span class="p">),</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// Oops, no bucket label or malformed label value. Skip.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// TODO(beorn7): Issue a warning somehow.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">continue</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">enh</span><span class="p">.</span><span class="nx">lblBuf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">sample</span><span class="p">.</span><span class="nx">Metric</span><span class="p">.</span><span class="nf">BytesWithoutLabels</span><span class="p">(</span><span class="nx">enh</span><span class="p">.</span><span class="nx">lblBuf</span><span class="p">,</span><span class="w"> </span><span class="nx">labels</span><span class="p">.</span><span class="nx">BucketLabel</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">mb</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">enh</span><span class="p">.</span><span class="nx">signatureToMetricWithBuckets</span><span class="p">[</span><span class="nb">string</span><span class="p">(</span><span class="nx">enh</span><span class="p">.</span><span class="nx">lblBuf</span><span class="p">)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nx">sample</span><span class="p">.</span><span class="nx">Metric</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">labels</span><span class="p">.</span><span class="nf">NewBuilder</span><span class="p">(</span><span class="nx">sample</span><span class="p">.</span><span class="nx">Metric</span><span class="p">).</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nf">Del</span><span class="p">(</span><span class="nx">excludedLabels</span><span class="o">...</span><span class="p">).</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nf">Labels</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nx">mb</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">metricWithBuckets</span><span class="p">{</span><span class="nx">sample</span><span class="p">.</span><span class="nx">Metric</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nx">enh</span><span class="p">.</span><span class="nx">signatureToMetricWithBuckets</span><span class="p">[</span><span class="nb">string</span><span class="p">(</span><span class="nx">enh</span><span class="p">.</span><span class="nx">lblBuf</span><span class="p">)]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">mb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">mb</span><span class="p">.</span><span class="nx">buckets</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">mb</span><span class="p">.</span><span class="nx">buckets</span><span class="p">,</span><span class="w"> </span><span class="nx">bucket</span><span class="p">{</span><span class="nx">upperBound</span><span class="p">,</span><span class="w"> </span><span class="nx">sample</span><span class="p">.</span><span class="nx">F</span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Now deal with the histograms.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">sample</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">histogramSamples</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// We have to reconstruct the exact same signature as above for</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// a conventional histogram, just ignoring any le label.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">enh</span><span class="p">.</span><span class="nx">lblBuf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">sample</span><span class="p">.</span><span class="nx">Metric</span><span class="p">.</span><span class="nf">Bytes</span><span class="p">(</span><span class="nx">enh</span><span class="p">.</span><span class="nx">lblBuf</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">mb</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">enh</span><span class="p">.</span><span class="nx">signatureToMetricWithBuckets</span><span class="p">[</span><span class="nb">string</span><span class="p">(</span><span class="nx">enh</span><span class="p">.</span><span class="nx">lblBuf</span><span class="p">)];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">mb</span><span class="p">.</span><span class="nx">buckets</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// At this data point, we have conventional histogram</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// buckets and a native histogram with the same name and</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// labels. Do not evaluate anything.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// TODO(beorn7): Issue a warning somehow.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nb">delete</span><span class="p">(</span><span class="nx">enh</span><span class="p">.</span><span class="nx">signatureToMetricWithBuckets</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">enh</span><span class="p">.</span><span class="nx">lblBuf</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">continue</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">enh</span><span class="p">.</span><span class="nx">Out</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">enh</span><span class="p">.</span><span class="nx">Out</span><span class="p">,</span><span class="w"> </span><span class="nx">Sample</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nx">Metric</span><span class="p">:</span><span class="w"> </span><span class="nx">enh</span><span class="p">.</span><span class="nf">DropMetricName</span><span class="p">(</span><span class="nx">sample</span><span class="p">.</span><span class="nx">Metric</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nx">F</span><span class="p">:</span><span class="w">      </span><span class="nf">histogramQuantile</span><span class="p">(</span><span class="nx">q</span><span class="p">,</span><span class="w"> </span><span class="nx">sample</span><span class="p">.</span><span class="nx">H</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">mb</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">enh</span><span class="p">.</span><span class="nx">signatureToMetricWithBuckets</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">mb</span><span class="p">.</span><span class="nx">buckets</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nx">enh</span><span class="p">.</span><span class="nx">Out</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">enh</span><span class="p">.</span><span class="nx">Out</span><span class="p">,</span><span class="w"> </span><span class="nx">Sample</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nx">Metric</span><span class="p">:</span><span class="w"> </span><span class="nx">mb</span><span class="p">.</span><span class="nx">metric</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nx">F</span><span class="p">:</span><span class="w">      </span><span class="nf">bucketQuantile</span><span class="p">(</span><span class="nx">q</span><span class="p">,</span><span class="w"> </span><span class="nx">mb</span><span class="p">.</span><span class="nx">buckets</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">enh</span><span class="p">.</span><span class="nx">Out</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// bucketQuantile calculates the quantile &#39;q&#39; based on the given buckets. The</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// buckets will be sorted by upperBound by this function (i.e. no sorting</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// needed before calling this function). The quantile value is interpolated</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// assuming a linear distribution within a bucket. However, if the quantile</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// falls into the highest bucket, the upper bound of the 2nd highest bucket is</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// returned. A natural lower bound of 0 is assumed if the upper bound of the</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// lowest bucket is greater 0. In that case, interpolation in the lowest bucket</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// happens linearly between 0 and the upper bound of the lowest bucket.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// However, if the lowest bucket has an upper bound less or equal 0, this upper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// bound is returned if the quantile falls into the lowest bucket.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// There are a number of special cases (once we have a way to report errors</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// happening during evaluations of AST functions, we should report those</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// explicitly):</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// If &#39;buckets&#39; has 0 observations, NaN is returned.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// If &#39;buckets&#39; has fewer than 2 elements, NaN is returned.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// If the highest bucket is not +Inf, NaN is returned.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// If q==NaN, NaN is returned.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// If q&lt;0, -Inf is returned.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// If q&gt;1, +Inf is returned.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">func</span><span class="w"> </span><span class="nf">bucketQuantile</span><span class="p">(</span><span class="nx">q</span><span class="w"> </span><span class="kt">float64</span><span class="p">,</span><span class="w"> </span><span class="nx">buckets</span><span class="w"> </span><span class="nx">buckets</span><span class="p">)</span><span class="w"> </span><span class="kt">float64</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">math</span><span class="p">.</span><span class="nf">IsNaN</span><span class="p">(</span><span class="nx">q</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">math</span><span class="p">.</span><span class="nf">NaN</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">q</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">math</span><span class="p">.</span><span class="nf">Inf</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">q</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">math</span><span class="p">.</span><span class="nf">Inf</span><span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">slices</span><span class="p">.</span><span class="nf">SortFunc</span><span class="p">(</span><span class="nx">buckets</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="nx">bucket</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">upperBound</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">upperBound</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">math</span><span class="p">.</span><span class="nf">IsInf</span><span class="p">(</span><span class="nx">buckets</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">buckets</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">upperBound</span><span class="p">,</span><span class="w"> </span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">math</span><span class="p">.</span><span class="nf">NaN</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">buckets</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">coalesceBuckets</span><span class="p">(</span><span class="nx">buckets</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">ensureMonotonic</span><span class="p">(</span><span class="nx">buckets</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">buckets</span><span class="p">)</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">math</span><span class="p">.</span><span class="nf">NaN</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">observations</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">buckets</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">buckets</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">count</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">observations</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">math</span><span class="p">.</span><span class="nf">NaN</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">rank</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">q</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">observations</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sort</span><span class="p">.</span><span class="nf">Search</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">buckets</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">buckets</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">count</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">rank</span><span class="w"> </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">buckets</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">buckets</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">buckets</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">].</span><span class="nx">upperBound</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">buckets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">upperBound</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">buckets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">upperBound</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">bucketStart</span><span class="w"> </span><span class="kt">float64</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">bucketEnd</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="nx">buckets</span><span class="p">[</span><span class="nx">b</span><span class="p">].</span><span class="nx">upperBound</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">count</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="nx">buckets</span><span class="p">[</span><span class="nx">b</span><span class="p">].</span><span class="nx">count</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">bucketStart</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">buckets</span><span class="p">[</span><span class="nx">b</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">upperBound</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">count</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="nx">buckets</span><span class="p">[</span><span class="nx">b</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">count</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">rank</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="nx">buckets</span><span class="p">[</span><span class="nx">b</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">count</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">bucketStart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="nx">bucketEnd</span><span class="o">-</span><span class="nx">bucketStart</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nx">rank</span><span class="o">/</span><span class="nx">count</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>相关资料</p>
<ul>
<li><a class="link" href="https://stackoverflow.com/questions/55162093/understanding-histogram-quantile-based-on-rate-in-prometheus"  target="_blank" rel="noopener"
    >https://stackoverflow.com/questions/55162093/understanding-histogram-quantile-based-on-rate-in-prometheus</a></li>
<li><a class="link" href="https://stackoverflow.com/questions/60962520/how-to-get-the-quantile-of-rate-in-prometheus/65418483#65418483"  target="_blank" rel="noopener"
    >https://stackoverflow.com/questions/60962520/how-to-get-the-quantile-of-rate-in-prometheus/65418483#65418483</a></li>
</ul>
<p>可以在 prometheus 项目下执行下面的单测：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-GO" data-lang="GO"><span class="line"><span class="cl"><span class="kd">func</span><span class="w"> </span><span class="nf">TestBucketQuantile__rate5m</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">q</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mf">0.4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">myBuckets</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">buckets</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">{</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">},</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">{</span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">},</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">{</span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">},</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">{</span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">},</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">{</span><span class="nx">math</span><span class="p">.</span><span class="nf">Inf</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="mi">15</span><span class="p">},</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">f</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">bucketQuantile</span><span class="p">(</span><span class="nx">q</span><span class="p">,</span><span class="w"> </span><span class="nx">myBuckets</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;==== before rate =====&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">myBuckets</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%.2f\n&#34;</span><span class="p">,</span><span class="w"> </span><span class="nx">f</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">myBucket</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">myBuckets</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">myBuckets</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">count</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">myBucket</span><span class="p">.</span><span class="nx">count</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;==== after rate =====&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">myBuckets</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">f1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">bucketQuantile</span><span class="p">(</span><span class="nx">q</span><span class="p">,</span><span class="w"> </span><span class="nx">myBuckets</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%.2f\n&#34;</span><span class="p">,</span><span class="w"> </span><span class="nx">f1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/prometheus/">Prometheus</a>
        
            <a href="/tags/grafana/">Grafana</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    <section class="article-lastmod">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <span>
            最后更新于 2024/12/10 22:09 CST
        </span>
    </section></footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdmirror.com/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdmirror.com/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdmirror.com/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.body, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>
    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/2022/10/hugo-quick-start/">
        
        

        <div class="article-details">
            <h2 class="article-title">Hugo 配置记录</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/2022/10/how-to-set-network-proxy/">
        
        

        <div class="article-details">
            <h2 class="article-title">代理设置</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/2022/09/r-tree-and-its-family/">
        
        

        <div class="article-details">
            <h2 class="article-title">R树及其家族</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/2022/09/spatial-index-technology-first-glimpse/">
        
        

        <div class="article-details">
            <h2 class="article-title">空间索引技术初见</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo="zhumengzhu/zhumengzhu.github.io"
        issue-term="pathname"
        
        label="💬"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy;
        
        2022 -
        
        2025 All Rights Reserved
    </section>

    
    <section>
        <script defer pjax data-style="short" src="https://busuanzi.9420.ltd/js"></script>
        本文总阅读量 <span id="busuanzi_page_pv"></span> 次
        本文总访客量 <span id="busuanzi_page_uv"></span> 人
        本站总访问量 <span id="busuanzi_site_pv"></span> 次
        本站总访客数 <span id="busuanzi_site_uv"></span> 人
    </section>

    
    <section class="totalcount">
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        发表了20篇文章 ·
        总计32.36k字

    </section>
    
    <section class="running-time">
        本博客已稳定运行
        <span id="runningdays" class="running-days"></span>
    </section>

    <section class="powerby">
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener"
                data-version="3.29.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>

    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdmirror.com/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdmirror.com/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdmirror.com/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdmirror.com/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdmirror.com/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

<script
    src="https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/js/ribbon.min.js"
    integrity="sha384-UEK8ZiP3VgFNP8KnKMKDmd4pAUAOJ59Y2Jo3ED2Z5qKQf6HLHovMxq7Beb9CLPUe"
    crossorigin="anonymous"
    size="300"
    alpha="0.6"
    zindex="-1"
    defer
></script>


<script
    src="https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/js/nprogress.min.js"
    integrity="sha384-bHDlAEUFxsRI7JfULv3DTpL2IXbbgn4JHQJibgo5iiXSK6Iu8muwqHANhun74Cqg"
    crossorigin="anonymous"
></script>
<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/css/nprogress.css"
    integrity="sha384-KJyhr2syt5+4M9Pz5dipCvTrtvOmLk/olWVdfhAp858UCa64Ia5GFpTN7+G4BWpE"
    crossorigin="anonymous"
/>
<script>
    NProgress.start();
    document.addEventListener("readystatechange", () => {
        if (document.readyState === "interactive") NProgress.inc(0.8);
        if (document.readyState === "complete") NProgress.done();
    });
</script>



<script>
    let s1 = '2022-10-16'; 
    s1 = new Date(s1.replace(/-/g, "/"));
    let s2 = new Date();
    let timeDifference = s2.getTime() - s1.getTime();

    let days = Math.floor(timeDifference / (1000 * 60 * 60 * 24));
    let hours = Math.floor((timeDifference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    let minutes = Math.floor((timeDifference % (1000 * 60 * 60)) / (1000 * 60));

    let result = days + "天" + hours + "小时" + minutes + "分钟";
    document.getElementById('runningdays').innerHTML = result;
</script>
    </body>
</html>
